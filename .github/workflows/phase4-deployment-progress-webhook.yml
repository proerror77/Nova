name: Phase 4 Deployment Progress Webhook

on:
  workflow_run:
    workflows: ["Phase 4 - GraphQL Gateway Staging Deployment"]
    types:
      - requested
      - in_progress
      - completed

jobs:
  send-progress-webhook:
    name: Send Progress to Discord Webhook
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read

    steps:
      - name: Get workflow run info
        id: workflow
        uses: actions/github-script@v7
        with:
          script: |
            const runId = context.payload.workflow_run.id;
            const status = context.payload.workflow_run.status;
            const conclusion = context.payload.workflow_run.conclusion;
            const name = context.payload.workflow_run.name;
            const htmlUrl = context.payload.workflow_run.html_url;
            const headBranch = context.payload.workflow_run.head_branch;
            const headSha = context.payload.workflow_run.head_sha;

            console.log(`Workflow: ${name}`);
            console.log(`Status: ${status}`);
            console.log(`Conclusion: ${conclusion}`);
            console.log(`Run ID: ${runId}`);

            core.setOutput('run-id', runId);
            core.setOutput('status', status);
            core.setOutput('conclusion', conclusion);
            core.setOutput('name', name);
            core.setOutput('url', htmlUrl);
            core.setOutput('branch', headBranch);
            core.setOutput('sha', headSha.substring(0, 7));

      - name: Get job status details
        id: jobs
        uses: actions/github-script@v7
        with:
          script: |
            const runId = ${{ steps.workflow.outputs.run-id }};
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId,
            });

            let jobsInfo = '';
            let completedJobs = 0;
            let failedJobs = 0;
            let inProgressJobs = 0;

            jobs.data.jobs.forEach(job => {
              const status = job.status;
              const conclusion = job.conclusion;
              const name = job.name;

              let emoji = '‚è≥';
              if (status === 'completed') {
                completedJobs++;
                emoji = conclusion === 'success' ? '‚úÖ' : '‚ùå';
              } else if (status === 'in_progress') {
                inProgressJobs++;
                emoji = 'üîÑ';
              }

              if (conclusion === 'failure') {
                failedJobs++;
              }

              jobsInfo += `${emoji} ${name}\n`;
            });

            core.setOutput('jobs-info', jobsInfo);
            core.setOutput('completed-jobs', completedJobs);
            core.setOutput('failed-jobs', failedJobs);
            core.setOutput('in-progress-jobs', inProgressJobs);
            core.setOutput('total-jobs', jobs.data.jobs.length);

      - name: Prepare Discord message (In Progress)
        id: message-progress
        if: steps.workflow.outputs.status == 'in_progress'
        run: |
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          MESSAGE="üöÄ **Phase 4 Staging Deployment Started**\n\n"
          MESSAGE+="üì¶ **Deployment Details:**\n"
          MESSAGE+="- Branch: \`${{ steps.workflow.outputs.branch }}\`\n"
          MESSAGE+="- Commit: \`${{ steps.workflow.outputs.sha }}\`\n"
          MESSAGE+="- Status: üîÑ In Progress\n"
          MESSAGE+="- Run ID: ${{ steps.workflow.outputs.run-id }}\n"
          MESSAGE+="- Time: ${TIMESTAMP}\n\n"
          MESSAGE+="üìã **Job Progress:**\n"
          MESSAGE+="${{ steps.jobs.outputs.jobs-info }}\n"
          MESSAGE+="- Completed: ${{ steps.jobs.outputs.completed-jobs }} / ${{ steps.jobs.outputs.total-jobs }}\n"
          MESSAGE+="- In Progress: ${{ steps.jobs.outputs.in-progress-jobs }}\n\n"
          MESSAGE+="üîó [View Details](${{ steps.workflow.outputs.url }})\n\n"
          MESSAGE+="‚è±Ô∏è Real-time updates enabled. Check back for status changes."
          echo "WEBHOOK_MESSAGE=$MESSAGE" >> $GITHUB_ENV

      - name: Prepare Discord message (Completed - Success)
        id: message-success
        if: steps.workflow.outputs.status == 'completed' && steps.workflow.outputs.conclusion == 'success'
        run: |
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          MESSAGE="‚úÖ **Phase 4 Staging Deployment Completed Successfully**\n\n"
          MESSAGE+="üì¶ **Deployment Details:**\n"
          MESSAGE+="- Branch: \`${{ steps.workflow.outputs.branch }}\`\n"
          MESSAGE+="- Commit: \`${{ steps.workflow.outputs.sha }}\`\n"
          MESSAGE+="- Status: ‚úÖ Success\n"
          MESSAGE+="- Run ID: ${{ steps.workflow.outputs.run-id }}\n"
          MESSAGE+="- Time: ${TIMESTAMP}\n\n"
          MESSAGE+="üìã **Job Summary:**\n"
          MESSAGE+="${{ steps.jobs.outputs.jobs-info }}\n"
          MESSAGE+="- Total Completed: ${{ steps.jobs.outputs.total-jobs }} / ${{ steps.jobs.outputs.total-jobs }}\n"
          MESSAGE+="- Failed: ${{ steps.jobs.outputs.failed-jobs }}\n\n"
          MESSAGE+="üéØ **Next Steps:**\n"
          MESSAGE+="1. Check Kafka consumer lag\n"
          MESSAGE+="2. Verify Redis cache hit rate\n"
          MESSAGE+="3. Review load test metrics\n"
          MESSAGE+="4. Plan production deployment\n\n"
          MESSAGE+="üîó [View Full Report](${{ steps.workflow.outputs.url }})"
          echo "WEBHOOK_MESSAGE=$MESSAGE" >> $GITHUB_ENV

      - name: Prepare Discord message (Completed - Failed)
        id: message-failure
        if: steps.workflow.outputs.status == 'completed' && steps.workflow.outputs.conclusion == 'failure'
        run: |
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          MESSAGE="‚ùå **Phase 4 Staging Deployment Failed**\n\n"
          MESSAGE+="üì¶ **Deployment Details:**\n"
          MESSAGE+="- Branch: \`${{ steps.workflow.outputs.branch }}\`\n"
          MESSAGE+="- Commit: \`${{ steps.workflow.outputs.sha }}\`\n"
          MESSAGE+="- Status: ‚ùå Failed\n"
          MESSAGE+="- Run ID: ${{ steps.workflow.outputs.run-id }}\n"
          MESSAGE+="- Time: ${TIMESTAMP}\n\n"
          MESSAGE+="üìã **Job Summary:**\n"
          MESSAGE+="${{ steps.jobs.outputs.jobs-info }}\n"
          MESSAGE+="- Failed: ${{ steps.jobs.outputs.failed-jobs }}\n\n"
          MESSAGE+="üîç **Troubleshooting Steps:**\n"
          MESSAGE+="1. Check failed job logs\n"
          MESSAGE+="2. Verify Docker build status\n"
          MESSAGE+="3. Check Kubernetes cluster connectivity\n"
          MESSAGE+="4. Review pod events\n\n"
          MESSAGE+="üîó [View Error Details](${{ steps.workflow.outputs.url }})"
          echo "WEBHOOK_MESSAGE=$MESSAGE" >> $GITHUB_ENV

      - name: Send to Discord Webhook
        if: env.DISCORD_WEBHOOK_URL != ''
        uses: SaucissonFrit/action-discord-webhook@v2
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          content: ${{ env.WEBHOOK_MESSAGE }}
          username: "GitHub Actions Bot"
          avatar-url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"

      - name: Send to Slack Webhook (Optional)
        if: env.SLACK_WEBHOOK_URL != ''
        run: |
          PAYLOAD=$(cat <<EOF
          {
            "text": "Phase 4 Deployment Status",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "${{ env.WEBHOOK_MESSAGE }}"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Details"
                    },
                    "url": "${{ steps.workflow.outputs.url }}"
                  }
                ]
              }
            ]
          }
          EOF
          )

          curl -X POST \
            -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

---

name: Deployment Progress Monitor

on:
  schedule:
    # Check every 5 minutes during deployment
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  check-latest-deployment:
    name: Check Latest Deployment Status
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read

    steps:
      - name: Get latest Phase 4 deployment run
        id: latest-run
        uses: actions/github-script@v7
        with:
          script: |
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'phase4-staging-deployment.yml',
              status: 'in_progress',
              per_page: 1,
            });

            if (runs.data.workflow_runs.length === 0) {
              console.log('No in-progress deployments');
              core.setOutput('found', 'false');
              return;
            }

            const run = runs.data.workflow_runs[0];
            core.setOutput('found', 'true');
            core.setOutput('run-id', run.id);
            core.setOutput('status', run.status);
            core.setOutput('created-at', run.created_at);
            core.setOutput('url', run.html_url);

      - name: Get current job progress
        if: steps.latest-run.outputs.found == 'true'
        id: progress
        uses: actions/github-script@v7
        with:
          script: |
            const runId = ${{ steps.latest-run.outputs.run-id }};
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId,
            });

            let completed = 0;
            let failed = 0;
            let inProgress = 0;
            let queued = 0;

            jobs.data.jobs.forEach(job => {
              if (job.status === 'completed') {
                completed++;
                if (job.conclusion === 'failure') {
                  failed++;
                }
              } else if (job.status === 'in_progress') {
                inProgress++;
              } else if (job.status === 'queued') {
                queued++;
              }
            });

            const total = jobs.data.jobs.length;
            const percentage = Math.round((completed / total) * 100);

            core.setOutput('completed', completed);
            core.setOutput('total', total);
            core.setOutput('failed', failed);
            core.setOutput('in-progress', inProgress);
            core.setOutput('queued', queued);
            core.setOutput('percentage', percentage);

      - name: Update GitHub Status (In Progress)
        if: steps.latest-run.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const percentage = ${{ steps.progress.outputs.percentage }};
            const completed = ${{ steps.progress.outputs.completed }};
            const total = ${{ steps.progress.outputs.total }};

            let status = 'üîÑ';
            if (percentage === 100) {
              status = '‚úÖ';
            } else if (${{ steps.progress.outputs.failed }} > 0) {
              status = '‚ùå';
            }

            const description = `${status} ${completed}/${total} jobs (${percentage}%)`;

            core.notice(`Phase 4 Deployment Progress: ${description}`);

      - name: Create status check
        if: steps.latest-run.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentUrl = '${{ steps.latest-run.outputs.url }}';
            const percentage = ${{ steps.progress.outputs.percentage }};

            core.setOutput('status-url', deploymentUrl);
            core.setOutput('progress-bar',
              '‚ñà'.repeat(Math.floor(percentage / 10)) +
              '‚ñë'.repeat(10 - Math.floor(percentage / 10))
            );

      - name: Output progress summary
        if: steps.latest-run.outputs.found == 'true'
        run: |
          echo "## üìä Phase 4 Deployment Progress"
          echo ""
          echo "**Progress**: ${{ steps.progress.outputs.percentage }}% Complete"
          echo ""
          echo "**Status**: "
          echo "- ‚úÖ Completed: ${{ steps.progress.outputs.completed }} / ${{ steps.progress.outputs.total }}"
          echo "- üîÑ In Progress: ${{ steps.progress.outputs.in-progress }}"
          echo "- ‚è≥ Queued: ${{ steps.progress.outputs.queued }}"
          echo "- ‚ùå Failed: ${{ steps.progress.outputs.failed }}"
          echo ""
          echo "**Link**: ${{ steps.latest-run.outputs.url }}"
          echo ""
          echo "[View Full Details](${{ steps.latest-run.outputs.url }})"
