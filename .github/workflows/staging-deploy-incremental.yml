name: Staging Deploy (Incremental) - GCP

# å¢é‡éƒ¨ç½²ï¼šåªæ„å»ºå’Œéƒ¨ç½²å˜æ›´çš„æœåŠ¡
# åˆ†å±‚éƒ¨ç½²ï¼šæŒ‰æœåŠ¡ä¾èµ–é¡ºåºéƒ¨ç½²ï¼Œç¡®ä¿é›¶åœæœº
# è‡ªåŠ¨å›æ»šï¼šä»»ä½•å±‚éƒ¨ç½²å¤±è´¥è‡ªåŠ¨å›æ»š
# å¹³å°ï¼šGCP (GKE + Artifact Registry)

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'k8s/**'
      - '.github/workflows/staging-deploy-incremental.yml'
  workflow_dispatch:
    inputs:
      force_all:
        description: 'Force rebuild all services'
        type: boolean
        default: false
      services:
        description: 'Specific services to deploy (comma-separated, e.g. identity-service,graph-service)'
        type: string
        default: ''

concurrency:
  group: staging-deploy-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

env:
  GCP_REGION: ${{ vars.GCP_REGION || 'asia-northeast1' }}
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GAR_REGISTRY: ${{ vars.GCP_REGION || 'asia-northeast1' }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/nova
  GKE_CLUSTER: ${{ vars.GKE_CLUSTER || 'nova-staging-gke' }}
  NAMESPACE: nova-staging

jobs:
  # ============================================================
  # Phase 1: æ£€æµ‹å˜æ›´
  # ============================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.detect.outputs.has_changes }}
      changed_services: ${{ steps.detect.outputs.changed_services }}
      shared_changed: ${{ steps.detect.outputs.shared_changed }}
      layer0: ${{ steps.layers.outputs.layer0 }}
      layer1: ${{ steps.layers.outputs.layer1 }}
      layer2: ${{ steps.layers.outputs.layer2 }}
      layer3: ${{ steps.layers.outputs.layer3 }}
      layer4: ${{ steps.layers.outputs.layer4 }}
      has_layer0: ${{ steps.layers.outputs.has_layer0 }}
      has_layer1: ${{ steps.layers.outputs.has_layer1 }}
      has_layer2: ${{ steps.layers.outputs.has_layer2 }}
      has_layer3: ${{ steps.layers.outputs.has_layer3 }}
      has_layer4: ${{ steps.layers.outputs.has_layer4 }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed services
        id: detect
        run: |
          set -e

          # æ‰‹åŠ¨æŒ‡å®šçš„æœåŠ¡ï¼ˆworkflow_dispatchï¼‰
          if [ -n "${{ inputs.services }}" ]; then
            echo "ğŸ“‹ Manual service selection: ${{ inputs.services }}"
            SERVICES=$(echo "${{ inputs.services }}" | tr ',' '\n' | jq -R -s -c 'split("\n") | map(select(. != ""))')
            echo "changed_services=$SERVICES" >> "$GITHUB_OUTPUT"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "shared_changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # å¼ºåˆ¶å…¨é‡æ„å»º
          if [ "${{ inputs.force_all }}" == "true" ]; then
            echo "ğŸ”„ Force all services rebuild"
            ALL_SERVICES='["analytics-service","content-service","feed-service","graph-service","graphql-gateway","identity-service","media-service","notification-service","ranking-service","realtime-chat-service","search-service","social-service","trust-safety-service"]'
            echo "changed_services=$ALL_SERVICES" >> "$GITHUB_OUTPUT"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "shared_changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # è·å–å˜æ›´æ–‡ä»¶
          if [ "${{ github.event_name }}" == "push" ]; then
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          else
            BASE_SHA=$(git rev-parse HEAD~1)
            HEAD_SHA=$(git rev-parse HEAD)
          fi

          echo "ğŸ“Š Comparing $BASE_SHA..$HEAD_SHA"
          CHANGED_FILES=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" 2>/dev/null || git diff --name-only HEAD~1 HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # æ£€æŸ¥å…±äº«åº“æ˜¯å¦å˜æ›´
          SHARED_CHANGED="false"
          if echo "$CHANGED_FILES" | grep -qE '^backend/(libs|common|proto)/'; then
            echo "âš ï¸  Shared libraries changed - rebuilding all services"
            SHARED_CHANGED="true"
            ALL_SERVICES='["analytics-service","content-service","feed-service","graph-service","graphql-gateway","identity-service","media-service","notification-service","ranking-service","realtime-chat-service","search-service","social-service","trust-safety-service"]'
            echo "changed_services=$ALL_SERVICES" >> "$GITHUB_OUTPUT"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "shared_changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # æ£€æµ‹å˜æ›´çš„æœåŠ¡
          CHANGED_SERVICES=$(echo "$CHANGED_FILES" | \
            grep '^backend/' | \
            cut -d'/' -f2 | \
            sort -u | \
            grep -E '^(analytics|content|feed|graph|graphql|identity|media|notification|ranking|realtime-chat|search|social|trust-safety)-service$' || true)

          if [ -z "$CHANGED_SERVICES" ]; then
            echo "âœ… No service changes detected"
            echo "changed_services=[]" >> "$GITHUB_OUTPUT"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "shared_changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "ğŸ“¦ Changed services:"
            echo "$CHANGED_SERVICES"
            SERVICES_JSON=$(echo "$CHANGED_SERVICES" | jq -R -s -c 'split("\n") | map(select(. != ""))')
            echo "changed_services=$SERVICES_JSON" >> "$GITHUB_OUTPUT"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "shared_changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Categorize services by layer
        id: layers
        run: |
          set -e

          SERVICES='${{ steps.detect.outputs.changed_services }}'
          echo "Services to categorize: $SERVICES"

          # å®šä¹‰æœåŠ¡å±‚çº§
          LAYER0='["identity-service","graph-service"]'
          LAYER1='["content-service","social-service","media-service"]'
          LAYER2='["feed-service","ranking-service","search-service","notification-service"]'
          LAYER3='["analytics-service","trust-safety-service","realtime-chat-service"]'
          LAYER4='["graphql-gateway"]'

          # è¿‡æ»¤å‡ºå˜æ›´çš„æœåŠ¡
          filter_services() {
            local layer=$1
            local services=$2
            echo "$services" | jq -c --argjson layer "$layer" '[.[] | select(. as $s | $layer | index($s))]'
          }

          L0=$(filter_services "$LAYER0" "$SERVICES")
          L1=$(filter_services "$LAYER1" "$SERVICES")
          L2=$(filter_services "$LAYER2" "$SERVICES")
          L3=$(filter_services "$LAYER3" "$SERVICES")
          L4=$(filter_services "$LAYER4" "$SERVICES")

          echo "Layer 0 (åŸºç¡€): $L0"
          echo "Layer 1 (æ ¸å¿ƒ): $L1"
          echo "Layer 2 (ä¸šåŠ¡): $L2"
          echo "Layer 3 (è¾¹ç¼˜): $L3"
          echo "Layer 4 (ç½‘å…³): $L4"

          echo "layer0=$L0" >> "$GITHUB_OUTPUT"
          echo "layer1=$L1" >> "$GITHUB_OUTPUT"
          echo "layer2=$L2" >> "$GITHUB_OUTPUT"
          echo "layer3=$L3" >> "$GITHUB_OUTPUT"
          echo "layer4=$L4" >> "$GITHUB_OUTPUT"

          [ "$L0" != "[]" ] && echo "has_layer0=true" >> "$GITHUB_OUTPUT" || echo "has_layer0=false" >> "$GITHUB_OUTPUT"
          [ "$L1" != "[]" ] && echo "has_layer1=true" >> "$GITHUB_OUTPUT" || echo "has_layer1=false" >> "$GITHUB_OUTPUT"
          [ "$L2" != "[]" ] && echo "has_layer2=true" >> "$GITHUB_OUTPUT" || echo "has_layer2=false" >> "$GITHUB_OUTPUT"
          [ "$L3" != "[]" ] && echo "has_layer3=true" >> "$GITHUB_OUTPUT" || echo "has_layer3=false" >> "$GITHUB_OUTPUT"
          [ "$L4" != "[]" ] && echo "has_layer4=true" >> "$GITHUB_OUTPUT" || echo "has_layer4=false" >> "$GITHUB_OUTPUT"

  # ============================================================
  # Phase 2: æ„å»ºå˜æ›´çš„æœåŠ¡ (æ¨é€åˆ° Artifact Registry)
  # ============================================================
  build-changed:
    name: Build ${{ matrix.service }}
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.changed_services) }}
      max-parallel: 6
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}
          token_format: access_token

      - name: Login to Artifact Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.GCP_REGION }}-docker.pkg.dev
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.access_token }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./backend/${{ matrix.service }}/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.GAR_REGISTRY }}/${{ matrix.service }}:${{ github.sha }}
            ${{ env.GAR_REGISTRY }}/${{ matrix.service }}:latest
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}
          build-args: |
            SERVICE_NAME=${{ matrix.service }}

      - name: Verify image
        run: |
          echo "âœ… ${{ matrix.service }}:${{ github.sha }} pushed to Artifact Registry"

  # ============================================================
  # Phase 3: åˆ†å±‚éƒ¨ç½²åˆ° GKE
  # ============================================================

  # Layer 0: åŸºç¡€æœåŠ¡
  deploy-layer0:
    name: Deploy Layer 0 (${{ matrix.service }})
    needs: [detect-changes, build-changed]
    if: needs.detect-changes.outputs.has_layer0 == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.layer0) }}
      fail-fast: true

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: Deploy ${{ matrix.service }}
        run: |
          SERVICE="${{ matrix.service }}"
          IMAGE="${{ env.GAR_REGISTRY }}/${SERVICE}:${{ github.sha }}"

          echo "ğŸš€ Deploying $SERVICE (Layer 0 - åŸºç¡€æœåŠ¡)"
          kubectl set image deployment/"$SERVICE" "$SERVICE=$IMAGE" -n ${{ env.NAMESPACE }}

          if ! kubectl rollout status deployment/"$SERVICE" -n ${{ env.NAMESPACE }} --timeout=5m; then
            echo "âŒ Rollout failed, initiating rollback..."
            kubectl rollout undo deployment/"$SERVICE" -n ${{ env.NAMESPACE }}
            exit 1
          fi

          echo "âœ… $SERVICE deployed successfully"

      - name: Health check
        run: |
          SERVICE="${{ matrix.service }}"
          kubectl wait --for=condition=ready pod -l app="$SERVICE" -n ${{ env.NAMESPACE }} --timeout=2m
          echo "âœ… $SERVICE is healthy"

  # Layer 1: æ ¸å¿ƒæœåŠ¡
  deploy-layer1:
    name: Deploy Layer 1 (${{ matrix.service }})
    needs: [detect-changes, build-changed, deploy-layer0]
    if: |
      always() &&
      needs.detect-changes.outputs.has_layer1 == 'true' &&
      (needs.deploy-layer0.result == 'success' || needs.deploy-layer0.result == 'skipped')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.layer1) }}
      fail-fast: false
      max-parallel: 3

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: Deploy ${{ matrix.service }}
        run: |
          SERVICE="${{ matrix.service }}"
          IMAGE="${{ env.GAR_REGISTRY }}/${SERVICE}:${{ github.sha }}"

          echo "ğŸš€ Deploying $SERVICE (Layer 1 - æ ¸å¿ƒæœåŠ¡)"
          kubectl set image deployment/"$SERVICE" "$SERVICE=$IMAGE" -n ${{ env.NAMESPACE }}

          if ! kubectl rollout status deployment/"$SERVICE" -n ${{ env.NAMESPACE }} --timeout=5m; then
            kubectl rollout undo deployment/"$SERVICE" -n ${{ env.NAMESPACE }}
            exit 1
          fi

          echo "âœ… $SERVICE deployed successfully"

      - name: Health check
        run: |
          SERVICE="${{ matrix.service }}"
          kubectl wait --for=condition=ready pod -l app="$SERVICE" -n ${{ env.NAMESPACE }} --timeout=2m
          echo "âœ… $SERVICE is healthy"

  # Layer 2: ä¸šåŠ¡æœåŠ¡
  deploy-layer2:
    name: Deploy Layer 2 (${{ matrix.service }})
    needs: [detect-changes, build-changed, deploy-layer0, deploy-layer1]
    if: |
      always() &&
      needs.detect-changes.outputs.has_layer2 == 'true' &&
      (needs.deploy-layer0.result == 'success' || needs.deploy-layer0.result == 'skipped') &&
      (needs.deploy-layer1.result == 'success' || needs.deploy-layer1.result == 'skipped')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.layer2) }}
      fail-fast: false
      max-parallel: 4

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: Deploy ${{ matrix.service }}
        run: |
          SERVICE="${{ matrix.service }}"
          IMAGE="${{ env.GAR_REGISTRY }}/${SERVICE}:${{ github.sha }}"

          echo "ğŸš€ Deploying $SERVICE (Layer 2 - ä¸šåŠ¡æœåŠ¡)"
          kubectl set image deployment/"$SERVICE" "$SERVICE=$IMAGE" -n ${{ env.NAMESPACE }}

          if ! kubectl rollout status deployment/"$SERVICE" -n ${{ env.NAMESPACE }} --timeout=5m; then
            kubectl rollout undo deployment/"$SERVICE" -n ${{ env.NAMESPACE }}
            exit 1
          fi

          echo "âœ… $SERVICE deployed successfully"

      - name: Health check
        run: |
          SERVICE="${{ matrix.service }}"
          kubectl wait --for=condition=ready pod -l app="$SERVICE" -n ${{ env.NAMESPACE }} --timeout=2m
          echo "âœ… $SERVICE is healthy"

  # Layer 3: è¾¹ç¼˜æœåŠ¡
  deploy-layer3:
    name: Deploy Layer 3 (${{ matrix.service }})
    needs: [detect-changes, build-changed, deploy-layer0, deploy-layer1, deploy-layer2]
    if: |
      always() &&
      needs.detect-changes.outputs.has_layer3 == 'true' &&
      (needs.deploy-layer0.result == 'success' || needs.deploy-layer0.result == 'skipped') &&
      (needs.deploy-layer1.result == 'success' || needs.deploy-layer1.result == 'skipped') &&
      (needs.deploy-layer2.result == 'success' || needs.deploy-layer2.result == 'skipped')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.layer3) }}
      fail-fast: false
      max-parallel: 3

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: Deploy ${{ matrix.service }}
        run: |
          SERVICE="${{ matrix.service }}"
          IMAGE="${{ env.GAR_REGISTRY }}/${SERVICE}:${{ github.sha }}"

          echo "ğŸš€ Deploying $SERVICE (Layer 3 - è¾¹ç¼˜æœåŠ¡)"
          kubectl set image deployment/"$SERVICE" "$SERVICE=$IMAGE" -n ${{ env.NAMESPACE }}

          if ! kubectl rollout status deployment/"$SERVICE" -n ${{ env.NAMESPACE }} --timeout=5m; then
            kubectl rollout undo deployment/"$SERVICE" -n ${{ env.NAMESPACE }}
            exit 1
          fi

          echo "âœ… $SERVICE deployed successfully"

      - name: Health check
        run: |
          SERVICE="${{ matrix.service }}"
          kubectl wait --for=condition=ready pod -l app="$SERVICE" -n ${{ env.NAMESPACE }} --timeout=2m
          echo "âœ… $SERVICE is healthy"

  # Layer 4: ç½‘å…³ï¼ˆæœ€åéƒ¨ç½²ï¼‰
  deploy-layer4:
    name: Deploy Layer 4 (Gateway)
    needs: [detect-changes, build-changed, deploy-layer0, deploy-layer1, deploy-layer2, deploy-layer3]
    if: |
      always() &&
      needs.detect-changes.outputs.has_layer4 == 'true' &&
      (needs.deploy-layer0.result == 'success' || needs.deploy-layer0.result == 'skipped') &&
      (needs.deploy-layer1.result == 'success' || needs.deploy-layer1.result == 'skipped') &&
      (needs.deploy-layer2.result == 'success' || needs.deploy-layer2.result == 'skipped') &&
      (needs.deploy-layer3.result == 'success' || needs.deploy-layer3.result == 'skipped')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.layer4) }}

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: Deploy graphql-gateway
        run: |
          SERVICE="${{ matrix.service }}"
          IMAGE="${{ env.GAR_REGISTRY }}/${SERVICE}:${{ github.sha }}"

          echo "ğŸš€ Deploying $SERVICE (Layer 4 - ç½‘å…³)"
          kubectl set image deployment/"$SERVICE" "$SERVICE=$IMAGE" -n ${{ env.NAMESPACE }}

          if ! kubectl rollout status deployment/"$SERVICE" -n ${{ env.NAMESPACE }} --timeout=5m; then
            kubectl rollout undo deployment/"$SERVICE" -n ${{ env.NAMESPACE }}
            exit 1
          fi

          echo "âœ… Gateway deployed successfully"

      - name: Health check
        run: |
          SERVICE="${{ matrix.service }}"
          kubectl wait --for=condition=ready pod -l app="$SERVICE" -n ${{ env.NAMESPACE }} --timeout=2m
          echo "âœ… Gateway is healthy"

  # ============================================================
  # Phase 4: Smoke Test
  # ============================================================
  smoke-test:
    name: Smoke Test
    needs: [detect-changes, deploy-layer0, deploy-layer1, deploy-layer2, deploy-layer3, deploy-layer4]
    if: |
      always() &&
      needs.detect-changes.outputs.has_changes == 'true' &&
      (needs.deploy-layer0.result == 'success' || needs.deploy-layer0.result == 'skipped') &&
      (needs.deploy-layer1.result == 'success' || needs.deploy-layer1.result == 'skipped') &&
      (needs.deploy-layer2.result == 'success' || needs.deploy-layer2.result == 'skipped') &&
      (needs.deploy-layer3.result == 'success' || needs.deploy-layer3.result == 'skipped') &&
      (needs.deploy-layer4.result == 'success' || needs.deploy-layer4.result == 'skipped')
    runs-on: ubuntu-latest

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: Verify deployments
        run: |
          echo "ğŸ§ª Smoke Test - Verifying deployed services"

          echo "1. All pods:"
          kubectl get pods -n ${{ env.NAMESPACE }} -o wide

          echo ""
          echo "2. Deployment status:"
          kubectl get deployments -n ${{ env.NAMESPACE }}

          echo ""
          echo "3. Non-running pods:"
          NOT_RUNNING=$(kubectl get pods -n ${{ env.NAMESPACE }} --field-selector=status.phase!=Running --no-headers 2>/dev/null | wc -l)
          if [ "$NOT_RUNNING" -gt 0 ]; then
            echo "âš ï¸  Found $NOT_RUNNING pods not in Running state"
            kubectl get pods -n ${{ env.NAMESPACE }} --field-selector=status.phase!=Running
          else
            echo "âœ… All pods are running"
          fi

      - name: GraphQL Gateway health check
        run: |
          echo "4. GraphQL Gateway health check:"
          kubectl run tmp-curl-${{ github.run_id }} --rm -i --image=curlimages/curl:8.10.1 -n ${{ env.NAMESPACE }} --restart=Never -- \
            sh -c 'curl -sS http://graphql-gateway.${{ env.NAMESPACE }}.svc.cluster.local:8080/health || echo "Gateway not responding"'

  # ============================================================
  # Phase 5: é€šçŸ¥
  # ============================================================
  notify-success:
    name: Notify Success
    needs: [detect-changes, smoke-test]
    if: success() && needs.detect-changes.outputs.has_changes == 'true'
    uses: ./.github/workflows/_reusable-feishu-notify.yml
    with:
      title: "Staging å¢é‡éƒ¨ç½²æˆåŠŸ (GCP)"
      status: "success"
      workflow-name: "Staging Deploy (Incremental)"
      message: |
        **ç’°å¢ƒ**: nova-staging (GKE)
        **æäº¤**: ${{ github.sha }}
        **åˆ†æ”¯**: ${{ github.ref_name }}
        **éƒ¨ç½²æœå‹™**: ${{ needs.detect-changes.outputs.changed_services }}

        âœ… å¢é‡éƒ¨ç½²å®Œæˆï¼Œåªæ›´æ–°äº†è®Šæ›´çš„æœå‹™
    secrets:
      feishu-webhook: ${{ secrets.FEISHU_WEBHOOK }}

  notify-failure:
    name: Notify Failure
    needs: [detect-changes, build-changed, deploy-layer0, deploy-layer1, deploy-layer2, deploy-layer3, deploy-layer4, smoke-test]
    if: failure()
    uses: ./.github/workflows/_reusable-feishu-notify.yml
    with:
      title: "Staging éƒ¨ç½²å¤±æ•— (GCP)"
      status: "failure"
      workflow-name: "Staging Deploy (Incremental)"
      message: |
        **ç’°å¢ƒ**: nova-staging (GKE)
        **æäº¤**: ${{ github.sha }}
        **åˆ†æ”¯**: ${{ github.ref_name }}
        **å˜—è©¦éƒ¨ç½²**: ${{ needs.detect-changes.outputs.changed_services }}

        âŒ éƒ¨ç½²å¤±æ•—ï¼Œå·²è‡ªå‹•å›æ»¾å¤±æ•—çš„æœå‹™
        è«‹æª¢æŸ¥æ—¥èªŒä¸¦ä¿®å¾©å•é¡Œã€‚
    secrets:
      feishu-webhook: ${{ secrets.FEISHU_WEBHOOK }}

  no-changes:
    name: No Changes
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Report no changes
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… NO SERVICE CHANGES DETECTED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "No backend service files were changed."
          echo "Skipping build and deployment."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # ============================================================
  # Summary
  # ============================================================
  summary:
    name: Deployment Summary
    needs: [detect-changes, build-changed, deploy-layer0, deploy-layer1, deploy-layer2, deploy-layer3, deploy-layer4, smoke-test]
    if: always() && needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Print summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š INCREMENTAL DEPLOYMENT SUMMARY (GCP)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Platform: GCP (GKE + Artifact Registry)"
          echo ""
          echo "Changed Services: ${{ needs.detect-changes.outputs.changed_services }}"
          echo "Shared Libraries Changed: ${{ needs.detect-changes.outputs.shared_changed }}"
          echo ""
          echo "Layer Status:"
          echo "  Layer 0 (åŸºç¡€): ${{ needs.deploy-layer0.result }}"
          echo "  Layer 1 (æ ¸å¿ƒ): ${{ needs.deploy-layer1.result }}"
          echo "  Layer 2 (ä¸šåŠ¡): ${{ needs.deploy-layer2.result }}"
          echo "  Layer 3 (è¾¹ç¼˜): ${{ needs.deploy-layer3.result }}"
          echo "  Layer 4 (ç½‘å…³): ${{ needs.deploy-layer4.result }}"
          echo ""
          echo "Smoke Test: ${{ needs.smoke-test.result }}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
