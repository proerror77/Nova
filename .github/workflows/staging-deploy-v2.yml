name: Staging Deploy V2 [DEPRECATED]

# âš ï¸  DEPRECATED: æ­¤å·¥ä½œæµå·²è¢« staging-deploy-incremental.yml å–ä»£
# ä¿ç•™æ­¤æ–‡ä»¶ä»…ä¾›å‚è€ƒï¼Œä¸å†è‡ªåŠ¨è§¦å‘
# ä½¿ç”¨æ–°çš„å¢é‡éƒ¨ç½²å·¥ä½œæµä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½å’Œå¯é æ€§

on:
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'backend/**'
  #     - 'k8s/**'
  #     - '.github/workflows/staging-deploy-v2.yml'
  workflow_dispatch:
    inputs:
      confirm:
        description: 'âš ï¸  æ­¤å·¥ä½œæµå·²å¼ƒç”¨ï¼Œè¯·ä½¿ç”¨ staging-deploy-incremental.yml'
        type: boolean
        required: true

# Prevent concurrent staging deployments
concurrency:
  group: staging-deploy-v2-${{ github.ref }}
  cancel-in-progress: false

# Default minimal permissions
permissions:
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'ap-northeast-1' }}
  REGISTRY_ALIAS: nova
  NAMESPACE: nova-staging

jobs:
  # Build all services in parallel using reusable Rust build workflow
  build-services:
    strategy:
      matrix:
        service:
          - analytics-service
          - content-service
          - feed-service
          - graph-service
          - graphql-gateway
          - identity-service
          - media-service
          - notification-service
          - ranking-service
          - realtime-chat-service
          - search-service
          - social-service
          - trust-safety-service
      max-parallel: 6
      fail-fast: false

    uses: ./.github/workflows/_reusable-rust-build.yml
    with:
      working-directory: backend
      cache-key-suffix: ${{ matrix.service }}
      cargo-command: build --release --package ${{ matrix.service }}

  # Authenticate to AWS + ECR (single job for all services)
  auth-ecr:
    needs: build-services
    uses: ./.github/workflows/_reusable-ecr-login.yml
    with:
      aws-region: ${{ vars.AWS_REGION || 'ap-northeast-1' }}
      role-session-name: gha-staging-${{ github.run_id }}
    secrets:
      aws-account-id: ${{ secrets.AWS_ACCOUNT_ID }}

  # Build and push Docker images (still need custom logic for ECR push)
  push-images:
    needs: [build-services, auth-ecr]
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      id-token: write

    strategy:
      matrix:
        service:
          - analytics-service
          - content-service
          - feed-service
          - graph-service
          - graphql-gateway
          - identity-service
          - media-service
          - notification-service
          - ranking-service
          - realtime-chat-service
          - search-service
          - social-service
          - trust-safety-service
      max-parallel: 6
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-role
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com
          role-session-name: gha-push-${{ github.run_id }}-${{ matrix.service }}
          role-skip-session-tagging: true

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push to ECR
        uses: ./.github/actions/build-push-ecr
        with:
          service-name: ${{ matrix.service }}
          image-tag: ${{ github.sha }}
          ecr-registry: ${{ needs.auth-ecr.outputs.ecr-registry }}
          registry-alias: ${{ env.REGISTRY_ALIAS }}

  # Deploy all services using reusable K8s deployment workflow
  deploy-services:
    needs: push-images
    strategy:
      matrix:
        service:
          - analytics-service
          - content-service
          - feed-service
          - graph-service
          - graphql-gateway
          - identity-service
          - media-service
          - notification-service
          - ranking-service
          - realtime-chat-service
          - search-service
          - social-service
          - trust-safety-service
      max-parallel: 6
      fail-fast: false

    uses: ./.github/workflows/_reusable-k8s-deploy.yml
    with:
      service-name: ${{ matrix.service }}
      image-tag: ${{ github.sha }}
      namespace: nova-staging
      aws-region: ${{ vars.AWS_REGION || 'ap-northeast-1' }}
      registry-alias: nova
      rollout-timeout: '5m'
      health-check: true
    secrets:
      aws-account-id: ${{ secrets.AWS_ACCOUNT_ID }}
      kubeconfig-b64: ${{ secrets.STAGING_KUBE_CONFIG }}

  # Smoke test (simplified using kubectl commands)
  smoke-test:
    needs: deploy-services
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-role
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com
          role-session-name: gha-smoke-${{ github.run_id }}
          role-skip-session-tagging: true

      - name: Configure kubeconfig
        env:
          KUBECONFIG_B64: ${{ secrets.STAGING_KUBE_CONFIG }}
        run: |
          mkdir -p ~/.kube
          echo "$KUBECONFIG_B64" | base64 --decode > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Verify all deployments
        run: |
          echo "ğŸ§ª Smoke Test - Verifying all services in ${{ env.NAMESPACE }}"

          # Check all pods
          echo "1. All pods:"
          kubectl get pods -n ${{ env.NAMESPACE }} -o wide

          # Check deployments
          echo ""
          echo "2. Deployment status:"
          kubectl get deployments -n ${{ env.NAMESPACE }}

          # Check for non-running pods
          echo ""
          echo "3. Check for any pods not running:"
          NOT_RUNNING=$(kubectl get pods -n ${{ env.NAMESPACE }} --field-selector=status.phase!=Running --no-headers 2>/dev/null | wc -l)
          if [ "$NOT_RUNNING" -gt 0 ]; then
            echo "âš ï¸  Found $NOT_RUNNING pods not in Running state"
            kubectl get pods -n ${{ env.NAMESPACE }} --field-selector=status.phase!=Running
          else
            echo "âœ… All pods are running"
          fi

          # Sample health check
          echo ""
          echo "4. Health check sample (identity-service):"
          kubectl run tmp-curl --rm -i --tty --image=curlimages/curl:8.10.1 -n ${{ env.NAMESPACE }} --restart=Never -- sh -lc 'curl -sS http://identity-service.nova-staging.svc.cluster.local:8080/health || echo "Service not responding"'

          echo ""
          echo "âœ… Smoke test completed"

  # Summary
  summary:
    needs: [build-services, push-images, deploy-services, smoke-test]
    if: always()
    runs-on: ubuntu-22.04

    steps:
      - name: Print summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… STAGING DEPLOYMENT V2 COMPLETED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Status:"
          echo "  Build: ${{ needs.build-services.result }}"
          echo "  Push: ${{ needs.push-images.result }}"
          echo "  Deploy: ${{ needs.deploy-services.result }}"
          echo "  Smoke Test: ${{ needs.smoke-test.result }}"
          echo ""
          echo "ğŸš€ Deployment:"
          echo "  Commit: ${{ github.sha }}"
          echo "  Branch: ${{ github.ref_name }}"
          echo "  Namespace: ${{ env.NAMESPACE }}"
          echo ""
          echo "ğŸ“ Changes from V1:"
          echo "  âœ… Using reusable workflows for:"
          echo "     - Rust builds (_reusable-rust-build.yml)"
          echo "     - ECR authentication (_reusable-ecr-login.yml)"
          echo "     - K8s deployments (_reusable-k8s-deploy.yml)"
          echo "  âœ… Reduced from ~350 lines to ~200 lines"
          echo "  âœ… Improved maintainability (update 1 file instead of 13)"
          echo "  âœ… Same performance with better code organization"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
