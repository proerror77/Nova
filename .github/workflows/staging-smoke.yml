name: Staging Smoke Tests

on:
  workflow_dispatch:
    inputs:
      namespace:
        description: "Kubernetes namespace to target"
        required: false
        default: "nova"
  schedule:
    - cron: "0 7 * * *" # daily smoke run at 07:00 UTC
  workflow_run:
    workflows: ["Deploy"]
    types:
      - completed

permissions:
  contents: read
  id-token: read

jobs:
  smoke-test:
    name: Run Staging Smoke Tests
    runs-on: ubuntu-latest
    if: >
      (github.event_name != 'workflow_run') ||
      (github.event.workflow_run.conclusion == 'success')
    environment: staging
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Ensure kubeconfig secret is present
        shell: bash
        env:
          KUBECONFIG_B64: ${{ secrets.STAGING_KUBE_CONFIG }}
          KUBECONFIG_RAW: ${{ secrets.STAGING_KUBE_CONFIG_RAW }}
        run: |
          if [[ -z "$KUBECONFIG_B64" && -z "$KUBECONFIG_RAW" ]]; then
            echo "::error::Neither STAGING_KUBE_CONFIG (base64) nor STAGING_KUBE_CONFIG_RAW (raw) is configured."
            exit 1
          fi
          if [[ -n "$KUBECONFIG_RAW" ]]; then
            echo "::notice::kubeconfig source = RAW"
          else
            echo "::notice::kubeconfig source = BASE64"
          fi

      - name: Print context
        shell: bash
        env:
          KUBECONFIG_SET: ${{ secrets.STAGING_KUBE_CONFIG }}
        run: |
          echo "branch=${GITHUB_REF_NAME} sha=${GITHUB_SHA}"
          if [[ -n "$KUBECONFIG_SET" ]]; then echo "has_KUBECONFIG=yes"; else echo "has_KUBECONFIG=no"; fi

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: Configure kubeconfig (v2)
        shell: bash
        env:
          KUBECONFIG_B64: ${{ secrets.STAGING_KUBE_CONFIG }}
          KUBECONFIG_RAW: ${{ secrets.STAGING_KUBE_CONFIG_RAW }}
        run: |
          set -euo pipefail
          mkdir -p ~/.kube
          if [ -n "${KUBECONFIG_RAW:-}" ]; then
            echo "::notice::decoder=raw v2"
            printf "%s" "$KUBECONFIG_RAW" > ~/.kube/config
          else
            echo "::notice::decoder=robust v2 (openssl-fallback)"
            # Normalize and validate base64 (strip whitespace/newlines/CRs)
            CLEAN=$(printf "%s" "$KUBECONFIG_B64" | tr -d '\r\n\t ')
            if [ -z "$CLEAN" ]; then
              echo "::error::STAGING_KUBE_CONFIG is empty after normalization"; exit 1; fi

            # Try openssl first, fallback to base64 -d
            if command -v openssl >/dev/null 2>&1; then
              if ! printf "%s" "$CLEAN" | openssl base64 -d -A > ~/.kube/config 2>/dev/null; then
                echo "::warning::openssl -d failed; trying coreutils base64 -d";
                printf "%s" "$CLEAN" | base64 -d > ~/.kube/config
              fi
            else
              printf "%s" "$CLEAN" | base64 -d > ~/.kube/config
            fi
          fi

          # Basic sanity check
          if ! head -n1 ~/.kube/config | grep -q "apiVersion"; then
            echo "::error::Decoded kubeconfig does not look valid (missing apiVersion)."; exit 1; fi

          chmod 600 ~/.kube/config
          kubectl version --client=true
          kubectl config get-contexts || true

      - name: Run staging smoke script
        shell: bash
        env:
          NAMESPACE: ${{ github.event.inputs.namespace || 'nova' }}
          CURL_IMAGE: ${{ vars.STAGING_CURL_IMAGE || 'curlimages/curl:8.10.1' }}
        run: |
          bash scripts/smoke-staging.sh
