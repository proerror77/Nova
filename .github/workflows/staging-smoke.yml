name: Staging Smoke Tests

on:
  workflow_dispatch:
    inputs:
      namespace:
        description: "Kubernetes namespace to target"
        required: false
        default: "nova"
  schedule:
    - cron: "0 7 * * *" # daily smoke run at 07:00 UTC
  workflow_run:
    workflows: ["Deploy"]
    types:
      - completed

permissions:
  contents: read
  id-token: write

jobs:
  smoke-test:
    name: Run Staging Smoke Tests
    runs-on: ubuntu-latest
    if: >
      (github.event_name != 'workflow_run') ||
      (github.event.workflow_run.conclusion == 'success')
    environment: staging
    env:
      AWS_REGION: ap-northeast-1
      EKS_CLUSTER_NAME: nova-eks
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Ensure kubeconfig secret is present
        shell: bash
        env:
          KUBECONFIG_B64: ${{ secrets.STAGING_KUBE_CONFIG }}
          KUBECONFIG_RAW: ${{ secrets.STAGING_KUBE_CONFIG_RAW }}
        run: |
          if [[ -z "$KUBECONFIG_B64" && -z "$KUBECONFIG_RAW" ]]; then
            echo "::error::Neither STAGING_KUBE_CONFIG (base64) nor STAGING_KUBE_CONFIG_RAW (raw) is configured."
            exit 1
          fi
          if [[ -n "$KUBECONFIG_RAW" ]]; then
            echo "::notice::kubeconfig source = RAW"
          else
            echo "::notice::kubeconfig source = BASE64"
          fi

      - name: Print context
        shell: bash
        env:
          KUBECONFIG_SET: ${{ secrets.STAGING_KUBE_CONFIG }}
        run: |
          echo "branch=${GITHUB_REF_NAME} sha=${GITHUB_SHA}"
          if [[ -n "$KUBECONFIG_SET" ]]; then echo "has_KUBECONFIG=yes"; else echo "has_KUBECONFIG=no"; fi

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: Configure AWS credentials (OIDC)
        id: aws-creds
        continue-on-error: true
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com
          role-session-name: gha-smoke-${{ github.run_id }}
          role-skip-session-tagging: true

      - name: Configure kubeconfig (v3 with AWS fallback)
        shell: bash
        env:
          KUBECONFIG_B64: ${{ secrets.STAGING_KUBE_CONFIG }}
          KUBECONFIG_RAW: ${{ secrets.STAGING_KUBE_CONFIG_RAW }}
          AWS_REGION: ${{ env.AWS_REGION }}
          EKS_CLUSTER_NAME: ${{ env.EKS_CLUSTER_NAME }}
        run: |
          set -euo pipefail
          mkdir -p ~/.kube
          configured=""
          if [ -n "${KUBECONFIG_RAW:-}" ]; then
            echo "::notice::decoder=raw v3"
            printf "%s" "$KUBECONFIG_RAW" > ~/.kube/config
            configured="raw"
          elif [ -n "${KUBECONFIG_B64:-}" ]; then
            echo "::notice::decoder=robust v3 (openssl-fallback)"
            CLEAN=$(printf "%s" "$KUBECONFIG_B64" | tr -d '\r\n\t ')
            if [ -z "$CLEAN" ]; then echo "::warning::Empty after normalization"; fi
            if command -v openssl >/dev/null 2>&1; then
              if ! printf "%s" "$CLEAN" | openssl base64 -d -A > ~/.kube/config 2>/dev/null; then
                echo "::warning::openssl -d failed; trying coreutils base64 -d";
                printf "%s" "$CLEAN" | base64 -d > ~/.kube/config || true
              fi
            else
              printf "%s" "$CLEAN" | base64 -d > ~/.kube/config || true
            fi
            configured="base64"
          else
            echo "::notice::no secret provided; will try AWS fallback"
          fi

          # If config invalid, attempt AWS fallback using EKS
          if ! grep -q "apiVersion" ~/.kube/config 2>/dev/null; then
            if [ "${{ steps.aws-creds.outcome }}" = "success" ] && command -v aws >/dev/null 2>&1; then
              echo "::notice::attempting AWS EKS kubeconfig fallback (cluster=${EKS_CLUSTER_NAME}, region=${AWS_REGION})"
              aws eks update-kubeconfig --name "${EKS_CLUSTER_NAME}" --region "${AWS_REGION}" --alias nova-staging
            else
              echo "::error::kubeconfig invalid and AWS creds not available for fallback."; exit 1
            fi
          fi

          # Basic sanity check (loose): kubeconfig should contain 'apiVersion'
          if ! grep -q "apiVersion" ~/.kube/config; then
            echo "::warning::kubeconfig missing 'apiVersion' marker; may be malformed."
          fi

          chmod 600 ~/.kube/config
          echo "::notice::kubeconfig_size_bytes=$(wc -c < ~/.kube/config)"
          kubectl version --client=true
          kubectl config get-contexts || true

      - name: Run staging smoke script
        shell: bash
        env:
          NAMESPACE: ${{ github.event.inputs.namespace || 'nova' }}
          CURL_IMAGE: ${{ vars.STAGING_CURL_IMAGE || 'curlimages/curl:8.10.1' }}
        run: |
          bash scripts/smoke-staging.sh
