name: Deploy Matrix SSO (Zitadel + Synapse OIDC)

# éƒ¨ç½² Matrix SSO çµ„ä»¶åˆ° GKE staging ç’°å¢ƒ
# çµ„ä»¶: Zitadel IdP, Synapse OIDC é…ç½®, ç›¸é—œ Secrets

on:
  workflow_dispatch:
    inputs:
      deploy_zitadel:
        description: 'Deploy Zitadel IdP'
        type: boolean
        default: true
      deploy_synapse_oidc:
        description: 'Deploy Synapse OIDC config'
        type: boolean
        default: true
      create_secrets:
        description: 'Create/Update secrets (requires GCP Secret Manager)'
        type: boolean
        default: false
      environment:
        description: 'Target environment'
        type: choice
        options:
          - staging
        default: staging

concurrency:
  group: matrix-sso-deploy-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

env:
  GCP_REGION: ${{ vars.GCP_REGION || 'asia-northeast1' }}
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GKE_CLUSTER: ${{ vars.GKE_CLUSTER || 'nova-staging-gke' }}
  NAMESPACE: nova-backend

jobs:
  # ============================================================
  # Phase 1: Setup & Validation
  # ============================================================
  setup:
    name: Setup & Validate
    runs-on: ubuntu-latest
    outputs:
      namespace: ${{ steps.config.outputs.namespace }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set configuration
        id: config
        run: |
          if [ "${{ inputs.environment }}" == "staging" ]; then
            echo "namespace=nova-backend" >> "$GITHUB_OUTPUT"
          else
            echo "namespace=nova-backend" >> "$GITHUB_OUTPUT"
          fi

      - name: Validate manifests
        run: |
          echo "ğŸ” Validating Kustomize manifests..."

          # Check if kustomize can build the overlay
          if [ -f "backend/k8s/overlays/staging/kustomization.yaml" ]; then
            kubectl kustomize backend/k8s/overlays/staging > /dev/null
            echo "âœ… Staging overlay is valid"
          else
            echo "âŒ Staging overlay not found"
            exit 1
          fi

  # ============================================================
  # Phase 1.5: Initialize Matrix SSO Databases
  # ============================================================
  init-databases:
    name: Initialize Matrix SSO Databases
    needs: setup
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Install gke-gcloud-auth-plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin --quiet 2>/dev/null || \
          sudo apt-get install -y google-cloud-sdk-gke-gcloud-auth-plugin

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ vars.GCP_PROJECT_ID }}

      - name: Delete previous job if exists
        run: |
          kubectl delete job matrix-sso-db-init -n nova-staging --ignore-not-found=true
          echo "âœ… Previous job cleaned up"

      - name: Run database initialization job
        run: |
          echo "ğŸ—„ï¸ Initializing Matrix SSO databases..."

          # Apply the database init job
          kubectl apply -f k8s/infrastructure/overlays/staging/matrix-sso-db-init-job.yaml

          # Wait for job to complete
          echo "â³ Waiting for database initialization..."
          kubectl wait --for=condition=complete job/matrix-sso-db-init -n nova-staging --timeout=120s || {
            echo "âŒ Database initialization failed"
            kubectl logs job/matrix-sso-db-init -n nova-staging
            exit 1
          }

          echo "âœ… Matrix SSO databases initialized"
          kubectl logs job/matrix-sso-db-init -n nova-staging

  # ============================================================
  # Phase 2: Create Secrets (Optional)
  # ============================================================
  create-secrets:
    name: Create Secrets
    needs: setup
    if: inputs.create_secrets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Install gke-gcloud-auth-plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin --quiet 2>/dev/null || \
          sudo apt-get install -y google-cloud-sdk-gke-gcloud-auth-plugin

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ vars.GCP_PROJECT_ID }}

      - name: Ensure namespace exists
        env:
          NAMESPACE: ${{ needs.setup.outputs.namespace }}
        run: |
          echo "ğŸ—ï¸ Ensuring namespace exists..."
          kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -
          echo "âœ… Namespace ready"

      - name: Create Zitadel Secrets
        env:
          NAMESPACE: ${{ needs.setup.outputs.namespace }}
        run: |
          echo "ğŸ” Creating Zitadel secrets..."

          # Generate secure values if not exists
          MASTERKEY=$(openssl rand -base64 32 | head -c 32)
          DB_PASSWORD=$(openssl rand -base64 24)
          ADMIN_PASSWORD="NovaAdmin2024!"  # Default for staging

          # Check if secret exists
          if kubectl get secret zitadel-secrets -n $NAMESPACE &>/dev/null; then
            echo "âš ï¸  Secret zitadel-secrets already exists, skipping..."
          else
            kubectl create secret generic zitadel-secrets \
              --namespace=$NAMESPACE \
              --from-literal=ZITADEL_MASTERKEY="$MASTERKEY" \
              --from-literal=ZITADEL_DATABASE_POSTGRES_USER_PASSWORD="$DB_PASSWORD" \
              --from-literal=ZITADEL_DATABASE_POSTGRES_ADMIN_PASSWORD="$DB_PASSWORD" \
              --from-literal=ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORD="$ADMIN_PASSWORD"
            echo "âœ… Created zitadel-secrets"
          fi

      - name: Create Synapse OIDC Secrets
        env:
          NAMESPACE: ${{ needs.setup.outputs.namespace }}
        run: |
          echo "ğŸ” Creating Synapse OIDC secrets..."

          OIDC_SECRET=$(openssl rand -base64 32)
          REGISTRATION_SECRET=$(openssl rand -base64 32)

          if kubectl get secret synapse-oidc-secrets -n $NAMESPACE &>/dev/null; then
            echo "âš ï¸  Secret synapse-oidc-secrets already exists, skipping..."
          else
            kubectl create secret generic synapse-oidc-secrets \
              --namespace=$NAMESPACE \
              --from-literal=oidc_client_secret="$OIDC_SECRET" \
              --from-literal=registration_shared_secret="$REGISTRATION_SECRET"
            echo "âœ… Created synapse-oidc-secrets"
          fi

      - name: Create Identity Service API Key
        env:
          NAMESPACE: ${{ needs.setup.outputs.namespace }}
        run: |
          echo "ğŸ” Creating identity-service API key..."

          API_KEY=$(openssl rand -base64 32)

          if kubectl get secret identity-service-api-key -n $NAMESPACE &>/dev/null; then
            echo "âš ï¸  Secret identity-service-api-key already exists, skipping..."
          else
            kubectl create secret generic identity-service-api-key \
              --namespace=$NAMESPACE \
              --from-literal=INTERNAL_API_KEY="$API_KEY"
            echo "âœ… Created identity-service-api-key"
          fi

  # ============================================================
  # Phase 3: Deploy Zitadel
  # ============================================================
  deploy-zitadel:
    name: Deploy Zitadel
    needs: [setup, init-databases, create-secrets]
    if: always() && inputs.deploy_zitadel && needs.setup.result == 'success' && needs.init-databases.result == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Install gke-gcloud-auth-plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin --quiet 2>/dev/null || \
          sudo apt-get install -y google-cloud-sdk-gke-gcloud-auth-plugin

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ vars.GCP_PROJECT_ID }}

      - name: Deploy Zitadel base resources
        env:
          NAMESPACE: ${{ needs.setup.outputs.namespace }}
        run: |
          echo "ğŸš€ Deploying Zitadel..."

          # Ensure namespace exists
          kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -

          # Apply base Zitadel resources (ignore ServiceMonitor if CRD not installed)
          kubectl apply -f backend/k8s/base/zitadel.yaml -n $NAMESPACE 2>&1 | grep -v "ServiceMonitor" || true

          echo "âœ… Zitadel base resources applied"

      - name: Apply staging overlay
        env:
          NAMESPACE: ${{ needs.setup.outputs.namespace }}
        run: |
          echo "ğŸš€ Applying staging patches..."

          # Apply staging-specific patches
          # Apply Zitadel staging config and ingress
          kubectl apply -f backend/k8s/overlays/staging/zitadel-config-patch.yaml -n $NAMESPACE
          kubectl apply -f backend/k8s/overlays/staging/zitadel-ingress.yaml -n $NAMESPACE

          echo "âœ… Staging patches applied"

      - name: Wait for Zitadel deployment
        env:
          NAMESPACE: ${{ needs.setup.outputs.namespace }}
        run: |
          echo "â³ Waiting for Zitadel to be ready..."

          kubectl rollout status deployment/zitadel -n $NAMESPACE --timeout=300s || {
            echo "âŒ Zitadel deployment failed"
            kubectl describe deployment/zitadel -n $NAMESPACE
            kubectl logs -l app=zitadel -n $NAMESPACE --tail=100
            exit 1
          }

          echo "âœ… Zitadel is ready"
          kubectl get pods -l app=zitadel -n $NAMESPACE

  # ============================================================
  # Phase 4: Deploy Synapse OIDC Config
  # ============================================================
  deploy-synapse-oidc:
    name: Deploy Synapse OIDC Config
    needs: [setup, deploy-zitadel]
    if: always() && inputs.deploy_synapse_oidc && needs.setup.result == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Install gke-gcloud-auth-plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin --quiet 2>/dev/null || \
          sudo apt-get install -y google-cloud-sdk-gke-gcloud-auth-plugin

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ vars.GCP_PROJECT_ID }}

      - name: Deploy Matrix well-known config
        env:
          NAMESPACE: ${{ needs.setup.outputs.namespace }}
        run: |
          echo "ğŸš€ Deploying Matrix well-known config..."

          kubectl apply -f backend/k8s/overlays/staging/matrix-well-known.yaml -n $NAMESPACE

          echo "âœ… Matrix well-known config applied"

      - name: Deploy Synapse OIDC config
        env:
          NAMESPACE: ${{ needs.setup.outputs.namespace }}
        run: |
          echo "ğŸš€ Deploying Synapse OIDC configuration..."

          # Apply Synapse config patch and ingress
          kubectl apply -f backend/k8s/overlays/staging/synapse-config-patch.yaml -n $NAMESPACE
          kubectl apply -f backend/k8s/overlays/staging/synapse-ingress.yaml -n $NAMESPACE

          echo "âœ… Synapse OIDC config applied"

      - name: Restart Synapse to pick up new config
        env:
          NAMESPACE: ${{ needs.setup.outputs.namespace }}
        run: |
          echo "ğŸ”„ Restarting Synapse..."

          if kubectl get deployment matrix-synapse -n $NAMESPACE &>/dev/null; then
            kubectl rollout restart deployment/matrix-synapse -n $NAMESPACE
            kubectl rollout status deployment/matrix-synapse -n $NAMESPACE --timeout=300s || {
              echo "âš ï¸  Synapse restart timeout, checking status..."
              kubectl describe deployment/matrix-synapse -n $NAMESPACE
            }
          else
            echo "âš ï¸  matrix-synapse deployment not found, skipping restart"
          fi

  # ============================================================
  # Phase 5: Verification
  # ============================================================
  verify:
    name: Verify Deployment
    needs: [setup, deploy-zitadel, deploy-synapse-oidc]
    if: always() && needs.setup.result == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Install gke-gcloud-auth-plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin --quiet 2>/dev/null || \
          sudo apt-get install -y google-cloud-sdk-gke-gcloud-auth-plugin

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ vars.GCP_PROJECT_ID }}

      - name: Check deployment status
        env:
          NAMESPACE: ${{ needs.setup.outputs.namespace }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š Matrix SSO Deployment Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          echo ""
          echo "ğŸ” Checking Zitadel..."
          kubectl get deployment zitadel -n $NAMESPACE -o wide 2>/dev/null || echo "Not deployed"
          kubectl get pods -l app=zitadel -n $NAMESPACE 2>/dev/null || true

          echo ""
          echo "ğŸ” Checking Matrix Synapse..."
          kubectl get deployment matrix-synapse -n $NAMESPACE -o wide 2>/dev/null || echo "Not deployed"
          kubectl get pods -l app=matrix-synapse -n $NAMESPACE 2>/dev/null || true

          echo ""
          echo "ğŸ” Checking Secrets..."
          kubectl get secret zitadel-secrets -n $NAMESPACE &>/dev/null && echo "âœ… zitadel-secrets" || echo "âŒ zitadel-secrets missing"
          kubectl get secret synapse-oidc-secrets -n $NAMESPACE &>/dev/null && echo "âœ… synapse-oidc-secrets" || echo "âŒ synapse-oidc-secrets missing"
          kubectl get secret identity-service-api-key -n $NAMESPACE &>/dev/null && echo "âœ… identity-service-api-key" || echo "âŒ identity-service-api-key missing"

          echo ""
          echo "ğŸ” Checking Ingress..."
          kubectl get ingress -n $NAMESPACE 2>/dev/null | grep -E "zitadel|matrix" || echo "No SSO ingress found"

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Test OIDC Discovery (if Zitadel is exposed)
        continue-on-error: true
        run: |
          echo "ğŸ§ª Testing OIDC Discovery endpoint..."

          # This will only work if Zitadel is externally accessible
          curl -s --max-time 10 https://id.staging.nova.app/.well-known/openid-configuration | head -20 || \
            echo "âš ï¸  OIDC discovery not accessible (may need DNS/ingress setup)"

      - name: Deployment complete
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Matrix SSO Deployment Complete"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Next steps:"
          echo "1. Configure DNS for id.staging.nova.app â†’ Zitadel Ingress"
          echo "2. Configure DNS for matrix.staging.nova.app â†’ Synapse Ingress"
          echo "3. Access Zitadel console and configure OIDC Application"
          echo "4. Follow: backend/docs/ZITADEL_UI_SETUP_GUIDE.md"
          echo ""
