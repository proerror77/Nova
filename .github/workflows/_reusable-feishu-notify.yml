name: Reusable Feishu Notification

# Reusable workflow for sending notifications to Feishu (Lark)
# Supports rich card messages with status indicators

on:
  workflow_call:
    inputs:
      title:
        description: 'Notification title'
        required: true
        type: string
      status:
        description: 'Status (success, failure, warning, info)'
        required: true
        type: string
      message:
        description: 'Notification message body'
        required: true
        type: string
      workflow-name:
        description: 'Workflow name'
        required: false
        type: string
        default: ${{ github.workflow }}
      details:
        description: 'Additional details (JSON format)'
        required: false
        type: string
        default: ''
    secrets:
      feishu-webhook:
        description: 'Feishu webhook URL'
        required: true

jobs:
  notify:
    name: Send Feishu Notification
    runs-on: ubuntu-22.04
    permissions:
      contents: read

    steps:
      - name: Prepare notification content
        id: prepare
        run: |
          # Determine color and emoji based on status
          case "${{ inputs.status }}" in
            success)
              COLOR="green"
              EMOJI="âœ…"
              STATUS_TEXT="æˆåŠŸ"
              ;;
            failure)
              COLOR="red"
              EMOJI="âŒ"
              STATUS_TEXT="å¤±æ•—"
              ;;
            warning)
              COLOR="orange"
              EMOJI="âš ï¸"
              STATUS_TEXT="è­¦å‘Š"
              ;;
            info)
              COLOR="blue"
              EMOJI="â„¹ï¸"
              STATUS_TEXT="è³‡è¨Š"
              ;;
            *)
              COLOR="grey"
              EMOJI="ğŸ“¢"
              STATUS_TEXT="${{ inputs.status }}"
              ;;
          esac

          echo "color=$COLOR" >> "$GITHUB_OUTPUT"
          echo "emoji=$EMOJI" >> "$GITHUB_OUTPUT"
          echo "status_text=$STATUS_TEXT" >> "$GITHUB_OUTPUT"

      - name: Send to Feishu
        env:
          FEISHU_WEBHOOK: ${{ secrets.feishu-webhook }}
        run: |
          # Build Feishu card message
          cat > /tmp/feishu_message.json << EOF
          {
            "msg_type": "interactive",
            "card": {
              "header": {
                "title": {
                  "content": "${{ steps.prepare.outputs.emoji }} ${{ inputs.title }}",
                  "tag": "plain_text"
                },
                "template": "${{ steps.prepare.outputs.color }}"
              },
              "elements": [
                {
                  "tag": "div",
                  "fields": [
                    {
                      "is_short": true,
                      "text": {
                        "tag": "lark_md",
                        "content": "**ç‹€æ…‹**\n${{ steps.prepare.outputs.status_text }}"
                      }
                    },
                    {
                      "is_short": true,
                      "text": {
                        "tag": "lark_md",
                        "content": "**å·¥ä½œæµ**\n${{ inputs.workflow-name }}"
                      }
                    },
                    {
                      "is_short": true,
                      "text": {
                        "tag": "lark_md",
                        "content": "**åˆ†æ”¯**\n${{ github.ref_name }}"
                      }
                    },
                    {
                      "is_short": true,
                      "text": {
                        "tag": "lark_md",
                        "content": "**æäº¤**\n\`${{ github.sha }}\`"
                      }
                    }
                  ]
                },
                {
                  "tag": "hr"
                },
                {
                  "tag": "div",
                  "text": {
                    "tag": "lark_md",
                    "content": "${{ inputs.message }}"
                  }
                },
                {
                  "tag": "action",
                  "actions": [
                    {
                      "tag": "button",
                      "text": {
                        "tag": "plain_text",
                        "content": "æŸ¥çœ‹è©³æƒ…"
                      },
                      "type": "primary",
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
          }
          EOF

          # Add additional details if provided
          if [ -n "${{ inputs.details }}" ]; then
            echo "Adding additional details..."
            # Details should be pre-formatted JSON
          fi

          # Send to Feishu
          HTTP_CODE=$(curl -X POST "$FEISHU_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d @/tmp/feishu_message.json \
            -w '%{http_code}' \
            -o /tmp/feishu_response.json \
            -s)

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… é£›æ›¸é€šçŸ¥ç™¼é€æˆåŠŸ"
            cat /tmp/feishu_response.json
          else
            echo "âš ï¸ é£›æ›¸é€šçŸ¥ç™¼é€å¤±æ•— (HTTP $HTTP_CODE)"
            cat /tmp/feishu_response.json
            exit 1
          fi

      - name: Upload response
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: feishu-notification-response
          path: /tmp/feishu_response.json
          retention-days: 7
