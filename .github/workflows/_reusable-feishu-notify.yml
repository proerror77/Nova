name: Reusable Feishu Notification

# Reusable workflow for sending notifications to Feishu (Lark)
# Supports rich card messages with status indicators and interactive buttons
#
# NOTE: This workflow is NON-FATAL - notification failures won't fail the parent workflow

on:
  workflow_call:
    inputs:
      title:
        description: 'Notification title'
        required: true
        type: string
      status:
        description: 'Status (success, failure, warning, info)'
        required: true
        type: string
      message:
        description: 'Notification message body'
        required: true
        type: string
      workflow-name:
        description: 'Workflow name'
        required: false
        type: string
        default: ${{ github.workflow }}
      environment:
        description: 'Deployment environment (staging, production)'
        required: false
        type: string
        default: 'staging'
      services:
        description: 'Comma-separated list of deployed services'
        required: false
        type: string
        default: ''
      duration:
        description: 'Deployment duration (e.g., "5m 30s")'
        required: false
        type: string
        default: ''
      layer-status:
        description: 'JSON object of layer statuses (e.g., {"layer0":"success","layer1":"skipped"})'
        required: false
        type: string
        default: ''
    secrets:
      feishu-webhook:
        description: 'Feishu webhook URL'
        required: false

jobs:
  notify:
    name: Send Feishu Notification
    runs-on: ubuntu-22.04
    continue-on-error: true
    permissions:
      contents: read

    steps:
      - name: Check webhook configuration
        id: check
        run: |
          if [ -z "${{ secrets.feishu-webhook }}" ]; then
            echo "âš ï¸ FEISHU_WEBHOOK secret is not configured"
            echo "Skipping Feishu notification"
            echo "configured=false" >> "$GITHUB_OUTPUT"
          else
            echo "âœ… FEISHU_WEBHOOK is configured"
            echo "configured=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Prepare notification content
        if: steps.check.outputs.configured == 'true'
        id: prepare
        env:
          SERVICES: ${{ inputs.services }}
          LAYER_STATUS: ${{ inputs.layer-status }}
        run: |
          # Determine color and emoji based on status
          case "${{ inputs.status }}" in
            success)
              COLOR="green"
              EMOJI="âœ…"
              STATUS_TEXT="éƒ¨ç½²æˆåŠŸ"
              STATUS_TAG="ğŸŸ¢"
              ;;
            failure)
              COLOR="red"
              EMOJI="âŒ"
              STATUS_TEXT="éƒ¨ç½²å¤±æ•—"
              STATUS_TAG="ğŸ”´"
              ;;
            warning)
              COLOR="orange"
              EMOJI="âš ï¸"
              STATUS_TEXT="éœ€è¦æ³¨æ„"
              STATUS_TAG="ğŸŸ¡"
              ;;
            info)
              COLOR="blue"
              EMOJI="â„¹ï¸"
              STATUS_TEXT="è³‡è¨Šé€šçŸ¥"
              STATUS_TAG="ğŸ”µ"
              ;;
            *)
              COLOR="grey"
              EMOJI="ğŸ“¢"
              STATUS_TEXT="${{ inputs.status }}"
              STATUS_TAG="âšª"
              ;;
          esac

          echo "color=$COLOR" >> "$GITHUB_OUTPUT"
          echo "emoji=$EMOJI" >> "$GITHUB_OUTPUT"
          echo "status_text=$STATUS_TEXT" >> "$GITHUB_OUTPUT"
          echo "status_tag=$STATUS_TAG" >> "$GITHUB_OUTPUT"

          # Count services
          if [ -n "$SERVICES" ]; then
            SERVICE_COUNT=$(echo "$SERVICES" | tr ',' '\n' | grep -c . || echo "0")
          else
            SERVICE_COUNT="0"
          fi
          echo "service_count=$SERVICE_COUNT" >> "$GITHUB_OUTPUT"

          # Format services list for display
          if [ -n "$SERVICES" ]; then
            SERVICE_LIST=$(echo "$SERVICES" | tr ',' '\n' | sed 's/^/â€¢ /' | tr '\n' '|' | sed 's/|$//')
            # Replace | with actual newline for jq
            echo "service_list=$SERVICE_LIST" >> "$GITHUB_OUTPUT"
          else
            echo "service_list=ç„¡è®Šæ›´æœå‹™" >> "$GITHUB_OUTPUT"
          fi

          # Parse layer status if provided
          if [ -n "$LAYER_STATUS" ] && [ "$LAYER_STATUS" != "{}" ]; then
            echo "has_layer_status=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_layer_status=false" >> "$GITHUB_OUTPUT"
          fi

          # Determine trigger type
          case "${{ github.event_name }}" in
            push)
              TRIGGER_TYPE="ğŸ”„ ä»£ç¢¼æ¨é€"
              ;;
            pull_request)
              TRIGGER_TYPE="ğŸ“¥ PR åˆä½µ"
              ;;
            workflow_dispatch)
              TRIGGER_TYPE="ğŸ‘¤ æ‰‹å‹•è§¸ç™¼"
              ;;
            schedule)
              TRIGGER_TYPE="â° å®šæ™‚ä»»å‹™"
              ;;
            *)
              TRIGGER_TYPE="ğŸš€ ${{ github.event_name }}"
              ;;
          esac
          echo "trigger_type=$TRIGGER_TYPE" >> "$GITHUB_OUTPUT"

          # Get current timestamp in UTC+8
          TIMESTAMP=$(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M:%S')
          echo "timestamp=$TIMESTAMP" >> "$GITHUB_OUTPUT"

      - name: Send to Feishu
        if: steps.check.outputs.configured == 'true'
        env:
          FEISHU_WEBHOOK: ${{ secrets.feishu-webhook }}
          EMOJI: ${{ steps.prepare.outputs.emoji }}
          TITLE: ${{ inputs.title }}
          COLOR: ${{ steps.prepare.outputs.color }}
          STATUS_TEXT: ${{ steps.prepare.outputs.status_text }}
          STATUS_TAG: ${{ steps.prepare.outputs.status_tag }}
          WORKFLOW_NAME: ${{ inputs.workflow-name }}
          BRANCH_NAME: ${{ github.ref_name }}
          COMMIT_SHA: ${{ github.sha }}
          MESSAGE: ${{ inputs.message }}
          ENVIRONMENT: ${{ inputs.environment }}
          SERVICES: ${{ inputs.services }}
          SERVICE_COUNT: ${{ steps.prepare.outputs.service_count }}
          SERVICE_LIST: ${{ steps.prepare.outputs.service_list }}
          DURATION: ${{ inputs.duration }}
          TRIGGER_TYPE: ${{ steps.prepare.outputs.trigger_type }}
          TIMESTAMP: ${{ steps.prepare.outputs.timestamp }}
          TRIGGER_ACTOR: ${{ github.actor }}
          DETAILS_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          COMMIT_URL: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
          REPO_URL: ${{ github.server_url }}/${{ github.repository }}
          LAYER_STATUS: ${{ inputs.layer-status }}
          HAS_LAYER_STATUS: ${{ steps.prepare.outputs.has_layer_status }}
        run: |
          # Build service list with proper formatting
          SERVICE_DISPLAY=$(echo "$SERVICE_LIST" | tr '|' '\n')

          # Build layer status section if available
          LAYER_SECTION=""
          if [ "$HAS_LAYER_STATUS" = "true" ] && [ -n "$LAYER_STATUS" ]; then
            # Parse layer status JSON and format for display
            LAYER_SECTION=$(echo "$LAYER_STATUS" | jq -r '
              to_entries | map(
                if .value == "success" then "âœ… " + .key
                elif .value == "failure" then "âŒ " + .key
                elif .value == "skipped" then "â­ï¸ " + .key
                else "âšª " + .key
                end
              ) | join(" | ")
            ' 2>/dev/null || echo "")
          fi

          # Duration display
          if [ -n "$DURATION" ]; then
            DURATION_DISPLAY="â±ï¸ $DURATION"
          else
            DURATION_DISPLAY=""
          fi

          # Build the card JSON using jq
          # First build the elements array separately, then construct the final object
          jq -n \
            --arg emoji "$EMOJI" \
            --arg title "$TITLE" \
            --arg color "$COLOR" \
            --arg status_text "$STATUS_TEXT" \
            --arg status_tag "$STATUS_TAG" \
            --arg workflow_name "$WORKFLOW_NAME" \
            --arg branch_name "$BRANCH_NAME" \
            --arg commit_sha "$COMMIT_SHA" \
            --arg commit_sha_short "${COMMIT_SHA:0:7}" \
            --arg message "$MESSAGE" \
            --arg environment "$ENVIRONMENT" \
            --arg service_count "$SERVICE_COUNT" \
            --arg service_display "$SERVICE_DISPLAY" \
            --arg duration_display "$DURATION_DISPLAY" \
            --arg trigger_type "$TRIGGER_TYPE" \
            --arg trigger_actor "$TRIGGER_ACTOR" \
            --arg timestamp "$TIMESTAMP" \
            --arg details_url "$DETAILS_URL" \
            --arg commit_url "$COMMIT_URL" \
            --arg repo_url "$REPO_URL" \
            --arg layer_section "$LAYER_SECTION" \
            '
            # Build base elements
            [
              {
                "tag": "div",
                "fields": [
                  {"is_short": true, "text": {"tag": "lark_md", "content": "**ç’°å¢ƒ**\n\($environment | ascii_upcase)"}},
                  {"is_short": true, "text": {"tag": "lark_md", "content": "**ç‹€æ…‹**\n\($status_tag) \($status_text)"}},
                  {"is_short": true, "text": {"tag": "lark_md", "content": "**åˆ†æ”¯**\n`\($branch_name)`"}},
                  {"is_short": true, "text": {"tag": "lark_md", "content": "**æœå‹™æ•¸é‡**\n\($service_count) å€‹æœå‹™"}}
                ]
              },
              {"tag": "hr"},
              {
                "tag": "div",
                "fields": [
                  {"is_short": true, "text": {"tag": "lark_md", "content": "**è§¸ç™¼æ–¹å¼**\n\($trigger_type)"}},
                  {"is_short": true, "text": {"tag": "lark_md", "content": "**è§¸ç™¼è€…**\n@\($trigger_actor)"}},
                  {"is_short": true, "text": {"tag": "lark_md", "content": "**æäº¤**\n[\($commit_sha_short)](\($commit_url))"}},
                  {"is_short": true, "text": {"tag": "lark_md", "content": "**æ™‚é–“**\n\($timestamp)"}}
                ]
              }
            ]
            # Add services section if available
            + (if (($service_display | length) > 0 and ($service_display == "ç„¡è®Šæ›´æœå‹™" | not)) then
              [{"tag": "hr"}, {"tag": "div", "text": {"tag": "lark_md", "content": "**ğŸ“¦ éƒ¨ç½²çš„æœå‹™**\n\($service_display)"}}]
              else [] end)
            # Add layer status if available
            + (if ($layer_section | length) > 0 then
              [{"tag": "div", "text": {"tag": "lark_md", "content": "**ğŸ”„ éƒ¨ç½²å±¤ç´š**\n\($layer_section)"}}]
              else [] end)
            # Add duration if available
            + (if ($duration_display | length) > 0 then
              [{"tag": "note", "elements": [{"tag": "plain_text", "content": "\($duration_display)"}]}]
              else [] end)
            # Add message and action buttons
            + [
              {"tag": "hr"},
              {"tag": "div", "text": {"tag": "lark_md", "content": $message}},
              {
                "tag": "action",
                "actions": [
                  {"tag": "button", "text": {"tag": "plain_text", "content": "ğŸ“‹ æŸ¥çœ‹æ—¥èªŒ"}, "type": "primary", "url": $details_url},
                  {"tag": "button", "text": {"tag": "plain_text", "content": "ğŸ” æŸ¥çœ‹æäº¤"}, "type": "default", "url": $commit_url},
                  {"tag": "button", "text": {"tag": "plain_text", "content": "ğŸ“ æŸ¥çœ‹å€‰åº«"}, "type": "default", "url": $repo_url}
                ]
              },
              {"tag": "note", "elements": [{"tag": "plain_text", "content": "Nova CI/CD â€¢ \($workflow_name)"}]}
            ]
            | {
              "msg_type": "interactive",
              "card": {
                "config": {"wide_screen_mode": true},
                "header": {
                  "title": {"content": "\($emoji) \($title)", "tag": "plain_text"},
                  "template": $color
                },
                "elements": .
              }
            }' > /tmp/feishu_message.json

          # Debug: show generated JSON
          echo "ğŸ“ Generated message:"
          cat /tmp/feishu_message.json | jq '.' || cat /tmp/feishu_message.json

          echo ""
          echo "ğŸ“¤ Sending notification to Feishu..."

          # Send to Feishu with timeout and retry
          HTTP_CODE=$(curl -X POST "$FEISHU_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d @/tmp/feishu_message.json \
            -w '%{http_code}' \
            -o /tmp/feishu_response.json \
            --connect-timeout 10 \
            --max-time 30 \
            -s || echo "000")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… é£›æ›¸é€šçŸ¥ç™¼é€æˆåŠŸ"
            cat /tmp/feishu_response.json || true
          else
            echo "âš ï¸ é£›æ›¸é€šçŸ¥ç™¼é€å¤±æ•— (HTTP $HTTP_CODE)"
            echo "Response:"
            cat /tmp/feishu_response.json 2>/dev/null || echo "No response body"
            echo ""
            echo "Note: Notification failure does not affect deployment status"
          fi

      - name: Skip notification
        if: steps.check.outputs.configured != 'true'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "â­ï¸  FEISHU NOTIFICATION SKIPPED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Reason: FEISHU_WEBHOOK secret is not configured"
          echo ""
          echo "To enable Feishu notifications:"
          echo "1. Go to repository Settings > Secrets and variables > Actions"
          echo "2. Add a secret named FEISHU_WEBHOOK"
          echo "3. Set the value to your Feishu bot webhook URL"
          echo ""
          echo "Deployment will continue without notification."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Upload response
        if: always() && steps.check.outputs.configured == 'true'
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: feishu-notification-response-${{ github.run_id }}
          path: /tmp/feishu_response.json
          retention-days: 7
          if-no-files-found: ignore
