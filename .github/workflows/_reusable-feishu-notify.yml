name: Reusable Feishu Notification

# Reusable workflow for sending notifications to Feishu (Lark)
# Supports rich card messages with status indicators
#
# NOTE: This workflow is NON-FATAL - notification failures won't fail the parent workflow

on:
  workflow_call:
    inputs:
      title:
        description: 'Notification title'
        required: true
        type: string
      status:
        description: 'Status (success, failure, warning, info)'
        required: true
        type: string
      message:
        description: 'Notification message body'
        required: true
        type: string
      workflow-name:
        description: 'Workflow name'
        required: false
        type: string
        default: ${{ github.workflow }}
      details:
        description: 'Additional details (JSON format)'
        required: false
        type: string
        default: ''
    secrets:
      feishu-webhook:
        description: 'Feishu webhook URL'
        required: false  # Changed to optional to prevent workflow failures

jobs:
  notify:
    name: Send Feishu Notification
    runs-on: ubuntu-22.04
    # Continue even if notification fails - notifications should never block deployments
    continue-on-error: true
    permissions:
      contents: read

    steps:
      - name: Check webhook configuration
        id: check
        run: |
          if [ -z "${{ secrets.feishu-webhook }}" ]; then
            echo "âš ï¸ FEISHU_WEBHOOK secret is not configured"
            echo "Skipping Feishu notification"
            echo "configured=false" >> "$GITHUB_OUTPUT"
          else
            echo "âœ… FEISHU_WEBHOOK is configured"
            echo "configured=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Prepare notification content
        if: steps.check.outputs.configured == 'true'
        id: prepare
        run: |
          # Determine color and emoji based on status
          case "${{ inputs.status }}" in
            success)
              COLOR="green"
              EMOJI="âœ…"
              STATUS_TEXT="æˆåŠŸ"
              ;;
            failure)
              COLOR="red"
              EMOJI="âŒ"
              STATUS_TEXT="å¤±æ•—"
              ;;
            warning)
              COLOR="orange"
              EMOJI="âš ï¸"
              STATUS_TEXT="è­¦å‘Š"
              ;;
            info)
              COLOR="blue"
              EMOJI="â„¹ï¸"
              STATUS_TEXT="è³‡è¨Š"
              ;;
            *)
              COLOR="grey"
              EMOJI="ğŸ“¢"
              STATUS_TEXT="${{ inputs.status }}"
              ;;
          esac

          echo "color=$COLOR" >> "$GITHUB_OUTPUT"
          echo "emoji=$EMOJI" >> "$GITHUB_OUTPUT"
          echo "status_text=$STATUS_TEXT" >> "$GITHUB_OUTPUT"

      - name: Send to Feishu
        if: steps.check.outputs.configured == 'true'
        env:
          FEISHU_WEBHOOK: ${{ secrets.feishu-webhook }}
          EMOJI: ${{ steps.prepare.outputs.emoji }}
          TITLE: ${{ inputs.title }}
          COLOR: ${{ steps.prepare.outputs.color }}
          STATUS_TEXT: ${{ steps.prepare.outputs.status_text }}
          WORKFLOW_NAME: ${{ inputs.workflow-name }}
          BRANCH_NAME: ${{ github.ref_name }}
          COMMIT_SHA: ${{ github.sha }}
          MESSAGE: ${{ inputs.message }}
          DETAILS_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          # Build Feishu card message using jq for proper JSON escaping
          jq -n \
            --arg emoji "$EMOJI" \
            --arg title "$TITLE" \
            --arg color "$COLOR" \
            --arg status_text "$STATUS_TEXT" \
            --arg workflow_name "$WORKFLOW_NAME" \
            --arg branch_name "$BRANCH_NAME" \
            --arg commit_sha "$COMMIT_SHA" \
            --arg message "$MESSAGE" \
            --arg details_url "$DETAILS_URL" \
            '{
              "msg_type": "interactive",
              "card": {
                "header": {
                  "title": {
                    "content": "\($emoji) \($title)",
                    "tag": "plain_text"
                  },
                  "template": $color
                },
                "elements": [
                  {
                    "tag": "div",
                    "fields": [
                      {
                        "is_short": true,
                        "text": {
                          "tag": "lark_md",
                          "content": "**ç‹€æ…‹**\n\($status_text)"
                        }
                      },
                      {
                        "is_short": true,
                        "text": {
                          "tag": "lark_md",
                          "content": "**å·¥ä½œæµ**\n\($workflow_name)"
                        }
                      },
                      {
                        "is_short": true,
                        "text": {
                          "tag": "lark_md",
                          "content": "**åˆ†æ”¯**\n\($branch_name)"
                        }
                      },
                      {
                        "is_short": true,
                        "text": {
                          "tag": "lark_md",
                          "content": "**æäº¤**\n`\($commit_sha)`"
                        }
                      }
                    ]
                  },
                  {
                    "tag": "hr"
                  },
                  {
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": $message
                    }
                  },
                  {
                    "tag": "action",
                    "actions": [
                      {
                        "tag": "button",
                        "text": {
                          "tag": "plain_text",
                          "content": "æŸ¥çœ‹è©³æƒ…"
                        },
                        "type": "primary",
                        "url": $details_url
                      }
                    ]
                  }
                ]
              }
            }' > /tmp/feishu_message.json

          echo "ğŸ“¤ Sending notification to Feishu..."

          # Send to Feishu with timeout and retry
          HTTP_CODE=$(curl -X POST "$FEISHU_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d @/tmp/feishu_message.json \
            -w '%{http_code}' \
            -o /tmp/feishu_response.json \
            --connect-timeout 10 \
            --max-time 30 \
            -s || echo "000")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… é£›æ›¸é€šçŸ¥ç™¼é€æˆåŠŸ"
            cat /tmp/feishu_response.json || true
          else
            echo "âš ï¸ é£›æ›¸é€šçŸ¥ç™¼é€å¤±æ•— (HTTP $HTTP_CODE)"
            echo "Response:"
            cat /tmp/feishu_response.json 2>/dev/null || echo "No response body"
            echo ""
            echo "Note: Notification failure does not affect deployment status"
            # Don't exit with error - notification failures are non-fatal
          fi

      - name: Skip notification
        if: steps.check.outputs.configured != 'true'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "â­ï¸  FEISHU NOTIFICATION SKIPPED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Reason: FEISHU_WEBHOOK secret is not configured"
          echo ""
          echo "To enable Feishu notifications:"
          echo "1. Go to repository Settings > Secrets and variables > Actions"
          echo "2. Add a secret named FEISHU_WEBHOOK"
          echo "3. Set the value to your Feishu bot webhook URL"
          echo ""
          echo "Deployment will continue without notification."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Upload response
        if: always() && steps.check.outputs.configured == 'true'
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: feishu-notification-response-${{ github.run_id }}
          path: /tmp/feishu_response.json
          retention-days: 7
          if-no-files-found: ignore
