name: Staging Deploy (Optimized)

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'k8s/**'
      - '.github/workflows/staging-deploy-optimized.yml'
  workflow_dispatch:


# Prevent concurrent staging deployments
concurrency:
  group: staging-deploy-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false
env:
  AWS_REGION: ap-northeast-1
  REGISTRY: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com
  REGISTRY_ALIAS: nova
  KUSTOMIZE_PATH: k8s/infrastructure/overlays/staging

jobs:
  # Pre-check: éªŒè¯ AWS credentials
  verify-aws:
    name: Verify AWS Access
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      id-token: write
    outputs:
      has_aws: ${{ steps.check.outputs.has_aws }}

    steps:
      - name: Configure AWS credentials
        id: aws-creds
        continue-on-error: true
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::025434362120:role/github-actions-role
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com
          role-session-name: gha-verify-${{ github.run_id }}
          role-skip-session-tagging: true

      - name: Check AWS availability
        id: check
        run: |
          if [ "${{ steps.aws-creds.outcome }}" = "success" ]; then
            echo "has_aws=true" >> "$GITHUB_OUTPUT"
            echo "âœ… AWS credentials configured"
          else
            echo "has_aws=false" >> "$GITHUB_OUTPUT"
            echo "âš ï¸  AWS credentials not configured"
          fi

  build-and-push:
    name: Build Docker Images
    needs: verify-aws
    if: needs.verify-aws.outputs.has_aws == 'true'
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      id-token: write

    strategy:
      matrix:
        service:
          - analytics-service
          - content-service
          - feed-service
          - graph-service
          - graphql-gateway
          - identity-service
          - media-service
          - notification-service
          - ranking-service
          - realtime-chat-service
          - search-service
          - social-service
          - trust-safety-service
          - user-service
      max-parallel: 4
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::025434362120:role/github-actions-role
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com
          role-session-name: gha-build-${{ github.run_id }}-${{ matrix.service }}
          role-skip-session-tagging: true

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - uses: ./.github/actions/build-push-ecr
        with:
          service-name: ${{ matrix.service }}
          image-tag: ${{ github.sha }}
          ecr-registry: ${{ env.REGISTRY }}
          registry-alias: ${{ env.REGISTRY_ALIAS }}

      - name: Verify image
        run: |
          echo "âœ… ${{ matrix.service }}:${{ github.sha }} pushed"
          aws ecr describe-images \
            --repository-name "${{ env.REGISTRY_ALIAS }}/${{ matrix.service }}" \
            --region ${{ env.AWS_REGION }} \
            --image-ids imageTag=${{ github.sha }} \
            --query 'imageDetails[0].{Tags:join(`,`,imageTags),Size:imageSizeInBytes,PushedAt:imagePushedAt}' \
            --output table

  update-kustomization:
    name: Update Kustomization
    needs: [verify-aws, build-and-push]
    if: needs.verify-aws.outputs.has_aws == 'true'
    runs-on: ubuntu-22.04
    permissions:
      contents: write
      pull-requests: write
    outputs:
      pr-number: ${{ steps.create-pr.outputs.pull-request-number }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Update image tags
        run: |
          cd ${{ env.KUSTOMIZE_PATH }}

          echo "ğŸ“ Updating image tags to: ${{ github.sha }}"

          kustomize edit set image \
            nova/analytics-service=${{ env.REGISTRY }}/${{ env.REGISTRY_ALIAS }}/analytics-service:${{ github.sha }} \
            nova/content-service=${{ env.REGISTRY }}/${{ env.REGISTRY_ALIAS }}/content-service:${{ github.sha }} \
            nova/feed-service=${{ env.REGISTRY }}/${{ env.REGISTRY_ALIAS }}/feed-service:${{ github.sha }} \
            nova/graph-service=${{ env.REGISTRY }}/${{ env.REGISTRY_ALIAS }}/graph-service:${{ github.sha }} \
            nova/graphql-gateway=${{ env.REGISTRY }}/${{ env.REGISTRY_ALIAS }}/graphql-gateway:${{ github.sha }} \
            nova/identity-service=${{ env.REGISTRY }}/${{ env.REGISTRY_ALIAS }}/identity-service:${{ github.sha }} \
            nova/media-service=${{ env.REGISTRY }}/${{ env.REGISTRY_ALIAS }}/media-service:${{ github.sha }} \
            nova/notification-service=${{ env.REGISTRY }}/${{ env.REGISTRY_ALIAS }}/notification-service:${{ github.sha }} \
            nova/ranking-service=${{ env.REGISTRY }}/${{ env.REGISTRY_ALIAS }}/ranking-service:${{ github.sha }} \
            nova/realtime-chat-service=${{ env.REGISTRY }}/${{ env.REGISTRY_ALIAS }}/realtime-chat-service:${{ github.sha }} \
            nova/search-service=${{ env.REGISTRY }}/${{ env.REGISTRY_ALIAS }}/search-service:${{ github.sha }} \
            nova/social-service=${{ env.REGISTRY }}/${{ env.REGISTRY_ALIAS }}/social-service:${{ github.sha }} \
            nova/trust-safety-service=${{ env.REGISTRY }}/${{ env.REGISTRY_ALIAS }}/trust-safety-service:${{ github.sha }} \
            nova/user-service=${{ env.REGISTRY }}/${{ env.REGISTRY_ALIAS }}/user-service:${{ github.sha }}

      # ä¼˜åŒ–: éªŒè¯ kustomization è¯­æ³•
      - name: Validate kustomization
        run: |
          cd ${{ env.KUSTOMIZE_PATH }}
          kustomize build . > /tmp/rendered.yaml
          echo "âœ… Kustomization valid"
          echo "ğŸ“¦ Preview (first 30 lines):"
          head -30 /tmp/rendered.yaml

      - name: Commit and create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(staging): update images to ${{ github.sha }}"
          branch: staging/kustomization-${{ github.run_id }}
          title: "chore(staging): update images to ${{ github.sha }}"
          body: |
            ## Automated Kustomization Update

            **Commit:** ${{ github.sha }}
            **Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            This PR automatically updates the Kustomization image tags to match the latest Docker builds.

            ### Services Updated:
            - user-service
            - content-service
            - feed-service
            - media-service
            - messaging-service
            - search-service
            - streaming-service

            ### Deployed Images:
            All services: `${{ env.REGISTRY }}/${{ env.REGISTRY_ALIAS }}/*:${{ github.sha }}`

            ---

            âœ… Automated by GitHub Actions
          labels: |
            automated
            kustomization
            staging
          delete-branch: true
          base: main

  # ä¼˜åŒ–: è‡ªåŠ¨åˆå¹¶ PRï¼ˆå¯é€‰ï¼‰
  merge-pull-request:
    name: Merge Pull Request
    needs: [verify-aws, build-and-push, update-kustomization]
    if: needs.verify-aws.outputs.has_aws == 'true' && needs.update-kustomization.outputs.pr-number != ''
    runs-on: ubuntu-22.04
    permissions:
      pull-requests: write
      contents: write

    steps:
      - name: Merge PR
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ needs.update-kustomization.outputs.pr-number }}
          merge-method: squash
        continue-on-error: true

  # ä¼˜åŒ–: å®é™…éªŒè¯ ArgoCD sync
  verify-argocd-sync:
    name: Verify ArgoCD Sync
    needs: [verify-aws, merge-pull-request]
    if: needs.verify-aws.outputs.has_aws == 'true'
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # å¦‚æœæœ‰ kubeconfig,å¯ä»¥å®é™…æ£€æŸ¥
      - name: Check ArgoCD application status
        run: |
          echo "ğŸ“‹ ArgoCD Application Check"
          echo ""
          echo "Expected Application:"
          echo "  Name: nova-staging"
          echo "  Namespace: argocd"
          echo "  Path: k8s/infrastructure/overlays/staging"
          echo ""
          echo "To verify sync status manually:"
          echo "  kubectl get application nova-staging -n argocd"
          echo "  kubectl get pods -n nova"
          echo ""
          echo "Images deployed:"
          echo "  All services: ${{ github.sha }}"

  # ä¼˜åŒ–: å®é™… Smoke Test
  smoke-test:
    name: Staging Smoke Test
    needs: [verify-aws, merge-pull-request, verify-argocd-sync]
    if: needs.verify-aws.outputs.has_aws == 'true'
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure kubeconfig secret is present
        shell: bash
        env:
          KUBECONFIG_B64: ${{ secrets.STAGING_KUBE_CONFIG }}
        run: |
          if [[ -z "$KUBECONFIG_B64" ]]; then
            echo "::warning::No STAGING_KUBE_CONFIG provided; skipping kubectl-based checks."
          fi

      - name: Install kubectl
        if: ${{ env.KUBECONFIG_B64 != '' }}
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"
      - name: Wait for ArgoCD sync
        run: |
          echo "â±ï¸  Waiting 2 minutes for ArgoCD to sync..."
          sleep 120

      # å¦‚æœæœ‰ kubeconfig,å¯ä»¥æ£€æŸ¥ Pod çŠ¶æ€
      - name: Configure kubeconfig
        if: ${{ env.KUBECONFIG_B64 != '' }}
        shell: bash
        env:
          KUBECONFIG_B64: ${{ secrets.STAGING_KUBE_CONFIG }}
        run: |
          mkdir -p ~/.kube
          echo "$KUBECONFIG_B64" | base64 --decode > ~/.kube/config
          chmod 600 ~/.kube/config
          kubectl get ns | head -n 5 || true

      - name: Verify deployments
        shell: bash
        run: |
          echo "ğŸ§ª Smoke Test Checklist:"
          if [[ -f ~/.kube/config ]]; then
            set -e
            echo "1. Verify pods"
            kubectl get pods -n nova -o wide || true
            echo "2. Rollout status"
            kubectl rollout status deployment/auth-service -n nova --timeout=120s || true
            echo "3. Health check"
            kubectl run tmp-curl --rm -i --tty --image=curlimages/curl:8.10.1 -n nova --restart=Never -- sh -lc 'curl -sS http://auth-service.nova.svc.cluster.local:8080/health' || true
            echo "âœ… kubectl-based checks completed"
          else
            echo "âš ï¸  No kubeconfig; manual verification only"
          fi

  # ä¼˜åŒ–: å¤±è´¥é€šçŸ¥
  notify-on-failure:
    name: Notify on Failure
    needs: [verify-aws, build-and-push, update-kustomization, merge-pull-request, verify-argocd-sync, smoke-test]
    if: failure()
    runs-on: ubuntu-22.04

    steps:
      - name: Create GitHub issue on failure
        run: |
          echo "âš ï¸  Deployment failed!"
          echo "Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          # TODO: é›†æˆ Slack webhook
          # curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
          #   -H 'Content-Type: application/json' \
          #   -d '{"text":"âŒ Staging deploy failed: ${{ github.sha }}"}'

  summary:
    name: Deployment Summary
    needs: [verify-aws, build-and-push, update-kustomization, merge-pull-request, verify-argocd-sync, smoke-test]
    if: always()
    runs-on: ubuntu-22.04

    steps:
      - name: Print summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… STAGING DEPLOYMENT PIPELINE COMPLETED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Status:"
          echo "  AWS Access: ${{ needs.verify-aws.outputs.has_aws }}"
          echo "  Build: ${{ needs.build-and-push.result }}"
          echo "  Kustomization: ${{ needs.update-kustomization.result }}"
          echo "  ArgoCD Sync: ${{ needs.verify-argocd-sync.result }}"
          echo "  Smoke Test: ${{ needs.smoke-test.result }}"
          echo ""
          echo "ğŸš€ Deployment:"
          echo "  Commit: ${{ github.sha }}"
          echo "  Branch: ${{ github.ref_name }}"
          echo "  ECR: ${{ env.REGISTRY }}/${{ env.REGISTRY_ALIAS }}"
          echo ""
          echo "ğŸ“¦ Services (8 total):"
          echo "  - auth-service:${{ github.sha }}"
          echo "  - user-service:${{ github.sha }}"
          echo "  - content-service:${{ github.sha }}"
          echo "  - feed-service:${{ github.sha }}"
          echo "  - media-service:${{ github.sha }}"
          echo "  - messaging-service:${{ github.sha }}"
          echo "  - search-service:${{ github.sha }}"
          echo "  - streaming-service:${{ github.sha }}"
          echo ""
          echo "ğŸ”— Next Steps:"
          echo "  1. kubectl get application nova-staging -n argocd"
          echo "  2. kubectl get pods -n nova"
          echo "  3. kubectl logs -f deployment/auth-service -n nova"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
