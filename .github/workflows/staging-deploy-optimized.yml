name: Staging Deploy (Optimized) [DEPRECATED]

# âš ï¸  DEPRECATED: æ­¤å·¥ä½œæµå·²è¢« staging-deploy-incremental.yml å–ä»£
# ä¿ç•™æ­¤æ–‡ä»¶ä»…ä¾›å‚è€ƒï¼Œä¸å†è‡ªåŠ¨è§¦å‘
# ä½¿ç”¨æ–°çš„å¢é‡éƒ¨ç½²å·¥ä½œæµä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½å’Œå¯é æ€§

on:
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'backend/**'
  #     - 'k8s/**'
  #     - '.github/workflows/staging-deploy-optimized.yml'
  workflow_dispatch:
    inputs:
      confirm:
        description: 'âš ï¸  æ­¤å·¥ä½œæµå·²å¼ƒç”¨ï¼Œè¯·ä½¿ç”¨ staging-deploy-incremental.yml'
        type: boolean
        required: true


# Prevent concurrent staging deployments
concurrency:
  group: staging-deploy-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

# Default minimal permissions
permissions:
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'ap-northeast-1' }}
  REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ vars.AWS_REGION || 'ap-northeast-1' }}.amazonaws.com
  REGISTRY_ALIAS: nova
  KUSTOMIZE_PATH: k8s/infrastructure/overlays/staging

jobs:
  # Pre-check: éªŒè¯ AWS credentials
  verify-aws:
    name: Verify AWS Access
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      id-token: write
    outputs:
      has_aws: ${{ steps.check.outputs.has_aws }}

    steps:
      - name: Configure AWS credentials
        id: aws-creds
        continue-on-error: true
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-role
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com
          role-session-name: gha-verify-${{ github.run_id }}
          role-skip-session-tagging: true

      - name: Check AWS availability
        id: check
        run: |
          if [ "${{ steps.aws-creds.outcome }}" = "success" ]; then
            echo "has_aws=true" >> "$GITHUB_OUTPUT"
            echo "âœ… AWS credentials configured"
          else
            echo "has_aws=false" >> "$GITHUB_OUTPUT"
            echo "âš ï¸  AWS credentials not configured"
          fi

  build-and-push:
    name: Build Docker Images
    needs: verify-aws
    if: needs.verify-aws.outputs.has_aws == 'true'
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      id-token: write

    strategy:
      matrix:
        service:
          - analytics-service
          - content-service
          - feed-service
          - graph-service
          - graphql-gateway
          - identity-service
          - media-service
          - notification-service
          - ranking-service
          - realtime-chat-service
          - search-service
          - social-service
          - trust-safety-service
      max-parallel: 4
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-role
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com
          role-session-name: gha-build-${{ github.run_id }}-${{ matrix.service }}
          role-skip-session-tagging: true

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - uses: ./.github/actions/build-push-ecr
        with:
          service-name: ${{ matrix.service }}
          image-tag: ${{ github.sha }}
          ecr-registry: ${{ env.REGISTRY }}
          registry-alias: ${{ env.REGISTRY_ALIAS }}

      - name: Verify image
        run: |
          echo "âœ… ${{ matrix.service }}:${{ github.sha }} pushed"
          aws ecr describe-images \
            --repository-name "${{ env.REGISTRY_ALIAS }}/${{ matrix.service }}" \
            --region ${{ env.AWS_REGION }} \
            --image-ids imageTag=${{ github.sha }} \
            --query 'imageDetails[0].{Tags:join(`,`,imageTags),Size:imageSizeInBytes,PushedAt:imagePushedAt}' \
            --output table

  deploy-staging:
    name: Deploy to Staging
    needs: [verify-aws, build-and-push]
    if: needs.verify-aws.outputs.has_aws == 'true'
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      id-token: write

    strategy:
      matrix:
        service:
          - analytics-service
          - content-service
          - feed-service
          - graph-service
          - graphql-gateway
          - identity-service
          - media-service
          - notification-service
          - ranking-service
          - realtime-chat-service
          - search-service
          - social-service
          - trust-safety-service
      max-parallel: 6  # å¹¶è¡Œéƒ¨ç½²æå‡é€Ÿåº¦
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-role
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com
          role-session-name: gha-deploy-${{ github.run_id }}-${{ matrix.service }}
          role-skip-session-tagging: true

      - name: Configure kubeconfig
        env:
          KUBECONFIG_B64: ${{ secrets.STAGING_KUBE_CONFIG }}
        run: |
          mkdir -p ~/.kube
          echo "$KUBECONFIG_B64" | base64 --decode > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      # ç›´æ¥ä½¿ç”¨ kubectl set image éƒ¨ç½²åˆ° nova-staging namespace
      - name: Deploy to staging
        run: |
          SERVICE_NAME="${{ matrix.service }}"
          IMAGE="${{ env.REGISTRY }}/${{ env.REGISTRY_ALIAS }}/${SERVICE_NAME}:${{ github.sha }}"
          NAMESPACE="nova-staging"

          echo "ğŸš€ Deploying $SERVICE_NAME to $NAMESPACE"

          # æ£€æŸ¥ deployment æ˜¯å¦å­˜åœ¨
          if kubectl get deployment "$SERVICE_NAME" -n $NAMESPACE &>/dev/null; then
            echo "ğŸ“¦ Updating deployment image"
            kubectl set image deployment/"$SERVICE_NAME" \
              "$SERVICE_NAME=$IMAGE" \
              -n $NAMESPACE

            echo "â³ Waiting for rollout (timeout: 5 minutes)..."
            kubectl rollout status deployment/"$SERVICE_NAME" -n $NAMESPACE --timeout=5m

            echo "âœ… $SERVICE_NAME deployed successfully!"
            kubectl get pods -n $NAMESPACE -l app="$SERVICE_NAME" -o wide
          else
            echo "âš ï¸  Deployment $SERVICE_NAME not found in $NAMESPACE"
            echo "Available deployments:"
            kubectl get deployments -n $NAMESPACE
            exit 1
          fi

      - name: Health check
        run: |
          SERVICE_NAME="${{ matrix.service }}"
          NAMESPACE="nova-staging"

          echo "ğŸ¥ Health check for $SERVICE_NAME"

          # è·å– pod çŠ¶æ€
          kubectl get pods -n $NAMESPACE -l app="$SERVICE_NAME" -o wide

          # æ£€æŸ¥æ˜¯å¦æœ‰å¥åº·çš„ pod
          READY_PODS=$(kubectl get pods -n $NAMESPACE -l app="$SERVICE_NAME" -o jsonpath='{.items[*].status.conditions[?(@.type=="Ready")].status}' | grep -o "True" | wc -l)

          if [ "$READY_PODS" -gt 0 ]; then
            echo "âœ… $READY_PODS pod(s) ready"
          else
            echo "âš ï¸  No ready pods found"
            kubectl describe pods -n $NAMESPACE -l app="$SERVICE_NAME" | tail -50
            exit 1
          fi

  # ä¼˜åŒ–: å®é™… Smoke Test
  smoke-test:
    name: Staging Smoke Test
    needs: [verify-aws, deploy-staging]
    if: needs.verify-aws.outputs.has_aws == 'true'
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-role
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com
          role-session-name: gha-smoke-${{ github.run_id }}
          role-skip-session-tagging: true

      - name: Configure kubeconfig
        env:
          KUBECONFIG_B64: ${{ secrets.STAGING_KUBE_CONFIG }}
        run: |
          mkdir -p ~/.kube
          echo "$KUBECONFIG_B64" | base64 --decode > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: Verify all deployments
        run: |
          NAMESPACE="nova-staging"
          echo "ğŸ§ª Smoke Test - Verifying all services in $NAMESPACE"
          echo ""

          # æ£€æŸ¥æ‰€æœ‰ pods
          echo "1. All pods:"
          kubectl get pods -n $NAMESPACE -o wide

          echo ""
          echo "2. Deployment status:"
          kubectl get deployments -n $NAMESPACE

          echo ""
          echo "3. Check for any pods not running:"
          NOT_RUNNING=$(kubectl get pods -n $NAMESPACE --field-selector=status.phase!=Running --no-headers 2>/dev/null | wc -l)
          if [ "$NOT_RUNNING" -gt 0 ]; then
            echo "âš ï¸  Found $NOT_RUNNING pods not in Running state:"
            kubectl get pods -n $NAMESPACE --field-selector=status.phase!=Running
          else
            echo "âœ… All pods are running"
          fi

          echo ""
          echo "4. Health check sample (identity-service):"
          kubectl run tmp-curl --rm -i --tty --image=curlimages/curl:8.10.1 -n $NAMESPACE --restart=Never -- sh -lc 'curl -sS http://identity-service.nova-staging.svc.cluster.local:8080/health || echo "Service not responding"'

          echo ""
          echo "âœ… Smoke test completed"

  # å¤±è´¥é€šçŸ¥ - é£›æ›¸
  notify-on-failure:
    name: Notify on Failure
    needs: [verify-aws, build-and-push, deploy-staging, smoke-test]
    if: failure()
    uses: ./.github/workflows/_reusable-feishu-notify.yml
    with:
      title: "Staging éƒ¨ç½²å¤±æ•—"
      status: "failure"
      workflow-name: "Staging Deploy (Optimized)"
      message: |
        **ç’°å¢ƒ**: nova-staging
        **æäº¤**: ${{ github.sha }}
        **åˆ†æ”¯**: ${{ github.ref_name }}
        **è§¸ç™¼è€…**: ${{ github.actor }}

        **å¤±æ•—éšæ®µ**:
        - Build: ${{ needs.build-and-push.result }}
        - Deploy: ${{ needs.deploy-staging.result }}
        - Smoke Test: ${{ needs.smoke-test.result }}

        è«‹æª¢æŸ¥æ—¥èªŒä¸¦ä¿®å¾©å•é¡Œã€‚
    secrets:
      feishu-webhook: ${{ secrets.FEISHU_WEBHOOK }}

  # æˆåŠŸé€šçŸ¥ - é£›æ›¸
  notify-on-success:
    name: Notify on Success
    needs: [verify-aws, build-and-push, deploy-staging, smoke-test]
    if: success()
    uses: ./.github/workflows/_reusable-feishu-notify.yml
    with:
      title: "Staging éƒ¨ç½²æˆåŠŸ"
      status: "success"
      workflow-name: "Staging Deploy (Optimized)"
      message: |
        **ç’°å¢ƒ**: nova-staging
        **æäº¤**: ${{ github.sha }}
        **åˆ†æ”¯**: ${{ github.ref_name }}
        **éƒ¨ç½²æœå‹™**: 13 å€‹å¾®æœå‹™

        âœ… æ‰€æœ‰æœå‹™å·²æˆåŠŸéƒ¨ç½²ä¸¦é€šéå¥åº·æª¢æŸ¥
    secrets:
      feishu-webhook: ${{ secrets.FEISHU_WEBHOOK }}

  summary:
    name: Deployment Summary
    needs: [verify-aws, build-and-push, deploy-staging, smoke-test]
    if: always()
    runs-on: ubuntu-22.04

    steps:
      - name: Print summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… STAGING DEPLOYMENT PIPELINE COMPLETED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Status:"
          echo "  AWS Access: ${{ needs.verify-aws.outputs.has_aws }}"
          echo "  Build: ${{ needs.build-and-push.result }}"
          echo "  Deploy: ${{ needs.deploy-staging.result }}"
          echo "  Smoke Test: ${{ needs.smoke-test.result }}"
          echo ""
          echo "ğŸš€ Deployment:"
          echo "  Commit: ${{ github.sha }}"
          echo "  Branch: ${{ github.ref_name }}"
          echo "  ECR: ${{ env.REGISTRY }}/${{ env.REGISTRY_ALIAS }}"
          echo "  Namespace: nova-staging"
          echo ""
          echo "ğŸ“¦ Services deployed (13 total):"
          echo "  - analytics-service:${{ github.sha }}"
          echo "  - content-service:${{ github.sha }}"
          echo "  - feed-service:${{ github.sha }}"
          echo "  - graph-service:${{ github.sha }}"
          echo "  - graphql-gateway:${{ github.sha }}"
          echo "  - identity-service:${{ github.sha }}"
          echo "  - media-service:${{ github.sha }}"
          echo "  - notification-service:${{ github.sha }}"
          echo "  - ranking-service:${{ github.sha }}"
          echo "  - realtime-chat-service:${{ github.sha }}"
          echo "  - search-service:${{ github.sha }}"
          echo "  - social-service:${{ github.sha }}"
          echo "  - trust-safety-service:${{ github.sha }}"
          echo ""
          echo "ğŸ”— Verification:"
          echo "  kubectl get pods -n nova-staging"
          echo "  kubectl logs -f deployment/identity-service -n nova-staging"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
