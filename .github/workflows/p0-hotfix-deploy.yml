name: P0 Hotfix - User Service BorrowMutError Fix

on:
  push:
    branches:
      - feature/phase1-grpc-migration

env:
  AWS_REGION: us-east-1

jobs:
  build-and-test:
    name: Build User Service
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true
          components: rustfmt, clippy

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          protoc --version

      - name: Check formatting
        run: cargo fmt --all -- --check
        continue-on-error: false

      - name: Run clippy on user-service
        working-directory: backend/user-service
        run: cargo clippy --lib --bins -- -D warnings
        continue-on-error: false

      - name: Run tests on user-service
        working-directory: backend/user-service
        run: cargo test --lib
        continue-on-error: false

      - name: Build user-service binary
        working-directory: backend/user-service
        run: cargo build --release --bin user-service
        continue-on-error: false

      - name: Display build info
        run: |
          echo "✅ Build successful!"
          ls -lh backend/user-service/target/release/user-service || echo "Binary not found"

  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: build-and-test
    if: always()

    steps:
      - name: Report Status
        run: |
          if [ "${{ needs.build-and-test.result }}" == "success" ]; then
            echo "✅ P0 Fix Build SUCCESSFUL - Ready for Docker build and deployment"
          else
            echo "❌ P0 Fix Build FAILED - Check logs above"
            exit 1
          fi
