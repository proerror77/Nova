name: Staging Kubectl Apply

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'k8s/**'
      - '.github/workflows/staging-kubectl-apply.yml'

env:
  AWS_REGION: ap-northeast-1
  CLUSTER_NAME: nova-staging
  ROLE_TO_ASSUME: arn:aws:iam::025434362120:role/github-actions-role

concurrency:
  group: staging-kubectl-apply
  cancel-in-progress: true

jobs:
  apply:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: gha-staging-apply-${{ github.run_id }}
          audience: sts.amazonaws.com

      - name: Ensure EKS access entry for this role
        id: access
        shell: bash
        run: |
          set -euo pipefail
          PRINCIPAL="${ROLE_TO_ASSUME}"
          echo "Creating/ensuring EKS access entry for $PRINCIPAL on ${CLUSTER_NAME}"
          aws eks create-access-entry --cluster-name "$CLUSTER_NAME" --principal-arn "$PRINCIPAL" 2>/dev/null || true
          aws eks associate-access-policy \
            --cluster-name "$CLUSTER_NAME" \
            --principal-arn "$PRINCIPAL" \
            --policy-arn arn:aws:eks::aws:cluster-access-policy/AmazonEKSClusterAdminPolicy \
            --access-scope type=cluster 2>/dev/null || true
          aws eks list-associated-access-policies --cluster-name "$CLUSTER_NAME" --principal-arn "$PRINCIPAL"

      - name: Install kubectl
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl
          curl -sLo /usr/local/bin/kubectl https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl
          chmod +x /usr/local/bin/kubectl

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --region "$AWS_REGION" --name "$CLUSTER_NAME"
          kubectl cluster-info || true

      - name: Setup Helm and install operators (CRDs)
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Install External Secrets Operator
        run: |
          helm repo add external-secrets https://charts.external-secrets.io
          helm repo update
          helm upgrade --install external-secrets external-secrets/external-secrets \
            -n external-secrets-system --create-namespace --atomic --wait --timeout 5m
          # wait for ESO deployment ready
          kubectl rollout status -n external-secrets-system deploy/external-secrets --timeout=180s || true

      - name: Install ClickHouse Operator (CRDs)
        continue-on-error: true
        run: |
          helm repo add altinity https://helm.clickhouse.tech
          helm repo update
          # Install operator in its own namespace
          helm upgrade --install clickhouse-operator altinity/clickhouse-operator \
            -n clickhouse-operator --create-namespace \
            --set installCRDs=true --atomic --wait --timeout 5m
          # wait for CRDs to appear
          for i in {1..30}; do \
            kubectl get crd | grep -q clickhouseinstallations.clickhouse.altinity.com && break; \
            sleep 6; \
          done

      - name: Render overlay (staging)
        run: |
          kubectl kustomize k8s/infrastructure/overlays/staging > /tmp/staging.yaml
          head -n 30 /tmp/staging.yaml


      - name: Apply to cluster
        run: |
          set -e
          kubectl apply -f /tmp/staging.yaml || true
          kubectl get pods -n nova-staging -o wide

      - name: Summary
        if: always()
        run: |
          echo "âœ… kubectl apply completed (or attempted)." 
          echo "Check pods:" 
          echo "kubectl get pods -n nova-staging"
