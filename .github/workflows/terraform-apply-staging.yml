name: Terraform Apply - Staging

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-apply-staging.yml'

env:
  TF_VERSION: 1.5.0
  AWS_REGION: ap-northeast-1

jobs:
  plan-and-apply:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: ğŸ” Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/nova-staging-github-actions
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-TerraformApply

      - name: ğŸ” Terraform Format Check
        working-directory: ./terraform
        run: terraform fmt -check -recursive

      - name: ğŸ”§ Terraform Init
        working-directory: ./terraform
        run: terraform init -upgrade -backend-config=backend.hcl

      - name: ğŸ” Verify Backend State
        working-directory: ./terraform
        run: |
          echo "Verifying backend state is accessible..."
          terraform state list > /dev/null || {
            echo "âŒ Backend state is empty or inaccessible"
            exit 1
          }
          RESOURCE_COUNT=$(terraform state list | wc -l)
          echo "âœ… Found $RESOURCE_COUNT resources in remote state"
          if [ "$RESOURCE_COUNT" -lt 1 ]; then
            echo "âŒ State appears empty! Expected at least 1 resource."
            exit 1
          fi

      - name: ğŸ“‹ Terraform Plan
        working-directory: ./terraform
        id: plan
        run: |
          terraform plan -var-file=staging.tfvars -out=staging.tfplan 2>&1 | tee plan.log

          # Extract summary
          SUMMARY=$(tail -5 plan.log | grep -E "^(No changes|Plan:|Apply complete)" || echo "Planning completed")
          echo "plan_summary=$SUMMARY" >> $GITHUB_OUTPUT

      - name: ğŸ’¾ Save Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: terraform/staging.tfplan

      - name: ğŸš€ Terraform Apply
        working-directory: ./terraform
        id: apply
        run: |
          echo "â³ Starting terraform apply at $(date)"
          terraform apply -auto-approve staging.tfplan 2>&1 | tee apply.log
          echo "âœ… Terraform apply completed at $(date)"

          # Extract outputs
          terraform output -json > outputs.json || echo "{}" > outputs.json
          cat outputs.json

      - name: ğŸ“¤ Save Apply Output
        uses: actions/upload-artifact@v4
        with:
          name: terraform-apply-output
          path: |
            terraform/apply.log
            terraform/outputs.json

      - name: ğŸ“Š Post Results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const planLog = fs.readFileSync('./terraform/plan.log', 'utf8');
            const applyLog = fs.readFileSync('./terraform/apply.log', 'utf8').slice(-2000); // Last 2000 chars

            let status = 'âœ… SUCCESS';
            if (context.job.status === 'failure') {
              status = 'âŒ FAILED';
            }

            const summary = `
            # ${status} Terraform Apply - Staging

            **Region:** ap-northeast-1
            **Timestamp:** ${new Date().toISOString()}

            ## Plan Summary
            \`\`\`
            ${planLog.split('\n').slice(-10).join('\n')}
            \`\`\`

            ## Apply Output (last 2000 chars)
            \`\`\`
            ${applyLog}
            \`\`\`

            [View Full Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            // Only post comment if triggered from a PR or issue (not from push event)
            if (context.issue.number) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
              core.info('âœ… Posted results comment to issue/PR');
            } else {
              core.info('â„¹ï¸ Skipping comment posting (push event detected, no PR/issue context)');
              core.info('ğŸ“‹ Summary: ' + status);
            }

      - name: âœ… Summary
        if: success()
        run: |
          echo "ğŸ‰ Infrastructure deployment completed successfully!"
          echo ""
          echo "ğŸ“Š Outputs:"
          cd terraform && terraform output -json | jq '.' || echo "(No outputs yet)"
