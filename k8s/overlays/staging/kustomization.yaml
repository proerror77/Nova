apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Staging environment configuration
# Two replicas for high availability testing, moderate resources
# Uses GCR for container registry with automated tag updates

namespace: nova-staging

# Base resources
resources:
  - ../../base/
  - external-secret.yaml

# Common labels for all resources in staging environment
labels:
  - includeSelectors: true
    pairs:
      app.kubernetes.io/environment: staging
      app.kubernetes.io/managed-by: kustomize

# Staging-specific image overrides
# Use GCR staging registry for pre-production testing
images:
  # Tier 1: Foundation
  - name: nova/identity-service
    newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/identity-service
    newTag: main-bd6fbdba24e1dec6873163aa51d2297d45cc5cc3

  # Tier 3: Content Platform
  - name: nova/content-service
    newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/content-service
    newTag: main-bd6fbdba24e1dec6873163aa51d2297d45cc5cc3

  # Tier 4: Social & Graph
  - name: nova/social-service
    newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/social-service
    newTag: main-bd6fbdba24e1dec6873163aa51d2297d45cc5cc3

  - name: nova/graph-service
    newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/graph-service
    newTag: main-bd6fbdba24e1dec6873163aa51d2297d45cc5cc3

  # Tier 5: Advanced Features
  - name: nova/feed-service
    newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/feed-service
    newTag: main-bd6fbdba24e1dec6873163aa51d2297d45cc5cc3

  - name: nova/ranking-service
    newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/ranking-service
    newTag: main-bd6fbdba24e1dec6873163aa51d2297d45cc5cc3

  - name: nova/analytics-service
    newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/analytics-service
    newTag: main-bd6fbdba24e1dec6873163aa51d2297d45cc5cc3

  - name: nova/notification-service
    newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/notification-service
    newTag: main-bd6fbdba24e1dec6873163aa51d2297d45cc5cc3

  - name: nova/realtime-chat-service
    newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/realtime-chat-service
    newTag: main-bd6fbdba24e1dec6873163aa51d2297d45cc5cc3

  - name: nova/search-service
    newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/search-service
    newTag: main-bd6fbdba24e1dec6873163aa51d2297d45cc5cc3

  - name: nova/media-service
    newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/media-service
    newTag: main-bd6fbdba24e1dec6873163aa51d2297d45cc5cc3

  - name: nova/trust-safety-service
    newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/trust-safety-service
    newTag: main-bd6fbdba24e1dec6873163aa51d2297d45cc5cc3

  # Tier 6: API Gateway
  - name: nova/graphql-gateway
    newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/graphql-gateway
    newTag: main-bd6fbdba24e1dec6873163aa51d2297d45cc5cc3

# Staging-specific ConfigMap
configMapGenerator:
  - name: nova-config
    behavior: merge
    literals:
      - ENVIRONMENT=staging
      - LOG_LEVEL=info
      - DEBUG_MODE=false
      - ENABLE_TRACING=true
      - DATABASE_POOL_SIZE=10
      - CACHE_ENABLED=true
      - ENABLE_METRICS=true
      - TRACE_SAMPLE_RATE=0.5
      - API_RATE_LIMIT_ENABLED=true
      - API_RATE_LIMIT_REQUESTS_PER_MINUTE=100
      - CORS_ALLOWED_ORIGINS="https://staging.nova.io,https://api-staging.nova.io"
      - FEATURE_FLAGS_ENABLED=true

# Resource and probe adjustments for staging
patches:
  - target:
      group: apps
      version: v1
      kind: Deployment
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent
  - target:
      group: apps
      version: v1
      kind: Deployment
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: placeholder
      spec:
        template:
          spec:
            securityContext:
              runAsNonRoot: false
