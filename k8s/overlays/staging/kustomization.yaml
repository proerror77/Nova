apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Staging environment configuration
# Two replicas for high availability testing, moderate resources
# Uses GCR for container registry with automated tag updates

namespace: nova-staging

# Base resources
resources:
  - ../../base/
  - external-secret.yaml

# Env patches for staging (TLS + dependency tiers)
patchesStrategicMerge:
  - content-service/env-patch.yaml
  - feed-service/env-patch.yaml
  - media-service/env-cdn-patch.yaml
  - analytics-service/env-patch.yaml

# Common labels for all resources in staging environment
labels:
  - includeSelectors: true
    pairs:
      app.kubernetes.io/environment: staging
      app.kubernetes.io/managed-by: kustomize

# Staging-specific image overrides
# Use GCP Artifact Registry for staging environment
images:
  # Tier 1: Foundation
  - name: nova/identity-service
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/identity-service
    newTag: 11c8a077-202512031705

  # Tier 3: Content Platform
  - name: nova/content-service
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/content-service
    newTag: 178b5cc3

  # Tier 4: Social & Graph
  - name: nova/social-service
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/social-service
    newTag: 178b5cc3

  - name: nova/graph-service
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/graph-service
    newTag: 178b5cc3

  # Tier 5: Advanced Features
  - name: nova/feed-service
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/feed-service
    newTag: 178b5cc3

  - name: nova/ranking-service
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/ranking-service
    newTag: 178b5cc3

  - name: nova/analytics-service
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/analytics-service
    newTag: 178b5cc3

  - name: nova/notification-service
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/notification-service
    newTag: 178b5cc3

  - name: nova/realtime-chat-service
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/realtime-chat-service
    newTag: 30868ad

  - name: nova/search-service
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/search-service
    newTag: 178b5cc3

  - name: nova/media-service
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/media-service
    newTag: 178b5cc3

  - name: nova/trust-safety-service
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/trust-safety-service
    newTag: 178b5cc3

  # Tier 6: API Gateway
  - name: nova/graphql-gateway
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/graphql-gateway
    newTag: 178b5cc3

  # Tier 5b: Feature Store (ML Features)
  - name: nova/feature-store
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/feature-store
    newTag: 178b5cc3

  # Tier 5c: Streaming Service (RTMP Management)
  - name: nova/streaming-service
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/streaming-service
    newTag: 178b5cc3

  # Tier 6b: AI Services
  - name: asia-northeast1-docker.pkg.dev/PROJECT_ID/nova/alice-voice-service
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/alice-voice-service
    newTag: latest

# Staging-specific ConfigMap
configMapGenerator:
  - name: nova-config
    behavior: merge
    literals:
      - ENVIRONMENT=staging
      - LOG_LEVEL=info
      - DEBUG_MODE=false
      - ENABLE_TRACING=true
      - DATABASE_POOL_SIZE=10
      - CACHE_ENABLED=true
      - ENABLE_METRICS=true
      - TRACE_SAMPLE_RATE=0.5
      - API_RATE_LIMIT_ENABLED=true
      - API_RATE_LIMIT_REQUESTS_PER_MINUTE=100
      - CORS_ALLOWED_ORIGINS="https://staging.nova.io,https://api-staging.nova.io"
      - FEATURE_FLAGS_ENABLED=true

# Resource and probe adjustments for staging
patches:
  - target:
      group: apps
      version: v1
      kind: Deployment
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent
  - target:
      group: apps
      version: v1
      kind: Deployment
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: placeholder
      spec:
        template:
          spec:
            securityContext:
              runAsNonRoot: false
