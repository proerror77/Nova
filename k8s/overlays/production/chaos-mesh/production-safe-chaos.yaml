---
# Production-Safe Chaos Experiments
# These are carefully designed to have minimal impact on production traffic

# Very Mild Network Latency (20ms only)
apiVersion: chaos-mesh.org/v1alpha1
kind: NetworkChaos
metadata:
  name: prod-network-latency-mild
  namespace: default
  annotations:
    chaos.description: "Mild network latency (20ms) - safe for production"
    chaos.approved-by: "sre-team"
    chaos.approved-date: "2025-11-09"
spec:
  action: delay
  mode: one  # Only 1 pod
  selector:
    namespaces:
      - default
    labelSelectors:
      app: auth-service
      chaos.mesh/safe: "true"  # Only target pods explicitly marked as safe
  delay:
    latency: "20ms"  # Very conservative
    jitter: "5ms"
  duration: "30s"  # Short duration
  scheduler:
    cron: "@every 12h"  # Twice a day only

---
# Single Pod Kill (with canary label)
apiVersion: chaos-mesh.org/v1alpha1
kind: PodChaos
metadata:
  name: prod-pod-kill-canary
  namespace: default
  annotations:
    chaos.description: "Kill single canary pod to test auto-recovery"
    chaos.approved-by: "sre-team"
spec:
  action: pod-kill
  mode: one
  selector:
    namespaces:
      - default
    labelSelectors:
      tier: backend
      chaos.mesh/canary: "true"  # Only canary pods
  duration: "10s"
  gracePeriod: 30  # Allow graceful shutdown
  scheduler:
    cron: "0 3 * * 0"  # Sunday at 3 AM only

---
# Minimal CPU Stress (30% only)
apiVersion: chaos-mesh.org/v1alpha1
kind: StressChaos
metadata:
  name: prod-cpu-stress-minimal
  namespace: default
  annotations:
    chaos.description: "Minimal CPU stress (30%) to test rate limiting"
    chaos.approved-by: "sre-team"
spec:
  mode: one
  selector:
    namespaces:
      - default
    labelSelectors:
      app: user-service
      chaos.mesh/safe: "true"
  stressors:
    cpu:
      workers: 1
      load: 30  # Only 30% load
  duration: "1m"  # Very short
  scheduler:
    cron: "0 4 * * 1"  # Monday at 4 AM only
