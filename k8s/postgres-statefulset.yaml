---
# ConfigMap for PostgreSQL initialization
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-config
  namespace: nova
data:
  init.sql: |
    -- Create nova_staging database
    CREATE DATABASE nova_staging;

    -- Create application user
    CREATE USER nova_admin WITH PASSWORD 'nova_password_staging_2024!@#';
    ALTER ROLE nova_admin WITH LOGIN;

    -- Grant privileges
    GRANT ALL PRIVILEGES ON DATABASE nova_staging TO nova_admin;

    -- Connect to the nova_staging database to set up schema permissions and extensions
    \c nova_staging

    -- Enable required extensions
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pg_trgm";

    -- Grant schema permissions
    GRANT ALL PRIVILEGES ON SCHEMA public TO nova_admin;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO nova_admin;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO nova_admin;

    -- Grant creation rights on public schema
    GRANT CREATE ON SCHEMA public TO nova_admin;

    -- Create prerequisite tables for migrations
    -- Base users table that migrations will reference
    CREATE TABLE IF NOT EXISTS users (
      id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      username VARCHAR(255) NOT NULL UNIQUE,
      email VARCHAR(255) NOT NULL UNIQUE,
      password_hash VARCHAR(255) NOT NULL,
      display_name VARCHAR(255),
      avatar_url TEXT,
      bio TEXT,
      is_active BOOLEAN DEFAULT true,
      created_at TIMESTAMPTZ DEFAULT NOW(),
      updated_at TIMESTAMPTZ DEFAULT NOW()
    );

    CREATE INDEX IF NOT EXISTS idx_users_username ON users(username);
    CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);

---
# Secret for PostgreSQL credentials
apiVersion: v1
kind: Secret
metadata:
  name: postgres-secret
  namespace: nova
type: Opaque
stringData:
  postgres-password: "postgresadmin123!@#"
  db-user: "nova_admin"
  db-password: "nova_password_staging_2024!@#"

---
# Service for PostgreSQL
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: nova
  labels:
    app: postgres
spec:
  type: ClusterIP
  selector:
    app: postgres
  ports:
  - name: postgres
    port: 5432
    targetPort: 5432
    protocol: TCP

---
# Deployment for PostgreSQL (using emptyDir for staging)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres
  namespace: nova
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: postgres:16-alpine
        imagePullPolicy: IfNotPresent
        ports:
        - name: postgres
          containerPort: 5432
          protocol: TCP
        env:
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: postgres-password
        - name: POSTGRES_USER
          value: "postgres"
        - name: POSTGRES_INITDB_ARGS
          value: "-c max_connections=200 -c shared_buffers=256MB -c effective_cache_size=1GB -c maintenance_work_mem=64MB -c checkpoint_completion_target=0.9 -c wal_buffers=16MB -c default_statistics_target=100"
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
          subPath: postgres
        - name: init-script
          mountPath: /docker-entrypoint-initdb.d
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - pg_isready -U postgres
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - pg_isready -U postgres
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        resources:
          requests:
            cpu: 250m
            memory: 512Mi
          limits:
            cpu: 500m
            memory: 1Gi
      volumes:
      - name: postgres-storage
        emptyDir: {}
      - name: init-script
        configMap:
          name: postgres-init-config
          defaultMode: 0755
