##############################################################################
# Debezium Connector Initialization Job
# Deploys the PostgreSQL CDC connector after Kafka Connect is ready
##############################################################################

apiVersion: batch/v1
kind: Job
metadata:
  name: debezium-connector-init
  namespace: nova
  labels:
    app: kafka-connect
    component: cdc-init
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 5
  template:
    metadata:
      labels:
        app: kafka-connect
        component: cdc-init
    spec:
      restartPolicy: OnFailure
      initContainers:
      # Wait for Kafka Connect to be ready
      - name: wait-for-connect
        image: curlimages/curl:latest
        command:
        - /bin/sh
        - -c
        - |
          echo "Waiting for Kafka Connect to be ready..."
          until curl -sf http://kafka-connect:8083/connectors > /dev/null 2>&1; do
            echo "Kafka Connect not ready, waiting..."
            sleep 5
          done
          echo "Kafka Connect is ready!"

      containers:
      - name: deploy-connector
        image: curlimages/curl:latest
        command:
        - /bin/sh
        - -c
        - |
          set -e

          CONNECT_URL="http://kafka-connect:8083"
          CONNECTOR_NAME="nova-postgres-cdc"

          echo "=== Debezium Connector Deployment ==="

          # Check if connector already exists
          if curl -sf "${CONNECT_URL}/connectors/${CONNECTOR_NAME}" > /dev/null 2>&1; then
            echo "Connector ${CONNECTOR_NAME} already exists"
            echo "Current status:"
            curl -s "${CONNECT_URL}/connectors/${CONNECTOR_NAME}/status" | head -100
            exit 0
          fi

          echo "Deploying connector: ${CONNECTOR_NAME}"

          # Deploy connector
          RESPONSE=$(curl -sf -X POST "${CONNECT_URL}/connectors" \
            -H "Content-Type: application/json" \
            -d '{
              "name": "nova-postgres-cdc",
              "config": {
                "connector.class": "io.debezium.connector.postgresql.PostgresConnector",
                "tasks.max": "1",
                "database.hostname": "postgres",
                "database.port": "5432",
                "database.user": "postgres",
                "database.password": "'"${POSTGRES_PASSWORD}"'",
                "database.dbname": "nova_auth",
                "database.server.name": "nova",
                "plugin.name": "pgoutput",
                "publication.name": "nova_cdc_publication",
                "slot.name": "nova_cdc_slot",
                "table.include.list": "public.posts,public.follows,public.comments,public.likes",
                "topic.prefix": "nova",
                "topic.creation.enable": "true",
                "topic.creation.default.replication.factor": "1",
                "topic.creation.default.partitions": "3",
                "key.converter": "org.apache.kafka.connect.json.JsonConverter",
                "key.converter.schemas.enable": "false",
                "value.converter": "org.apache.kafka.connect.json.JsonConverter",
                "value.converter.schemas.enable": "false",
                "transforms": "route",
                "transforms.route.type": "org.apache.kafka.connect.transforms.RegexRouter",
                "transforms.route.regex": "nova\\.public\\.(.+)",
                "transforms.route.replacement": "cdc.$1",
                "snapshot.mode": "initial",
                "decimal.handling.mode": "string",
                "time.precision.mode": "connect",
                "heartbeat.interval.ms": "10000",
                "heartbeat.action.query": "INSERT INTO cdc_heartbeat (id, ts) VALUES (1, NOW()) ON CONFLICT (id) DO UPDATE SET ts = NOW()",
                "errors.tolerance": "all",
                "errors.log.enable": "true",
                "errors.log.include.messages": "true"
              }
            }')

          echo "Response: ${RESPONSE}"

          # Wait for connector to start
          sleep 10

          # Check status
          echo ""
          echo "Connector status:"
          curl -s "${CONNECT_URL}/connectors/${CONNECTOR_NAME}/status"

          echo ""
          echo "=== Deployment Complete ==="

        env:
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-credentials
              key: password
              optional: true
