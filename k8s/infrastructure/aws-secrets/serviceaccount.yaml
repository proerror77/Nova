# ServiceAccount with IRSA annotation for AWS Secrets Manager access
# Required for identity-service and graphql-gateway to access JWT secrets
#
# Prerequisites:
# 1. EKS cluster with OIDC provider enabled
# 2. IAM role created with trust relationship to OIDC provider (see iam-policy.yaml)
# 3. IAM policy attached to role (see iam-policy.yaml)
#
# Setup Instructions:
# 1. Create IAM role and policy in AWS (see iam-policy.yaml)
# 2. Replace <ACCOUNT_ID> and <REGION> in annotation below
# 3. Apply this manifest: kubectl apply -f serviceaccount.yaml
# 4. Update service deployments to use this ServiceAccount
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: aws-secrets-manager
  namespace: nova
  annotations:
    # IRSA annotation - replace with your actual IAM role ARN
    # Format: arn:aws:iam::<ACCOUNT_ID>:role/<ROLE_NAME>
    eks.amazonaws.com/role-arn: arn:aws:iam::<ACCOUNT_ID>:role/nova-secrets-manager-role
  labels:
    app.kubernetes.io/name: aws-secrets-manager
    app.kubernetes.io/component: service-account
    app.kubernetes.io/part-of: nova
---
# Example: Update identity-service deployment to use this ServiceAccount
# Add these lines to identity-service Deployment spec:
#
# spec:
#   template:
#     spec:
#       serviceAccountName: aws-secrets-manager  # ADD THIS LINE
#       containers:
#       - name: identity-service
#         env:
#         - name: AWS_SECRETS_JWT_NAME
#           value: "prod/nova/jwt-config"
#         - name: AWS_REGION
#           value: "us-west-2"
