---
# API Gateway Ingress Configuration
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nova-api-gateway
  labels:
    app: nova-api-gateway
  annotations:
    # 使用 Nginx 作为 Ingress Controller

    # CORS 配置
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, PATCH, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-origin: "http://localhost:3000,http://localhost:3001"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"

    # 请求体大小限制（用于文件上传）
    nginx.ingress.kubernetes.io/proxy-body-size: 100m

    # 连接超时配置
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "120"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "120"

    # WebSocket 支持
    nginx.ingress.kubernetes.io/websocket-services: "graphql-gateway"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"

    # 速率限制
    nginx.ingress.kubernetes.io/limit-rps: "100"
    # 讓 cert-manager 自動簽發 TLS
    cert-manager.io/cluster-issuer: nova-ca-issuer

spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - api.nova.local
    secretName: nova-tls-secret
  rules:
  # 贴文相关 API
  - host: api.nova.local
    http:
      paths:
      # Content Service - Posts
      - path: /api/v2/posts
        pathType: Prefix
        backend:
          service:
            name: content-service
            port:
              number: 8080

      # Media Service - Uploads
      - path: /api/v2/uploads
        pathType: Prefix
        backend:
          service:
            name: media-service
            port:
              number: 8082

      # Media Service - Videos
      - path: /api/v2/videos
        pathType: Prefix
        backend:
          service:
            name: media-service
            port:
              number: 8082

      # Media Service - Reels
      - path: /api/v2/reels
        pathType: Prefix
        backend:
          service:
            name: media-service
            port:
              number: 8082

      # Identity Service - Users/Auth (via GraphQL Gateway → gRPC identity-service)
      - path: /api/v2/users
        pathType: Prefix
        backend:
          service:
            name: graphql-gateway
            port:
              number: 8080

      - path: /api/v2/auth
        pathType: Prefix
        backend:
          service:
            name: graphql-gateway
            port:
              number: 8080

      # Social Service - Feed/Discovery/Relationships
      - path: /api/v2/feed
        pathType: Prefix
        backend:
          service:
            name: feed-service
            port:
              number: 8084

      - path: /api/v2/discover
        pathType: Prefix
        backend:
          service:
            name: feed-service
            port:
              number: 8084

      - path: /api/v2/relationships
        pathType: Prefix
        backend:
          service:
            name: social-service
            port:
              number: 8081

      - path: /api/v2/trending
        pathType: Prefix
        backend:
          service:
            name: feed-service
            port:
              number: 8084

      # Messaging Service - Messages/Calls/Notifications
      - path: /api/v2/messages
        pathType: Prefix
        backend:
          service:
            name: messaging-service
            port:
              number: 8080

      - path: /api/v2/conversations
        pathType: Prefix
        backend:
          service:
            name: messaging-service
            port:
              number: 8080

      - path: /api/v2/calls
        pathType: Prefix
        backend:
          service:
            name: messaging-service
            port:
              number: 8080

      - path: /api/v2/notifications
        pathType: Prefix
        backend:
          service:
            name: notification-service
            port:
              number: 8080

      # Search Service
      - path: /api/v2/search
        pathType: Prefix
        backend:
          service:
            name: search-service
            port:
              number: 8086

      # Analytics Service
      - path: /api/v2/analytics
        pathType: Prefix
        backend:
          service:
            name: analytics-service
            port:
              number: 8080

      - path: /api/v2/events
        pathType: Prefix
        backend:
          service:
            name: analytics-service
            port:
              number: 8080

      # Ranking Service
      - path: /api/v2/ranking
        pathType: Prefix
        backend:
          service:
            name: ranking-service
            port:
              number: 8080

      # Trust & Safety Service
      - path: /api/v2/moderation
        pathType: Prefix
        backend:
          service:
            name: trust-safety-service
            port:
              number: 8080

      # Realtime Chat Service
      - path: /api/v2/chat
        pathType: Prefix
        backend:
          service:
            name: realtime-chat-service
            port:
              number: 8080

      - path: /graphql
        pathType: Prefix
        backend:
          service:
            name: graphql-gateway
            port:
              number: 8080
      # WebSocket endpoint (GraphQL subscriptions / real-time)
      - path: /ws
        pathType: Prefix
        backend:
          service:
            name: graphql-gateway
            port:
              number: 8080

      # Health checks
      - path: /health
        pathType: Exact
        backend:
          service:
            name: graphql-gateway
            port:
              number: 8080

---
# NetworkPolicy for security
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: nova-api-network-policy
  labels:
    app: nova
spec:
  podSelector:
    matchLabels:
      app: nova
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow traffic from Ingress Controller
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
  # Allow inter-pod communication
  - from:
    - podSelector:
        matchLabels:
          app: content-service
    - podSelector:
        matchLabels:
          app: media-service
    - podSelector:
        matchLabels:
          app: messaging-service
  egress:
  # Allow outbound traffic to databases and external services
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 5432  # PostgreSQL
    - protocol: TCP
      port: 6379  # Redis
    - protocol: TCP
      port: 9092  # Kafka
    - protocol: TCP
      port: 8123  # ClickHouse
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 53   # DNS
    - protocol: UDP
      port: 53   # DNS
