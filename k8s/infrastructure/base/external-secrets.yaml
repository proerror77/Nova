---
# External Secrets Operator - SecretStore for AWS Secrets Manager
# This replaces hardcoded secrets in ConfigMaps/Secrets

apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-secrets
  namespace: external-secrets
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::025434362120:role/external-secrets-irsa

---
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: aws-secrets
spec:
  provider:
    aws:
      service: SecretsManager
      region: ap-northeast-1
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets
            namespace: external-secrets

---
# GraphQL Gateway Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: graphql-gateway-secrets
  namespace: nova-gateway
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets
    kind: ClusterSecretStore
  target:
    name: graphql-gateway-secret
    creationPolicy: Owner
    template:
      metadata:
        labels:
          app: graphql-gateway
      type: Opaque
      data:
        JWT_SECRET: "{{ .jwt_secret }}"
        JWT_REFRESH_SECRET: "{{ .jwt_refresh_secret }}"
        DATABASE_PASSWORD: "{{ .db_password }}"
  data:
  - secretKey: jwt_secret
    remoteRef:
      key: nova/graphql-gateway/jwt-secret
  - secretKey: jwt_refresh_secret
    remoteRef:
      key: nova/graphql-gateway/jwt-refresh-secret
  - secretKey: db_password
    remoteRef:
      key: nova/database/password

---
# Auth Service Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: auth-service-secrets
  namespace: nova-backend
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets
    kind: ClusterSecretStore
  target:
    name: auth-service-secret
    creationPolicy: Owner
  data:
  - secretKey: JWT_SECRET
    remoteRef:
      key: nova/auth-service/jwt-secret
  - secretKey: JWT_ISSUER_KEY
    remoteRef:
      key: nova/auth-service/issuer-key
  - secretKey: REFRESH_TOKEN_SECRET
    remoteRef:
      key: nova/auth-service/refresh-token-secret
  - secretKey: DATABASE_PASSWORD
    remoteRef:
      key: nova/database/password
  - secretKey: BCRYPT_COST
    remoteRef:
      key: nova/auth-service/bcrypt-cost

---
# User Service Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: user-service-secrets
  namespace: nova-backend
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets
    kind: ClusterSecretStore
  target:
    name: user-service-secret
    creationPolicy: Owner
  data:
  - secretKey: DATABASE_PASSWORD
    remoteRef:
      key: nova/database/password
  - secretKey: REDIS_PASSWORD
    remoteRef:
      key: nova/redis/password
  - secretKey: AUTH_SERVICE_API_KEY
    remoteRef:
      key: nova/user-service/auth-api-key

---
# Media Service Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: media-service-secrets
  namespace: nova-backend
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets
    kind: ClusterSecretStore
  target:
    name: media-service-secret
    creationPolicy: Owner
  data:
  - secretKey: DATABASE_PASSWORD
    remoteRef:
      key: nova/database/password
  - secretKey: S3_ACCESS_KEY
    remoteRef:
      key: nova/s3/access-key
  - secretKey: S3_SECRET_KEY
    remoteRef:
      key: nova/s3/secret-key
  - secretKey: S3_BUCKET
    remoteRef:
      key: nova/s3/bucket-name

---
# Messaging Service Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: messaging-service-secrets
  namespace: nova-backend
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets
    kind: ClusterSecretStore
  target:
    name: messaging-service-secret
    creationPolicy: Owner
  data:
  - secretKey: DATABASE_PASSWORD
    remoteRef:
      key: nova/database/password
  - secretKey: REDIS_PASSWORD
    remoteRef:
      key: nova/redis/password
  - secretKey: KAFKA_SASL_PASSWORD
    remoteRef:
      key: nova/kafka/sasl-password

---
# Database Root Secret (for init)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: postgres-root-secret
  namespace: nova
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets
    kind: ClusterSecretStore
  target:
    name: postgres-root-secret
    creationPolicy: Owner
  data:
  - secretKey: POSTGRES_PASSWORD
    remoteRef:
      key: nova/database/root-password
  - secretKey: POSTGRES_REPLICATION_PASSWORD
    remoteRef:
      key: nova/database/replication-password

---
# Redis Secret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: redis-secret
  namespace: nova
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets
    kind: ClusterSecretStore
  target:
    name: redis-secret
    creationPolicy: Owner
  data:
  - secretKey: redis-password
    remoteRef:
      key: nova/redis/password

---
# Monitoring/Observability Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: observability-secrets
  namespace: nova-monitoring
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets
    kind: ClusterSecretStore
  target:
    name: observability-secret
    creationPolicy: Owner
  data:
  - secretKey: SENTRY_DSN
    remoteRef:
      key: nova/sentry/dsn
  - secretKey: DATADOG_API_KEY
    remoteRef:
      key: nova/datadog/api-key
  - secretKey: DATADOG_APP_KEY
    remoteRef:
      key: nova/datadog/app-key

---
# Rotation CronJob - Trigger secret refresh
apiVersion: batch/v1
kind: CronJob
metadata:
  name: external-secrets-refresh
  namespace: external-secrets
spec:
  schedule: "0 */6 * * *"  # Every 6 hours
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: external-secrets
          containers:
          - name: refresh
            image: bitnami/kubectl:latest
            command:
            - /bin/sh
            - -c
            - |
              # Annotate all ExternalSecrets to trigger refresh
              kubectl annotate externalsecrets --all \
                -n nova-gateway \
                -n nova-backend \
                -n nova \
                refresh-trigger="$(date +%s)" \
                --overwrite
          restartPolicy: OnFailure

---
# Secret Audit - Log all secret access
apiVersion: audit.k8s.io/v1
kind: Policy
metadata:
  name: secret-audit
rules:
- level: RequestResponse
  omitStages:
  - RequestReceived
  resources:
  - group: ""
    resources: ["secrets"]
  namespaces: ["nova", "nova-gateway", "nova-backend"]
