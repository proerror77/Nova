apiVersion: batch/v1
kind: CronJob
metadata:
  name: secrets-sync
  namespace: nova-staging
spec:
  schedule: "*/30 * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  startingDeadlineSeconds: 600
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: sts-rotator
          restartPolicy: OnFailure
          containers:
          - name: sync
            image: alpine:3.20
            imagePullPolicy: IfNotPresent
            command: ["sh","-lc"]
            args:
              - |
                set -euo pipefail
                apk add --no-cache curl jq aws-cli >/dev/null
                ns=nova-staging
                API=https://kubernetes.default.svc
                TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
                CACERT=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt

                patch_secret_json() {
                  local name=$1
                  local json=$2
                  # build merge patch with base64-encoded values
                  data=$(echo "$json" | jq -r 'to_entries | map({(.key): (.value|@base64)}) | add')
                  printf '{"data":%s}' "$data"
                }

                # DB credentials
                db_json=$(aws secretsmanager get-secret-value --secret-id nova/staging/nova-db-credentials | jq -r .SecretString)
                db_patch=$(patch_secret_json nova-db-credentials "$db_json")
                curl -sS -X PATCH "$API/api/v1/namespaces/$ns/secrets/nova-db-credentials" \
                  -H "Authorization: Bearer $TOKEN" -H 'Content-Type: application/merge-patch+json' \
                  --cacert "$CACERT" -d "$db_patch" >/dev/null

                # JWT keys
                jwt_json=$(aws secretsmanager get-secret-value --secret-id nova/staging/nova-jwt-keys | jq -r .SecretString)
                jwt_patch=$(patch_secret_json nova-jwt-keys "$jwt_json")
                curl -sS -X PATCH "$API/api/v1/namespaces/$ns/secrets/nova-jwt-keys" \
                  -H "Authorization: Bearer $TOKEN" -H 'Content-Type: application/merge-patch+json' \
                  --cacert "$CACERT" -d "$jwt_patch" >/dev/null

                # ClickHouse credentials
                ch_json=$(aws secretsmanager get-secret-value --secret-id nova/staging/nova-clickhouse-credentials | jq -r .SecretString)
                ch_patch=$(patch_secret_json nova-clickhouse-credentials "$ch_json")
                curl -sS -X PATCH "$API/api/v1/namespaces/$ns/secrets/nova-clickhouse-credentials" \
                  -H "Authorization: Bearer $TOKEN" -H 'Content-Type: application/merge-patch+json' \
                  --cacert "$CACERT" -d "$ch_patch" >/dev/null

                # S3 config (bucket/region only; creds 仍由 STS rotator 管)
                s3cfg_json=$(aws secretsmanager get-secret-value --secret-id nova/staging/nova-s3-config | jq -r .SecretString)
                s3cfg_patch=$(patch_secret_json nova-s3-credentials "$s3cfg_json")
                curl -sS -X PATCH "$API/api/v1/namespaces/$ns/secrets/nova-s3-credentials" \
                  -H "Authorization: Bearer $TOKEN" -H 'Content-Type: application/merge-patch+json' \
                  --cacert "$CACERT" -d "$s3cfg_patch" >/dev/null

                # Push credentials (APNs/FCM)
                push_json=$(aws secretsmanager get-secret-value --secret-id nova/staging/nova-push-credentials | jq -r .SecretString)
                push_patch=$(patch_secret_json nova-push-credentials "$push_json")
                curl -sS -X PATCH "$API/api/v1/namespaces/$ns/secrets/nova-push-credentials" \
                  -H "Authorization: Bearer $TOKEN" -H 'Content-Type: application/merge-patch+json' \
                  --cacert "$CACERT" -d "$push_patch" >/dev/null

                # Realtime Chat Service E2EE credentials
                rtc_json=$(aws secretsmanager get-secret-value --secret-id nova/staging/realtime-chat-service-secret | jq -r .SecretString)
                rtc_patch=$(patch_secret_json realtime-chat-service-secret "$rtc_json")
                curl -sS -X PATCH "$API/api/v1/namespaces/$ns/secrets/realtime-chat-service-secret" \
                  -H "Authorization: Bearer $TOKEN" -H 'Content-Type: application/merge-patch+json' \
                  --cacert "$CACERT" -d "$rtc_patch" >/dev/null

                # 滾動重啟受影響 Deployment（若有變更）
                ts=$(date -Iseconds)
                RPATCH=$(printf '{"spec":{"template":{"metadata":{"annotations":{"kubectl.kubernetes.io/restartedAt":"%s"}}}}}' "$ts")
                for d in user-service content-service media-service streaming-service analytics-service search-service realtime-chat-service; do
                  curl -sS -X PATCH "$API/apis/apps/v1/namespaces/$ns/deployments/$d" \
                    -H "Authorization: Bearer $TOKEN" -H 'Content-Type: application/merge-patch+json' \
                    --cacert "$CACERT" -d "$RPATCH" >/dev/null || true
                done
