apiVersion: v1
kind: ConfigMap
metadata:
  name: seed-data-scripts
  namespace: nova-staging
data:
  01_seed_auth_users.sql: |
    -- Seed data for auth-service (nova_auth database)
    INSERT INTO users (id, email, password_hash, email_verified, created_at, updated_at)
    VALUES
        ('00000000-0000-0000-0000-000000000001'::uuid, 'alice@test.nova.com', '$2b$10$YourBcryptHashHere1', true, NOW(), NOW()),
        ('00000000-0000-0000-0000-000000000002'::uuid, 'bob@test.nova.com', '$2b$10$YourBcryptHashHere2', true, NOW(), NOW()),
        ('00000000-0000-0000-0000-000000000003'::uuid, 'charlie@test.nova.com', '$2b$10$YourBcryptHashHere3', true, NOW(), NOW()),
        ('00000000-0000-0000-0000-000000000004'::uuid, 'diana@test.nova.com', '$2b$10$YourBcryptHashHere4', true, NOW(), NOW()),
        ('00000000-0000-0000-0000-000000000005'::uuid, 'eve@test.nova.com', '$2b$10$YourBcryptHashHere5', true, NOW(), NOW())
    ON CONFLICT (id) DO NOTHING;

  02_seed_user_profiles.sql: |
    -- Seed data for user-service (nova_user database)
    INSERT INTO users (id, username, display_name, bio, avatar_url, is_verified, is_private, created_at, updated_at)
    VALUES
        ('00000000-0000-0000-0000-000000000001'::uuid, 'alice_test', 'Alice Smith', 'Software engineer', 'https://avatar.test.nova.com/alice.jpg', true, false, NOW(), NOW()),
        ('00000000-0000-0000-0000-000000000002'::uuid, 'bob_test', 'Bob Johnson', 'Full-stack developer', 'https://avatar.test.nova.com/bob.jpg', true, false, NOW(), NOW()),
        ('00000000-0000-0000-0000-000000000003'::uuid, 'charlie_test', 'Charlie Brown', 'DevOps engineer', 'https://avatar.test.nova.com/charlie.jpg', false, false, NOW(), NOW()),
        ('00000000-0000-0000-0000-000000000004'::uuid, 'diana_test', 'Diana Prince', 'Product designer', 'https://avatar.test.nova.com/diana.jpg', true, true, NOW(), NOW()),
        ('00000000-0000-0000-0000-000000000005'::uuid, 'eve_test', 'Eve Anderson', 'Backend architect', 'https://avatar.test.nova.com/eve.jpg', false, false, NOW(), NOW())
    ON CONFLICT (id) DO UPDATE SET username = EXCLUDED.username, updated_at = NOW();

  run_seed.sh: |
    #!/bin/bash
    set -euo pipefail

    echo "Starting seed data initialization..."
    echo "  Database Host: $DB_HOST"
    echo "  Database Port: $DB_PORT"
    echo "  Database User: $DB_USER"

    # 等待 PostgreSQL 就绪
    echo "Waiting for PostgreSQL to be ready..."
    for i in {1..30}; do
      if PGPASSWORD="$DB_PASSWORD" psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d postgres -c "SELECT 1" 2>/dev/null; then
        echo "✓ PostgreSQL is ready"
        break
      fi
      echo "  Attempt $i/30 - waiting..."
      sleep 2
    done

    apply_sql() {
      local db="$1"
      local sql="$2"

      if [[ ! -f "$sql" ]]; then
        echo "  Skipping missing seed file: $sql"
        return 0
      fi

      echo "Seeding database: $db"
      echo "  Executing: $(basename "$sql")"
      PGPASSWORD="$DB_PASSWORD" psql \
        -h "$DB_HOST" \
        -p "$DB_PORT" \
        -U "$DB_USER" \
        -d "$db" \
        -f "$sql" \
        -q || echo "  Warning: Some inserts may have been skipped (ON CONFLICT)"
    }

    # Seed per-service databases with matching SQL
    apply_sql nova_auth /seed-data/01_seed_auth_users.sql
    apply_sql nova_user /seed-data/02_seed_user_profiles.sql
    echo "✓ Seed data initialization complete"
---
apiVersion: batch/v1
kind: Job
metadata:
  name: seed-data-init
  namespace: nova-staging
  annotations:
    description: "Initialize staging database with test data for E2E testing"
spec:
  ttlSecondsAfterFinished: 3600  # Clean up after 1 hour
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: seed-data-init
    spec:
      restartPolicy: OnFailure
      containers:
      - name: seed-data
        image: postgres:16-alpine
        command: ["/bin/sh", "/seed-data/run_seed.sh"]
        env:
        # 从统一的 nova-db-credentials Secret 获取数据库凭证
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: DB_USER
              optional: false
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: DB_PASSWORD
              optional: false
        - name: DB_HOST
          value: "postgres.nova-staging.svc.cluster.local"
        - name: DB_PORT
          value: "5432"
        volumeMounts:
        - name: seed-scripts
          mountPath: /seed-data
          readOnly: true
      volumes:
      - name: seed-scripts
        configMap:
          name: seed-data-scripts
          defaultMode: 0755
