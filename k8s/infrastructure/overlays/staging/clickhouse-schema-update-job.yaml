##############################################################################
# ClickHouse Schema Update Job
# Creates Materialized Views for incremental aggregation
#
# This job should be run once to update the ClickHouse schema.
# After successful completion, the job will auto-delete after 1 hour.
##############################################################################

apiVersion: batch/v1
kind: Job
metadata:
  name: clickhouse-schema-update
  namespace: nova-staging
  labels:
    app: clickhouse
    component: schema-update
spec:
  ttlSecondsAfterFinished: 3600
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: clickhouse
        component: schema-update
    spec:
      restartPolicy: OnFailure

      initContainers:
      # Wait for ClickHouse to be ready
      - name: wait-for-clickhouse
        image: curlimages/curl:latest
        command:
        - /bin/sh
        - -c
        - |
          echo "Waiting for ClickHouse..."
          for i in $(seq 1 30); do
            if curl -sf "http://clickhouse.nova-staging.svc.cluster.local:8123/ping" > /dev/null 2>&1; then
              echo "ClickHouse is ready!"
              exit 0
            fi
            echo "  Attempt $i/30, retrying..."
            sleep 5
          done
          echo "ClickHouse is not ready"
          exit 1

      containers:
      - name: schema-update
        image: clickhouse/clickhouse-server:24.8
        env:
        - name: CLICKHOUSE_HOST
          value: "clickhouse.nova-staging.svc.cluster.local"
        - name: CLICKHOUSE_PORT
          value: "9000"
        - name: CLICKHOUSE_USER
          value: "nova"
        - name: CLICKHOUSE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: nova-clickhouse-credentials
              key: CLICKHOUSE_PASSWORD
              optional: true
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "=============================================="
          echo "  ClickHouse Schema Update"
          echo "=============================================="
          echo ""

          # Default password if secret not available
          CH_PASS="${CLICKHOUSE_PASSWORD:-nova}"

          # Drop old views first (they might conflict with new materialized views)
          echo "Dropping old views if they exist..."
          clickhouse-client --host="$CLICKHOUSE_HOST" --port="$CLICKHOUSE_PORT" \
            --user="$CLICKHOUSE_USER" --password="$CH_PASS" \
            --query="DROP VIEW IF EXISTS nova_feed.post_metrics_1h" || true
          clickhouse-client --host="$CLICKHOUSE_HOST" --port="$CLICKHOUSE_PORT" \
            --user="$CLICKHOUSE_USER" --password="$CH_PASS" \
            --query="DROP VIEW IF EXISTS nova_feed.user_author_90d" || true
          clickhouse-client --host="$CLICKHOUSE_HOST" --port="$CLICKHOUSE_PORT" \
            --user="$CLICKHOUSE_USER" --password="$CH_PASS" \
            --query="DROP VIEW IF EXISTS nova_feed.mv_post_likes_hourly" || true
          clickhouse-client --host="$CLICKHOUSE_HOST" --port="$CLICKHOUSE_PORT" \
            --user="$CLICKHOUSE_USER" --password="$CH_PASS" \
            --query="DROP VIEW IF EXISTS nova_feed.mv_post_comments_hourly" || true
          clickhouse-client --host="$CLICKHOUSE_HOST" --port="$CLICKHOUSE_PORT" \
            --user="$CLICKHOUSE_USER" --password="$CH_PASS" \
            --query="DROP VIEW IF EXISTS nova_feed.mv_user_author_likes" || true
          clickhouse-client --host="$CLICKHOUSE_HOST" --port="$CLICKHOUSE_PORT" \
            --user="$CLICKHOUSE_USER" --password="$CH_PASS" \
            --query="DROP VIEW IF EXISTS nova_feed.mv_user_author_comments" || true

          echo ""
          echo "Creating/updating database schema..."

          # Create database if not exists
          clickhouse-client --host="$CLICKHOUSE_HOST" --port="$CLICKHOUSE_PORT" \
            --user="$CLICKHOUSE_USER" --password="$CH_PASS" \
            --query="CREATE DATABASE IF NOT EXISTS nova_feed"

          echo ""
          echo "Creating CDC tables..."

          clickhouse-client --host="$CLICKHOUSE_HOST" --port="$CLICKHOUSE_PORT" \
            --user="$CLICKHOUSE_USER" --password="$CH_PASS" \
            --multiquery --query="
          CREATE TABLE IF NOT EXISTS nova_feed.posts_cdc (
            id UUID,
            user_id UUID,
            content String,
            media_key String,
            media_type String,
            created_at DateTime DEFAULT now(),
            updated_at DateTime DEFAULT now(),
            deleted_at Nullable(DateTime),
            is_deleted UInt8 DEFAULT 0,
            cdc_operation Int8,
            cdc_timestamp DateTime DEFAULT now(),
            media_url Nullable(String)
          ) ENGINE = ReplacingMergeTree(cdc_timestamp)
          PARTITION BY toYYYYMM(created_at)
          ORDER BY (user_id, id, cdc_timestamp)
          TTL created_at + INTERVAL 365 DAY;

          CREATE TABLE IF NOT EXISTS nova_feed.comments_cdc (
            id String,
            post_id String,
            user_id String,
            content String,
            parent_comment_id String,
            created_at DateTime DEFAULT now(),
            updated_at DateTime DEFAULT now(),
            soft_delete DateTime DEFAULT toDateTime(0),
            cdc_operation Int8,
            cdc_timestamp DateTime DEFAULT now()
          ) ENGINE = ReplacingMergeTree(cdc_timestamp)
          PARTITION BY toYYYYMM(created_at)
          ORDER BY (post_id, id, cdc_timestamp)
          TTL created_at + INTERVAL 365 DAY;

          CREATE TABLE IF NOT EXISTS nova_feed.likes_cdc (
            post_id String,
            user_id String,
            created_at DateTime DEFAULT now(),
            cdc_operation Int8,
            cdc_timestamp DateTime DEFAULT now(),
            like_count Int8
          ) ENGINE = SummingMergeTree(like_count)
          PARTITION BY toYYYYMM(created_at)
          ORDER BY (post_id, user_id, cdc_timestamp)
          TTL created_at + INTERVAL 365 DAY;

          CREATE TABLE IF NOT EXISTS nova_feed.follows_cdc (
            follower_id String,
            followee_id String,
            created_at DateTime DEFAULT now(),
            cdc_operation Int8,
            cdc_timestamp DateTime DEFAULT now(),
            follow_count Int8
          ) ENGINE = SummingMergeTree(follow_count)
          PARTITION BY toYYYYMM(created_at)
          ORDER BY (followee_id, follower_id, cdc_timestamp)
          TTL created_at + INTERVAL 365 DAY;

          CREATE TABLE IF NOT EXISTS nova_feed.users_cdc (
            id UUID,
            username String,
            display_name String,
            email String,
            avatar_url String,
            bio String,
            created_at DateTime DEFAULT now(),
            updated_at DateTime DEFAULT now(),
            deleted_at Nullable(DateTime),
            cdc_operation Int8,
            cdc_timestamp DateTime DEFAULT now()
          ) ENGINE = ReplacingMergeTree(cdc_timestamp)
          PARTITION BY toYYYYMM(created_at)
          ORDER BY (id, cdc_timestamp)
          TTL created_at + INTERVAL 730 DAY;

          CREATE TABLE IF NOT EXISTS nova_feed.post_likes_hourly (
            metric_hour DateTime,
            post_id String,
            likes_delta Int32,
            updated_at DateTime
          ) ENGINE = SummingMergeTree(likes_delta)
          PARTITION BY toYYYYMM(metric_hour)
          ORDER BY (metric_hour, post_id);

          CREATE TABLE IF NOT EXISTS nova_feed.post_comments_hourly (
            metric_hour DateTime,
            post_id String,
            comments_delta Int32,
            updated_at DateTime
          ) ENGINE = SummingMergeTree(comments_delta)
          PARTITION BY toYYYYMM(metric_hour)
          ORDER BY (metric_hour, post_id);

          CREATE TABLE IF NOT EXISTS nova_feed.user_author_affinity (
            user_id String,
            author_id String,
            affinity_delta Float32,
            event_time DateTime,
            updated_at DateTime
          ) ENGINE = SummingMergeTree(affinity_delta)
          PARTITION BY toYYYYMM(event_time)
          ORDER BY (user_id, author_id, event_time);
          "

          # Apply TTL to existing CDC tables (ALTER TABLE)
          # Note: Using toDate() for TTL compatibility
          echo "Adding TTL policies to existing tables..."

          clickhouse-client --host="$CLICKHOUSE_HOST" --port="$CLICKHOUSE_PORT" \
            --user="$CLICKHOUSE_USER" --password="$CH_PASS" \
            --query="ALTER TABLE nova_feed.posts_cdc MODIFY TTL toDate(created_at) + INTERVAL 1 YEAR" || echo "posts_cdc TTL update skipped"

          clickhouse-client --host="$CLICKHOUSE_HOST" --port="$CLICKHOUSE_PORT" \
            --user="$CLICKHOUSE_USER" --password="$CH_PASS" \
            --query="ALTER TABLE nova_feed.follows_cdc MODIFY TTL toDate(created_at) + INTERVAL 2 YEAR" || echo "follows_cdc TTL update skipped"

          clickhouse-client --host="$CLICKHOUSE_HOST" --port="$CLICKHOUSE_PORT" \
            --user="$CLICKHOUSE_USER" --password="$CH_PASS" \
            --query="ALTER TABLE nova_feed.comments_cdc MODIFY TTL toDate(created_at) + INTERVAL 1 YEAR" || echo "comments_cdc TTL update skipped"

          clickhouse-client --host="$CLICKHOUSE_HOST" --port="$CLICKHOUSE_PORT" \
            --user="$CLICKHOUSE_USER" --password="$CH_PASS" \
            --query="ALTER TABLE nova_feed.likes_cdc MODIFY TTL toDate(created_at) + INTERVAL 1 YEAR" || echo "likes_cdc TTL update skipped"

          echo ""
          echo "Creating materialized views..."

          # MV for likes (likes_cdc: cdc_operation DELETE=2)
          clickhouse-client --host="$CLICKHOUSE_HOST" --port="$CLICKHOUSE_PORT" \
            --user="$CLICKHOUSE_USER" --password="$CH_PASS" \
            --multiquery --query="
          CREATE MATERIALIZED VIEW IF NOT EXISTS nova_feed.mv_post_likes_hourly
          TO nova_feed.post_likes_hourly AS
          SELECT
            toStartOfHour(created_at) AS metric_hour,
            toString(post_id) AS post_id,
            if(cdc_operation = 2, -1, 1) AS likes_delta,
            now() AS updated_at
          FROM nova_feed.likes_cdc"

          echo "Created mv_post_likes_hourly"

          # MV for comments (comments_cdc: cdc_operation DELETE=3)
          clickhouse-client --host="$CLICKHOUSE_HOST" --port="$CLICKHOUSE_PORT" \
            --user="$CLICKHOUSE_USER" --password="$CH_PASS" \
            --multiquery --query="
          CREATE MATERIALIZED VIEW IF NOT EXISTS nova_feed.mv_post_comments_hourly
          TO nova_feed.post_comments_hourly AS
          SELECT
            toStartOfHour(created_at) AS metric_hour,
            toString(post_id) AS post_id,
            if(cdc_operation = 3, -1, if(cdc_operation = 1, 1, 0)) AS comments_delta,
            now() AS updated_at
          FROM nova_feed.comments_cdc"

          echo "Created mv_post_comments_hourly"

          # MV for user-author likes affinity
          clickhouse-client --host="$CLICKHOUSE_HOST" --port="$CLICKHOUSE_PORT" \
            --user="$CLICKHOUSE_USER" --password="$CH_PASS" \
            --multiquery --query="
          CREATE MATERIALIZED VIEW IF NOT EXISTS nova_feed.mv_user_author_likes
          TO nova_feed.user_author_affinity AS
          SELECT
            toString(l.user_id) AS user_id,
            toString(p.user_id) AS author_id,
            if(l.cdc_operation = 2, -1.0, 1.0) AS affinity_delta,
            toDateTime(l.created_at) AS event_time,
            now() AS updated_at
          FROM nova_feed.likes_cdc l
          INNER JOIN nova_feed.posts_cdc p ON toString(p.id) = l.post_id"

          echo "Created mv_user_author_likes"

          # MV for user-author comments affinity (weight 2x for comments)
          clickhouse-client --host="$CLICKHOUSE_HOST" --port="$CLICKHOUSE_PORT" \
            --user="$CLICKHOUSE_USER" --password="$CH_PASS" \
            --multiquery --query="
          CREATE MATERIALIZED VIEW IF NOT EXISTS nova_feed.mv_user_author_comments
          TO nova_feed.user_author_affinity AS
          SELECT
            toString(c.user_id) AS user_id,
            toString(p.user_id) AS author_id,
            if(c.cdc_operation = 3, -2.0, if(c.cdc_operation = 1, 2.0, 0.0)) AS affinity_delta,
            toDateTime(c.created_at) AS event_time,
            now() AS updated_at
          FROM nova_feed.comments_cdc c
          INNER JOIN nova_feed.posts_cdc p ON toString(p.id) = c.post_id"

          echo "Created mv_user_author_comments"

          echo ""
          echo "Creating query views..."

          # post_metrics_1h view (reads from materialized tables)
          clickhouse-client --host="$CLICKHOUSE_HOST" --port="$CLICKHOUSE_PORT" \
            --user="$CLICKHOUSE_USER" --password="$CH_PASS" \
            --multiquery --query="
          CREATE OR REPLACE VIEW nova_feed.post_metrics_1h AS
          SELECT
            coalesce(l.metric_hour, c.metric_hour) AS metric_hour,
            coalesce(l.post_id, c.post_id) AS post_id,
            greatest(0, coalesce(l.likes_count, 0)) AS likes_count,
            greatest(0, coalesce(c.comments_count, 0)) AS comments_count,
            toInt64(0) AS shares_count,
            toInt64(0) AS impressions_count
          FROM (
            SELECT metric_hour, post_id, sum(likes_delta) AS likes_count
            FROM nova_feed.post_likes_hourly
            GROUP BY metric_hour, post_id
          ) l
          FULL OUTER JOIN (
            SELECT metric_hour, post_id, sum(comments_delta) AS comments_count
            FROM nova_feed.post_comments_hourly
            GROUP BY metric_hour, post_id
          ) c ON l.metric_hour = c.metric_hour AND l.post_id = c.post_id"

          echo "Created post_metrics_1h view"

          # user_author_90d view (reads from materialized table)
          clickhouse-client --host="$CLICKHOUSE_HOST" --port="$CLICKHOUSE_PORT" \
            --user="$CLICKHOUSE_USER" --password="$CH_PASS" \
            --multiquery --query="
          CREATE OR REPLACE VIEW nova_feed.user_author_90d AS
          SELECT
            user_id,
            author_id,
            sum(affinity_delta) AS interaction_count,
            max(event_time) AS last_interaction
          FROM nova_feed.user_author_affinity
          WHERE event_time >= now() - INTERVAL 90 DAY
          GROUP BY user_id, author_id
          HAVING interaction_count > 0"

          echo "Created user_author_90d view"

          echo ""
          echo "=============================================="
          echo "  Schema Update Complete"
          echo "=============================================="
          echo ""
          echo "Tables and views in nova_feed:"
          clickhouse-client --host="$CLICKHOUSE_HOST" --port="$CLICKHOUSE_PORT" \
            --user="$CLICKHOUSE_USER" --password="$CH_PASS" \
            --query="SELECT name, engine FROM system.tables WHERE database = 'nova_feed' ORDER BY name"
          echo ""

        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 256Mi
