apiVersion: apps/v1
kind: Deployment
metadata:
  name: feed-service
spec:
  template:
    spec:
      containers:
      - name: feed-service
        env:
        - name: APP_PORT
          value: "8084"
        - name: SERVER_PORT
          value: "8084"
        - name: KAFKA_BOOTSTRAP_SERVERS
          valueFrom:
            configMapKeyRef:
              name: nova-config
              key: KAFKA_BROKERS
        # content-service 對 feed-service 非硬依賴，降級為 Tier1 避免啟動時 CrashLoop
        - name: GRPC_CONTENT_SERVICE_TIER
          value: "1"
        # identity-service 在啟動時可能尚未就緒，降級 tier 避免 CrashLoop
        - name: GRPC_IDENTITY_SERVICE_TIER
          value: "1"
        # graph-service gRPC URL (mTLS enabled)
        - name: GRPC_GRAPH_SERVICE_URL
          value: "https://graph-service.nova-staging.svc.cluster.local:9080"
        # graph-service 非必要依賴，降級 tier 避免啟動時 CrashLoop
        - name: GRPC_GRAPH_SERVICE_TIER
          value: "1"
        # Feed-service 作為 gRPC client 需要使用 content-service 的服務域名以完成 mTLS 驗證
        - name: GRPC_TLS_DOMAIN_NAME
          value: "content-service.nova-staging.svc.cluster.local"
        # Default image URL for posts marked as image but missing media_urls (staging-only)
        - name: FEED_DEFAULT_IMAGE_URL
          value: "https://picsum.photos/seed/nova-feed/800/600"
