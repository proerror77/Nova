# Feed Service 环境变量配置 - Staging
# 包含完整的 mTLS 配置与服务依赖

apiVersion: apps/v1
kind: Deployment
metadata:
  name: feed-service
spec:
  template:
    spec:
      containers:
      - name: feed-service
        env:
        # ============================================================
        # 服务端口配置
        # ============================================================
        - name: APP_PORT
          value: "8084"
        - name: SERVER_PORT
          value: "8084"
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: feed-db-url

        # ============================================================
        # Kafka 配置
        # ============================================================
        - name: KAFKA_BOOTSTRAP_SERVERS
          valueFrom:
            configMapKeyRef:
              name: nova-config
              key: KAFKA_BROKERS

        # ============================================================
        # gRPC 服务 URL 配置 (mTLS)
        # ============================================================
        - name: GRPC_IDENTITY_SERVICE_URL
          value: "https://identity-service.nova-staging.svc.cluster.local:50051"
        - name: GRPC_SOCIAL_SERVICE_URL
          value: "https://social-service.nova-staging.svc.cluster.local:50052"
        - name: GRPC_RANKING_SERVICE_URL
          value: "https://ranking-service.nova-staging.svc.cluster.local:9011"
        - name: GRPC_CONTENT_SERVICE_URL
          value: "https://content-service.nova-staging.svc.cluster.local:9080"
        - name: GRPC_GRAPH_SERVICE_URL
          value: "https://graph-service.nova-staging.svc.cluster.local:9080"
        - name: GRPC_FEED_SERVICE_URL
          value: "https://feed-service.nova-staging.svc.cluster.local:9084"
        - name: GRPC_SEARCH_SERVICE_URL
          value: "http://search-service.nova-staging.svc.cluster.local:9086"
        - name: GRPC_MEDIA_SERVICE_URL
          value: "https://media-service.nova-staging.svc.cluster.local:9082"
        - name: GRPC_TRUST_SAFETY_SERVICE_URL
          value: "http://trust-safety-service.nova-staging.svc.cluster.local:50056"
        - name: GRPC_FEATURE_STORE_URL
          value: "http://feature-store.nova-staging.svc.cluster.local:9089"
        - name: REDIS_URL
          value: "redis://redis-cluster.nova-staging.svc.cluster.local:6379"

        # ============================================================
        # gRPC 服务 Tier 配置 (非硬依赖，避免启动 CrashLoop)
        # ============================================================
        - name: GRPC_CONTENT_SERVICE_TIER
          value: "1"
        - name: GRPC_IDENTITY_SERVICE_TIER
          value: "1"
        - name: GRPC_GRAPH_SERVICE_TIER
          value: "1"
        - name: GRPC_FEED_SERVICE_TIER
          value: "2"
        - name: GRPC_SEARCH_SERVICE_TIER
          value: "1"
        - name: GRPC_MEDIA_SERVICE_TIER
          value: "1"
        - name: GRPC_FEATURE_STORE_TIER
          value: "2"
        - name: GRPC_TRUST_SAFETY_SERVICE_TIER
          value: "1"
        - name: GRPC_RANKING_SERVICE_TIER
          value: "1"
        - name: GRPC_SOCIAL_SERVICE_TIER
          value: "1"

        # ============================================================
        # mTLS 配置
        # ============================================================
        - name: GRPC_TLS_DOMAIN_NAME
          value: "content-service.nova-staging.svc.cluster.local"
        - name: GRPC_TLS_ENABLED
          value: "true"
        - name: GRPC_TLS_CA_CERT_PATH
          value: "/etc/nova/certs/ca.crt"
        - name: GRPC_TLS_CLIENT_CERT_PATH
          value: "/etc/nova/certs/client.crt"
        - name: GRPC_TLS_CLIENT_KEY_PATH
          value: "/etc/nova/certs/client.key"
        - name: GRPC_SERVER_CERT_PATH
          value: "/etc/nova/certs/server.crt"
        - name: GRPC_SERVER_KEY_PATH
          value: "/etc/nova/certs/server.key"
        - name: GRPC_CLIENT_CA_CERT_PATH
          value: "/etc/nova/certs/ca.crt"
        - name: GRPC_REQUIRE_CLIENT_CERT
          value: "true"

        # ============================================================
        # Staging 专用配置
        # ============================================================
        - name: FEED_DEFAULT_IMAGE_URL
          value: "https://picsum.photos/seed/nova-feed/800/600"

        volumeMounts:
        - name: grpc-mtls-shared
          mountPath: /etc/nova/certs
          readOnly: true

      volumes:
      - name: grpc-mtls-shared
        secret:
          secretName: grpc-mtls-shared
