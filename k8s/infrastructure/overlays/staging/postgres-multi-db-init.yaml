# PostgreSQL Â§öÊï∞ÊçÆÂ∫ìÂàùÂßãÂåñ
# ‰∏∫ 14 ‰∏™ÂæÆÊúçÂä°ÂàõÂª∫ÂêÑËá™ÁöÑÊï∞ÊçÆÂ∫ìÂíåÁî®Êà∑
# ‰ΩøÁî®ÊúÄÂ∞èÊùÉÈôêÂéüÂàôÔºåÊØè‰∏™ÊúçÂä°ÊúâÁã¨Á´ãÁöÑÂá≠ËØÅ

apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-multi-db-init
  namespace: nova-staging
  labels:
    app: postgres
    component: init-script
data:
  # Á¨¨‰∏ÄÊ≠•ÔºöÂàõÂª∫ÊâÄÊúâÊï∞ÊçÆÂ∫ì
  01-create-databases.sql: |
    -- ÂàõÂª∫ÊâÄÊúâÂæÆÊúçÂä°Êï∞ÊçÆÂ∫ì
    SELECT 'CREATE DATABASE nova_auth' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_auth')\gexec
    SELECT 'CREATE DATABASE nova_user' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_user')\gexec
    SELECT 'CREATE DATABASE nova_content' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_content')\gexec
    SELECT 'CREATE DATABASE nova_feed' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_feed')\gexec
    SELECT 'CREATE DATABASE nova_messaging' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_messaging')\gexec
    SELECT 'CREATE DATABASE nova_search' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_search')\gexec
    SELECT 'CREATE DATABASE nova_notification' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_notification')\gexec
    SELECT 'CREATE DATABASE nova_media' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_media')\gexec
    SELECT 'CREATE DATABASE nova_analytics' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_analytics')\gexec
    SELECT 'CREATE DATABASE nova_graph' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_graph')\gexec
    SELECT 'CREATE DATABASE nova_ranking' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_ranking')\gexec
    SELECT 'CREATE DATABASE nova_feature_store' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_feature_store')\gexec
    SELECT 'CREATE DATABASE nova_identity' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_identity')\gexec
    SELECT 'CREATE DATABASE nova_trust_safety' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_trust_safety')\gexec
    SELECT 'CREATE DATABASE nova_realtime_chat' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_realtime_chat')\gexec

    -- Future: dedicated social-service database (nova_social)
    SELECT 'CREATE DATABASE nova_social' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_social')\gexec

    -- Zitadel IdP database (Matrix SSO)
    SELECT 'CREATE DATABASE zitadel' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'zitadel')\gexec

    -- Synapse Matrix homeserver database
    SELECT 'CREATE DATABASE synapse' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'synapse')\gexec

  # Á¨¨‰∫åÊ≠•ÔºöÂàõÂª∫ÊúçÂä°Áî®Êà∑ÂíåÊùÉÈôê
  02-create-service-users.sql: |
    -- ‰∏∫ÊØè‰∏™ÂæÆÊúçÂä°ÂàõÂª∫Áã¨Á´ãÁî®Êà∑Ôºà‰ΩøÁî®ÊúÄÂ∞èÊùÉÈôêÂéüÂàôÔºâ
    DO $$
    BEGIN
      -- auth-service Áî®Êà∑
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_auth_svc') THEN
        CREATE USER nova_auth_svc WITH ENCRYPTED PASSWORD 'nova_auth_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_auth TO nova_auth_svc;
      END IF;

      -- user-service Áî®Êà∑
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_user_svc') THEN
        CREATE USER nova_user_svc WITH ENCRYPTED PASSWORD 'nova_user_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_user TO nova_user_svc;
      END IF;

      -- content-service Áî®Êà∑
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_content_svc') THEN
        CREATE USER nova_content_svc WITH ENCRYPTED PASSWORD 'nova_content_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_content TO nova_content_svc;
      END IF;

      -- feed-service Áî®Êà∑
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_feed_svc') THEN
        CREATE USER nova_feed_svc WITH ENCRYPTED PASSWORD 'nova_feed_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_feed TO nova_feed_svc;
      END IF;

      -- messaging-service (legacy, read-only) Áî®Êà∑
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_messaging_svc') THEN
        CREATE USER nova_messaging_svc WITH ENCRYPTED PASSWORD 'nova_messaging_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_messaging TO nova_messaging_svc;
      END IF;

      -- search-service Áî®Êà∑
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_search_svc') THEN
        CREATE USER nova_search_svc WITH ENCRYPTED PASSWORD 'nova_search_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_search TO nova_search_svc;
      END IF;

      -- notification-service Áî®Êà∑
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_notification_svc') THEN
        CREATE USER nova_notification_svc WITH ENCRYPTED PASSWORD 'nova_notification_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_notification TO nova_notification_svc;
      END IF;

      -- media-service Áî®Êà∑
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_media_svc') THEN
        CREATE USER nova_media_svc WITH ENCRYPTED PASSWORD 'nova_media_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_media TO nova_media_svc;
      END IF;

      -- analytics-service Áî®Êà∑
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_analytics_svc') THEN
        CREATE USER nova_analytics_svc WITH ENCRYPTED PASSWORD 'nova_analytics_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_analytics TO nova_analytics_svc;
      END IF;

      -- graph-service Áî®Êà∑
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_graph_svc') THEN
        CREATE USER nova_graph_svc WITH ENCRYPTED PASSWORD 'nova_graph_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_graph TO nova_graph_svc;
      END IF;

      -- ranking-service Áî®Êà∑
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_ranking_svc') THEN
        CREATE USER nova_ranking_svc WITH ENCRYPTED PASSWORD 'nova_ranking_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_ranking TO nova_ranking_svc;
      END IF;

      -- feature-store Áî®Êà∑
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_feature_store_svc') THEN
        CREATE USER nova_feature_store_svc WITH ENCRYPTED PASSWORD 'nova_feature_store_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_feature_store TO nova_feature_store_svc;
      END IF;

      -- social-service Áî®Êà∑ÔºàÈ†êÁïôÔºöÁç®Á´ã nova_social Ë≥áÊñôÂ∫´Ôºâ
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_social_svc') THEN
        CREATE USER nova_social_svc WITH ENCRYPTED PASSWORD 'nova_social_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_social TO nova_social_svc;
      END IF;

      -- identity-service Áî®Êà∑
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_identity_svc') THEN
        CREATE USER nova_identity_svc WITH ENCRYPTED PASSWORD 'nova_identity_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_identity TO nova_identity_svc;
      END IF;

      -- trust-safety-service Áî®Êà∑
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_trust_safety_svc') THEN
        CREATE USER nova_trust_safety_svc WITH ENCRYPTED PASSWORD 'nova_trust_safety_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_trust_safety TO nova_trust_safety_svc;
      END IF;

      -- realtime-chat-service Áî®Êà∑
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_realtime_chat_svc') THEN
        CREATE USER nova_realtime_chat_svc WITH ENCRYPTED PASSWORD 'nova_realtime_chat_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_realtime_chat TO nova_realtime_chat_svc;
      END IF;

      -- Zitadel IdP Áî®Êà∑ (Matrix SSO)
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'zitadel') THEN
        CREATE USER zitadel WITH ENCRYPTED PASSWORD 'zitadel_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE zitadel TO zitadel;
      END IF;

      -- Synapse Matrix Áî®Êà∑
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'synapse') THEN
        CREATE USER synapse WITH ENCRYPTED PASSWORD 'synapse_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE synapse TO synapse;
      END IF;
    END
    $$;

  # Á¨¨‰∏âÊ≠•ÔºöÂàõÂª∫Êâ©Â±ïÂíåÂàùÂßã schema
  03-create-extensions.sql: |
    -- Âú®ÊØè‰∏™Êï∞ÊçÆÂ∫ì‰∏≠ÂêØÁî®ÂøÖË¶ÅÁöÑÊâ©Â±ï
    \c nova_auth
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_user
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_content
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_feed
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_messaging
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_search
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_notification
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_media
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_analytics
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_graph
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_ranking
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_feature_store
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    -- social-service Â∞àÁî®Ë≥áÊñôÂ∫´Êì¥Â±ï
    \c nova_social
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_identity
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_trust_safety
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_realtime_chat
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    -- Zitadel IdP Êì¥Â±ï
    \c zitadel
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    -- Synapse Matrix Êì¥Â±ï
    \c synapse
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

  # Á¨¨ÂõõÊ≠•ÔºöÂàõÂª∫ graph-service Âü∫Á°Ä schema
  04-create-graph-schema.sql: |
    -- Graph Service PostgreSQL Schema (nova_graph)
    \c nova_graph

    CREATE TABLE IF NOT EXISTS users (
      id UUID PRIMARY KEY,
      username VARCHAR(50) NOT NULL UNIQUE,
      created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      deleted_at TIMESTAMP WITH TIME ZONE NULL
    );

    CREATE INDEX IF NOT EXISTS idx_users_username ON users(username);
    CREATE INDEX IF NOT EXISTS idx_users_deleted_at ON users(deleted_at) WHERE deleted_at IS NULL;

    CREATE TABLE IF NOT EXISTS follows (
      follower_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
      following_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
      created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      PRIMARY KEY (follower_id, following_id),
      CONSTRAINT no_self_follow CHECK (follower_id != following_id)
    );

    CREATE INDEX IF NOT EXISTS idx_follows_follower ON follows(follower_id);
    CREATE INDEX IF NOT EXISTS idx_follows_following ON follows(following_id);
    CREATE INDEX IF NOT EXISTS idx_follows_created_at ON follows(created_at);

    CREATE TABLE IF NOT EXISTS mutes (
      muter_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
      muted_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
      created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      PRIMARY KEY (muter_id, muted_id),
      CONSTRAINT no_self_mute CHECK (muter_id != muted_id)
    );

    CREATE INDEX IF NOT EXISTS idx_mutes_muter ON mutes(muter_id);
    CREATE INDEX IF NOT EXISTS idx_mutes_muted ON mutes(muted_id);

    CREATE TABLE IF NOT EXISTS blocks (
      blocker_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
      blocked_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
      created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      PRIMARY KEY (blocker_id, blocked_id),
      CONSTRAINT no_self_block CHECK (blocker_id != blocked_id)
    );

    CREATE INDEX IF NOT EXISTS idx_blocks_blocker ON blocks(blocker_id);
    CREATE INDEX IF NOT EXISTS idx_blocks_blocked ON blocks(blocked_id);

  # Á¨¨‰∫îÊ≠•ÔºöÂàõÂª∫ search-service Âü∫Á°Ä schema (‰ΩøÁî® nova_content Êï∞ÊçÆÂ∫ì)
  05-create-search-schema.sql: |
    -- Search Service PostgreSQL Schema (nova_content)
    \c nova_content

    CREATE TABLE IF NOT EXISTS search_event_logs (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      user_id UUID NOT NULL,
      query TEXT NOT NULL,
      results_count INTEGER NOT NULL DEFAULT 0,
      clicked_type VARCHAR(50),
      clicked_id UUID,
      session_id UUID NOT NULL,
      created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
    );

    CREATE INDEX IF NOT EXISTS idx_search_user ON search_event_logs(user_id);
    CREATE INDEX IF NOT EXISTS idx_search_query ON search_event_logs(query);
    CREATE INDEX IF NOT EXISTS idx_search_created ON search_event_logs(created_at DESC);

    CREATE TABLE IF NOT EXISTS search_suggestions (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      query_prefix VARCHAR(100) NOT NULL,
      suggestion TEXT NOT NULL,
      suggestion_type VARCHAR(20) NOT NULL,
      popularity_score INTEGER NOT NULL DEFAULT 0,
      last_used_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
      created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
      UNIQUE (query_prefix, suggestion, suggestion_type)
    );

    CREATE INDEX IF NOT EXISTS idx_suggestions_prefix ON search_suggestions(query_prefix);
    CREATE INDEX IF NOT EXISTS idx_suggestions_popularity ON search_suggestions(popularity_score DESC);

    CREATE TABLE IF NOT EXISTS trending_queries (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      query TEXT NOT NULL,
      search_count INTEGER NOT NULL DEFAULT 0,
      trend_score FLOAT NOT NULL DEFAULT 0,
      time_window VARCHAR(10) NOT NULL,
      cached_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
      UNIQUE (query, time_window)
    );

    CREATE INDEX IF NOT EXISTS idx_trending_time_window ON trending_queries(time_window, trend_score DESC);
    CREATE INDEX IF NOT EXISTS idx_trending_cached ON trending_queries(cached_at DESC);

  # Êï∞ÊçÆÂ∫ìÊò†Â∞Ñ‰ø°ÊÅØÔºàÁî®‰∫éÂèÇËÄÉÔºâ
  database-mapping.txt: |
    ÂæÆÊúçÂä° ‚Üí Êï∞ÊçÆÂ∫ìÊò†Â∞ÑË°®

    1. auth-service ‚Üí nova_auth
    2. user-service ‚Üí nova_user
    3. content-service ‚Üí nova_content
    4. feed-service ‚Üí nova_feed
    5. legacy messaging-service ‚Üí nova_messaging (read-only)
    6. search-service ‚Üí nova_search
    7. notification-service ‚Üí nova_notification
    8. media-service ‚Üí nova_media
    9. analytics-service ‚Üí nova_analytics
    10. graph-service ‚Üí nova_graph
    11. ranking-service ‚Üí nova_ranking
    12. feature-store ‚Üí nova_feature_store
    13. identity-service ‚Üí nova_identity
    14. trust-safety-service ‚Üí nova_trust_safety
    15. realtime-chat-service ‚Üí nova_realtime_chat
    16. zitadel (Matrix SSO IdP) ‚Üí zitadel
    17. synapse (Matrix homeserver) ‚Üí synapse

---
# Êõ¥Êñ∞ postgres ÁöÑ init script Âç∑Êù•‰ΩøÁî®Â§öÊï∞ÊçÆÂ∫ìÈÖçÁΩÆ
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-scripts
  namespace: nova-staging
  labels:
    app: postgres
    component: init-script
data:
  # ÁªºÂêàÂàùÂßãÂåñËÑöÊú¨
  init-all-databases.sh: |
    #!/bin/bash
    set -e

    echo "üóÑÔ∏è  PostgreSQL Multi-Database Initialization - Starting at $(date)"
    echo "========================================"

    # ËøêË°åÂàùÂßãÂåñ SQL ËÑöÊú¨
    echo "Step 1: Creating databases..."
    psql -v ON_ERROR_STOP=1 -f /docker-entrypoint-initdb.d/01-create-databases.sql

    echo "Step 2: Creating service users..."
    psql -v ON_ERROR_STOP=1 -f /docker-entrypoint-initdb.d/02-create-service-users.sql

    echo "Step 3: Creating extensions..."
    psql -v ON_ERROR_STOP=1 -f /docker-entrypoint-initdb.d/03-create-extensions.sql

    echo ""
    echo "‚úÖ All databases initialized successfully!"
    echo "========================================"
    echo ""
    echo "üìä Created databases:"
    psql -l | grep nova_

    echo ""
    echo "üîê Created service users:"
    psql -c "\du" | grep nova_
