# PostgreSQL å¤šæ•°æ®åº“åˆå§‹åŒ–
# ä¸º 14 ä¸ªå¾®æœåŠ¡åˆ›å»ºå„è‡ªçš„æ•°æ®åº“å’Œç”¨æˆ·
# ä½¿ç”¨æœ€å°æƒé™åŸåˆ™ï¼Œæ¯ä¸ªæœåŠ¡æœ‰ç‹¬ç«‹çš„å‡­è¯

apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-multi-db-init
  namespace: nova-staging
  labels:
    app: postgres
    component: init-script
data:
  # ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºæ‰€æœ‰æ•°æ®åº“
  01-create-databases.sql: |
    -- åˆ›å»ºæ‰€æœ‰å¾®æœåŠ¡æ•°æ®åº“
    SELECT 'CREATE DATABASE nova_auth' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_auth')\gexec
    SELECT 'CREATE DATABASE nova_user' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_user')\gexec
    SELECT 'CREATE DATABASE nova_content' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_content')\gexec
    SELECT 'CREATE DATABASE nova_feed' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_feed')\gexec
    SELECT 'CREATE DATABASE nova_messaging' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_messaging')\gexec
    SELECT 'CREATE DATABASE nova_search' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_search')\gexec
    SELECT 'CREATE DATABASE nova_notification' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_notification')\gexec
    SELECT 'CREATE DATABASE nova_media' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_media')\gexec
    SELECT 'CREATE DATABASE nova_analytics' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_analytics')\gexec
    SELECT 'CREATE DATABASE nova_graph' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_graph')\gexec
    SELECT 'CREATE DATABASE nova_ranking' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_ranking')\gexec
    SELECT 'CREATE DATABASE nova_feature_store' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_feature_store')\gexec
    SELECT 'CREATE DATABASE nova_identity' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_identity')\gexec
    SELECT 'CREATE DATABASE nova_trust_safety' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_trust_safety')\gexec
    SELECT 'CREATE DATABASE nova_realtime_chat' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_realtime_chat')\gexec

    -- Future: dedicated social-service database (nova_social)
    SELECT 'CREATE DATABASE nova_social' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nova_social')\gexec

    -- Zitadel IdP database (Matrix SSO)
    SELECT 'CREATE DATABASE zitadel' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'zitadel')\gexec

    -- Synapse Matrix homeserver database
    SELECT 'CREATE DATABASE synapse' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'synapse')\gexec

  # ç¬¬äºŒæ­¥ï¼šåˆ›å»ºæœåŠ¡ç”¨æˆ·å’Œæƒé™
  02-create-service-users.sql: |
    -- ä¸ºæ¯ä¸ªå¾®æœåŠ¡åˆ›å»ºç‹¬ç«‹ç”¨æˆ·ï¼ˆä½¿ç”¨æœ€å°æƒé™åŸåˆ™ï¼‰
    DO $$
    BEGIN
      -- auth-service ç”¨æˆ·
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_auth_svc') THEN
        CREATE USER nova_auth_svc WITH ENCRYPTED PASSWORD 'nova_auth_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_auth TO nova_auth_svc;
      END IF;

      -- user-service ç”¨æˆ·
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_user_svc') THEN
        CREATE USER nova_user_svc WITH ENCRYPTED PASSWORD 'nova_user_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_user TO nova_user_svc;
      END IF;

      -- content-service ç”¨æˆ·
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_content_svc') THEN
        CREATE USER nova_content_svc WITH ENCRYPTED PASSWORD 'nova_content_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_content TO nova_content_svc;
      END IF;

      -- feed-service ç”¨æˆ·
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_feed_svc') THEN
        CREATE USER nova_feed_svc WITH ENCRYPTED PASSWORD 'nova_feed_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_feed TO nova_feed_svc;
      END IF;

      -- messaging-service (legacy, read-only) ç”¨æˆ·
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_messaging_svc') THEN
        CREATE USER nova_messaging_svc WITH ENCRYPTED PASSWORD 'nova_messaging_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_messaging TO nova_messaging_svc;
      END IF;

      -- search-service ç”¨æˆ·
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_search_svc') THEN
        CREATE USER nova_search_svc WITH ENCRYPTED PASSWORD 'nova_search_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_search TO nova_search_svc;
      END IF;

      -- notification-service ç”¨æˆ·
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_notification_svc') THEN
        CREATE USER nova_notification_svc WITH ENCRYPTED PASSWORD 'nova_notification_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_notification TO nova_notification_svc;
      END IF;

      -- media-service ç”¨æˆ·
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_media_svc') THEN
        CREATE USER nova_media_svc WITH ENCRYPTED PASSWORD 'nova_media_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_media TO nova_media_svc;
      END IF;

      -- analytics-service ç”¨æˆ·
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_analytics_svc') THEN
        CREATE USER nova_analytics_svc WITH ENCRYPTED PASSWORD 'nova_analytics_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_analytics TO nova_analytics_svc;
      END IF;

      -- graph-service ç”¨æˆ·
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_graph_svc') THEN
        CREATE USER nova_graph_svc WITH ENCRYPTED PASSWORD 'nova_graph_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_graph TO nova_graph_svc;
      END IF;

      -- ranking-service ç”¨æˆ·
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_ranking_svc') THEN
        CREATE USER nova_ranking_svc WITH ENCRYPTED PASSWORD 'nova_ranking_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_ranking TO nova_ranking_svc;
      END IF;

      -- feature-store ç”¨æˆ·
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_feature_store_svc') THEN
        CREATE USER nova_feature_store_svc WITH ENCRYPTED PASSWORD 'nova_feature_store_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_feature_store TO nova_feature_store_svc;
      END IF;

      -- social-service ç”¨æˆ·ï¼ˆé ç•™ï¼šç¨ç«‹ nova_social è³‡æ–™åº«ï¼‰
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_social_svc') THEN
        CREATE USER nova_social_svc WITH ENCRYPTED PASSWORD 'nova_social_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_social TO nova_social_svc;
      END IF;

      -- identity-service ç”¨æˆ·
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_identity_svc') THEN
        CREATE USER nova_identity_svc WITH ENCRYPTED PASSWORD 'nova_identity_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_identity TO nova_identity_svc;
      END IF;

      -- trust-safety-service ç”¨æˆ·
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_trust_safety_svc') THEN
        CREATE USER nova_trust_safety_svc WITH ENCRYPTED PASSWORD 'nova_trust_safety_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_trust_safety TO nova_trust_safety_svc;
      END IF;

      -- realtime-chat-service ç”¨æˆ·
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'nova_realtime_chat_svc') THEN
        CREATE USER nova_realtime_chat_svc WITH ENCRYPTED PASSWORD 'nova_realtime_chat_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE nova_realtime_chat TO nova_realtime_chat_svc;
      END IF;

      -- Zitadel IdP ç”¨æˆ· (Matrix SSO)
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'zitadel') THEN
        CREATE USER zitadel WITH ENCRYPTED PASSWORD 'zitadel_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE zitadel TO zitadel;
      END IF;

      -- Synapse Matrix ç”¨æˆ·
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'synapse') THEN
        CREATE USER synapse WITH ENCRYPTED PASSWORD 'synapse_staging_pwd';
        GRANT ALL PRIVILEGES ON DATABASE synapse TO synapse;
      END IF;
    END
    $$;

  # ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºæ‰©å±•å’Œåˆå§‹ schema
  03-create-extensions.sql: |
    -- åœ¨æ¯ä¸ªæ•°æ®åº“ä¸­å¯ç”¨å¿…è¦çš„æ‰©å±•
    \c nova_auth
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_user
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_content
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_feed
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_messaging
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_search
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_notification
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_media
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_analytics
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_graph
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_ranking
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_feature_store
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    -- social-service å°ˆç”¨è³‡æ–™åº«æ“´å±•
    \c nova_social
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_identity
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_trust_safety
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    \c nova_realtime_chat
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    -- Zitadel IdP æ“´å±•
    \c zitadel
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    -- Synapse Matrix æ“´å±•
    \c synapse
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

  # æ•°æ®åº“æ˜ å°„ä¿¡æ¯ï¼ˆç”¨äºå‚è€ƒï¼‰
  database-mapping.txt: |
    å¾®æœåŠ¡ â†’ æ•°æ®åº“æ˜ å°„è¡¨

    1. auth-service â†’ nova_auth
    2. user-service â†’ nova_user
    3. content-service â†’ nova_content
    4. feed-service â†’ nova_feed
    5. legacy messaging-service â†’ nova_messaging (read-only)
    6. search-service â†’ nova_search
    7. notification-service â†’ nova_notification
    8. media-service â†’ nova_media
    9. analytics-service â†’ nova_analytics
    10. graph-service â†’ nova_graph
    11. ranking-service â†’ nova_ranking
    12. feature-store â†’ nova_feature_store
    13. identity-service â†’ nova_identity
    14. trust-safety-service â†’ nova_trust_safety
    15. realtime-chat-service â†’ nova_realtime_chat
    16. zitadel (Matrix SSO IdP) â†’ zitadel
    17. synapse (Matrix homeserver) â†’ synapse

---
# æ›´æ–° postgres çš„ init script å·æ¥ä½¿ç”¨å¤šæ•°æ®åº“é…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-scripts
  namespace: nova-staging
  labels:
    app: postgres
    component: init-script
data:
  # ç»¼åˆåˆå§‹åŒ–è„šæœ¬
  init-all-databases.sh: |
    #!/bin/bash
    set -e

    echo "ğŸ—„ï¸  PostgreSQL Multi-Database Initialization - Starting at $(date)"
    echo "========================================"

    # è¿è¡Œåˆå§‹åŒ– SQL è„šæœ¬
    echo "Step 1: Creating databases..."
    psql -v ON_ERROR_STOP=1 -f /docker-entrypoint-initdb.d/01-create-databases.sql

    echo "Step 2: Creating service users..."
    psql -v ON_ERROR_STOP=1 -f /docker-entrypoint-initdb.d/02-create-service-users.sql

    echo "Step 3: Creating extensions..."
    psql -v ON_ERROR_STOP=1 -f /docker-entrypoint-initdb.d/03-create-extensions.sql

    echo ""
    echo "âœ… All databases initialized successfully!"
    echo "========================================"
    echo ""
    echo "ğŸ“Š Created databases:"
    psql -l | grep nova_

    echo ""
    echo "ğŸ” Created service users:"
    psql -c "\du" | grep nova_
