# ClickHouse Installation CRD - Nova Analytics Service
# This file contains the latest staging configuration with CDC support
# Last updated: 2025-11-26 - Fixed memory limits to 2Gi for CDC data processing
#
# Key changes from previous version:
# - Increased memory limits: 512Mi → 2Gi
# - Increased memory requests: 256Mi → 1Gi
# - Removed CPU limits to prevent scheduling conflicts
# - Simplified to single CRD configuration (nova-ch)
# - Integrated users configuration directly in CRD
# - Supports CDC data from PostgreSQL via Debezium

apiVersion: clickhouse.altinity.com/v1
kind: ClickHouseInstallation
metadata:
  annotations:
    argocd.argoproj.io/compare-result: "false"
    environment: staging
  creationTimestamp: "2025-11-14T16:27:55Z"
  finalizers:
  - finalizer.clickhouseinstallation.altinity.com
  generation: 5
  name: nova-ch
  namespace: nova-staging
  resourceVersion: "9778126"
  uid: 54a5c517-b147-4f4a-8d2e-3dc64319d84c
spec:
  configuration:
    clusters:
    - layout:
        replicasCount: 1
        shardsCount: 1
      name: single
      templates:
        podTemplate: ch-pod
        serviceTemplate: ch-svc
    files:
      users.d/nova.xml: |
        <yandex>
          <users>
            <nova>
              <password_sha256_hex>86112850e198ebaa0fc49c4cb0238183994eb5abad94a2113a3ebc3b92f59370</password_sha256_hex>
              <networks>
                <!-- Restrict to VPC CIDR to avoid public access -->
                <ip>10.0.0.0/8</ip>
              </networks>
              <profile>default</profile>
              <quota>default</quota>
            </nova>
          </users>
        </yandex>
    users:
      nova/networks/ip:
      - 10.0.0.0/8
      nova/password_sha256_hex: 86112850e198ebaa0fc49c4cb0238183994eb5abad94a2113a3ebc3b92f59370
      nova/profile: default
      nova/quota: default
  templates:
    podTemplates:
    - name: ch-pod
      spec:
        containers:
        - image: clickhouse/clickhouse-server:24.8
          name: clickhouse
          resources:
            limits:
              memory: 2Gi
            requests:
              memory: 1Gi
          volumeMounts:
          - mountPath: /var/lib/clickhouse
            name: data
        volumes:
        - name: data
          persistentVolumeClaim:
            claimName: nova-ch-data
    serviceTemplates:
    - generateName: clickhouse-nova-ch
      metadata:
        labels:
          app: nova
      name: ch-svc
      spec:
        ports:
        - name: http
          port: 8123
          targetPort: http
        - name: tcp
          port: 9000
          targetPort: tcp
        type: ClusterIP
