# Social Service 环境变量配置 - Staging
# 包含完整的 mTLS 服务端配置和客户端配置

apiVersion: apps/v1
kind: Deployment
metadata:
  name: social-service
spec:
  template:
    spec:
      containers:
      - name: social-service
        env:
        # ============================================================
        # 应用环境配置
        # ============================================================
        - name: APP_ENV
          value: "staging"

        # ============================================================
        # 服务基础配置
        # ============================================================
        - name: RUST_LOG
          value: "info,social_service=debug"
        - name: SERVICE_NAME
          value: "social-service"
        - name: SERVER_HOST
          value: "0.0.0.0"
        - name: PORT
          value: "8006"
        - name: SERVER_PORT
          value: "8006"
        - name: GRPC_PORT
          value: "50052"

        # ============================================================
        # 数据库和消息队列配置
        # ============================================================
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: social-service-secret
              key: database-url
        - name: REDIS_URL
          valueFrom:
            configMapKeyRef:
              name: social-service-configmap
              key: redis-url
        - name: KAFKA_BROKERS
          valueFrom:
            configMapKeyRef:
              name: social-service-configmap
              key: kafka-brokers

        # ============================================================
        # mTLS 服务端配置 (作为 gRPC Server)
        # ============================================================
        - name: GRPC_SERVER_CERT_PATH
          value: "/etc/nova/certs/server.crt"
        - name: GRPC_SERVER_KEY_PATH
          value: "/etc/nova/certs/server.key"
        - name: GRPC_CA_CERT_PATH
          value: "/etc/nova/certs/ca.crt"
        - name: GRPC_REQUIRE_CLIENT_CERT
          value: "true"

        # ============================================================
        # mTLS 客户端配置 (连接其他 gRPC 服务)
        # ============================================================
        - name: GRPC_TLS_ENABLED
          value: "true"
        - name: GRPC_TLS_CA_CERT_PATH
          value: "/etc/nova/certs/ca.crt"
        - name: GRPC_TLS_CLIENT_CERT_PATH
          value: "/etc/nova/certs/client.crt"
        - name: GRPC_TLS_CLIENT_KEY_PATH
          value: "/etc/nova/certs/client.key"
        - name: GRPC_TLS_DOMAIN_NAME
          value: "social-service.nova-staging.svc.cluster.local"

        # ============================================================
        # gRPC 服务端点配置
        # ============================================================
        - name: GRPC_IDENTITY_SERVICE_URL
          value: "https://identity-service.nova-staging.svc.cluster.local:50051"
        - name: GRPC_CONTENT_SERVICE_URL
          value: "https://content-service.nova-staging.svc.cluster.local:9080"
        - name: GRPC_FEED_SERVICE_URL
          value: "https://feed-service.nova-staging.svc.cluster.local:9084"
        - name: GRPC_SEARCH_SERVICE_URL
          value: "http://search-service.nova-staging.svc.cluster.local:9086"
        - name: GRPC_MEDIA_SERVICE_URL
          value: "https://media-service.nova-staging.svc.cluster.local:9082"
        - name: GRPC_NOTIFICATION_SERVICE_URL
          value: "http://notification-service.nova-staging.svc.cluster.local:9080"
        - name: GRPC_ANALYTICS_SERVICE_URL
          value: "https://analytics-service.nova-staging.svc.cluster.local:9080"
        - name: GRPC_GRAPH_SERVICE_URL
          value: "https://graph-service.nova-staging.svc.cluster.local:9080"
        - name: GRPC_SOCIAL_SERVICE_URL
          value: "https://social-service.nova-staging.svc.cluster.local:50052"
        - name: GRPC_CHAT_SERVICE_URL
          value: "https://realtime-chat-service.nova-staging.svc.cluster.local:9095"
        - name: GRPC_RANKING_SERVICE_URL
          value: "https://ranking-service.nova-staging.svc.cluster.local:9011"
        - name: GRPC_TRUST_SAFETY_SERVICE_URL
          value: "https://trust-safety-service.nova-staging.svc.cluster.local:50056"

        # ============================================================
        # 依赖服务 Tier 配置 (降级为 soft 依赖避免启动失败)
        # ============================================================
        - name: GRPC_IDENTITY_SERVICE_TIER
          value: "1"
        - name: GRPC_CONTENT_SERVICE_TIER
          value: "1"
        - name: GRPC_GRAPH_SERVICE_TIER
          value: "1"
        - name: GRPC_RANKING_SERVICE_TIER
          value: "1"
        - name: GRPC_SOCIAL_SERVICE_TIER
          value: "2"
        - name: GRPC_FEATURE_STORE_TIER
          value: "2"

        # ============================================================
        # 启动探针配置 (给服务更多启动时间)
        # ============================================================
        startupProbe:
          httpGet:
            path: /health
            port: 8006
            scheme: HTTP
          failureThreshold: 30
          periodSeconds: 10

        livenessProbe:
          httpGet:
            path: /health
            port: 8006
            scheme: HTTP
          initialDelaySeconds: 120
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3

        readinessProbe:
          httpGet:
            path: /ready
            port: 8006
            scheme: HTTP
          initialDelaySeconds: 60
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3

        volumeMounts:
        - name: grpc-mtls-shared
          mountPath: /etc/nova/certs
          readOnly: true

      volumes:
      - name: grpc-mtls-shared
        secret:
          secretName: grpc-mtls-shared
