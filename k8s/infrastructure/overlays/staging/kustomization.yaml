apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: nova-staging

# Strategic merge patches for staging environment
# Using JSON 6902 patches with explicit namespace targeting
# This allows patches to work correctly with nested kustomizations
# Patch to ensure only one search-service Service definition is used
patches:
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 25m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 512Mi
  target:
    group: apps
    kind: Deployment
    name: content-service

    version: v1
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 25m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 1Gi
  target:
    group: apps
    kind: Deployment
    name: feed-service

    version: v1
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 25m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 1Gi
  target:
    group: apps
    kind: Deployment
    name: media-service

    version: v1
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 25m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 1Gi
  target:
    group: apps
    kind: Deployment
    name: search-service

    version: v1
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 25m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 512Mi
  target:
    group: apps
    kind: Deployment
    name: analytics-service

    version: v1
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 25m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 512Mi
  target:
    group: apps
    kind: Deployment
    name: graph-service

    version: v1
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 25m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 512Mi
  target:
    group: apps
    kind: Deployment
    name: graphql-gateway

    version: v1
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 25m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 512Mi
  target:
    group: apps
    kind: Deployment
    name: identity-service

    version: v1
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 25m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 512Mi
  target:
    group: apps
    kind: Deployment
    name: notification-service

    version: v1
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 25m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 512Mi
  target:
    group: apps
    kind: Deployment
    name: ranking-service

    version: v1
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 25m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 512Mi
  target:
    group: apps
    kind: Deployment
    name: realtime-chat-service

    version: v1
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 25m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 512Mi
  target:
    group: apps
    kind: Deployment
    name: social-service

    version: v1
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 25m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 512Mi
  target:
    group: apps
    kind: Deployment
    name: trust-safety-service

    version: v1
# search-service ports now defined in grpc-services.yaml (gRPC:50057, HTTP:8086)
- path: configmap-patch.yaml
- path: deployment-images-patch.yaml
- path: postgres-deploy-patch.yaml
- path: service-selectors-patch.yaml
- path: redis-deploy-patch.yaml
- path: deploy-labels-patch.yaml
- path: feed-service-env-patch.yaml
- path: analytics-service-env-patch.yaml
- path: content-service-env-patch.yaml
- path: content-service-probes-patch.yaml
- path: content-service-ports-patch.yaml
- path: runasuser-patch.yaml
- path: search-service-env-patch.yaml
- path: notification-service-env-port-patch.yaml
- path: notification-service-probes-patch.yaml
- path: elasticsearch-replicas-patch.yaml
- path: s3-env-patch.yaml
- path: prefer-large-nodes-patch.yaml
- path: identity-service-probes-patch.yaml
- path: feed-service-probes-patch.yaml
- path: service-db-env-patch.yaml
- path: service-redis-env-patch.yaml
- path: grpc-tls-env-patch.yaml
- path: graphql-gateway-env-patch.yaml

# (migrated to strategic merge patches per service to avoid jsonpatch parent missing)


# 启用以下 patches 以完整配置 staging 环境（strategic merge）
# - feed-service-init-fix.yaml  # ❌ 已移除：feed-service 通过 Kafka content-events 解耦，不再直接依赖 content-service
# Identity-service gRPC-only health checks (no HTTP server)
# Feed-service 探針需對應 8084 + /health，必須啟用
# Shared DATABASE_URL wiring for core services
# Shared Redis URL wiring for services using Redis
# - resource-optimization-patch.yaml  # 可选：资源优化
#
# PgBouncer images now patched in base manifests (k8s/infrastructure/pgbouncer),
# staging overlay does not need additional image patches.

# Remove deprecated/retired services from staging (none currently included)
# Note: ClickHouse 需要额外的网络隔离 patches

images:
- name: nova/analytics-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/analytics-service
  newTag: d76baed0b3ece4ccb5d1a3ce34f97954dc792461
- name: nova/content-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/content-service
  newTag: 04d28e5917f31c454fe785d431d21290a87cf364
- name: nova/feed-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/feed-service
  newTag: d76baed0b3ece4ccb5d1a3ce34f97954dc792461
- name: nova/graph-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/graph-service
  newTag: d76baed0b3ece4ccb5d1a3ce34f97954dc792461
- name: nova/graphql-gateway
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/graphql-gateway
  newTag: d76baed0b3ece4ccb5d1a3ce34f97954dc792461
- name: nova/identity-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/identity-service
  newTag: d76baed0b3ece4ccb5d1a3ce34f97954dc792461
- name: nova/media-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/media-service
  newTag: d76baed0b3ece4ccb5d1a3ce34f97954dc792461
- name: nova/notification-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/notification-service
  newTag: d76baed0b3ece4ccb5d1a3ce34f97954dc792461
- name: nova/ranking-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/ranking-service
  newTag: d76baed0b3ece4ccb5d1a3ce34f97954dc792461
- name: nova/realtime-chat-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/realtime-chat-service
  newTag: d76baed0b3ece4ccb5d1a3ce34f97954dc792461
- name: nova/search-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/search-service
  newTag: d76baed0b3ece4ccb5d1a3ce34f97954dc792461
- name: nova/social-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/social-service
  newTag: d76baed0b3ece4ccb5d1a3ce34f97954dc792461
- name: nova/trust-safety-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/trust-safety-service
  newTag: d76baed0b3ece4ccb5d1a3ce34f97954dc792461

# Staging replica configuration
# All core services enabled with 1 replica
# PgBouncer disabled due to hostPort conflicts
# api-gateway removed (deprecated in favor of graphql-gateway); turn-server disabled
replicas:
- count: 0
  name: pgbouncer
- count: 1
  name: analytics-service
- count: 1
  name: ranking-service
- count: 1
  name: realtime-chat-service
- count: 1
  name: trust-safety-service
- count: 1
  name: social-service
- count: 1
  name: feed-service
- count: 0
  name: turn-server
- count: 1
  name: content-service
- count: 1
  name: graph-service
- count: 1
  name: graphql-gateway
- count: 1
  name: identity-service
- count: 1
  name: media-service
- count: 1
  name: notification-service
- count: 1
  name: search-service

commonAnnotations:
  argocd.argoproj.io/compare-result: "false"
  environment: staging


# ========================================
# P0 Priority: Core Service Infrastructure
# ========================================
# gRPC service discovery和 networking 交由 microservices 自带 Service 定义管理，避免重复

# Database migration job (runs before services start)

# PostgreSQL multi-database initialization

# ========================================
# P1 Priority: Service Startup Orchestration
# ========================================
# Init containers for dependency ordering
# ❌ COMMENTED: service-init-containers-patch.yaml - 导致资源ID冲突
# - service-init-containers-patch.yaml

# ========================================
# P2 Priority: Data & Event Infrastructure
# ========================================
# Redis cluster for caching and sessions

# Kafka + Zookeeper for event streaming

# ClickHouse for analytics

# ========================================
# P3 Priority: API Contract Management
# ========================================
# Protocol Buffer definitions and service registry

# ========================================
# P4 Priority: Microservice Deployments
# ========================================
# All application service deployments from microservices directory kustomization

# ========================================
# PgBouncer connection pooling (P1 Priority)
# ========================================
resources:
- ../../base
- postgres-pvc-gp3.yaml
- pgbouncer-userlist-patch.yaml
- clickhouse-pvc.yaml
# sts-rotator.yaml - DISABLED: aws sts get-session-token cannot be called with IRSA session credentials
# S3 credentials are now managed by ExternalSecrets (nova-s3-credentials from nova/staging/nova-s3-config)
# - sts-rotator.yaml
- secrets-sync.yaml
- content-service-configmap.yaml
- resource-optimization-info.configmap.yaml
- nova-clickhouse-credentials.yaml
- seed-data-job.yaml
- sqlx-migrate-job.yaml
- postgres-multi-db-init.yaml
- redis-cluster-statefulset.yaml
- kafka-zookeeper-deployment.yaml
- clickhouse-statefulset.yaml
- neo4j-statefulset.yaml
- proto-management.yaml
- ../../../microservices
- ../../pgbouncer
