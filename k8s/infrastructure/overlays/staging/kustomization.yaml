apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: nova-staging

# Strategic merge patches for staging environment
# Using JSON 6902 patches with explicit namespace targeting
# This allows patches to work correctly with nested kustomizations
# Patch to ensure only one search-service Service definition is used
patches:
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
  target:
    group: apps
    kind: Deployment
    name: content-service
    namespace: nova-staging
    version: v1
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 512Mi
        limits:
          cpu: 500m
          memory: 1Gi
  target:
    group: apps
    kind: Deployment
    name: feed-service
    namespace: nova-staging
    version: v1
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 512Mi
        limits:
          cpu: 500m
          memory: 1Gi
  target:
    group: apps
    kind: Deployment
    name: media-service
    namespace: nova-staging
    version: v1
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 200m
          memory: 512Mi
        limits:
          cpu: 1000m
          memory: 2Gi
  target:
    group: apps
    kind: Deployment
    name: search-service
    namespace: nova-staging
    version: v1
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
  target:
    group: apps
    kind: Deployment
    name: analytics-service
    namespace: nova-staging
    version: v1
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
  target:
    group: apps
    kind: Deployment
    name: graph-service
    namespace: nova-staging
    version: v1
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
  target:
    group: apps
    kind: Deployment
    name: graphql-gateway
    namespace: nova-staging
    version: v1
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
  target:
    group: apps
    kind: Deployment
    name: identity-service
    namespace: nova-staging
    version: v1
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
  target:
    group: apps
    kind: Deployment
    name: notification-service
    namespace: nova-staging
    version: v1
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
  target:
    group: apps
    kind: Deployment
    name: ranking-service
    namespace: nova-staging
    version: v1
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
  target:
    group: apps
    kind: Deployment
    name: realtime-chat-service
    namespace: nova-staging
    version: v1
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
  target:
    group: apps
    kind: Deployment
    name: social-service
    namespace: nova-staging
    version: v1
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
  target:
    group: apps
    kind: Deployment
    name: trust-safety-service
    namespace: nova-staging
    version: v1
- patch: |-
    - op: replace
      path: /spec/ports
      value:
        - name: http
          port: 8086
          targetPort: 8086
          protocol: TCP
  target:
    kind: Service
    name: search-service
    namespace: nova-staging
    version: v1
- path: configmap-patch.yaml
- path: deployment-images-patch.yaml
- path: postgres-deploy-patch.yaml
- path: service-selectors-patch.yaml
- path: redis-deploy-patch.yaml
- path: deploy-labels-patch.yaml
- path: feed-service-env-patch.yaml
- path: analytics-service-env-patch.yaml
- path: content-service-env-patch.yaml
- path: content-service-probes-patch.yaml
- path: content-service-ports-patch.yaml
- path: runasuser-patch.yaml
- path: search-service-env-patch.yaml
- path: notification-service-env-port-patch.yaml
- path: notification-service-probes-patch.yaml
- path: elasticsearch-replicas-patch.yaml
- path: s3-env-patch.yaml
- path: prefer-large-nodes-patch.yaml
- path: identity-service-probes-patch.yaml
- path: feed-service-probes-patch.yaml
- path: service-db-env-patch.yaml
- path: service-redis-env-patch.yaml
- path: grpc-tls-env-patch.yaml

# (migrated to strategic merge patches per service to avoid jsonpatch parent missing)


# 启用以下 patches 以完整配置 staging 环境（strategic merge）
# - feed-service-init-fix.yaml  # ❌ 已移除：feed-service 通过 Kafka content-events 解耦，不再直接依赖 content-service
# Identity-service gRPC-only health checks (no HTTP server)
# Feed-service 探針需對應 8084 + /health，必須啟用
# Shared DATABASE_URL wiring for core services
# Shared Redis URL wiring for services using Redis
# - resource-optimization-patch.yaml  # 可选：资源优化
#
# PgBouncer images now patched in base manifests (k8s/infrastructure/pgbouncer),
# staging overlay does not need additional image patches.

# Remove deprecated/retired services from staging (none currently included)
# Note: ClickHouse 需要额外的网络隔离 patches

images:
- name: nova/analytics-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/analytics-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/content-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/content-service
  newTag: 4e7634a01c998bba650915882af53547504556b7
- name: nova/feed-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/feed-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/graph-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/graph-service
  newTag: 453ce5e7a4447cd313e55bda15d24e8de2e27975
- name: nova/graphql-gateway
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/graphql-gateway
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/identity-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/identity-service
  newTag: dae305a3b9bbbb3a3257b3e8b1162f24608aefe9
- name: nova/media-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/media-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/notification-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/notification-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/ranking-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/ranking-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/realtime-chat-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/realtime-chat-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/search-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/search-service
  newTag: 3bc3d089df39336265aebb0d902ceb1af1893e0a
- name: nova/social-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/social-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/trust-safety-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/trust-safety-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5

# Staging replica overrides to keep core path light
  # Disable non-critical services temporarily to free CPU for DB/Redis

  # Disable PgBouncer in staging for now to avoid hostPort conflicts and crashes
  - name: pgbouncer
    count: 0

  # Keep a single replica for core path services
replicas:
- count: 0
  name: analytics-service
- count: 0
  name: ranking-service
- count: 0
  name: realtime-chat-service
- count: 0
  name: trust-safety-service
- count: 0
  name: social-service
- count: 0
  name: api-gateway
- count: 0
  name: feed-service
- count: 0
  name: turn-server
- count: 0
  name: pgbouncer
- count: 1
  name: content-service
- count: 0
  name: graph-service
- count: 0
  name: graphql-gateway
- count: 1
  name: media-service
- count: 1
  name: notification-service
- count: 1
  name: search-service

commonAnnotations:
  argocd.argoproj.io/compare-result: "false"
  environment: staging


# ========================================
# P0 Priority: Core Service Infrastructure
# ========================================
# gRPC service discovery和 networking 交由 microservices 自带 Service 定义管理，避免重复

# Database migration job (runs before services start)

# PostgreSQL multi-database initialization

# ========================================
# P1 Priority: Service Startup Orchestration
# ========================================
# Init containers for dependency ordering
# ❌ COMMENTED: service-init-containers-patch.yaml - 导致资源ID冲突
# - service-init-containers-patch.yaml

# ========================================
# P2 Priority: Data & Event Infrastructure
# ========================================
# Redis cluster for caching and sessions

# Kafka + Zookeeper for event streaming

# ClickHouse for analytics

# ========================================
# P3 Priority: API Contract Management
# ========================================
# Protocol Buffer definitions and service registry

# ========================================
# P4 Priority: Microservice Deployments
# ========================================
# All application service deployments from microservices directory kustomization

# ========================================
# PgBouncer connection pooling (P1 Priority)
# ========================================
resources:
- ../../base
- postgres-pvc-gp3.yaml
- clickhouse-pvc.yaml
- sts-rotator.yaml
- secrets-sync.yaml
- content-service-configmap.yaml
- resource-optimization-info.configmap.yaml
- nova-clickhouse-credentials.yaml
- clickhouse-chi.yaml
- clickhouse-service-clusterip.yaml
- clickhouse-service-internal.yaml
- seed-data-job.yaml
- sqlx-migrate-job.yaml
- postgres-multi-db-init.yaml
- redis-cluster-statefulset.yaml
- kafka-zookeeper-deployment.yaml
- clickhouse-installation.yaml
- neo4j-statefulset.yaml
- proto-management.yaml
- ../../../microservices
- ../../pgbouncer
