apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: nova-staging

# Strategic merge patches for staging environment
# Using JSON 6902 patches with explicit namespace targeting
# This allows patches to work correctly with nested kustomizations
patchesJson6902:
- target:
    group: apps
    version: v1
    kind: Deployment
    name: user-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: content-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: feed-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 512Mi
        limits:
          cpu: 500m
          memory: 1Gi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: media-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 512Mi
        limits:
          cpu: 500m
          memory: 1Gi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: messaging-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 512Mi
        limits:
          cpu: 500m
          memory: 1Gi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: search-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 200m
          memory: 512Mi
        limits:
          cpu: 1000m
          memory: 2Gi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: analytics-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: graph-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: graphql-gateway
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: identity-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: notification-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: ranking-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: realtime-chat-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: social-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: trust-safety-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
# - secrets-patch.yaml
# - configmap-patch.yaml
# - deployment-images-patch.yaml
# - postgres-deploy-patch.yaml
# - service-selectors-patch.yaml
# - redis-deploy-patch.yaml
# - deploy-labels-patch.yaml
# - user-service-env-patch.yaml
# - user-service-probes-patch.yaml
# - feed-service-env-patch.yaml
# - feed-service-probes-patch.yaml
# - messaging-service-env-patch.yaml
# - messaging-service-env-port-patch.yaml
# - messaging-service-probes-patch.yaml
# - content-service-env-patch.yaml
# - content-service-probes-patch.yaml
# - search-service-env-patch.yaml
# - elasticsearch-replicas-patch.yaml
# - s3-env-patch.yaml
# - hpa-min1-patch.yaml
# - prefer-large-nodes-patch.yaml
# - resource-optimization-patch.yaml
# Note: Harden ClickHouse exposure with additional patches as needed

images:
- name: nova/analytics-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/analytics-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/content-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/content-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/feed-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/feed-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/graph-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/graph-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/graphql-gateway
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/graphql-gateway
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/identity-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/identity-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/media-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/media-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/notification-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/notification-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/ranking-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/ranking-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/realtime-chat-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/realtime-chat-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/search-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/search-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/social-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/social-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/trust-safety-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/trust-safety-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/user-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/user-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5

# TODO: Re-enable replicas after resources are properly discovered
#replicas:
#- count: 1
#  name: analytics-service
#- count: 1
#  name: content-service
#- count: 1
#  name: feed-service
#- count: 1
#  name: graph-service
#- count: 1
#  name: graphql-gateway
#- count: 1
#  name: identity-service
#- count: 1
#  name: media-service
#- count: 1
#  name: notification-service
#- count: 1
#  name: ranking-service
#- count: 1
#  name: realtime-chat-service
#- count: 1
#  name: search-service
#- count: 1
#  name: social-service
#- count: 1
#  name: trust-safety-service
#- count: 1
#  name: user-service

commonAnnotations:
  argocd.argoproj.io/compare-result: "false"
  environment: staging

resources:
- ../../base
- postgres-pvc-gp3.yaml
- clickhouse-pvc.yaml
- sts-rotator.yaml
- secrets-sync.yaml
- resource-optimization-info.configmap.yaml
- nova-messaging-keys.yaml
- nova-clickhouse-credentials.yaml
- clickhouse-chi.yaml
- clickhouse-service-clusterip.yaml
- clickhouse-service-internal.yaml
- external-secrets-store.yaml
- external-secrets.yaml
- seed-data-job.yaml
# PgBouncer connection pooling (P1 Priority)
- ../../pgbouncer
