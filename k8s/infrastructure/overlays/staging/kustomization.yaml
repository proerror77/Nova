apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization


namespace: nova

# Staging 环境特定配置
patchesStrategicMerge:
- deployment-patch.yaml
- secrets-patch.yaml
- configmap-patch.yaml
- deployment-images-patch.yaml
- postgres-deploy-patch.yaml
- service-selectors-patch.yaml
- redis-deploy-patch.yaml
- deploy-labels-patch.yaml
- user-service-env-patch.yaml
- elasticsearch-replicas-patch.yaml

# 环境变量覆盖 (不使用 generator,改用 patch 方式)
# configMapGenerator:
# - behavior: merge
#   literals:
#   - APP_ENV=staging
#   - LOG_LEVEL=info
#   - RUST_LOG=info,actix_web=info
#   - FEATURE_FLAG_BETA=true
#   name: nova-config

# 镜像标签配置（通过 CI/CD 动态更新）
images:
- name: nova/auth-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/auth-service
  newTag: 5073f213cc88809ac54c40e1f5e8494ded8c624c
- name: nova/content-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/content-service
  newTag: 5073f213cc88809ac54c40e1f5e8494ded8c624c
- name: nova/feed-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/feed-service
  newTag: 5073f213cc88809ac54c40e1f5e8494ded8c624c
- name: nova/media-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/media-service
  newTag: 5073f213cc88809ac54c40e1f5e8494ded8c624c
- name: nova/messaging-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/messaging-service
  newTag: 5073f213cc88809ac54c40e1f5e8494ded8c624c
- name: nova/search-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/search-service
  newTag: 5073f213cc88809ac54c40e1f5e8494ded8c624c
- name: nova/streaming-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/streaming-service
  newTag: 5073f213cc88809ac54c40e1f5e8494ded8c624c
- name: nova/user-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/user-service
  newTag: 5073f213cc88809ac54c40e1f5e8494ded8c624c

# 副本数配置 (降低至 1 以适应资源限制)
replicas:
- count: 0
  name: auth-service
- count: 1
  name: user-service
- count: 1
  name: content-service
- count: 1
  name: feed-service
- count: 1
  name: media-service
- count: 1
  name: messaging-service
- count: 1
  name: search-service
- count: 1
  name: streaming-service

# 公共注解
commonAnnotations:
  argocd.argoproj.io/compare-result: "false"
  deployment.kubernetes.io/version: "1"
  environment: staging
resources:
- ../../base
- clickhouse-chi.yaml
- postgres-pvc-gp3.yaml
