apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: nova

patchesStrategicMerge:
- deployment-patch.yaml
- secrets-patch.yaml
- configmap-patch.yaml
- deployment-images-patch.yaml
- postgres-deploy-patch.yaml
- service-selectors-patch.yaml
- redis-deploy-patch.yaml
- deploy-labels-patch.yaml
- user-service-env-patch.yaml
- user-service-probes-patch.yaml
- feed-service-env-patch.yaml
- messaging-service-env-patch.yaml
- messaging-service-env-port-patch.yaml
- messaging-service-probes-patch.yaml
- content-service-env-patch.yaml
- streaming-service-env-patch.yaml
- search-service-env-patch.yaml
- elasticsearch-replicas-patch.yaml
- s3-env-patch.yaml
- hpa-min1-patch.yaml
- prefer-large-nodes-patch.yaml
- resource-optimization-patch.yaml
# Harden ClickHouse exposure

images:
- name: nova/auth-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/auth-service
  newTag: d558d85069e280ac2568db182d064ed3e3d7eea9
- name: nova/content-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/content-service
  newTag: d558d85069e280ac2568db182d064ed3e3d7eea9
- name: nova/feed-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/feed-service
  newTag: d558d85069e280ac2568db182d064ed3e3d7eea9
- name: nova/media-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/media-service
  newTag: d558d85069e280ac2568db182d064ed3e3d7eea9
- name: nova/messaging-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/messaging-service
  newTag: d558d85069e280ac2568db182d064ed3e3d7eea9
- name: nova/search-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/search-service
  newTag: d558d85069e280ac2568db182d064ed3e3d7eea9
- name: nova/streaming-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/streaming-service
  newTag: d558d85069e280ac2568db182d064ed3e3d7eea9
- name: nova/user-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/user-service
  newTag: d558d85069e280ac2568db182d064ed3e3d7eea9

replicas:
- count: 1
  name: auth-service
- count: 1
  name: user-service
- count: 1
  name: content-service
- count: 1
  name: feed-service
- count: 1
  name: media-service
- count: 1
  name: messaging-service
- count: 1
  name: search-service
- count: 1
  name: streaming-service

commonAnnotations:
  argocd.argoproj.io/compare-result: "false"
  environment: staging

resources:
- ../../base
- postgres-pvc-gp3.yaml
- clickhouse-pvc.yaml
- sts-rotator.yaml
- secrets-sync.yaml
- resource-optimization-info.configmap.yaml
- nova-messaging-keys.yaml
- nova-clickhouse-credentials.yaml
- clickhouse-chi.yaml
- clickhouse-service-clusterip.yaml
- clickhouse-service-internal.yaml
- external-secrets-store.yaml
- external-secrets.yaml
- seed-data-job.yaml
