apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: nova-staging

# Strategic merge patches for staging environment
# Using JSON 6902 patches with explicit namespace targeting
# This allows patches to work correctly with nested kustomizations
patches:
- target:
    group: apps
    version: v1
    kind: Deployment
    name: content-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: feed-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 512Mi
        limits:
          cpu: 500m
          memory: 1Gi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: media-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 512Mi
        limits:
          cpu: 500m
          memory: 1Gi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: messaging-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 512Mi
        limits:
          cpu: 500m
          memory: 1Gi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: search-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 200m
          memory: 512Mi
        limits:
          cpu: 1000m
          memory: 2Gi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: analytics-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: graph-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: graphql-gateway
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: identity-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: notification-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: ranking-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: realtime-chat-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: social-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: trust-safety-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
# Patch to ensure only one search-service Service definition is used
- target:
    version: v1
    kind: Service
    name: search-service
    namespace: nova-staging
  patch: |-
    - op: replace
      path: /spec/ports
      value:
        - name: http
          port: 8086
          targetPort: 8086
          protocol: TCP

# (migrated to strategic merge patches per service to avoid jsonpatch parent missing)


# 启用以下 patches 以完整配置 staging 环境（strategic merge）
patchesStrategicMerge:
- configmap-patch.yaml
- deployment-images-patch.yaml
- postgres-deploy-patch.yaml
- service-selectors-patch.yaml
- redis-deploy-patch.yaml
- deploy-labels-patch.yaml
- feed-service-env-patch.yaml
# - feed-service-probes-patch.yaml  # TODO: 检查 probe 配置
- messaging-service-env-patch.yaml
- messaging-service-env-port-patch.yaml
- messaging-service-probes-patch.yaml
- messaging-cronjob-patch.yaml
- content-service-env-patch.yaml
- content-service-probes-patch.yaml
- feed-service-init-fix.yaml
- content-service-ports-patch.yaml
- runasuser-patch.yaml
- search-service-env-patch.yaml
- elasticsearch-replicas-patch.yaml
- s3-env-patch.yaml
- prefer-large-nodes-patch.yaml
# Identity-service gRPC-only health checks (no HTTP server)
- identity-service-probes-patch.yaml
# Shared DATABASE_URL wiring for core services
- service-db-env-patch.yaml
# Shared Redis URL wiring for services using Redis
- service-redis-env-patch.yaml
# - resource-optimization-patch.yaml  # 可选：资源优化
- grpc-tls-env-patch.yaml

# Remove deprecated/retired services from staging (none currently included)
# Note: ClickHouse 需要额外的网络隔离 patches

images:
- name: nova/analytics-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/analytics-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/content-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/content-service
  newTag: a421b8273d311cd7d290176cbd6912b20824b218
- name: nova/feed-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/feed-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/graph-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/graph-service
  newTag: 453ce5e7a4447cd313e55bda15d24e8de2e27975
- name: nova/graphql-gateway
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/graphql-gateway
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/identity-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/identity-service
  newTag: dae305a3b9bbbb3a3257b3e8b1162f24608aefe9
- name: nova/media-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/media-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/notification-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/notification-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/ranking-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/ranking-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/realtime-chat-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/realtime-chat-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/search-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/search-service
  newTag: dbd971aa18d2a18f14b4901b573436c4cb0f0e8f
- name: nova/social-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/social-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5
- name: nova/trust-safety-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/trust-safety-service
  newTag: c849ea7287e61bc77123ee9d58b3f47cb2901cb5

# Staging replica overrides to keep core path light
replicas:
  # Disable non-critical services temporarily to free CPU for DB/Redis
  - name: analytics-service
    count: 0
  - name: ranking-service
    count: 0
  - name: realtime-chat-service
    count: 0
  - name: trust-safety-service
    count: 0
  - name: social-service
    count: 0
  - name: api-gateway
    count: 0

  # Keep a single replica for core path services
  - name: content-service
    count: 1
  - name: graph-service
    count: 1
  - name: graphql-gateway
    count: 1
  - name: media-service
    count: 1
  - name: notification-service
    count: 1
  - name: search-service
    count: 1

commonAnnotations:
  argocd.argoproj.io/compare-result: "false"
  environment: staging

resources:
- ../../base
- postgres-pvc-gp3.yaml
- clickhouse-pvc.yaml
- sts-rotator.yaml
- secrets-sync.yaml
- content-service-configmap.yaml
- media-service-configmap.yaml
- resource-optimization-info.configmap.yaml
- nova-messaging-keys.yaml
- nova-clickhouse-credentials.yaml
- clickhouse-chi.yaml
- clickhouse-service-clusterip.yaml
- clickhouse-service-internal.yaml
- seed-data-job.yaml

# ========================================
# P0 Priority: Core Service Infrastructure
# ========================================
# gRPC service discovery和 networking 交由 microservices 自带 Service 定义管理，避免重复

# Database migration job (runs before services start)
- sqlx-migrate-job.yaml

# PostgreSQL multi-database initialization
- postgres-multi-db-init.yaml

# ========================================
# P1 Priority: Service Startup Orchestration
# ========================================
# Init containers for dependency ordering
# ❌ COMMENTED: service-init-containers-patch.yaml - 导致资源ID冲突
# - service-init-containers-patch.yaml

# ========================================
# P2 Priority: Data & Event Infrastructure
# ========================================
# Redis cluster for caching and sessions
- redis-cluster-statefulset.yaml

# Kafka + Zookeeper for event streaming
- kafka-zookeeper-deployment.yaml

# ClickHouse for analytics
- clickhouse-installation.yaml

# ========================================
# P3 Priority: API Contract Management
# ========================================
# Protocol Buffer definitions and service registry
- proto-management.yaml

# ========================================
# P4 Priority: Microservice Deployments
# ========================================
# All application service deployments from microservices directory kustomization
- ../../../microservices

# ========================================
# PgBouncer connection pooling (P1 Priority)
# ========================================
- ../../pgbouncer
