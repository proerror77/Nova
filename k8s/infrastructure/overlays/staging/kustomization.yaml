apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: nova

patchesStrategicMerge:
- deployment-patch.yaml
- secrets-patch.yaml
- configmap-patch.yaml
- deployment-images-patch.yaml
- postgres-deploy-patch.yaml
- service-selectors-patch.yaml
- redis-deploy-patch.yaml
- deploy-labels-patch.yaml
- user-service-env-patch.yaml
- user-service-probes-patch.yaml
- feed-service-env-patch.yaml
- feed-service-probes-patch.yaml
- messaging-service-env-patch.yaml
- messaging-service-env-port-patch.yaml
- messaging-service-probes-patch.yaml
- content-service-env-patch.yaml
- content-service-probes-patch.yaml
- streaming-service-env-patch.yaml
- search-service-env-patch.yaml
- elasticsearch-replicas-patch.yaml
- s3-env-patch.yaml
- hpa-min1-patch.yaml
- prefer-large-nodes-patch.yaml
- resource-optimization-patch.yaml
# Harden ClickHouse exposure

images:
- name: nova/analytics-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/analytics-service
  newTag: a3c6095ad20277c62133862f6e9425c98d0f9bc3
- name: nova/content-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/content-service
  newTag: a3c6095ad20277c62133862f6e9425c98d0f9bc3
- name: nova/feed-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/feed-service
  newTag: a3c6095ad20277c62133862f6e9425c98d0f9bc3
- name: nova/graph-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/graph-service
  newTag: a3c6095ad20277c62133862f6e9425c98d0f9bc3
- name: nova/graphql-gateway
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/graphql-gateway
  newTag: a3c6095ad20277c62133862f6e9425c98d0f9bc3
- name: nova/identity-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/identity-service
  newTag: a3c6095ad20277c62133862f6e9425c98d0f9bc3
- name: nova/media-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/media-service
  newTag: a3c6095ad20277c62133862f6e9425c98d0f9bc3
- name: nova/notification-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/notification-service
  newTag: a3c6095ad20277c62133862f6e9425c98d0f9bc3
- name: nova/ranking-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/ranking-service
  newTag: a3c6095ad20277c62133862f6e9425c98d0f9bc3
- name: nova/realtime-chat-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/realtime-chat-service
  newTag: a3c6095ad20277c62133862f6e9425c98d0f9bc3
- name: nova/search-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/search-service
  newTag: a3c6095ad20277c62133862f6e9425c98d0f9bc3
- name: nova/social-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/social-service
  newTag: a3c6095ad20277c62133862f6e9425c98d0f9bc3
- name: nova/trust-safety-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/trust-safety-service
  newTag: a3c6095ad20277c62133862f6e9425c98d0f9bc3
- name: nova/user-service
  newName: 025434362120.dkr.ecr.ap-northeast-1.amazonaws.com/nova/user-service
  newTag: a3c6095ad20277c62133862f6e9425c98d0f9bc3

replicas:
- count: 1
  name: analytics-service
- count: 1
  name: content-service
- count: 1
  name: feed-service
- count: 1
  name: graph-service
- count: 1
  name: graphql-gateway
- count: 1
  name: identity-service
- count: 1
  name: media-service
- count: 1
  name: notification-service
- count: 1
  name: ranking-service
- count: 1
  name: realtime-chat-service
- count: 1
  name: search-service
- count: 1
  name: social-service
- count: 1
  name: trust-safety-service
- count: 1
  name: user-service

commonAnnotations:
  argocd.argoproj.io/compare-result: "false"
  environment: staging

resources:
- ../../base
- postgres-pvc-gp3.yaml
- clickhouse-pvc.yaml
- sts-rotator.yaml
- secrets-sync.yaml
- resource-optimization-info.configmap.yaml
- nova-messaging-keys.yaml
- nova-clickhouse-credentials.yaml
- clickhouse-chi.yaml
- clickhouse-service-clusterip.yaml
- clickhouse-service-internal.yaml
- external-secrets-store.yaml
- external-secrets.yaml
- seed-data-job.yaml
# PgBouncer connection pooling (P1 Priority)
- ../../pgbouncer
