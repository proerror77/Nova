# å¾®æœåŠ¡å¯åŠ¨ä¾èµ–ç®¡ç†
# ä¸ºå„ä¸ªå¾®æœåŠ¡æ·»åŠ  Init Containerï¼Œç¡®ä¿ä¾èµ–æœåŠ¡å…ˆå¯åŠ¨
# è¿™é¿å…äº†çº§è”æ•…éšœå’Œå¯åŠ¨é¡ºåºæ··ä¹±

---
# feed-service ä¾èµ–ï¼škafka + content-service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: feed-service
spec:
  template:
    spec:
      initContainers:
      - name: wait-for-kafka
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          echo "â³ Waiting for kafka:9092..."
          for i in $(seq 1 30); do
            if nc -zv kafka.nova-staging.svc.cluster.local 9092 2>/dev/null; then
              echo "âœ“ kafka is ready"
              exit 0
            fi
            echo "  Attempt $i/30, retrying..."
            sleep 2
          done
          echo "âŒ kafka is not ready"
          exit 1

# search-service ä¾èµ–ï¼špostgres + elasticsearch
apiVersion: apps/v1
kind: Deployment
metadata:
  name: search-service
spec:
  template:
    spec:
      initContainers:
      - name: wait-for-postgres
        image: postgres:15-alpine
        command:
        - sh
        - -c
        - |
          echo "â³ Waiting for postgres:5432..."
          for i in $(seq 1 30); do
            if PGPASSWORD="$DB_PASSWORD" psql -h postgres.nova-staging.svc.cluster.local -U "$DB_USER" -d postgres -c "SELECT 1" 2>/dev/null; then
              echo "âœ“ postgres is ready"
              exit 0
            fi
            sleep 2
          done
          exit 1
        env:
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: DB_USER
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: DB_PASSWORD

      - name: wait-for-elasticsearch
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          echo "â³ Waiting for elasticsearch:9200..."
          for i in $(seq 1 30); do
            if nc -zv elasticsearch.nova-staging.svc.cluster.local 9200 2>/dev/null; then
              echo "âœ“ elasticsearch is ready"
              exit 0
            fi
            sleep 2
          done
          exit 1

---
# analytics-service ä¾èµ–ï¼škafka + clickhouse
apiVersion: apps/v1
kind: Deployment
metadata:
  name: analytics-service
spec:
  template:
    spec:
      initContainers:
      - name: wait-for-kafka
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          echo "â³ Waiting for kafka:9092..."
          for i in $(seq 1 30); do
            if nc -zv kafka.nova-staging.svc.cluster.local 9092 2>/dev/null; then
              echo "âœ“ kafka is ready"
              exit 0
            fi
            sleep 2
          done
          exit 1

      - name: wait-for-clickhouse
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          echo "â³ Waiting for clickhouse:9000..."
          for i in $(seq 1 30); do
            if nc -zv clickhouse.nova-staging.svc.cluster.local 9000 2>/dev/null; then
              echo "âœ“ clickhouse is ready"
              exit 0
            fi
            sleep 2
          done
          exit 1

---
# graph-service ä¾èµ–ï¼šneo4j
apiVersion: apps/v1
kind: Deployment
metadata:
  name: graph-service
spec:
  template:
    spec:
      initContainers:
      - name: wait-for-neo4j
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          echo "â³ Waiting for neo4j:7687..."
          for i in $(seq 1 30); do
            if nc -zv neo4j.nova-staging.svc.cluster.local 7687 2>/dev/null; then
              echo "âœ“ neo4j is ready"
              exit 0
            fi
            sleep 2
          done
          exit 1

---
# notification-service ä¾èµ–ï¼šredis
apiVersion: apps/v1
kind: Deployment
metadata:
  name: notification-service
spec:
  template:
    spec:
      initContainers:
      - name: wait-for-redis
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          echo "â³ Waiting for redis:6379..."
          for i in $(seq 1 30); do
            if nc -zv redis-cluster.nova-staging.svc.cluster.local 6379 2>/dev/null; then
              echo "âœ“ redis is ready"
              exit 0
            fi
            sleep 2
          done
          exit 1

---
# ranking-service ä¾èµ–ï¼šredis + postgres
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ranking-service
spec:
  template:
    spec:
      initContainers:
      - name: wait-for-redis
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          echo "â³ Waiting for redis:6379..."
          for i in $(seq 1 30); do
            if nc -zv redis-cluster.nova-staging.svc.cluster.local 6379 2>/dev/null; then
              echo "âœ“ redis is ready"
              exit 0
            fi
            sleep 2
          done
          exit 1

      - name: wait-for-postgres
        image: postgres:15-alpine
        command:
        - sh
        - -c
        - |
          echo "â³ Waiting for postgres:5432..."
          for i in $(seq 1 30); do
            if PGPASSWORD="$DB_PASSWORD" psql -h postgres.nova-staging.svc.cluster.local -U "$DB_USER" -d postgres -c "SELECT 1" 2>/dev/null; then
              echo "âœ“ postgres is ready"
              exit 0
            fi
            sleep 2
          done
          exit 1
        env:
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: DB_USER
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: DB_PASSWORD

---
# realtime-chat-service ä¾èµ–ï¼šredis + kafka only (é€šè¿‡ messaging-events è§£è€¦)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: realtime-chat-service
spec:
  template:
    spec:
      initContainers:
      - name: realtime-chat-db-migrate
        image: postgres:15-alpine
        command:
        - sh
        - -c
        - |
          set -euo pipefail
          echo "â³ Waiting for postgres:5432..."
          for i in $(seq 1 60); do
            if PGPASSWORD="$DB_PASSWORD" psql -h postgres.nova-staging.svc.cluster.local -U "$DB_USER" -d postgres -c "SELECT 1" 2>/dev/null; then
              echo "âœ“ postgres is ready"
              break
            fi
            sleep 2
          done

          echo "ðŸ› ï¸  Ensuring realtime-chat metadata index exists (ux_messages_matrix_event_id)..."
          PGPASSWORD="$DB_PASSWORD" psql \
            -h postgres.nova-staging.svc.cluster.local \
            -U "$DB_USER" \
            -d nova_realtime_chat \
            -v ON_ERROR_STOP=1 \
            -c "DO \\$\\$ BEGIN \
                  IF to_regclass('public.messages') IS NOT NULL \
                     AND EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema='public' AND table_name='messages' AND column_name='matrix_event_id') THEN \
                    EXECUTE 'CREATE UNIQUE INDEX IF NOT EXISTS ux_messages_matrix_event_id ON public.messages(matrix_event_id) WHERE matrix_event_id IS NOT NULL'; \
                  END IF; \
                END \\$\\$;"

          echo "âœ“ realtime-chat DB migration complete"
        env:
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: DB_USER
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: DB_PASSWORD
      - name: wait-for-redis
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          echo "â³ Waiting for redis:6379..."
          for i in $(seq 1 30); do
            if nc -zv redis-cluster.nova-staging.svc.cluster.local 6379 2>/dev/null; then
              echo "âœ“ redis is ready"
              exit 0
            fi
            sleep 2
          done
          exit 1

---
# trust-safety-service ä¾èµ–ï¼špostgres + kafka
apiVersion: apps/v1
kind: Deployment
metadata:
  name: trust-safety-service
spec:
  template:
    spec:
      initContainers:
      - name: wait-for-postgres
        image: postgres:15-alpine
        command:
        - sh
        - -c
        - |
          echo "â³ Waiting for postgres:5432..."
          for i in $(seq 1 30); do
            if PGPASSWORD="$DB_PASSWORD" psql -h postgres.nova-staging.svc.cluster.local -U "$DB_USER" -d postgres -c "SELECT 1" 2>/dev/null; then
              echo "âœ“ postgres is ready"
              exit 0
            fi
            sleep 2
          done
          exit 1
        env:
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: DB_USER
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: DB_PASSWORD

      - name: wait-for-kafka
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          echo "â³ Waiting for kafka:9092..."
          for i in $(seq 1 30); do
            if nc -zv kafka.nova-staging.svc.cluster.local 9092 2>/dev/null; then
              echo "âœ“ kafka is ready"
              exit 0
            fi
            sleep 2
          done
          exit 1

---
# content-service ä¾èµ–ï¼špostgres
apiVersion: apps/v1
kind: Deployment
metadata:
  name: content-service
spec:
  template:
    spec:
      initContainers:
      - name: wait-for-postgres
        image: postgres:15-alpine
        command:
        - sh
        - -c
        - |
          echo "â³ Waiting for postgres:5432..."
          for i in $(seq 1 30); do
            if PGPASSWORD="$DB_PASSWORD" psql -h postgres.nova-staging.svc.cluster.local -U "$DB_USER" -d postgres -c "SELECT 1" 2>/dev/null; then
              echo "âœ“ postgres is ready"
              exit 0
            fi
            sleep 2
          done
          exit 1
        env:
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: DB_USER
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: DB_PASSWORD

---
# media-service ä¾èµ–ï¼špostgres only (é€šè¿‡ Kafka nova.media.events ä¸Ž content-service è§£è€¦)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: media-service
spec:
  template:
    spec:
      initContainers:
      - name: wait-for-postgres
        image: postgres:15-alpine
        command:
        - sh
        - -c
        - |
          echo "â³ Waiting for postgres:5432..."
          for i in $(seq 1 30); do
            if PGPASSWORD="$DB_PASSWORD" psql -h postgres.nova-staging.svc.cluster.local -U "$DB_USER" -d postgres -c "SELECT 1" 2>/dev/null; then
              echo "âœ“ postgres is ready"
              exit 0
            fi
            sleep 2
          done
          exit 1
        env:
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: DB_USER
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: DB_PASSWORD

---
# identity-service ä¾èµ–ï¼špostgres only (æ›¿ä»£äº† user-service)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: identity-service
spec:
  template:
    spec:
      initContainers:
      - name: wait-for-postgres
        image: postgres:15-alpine
        command:
        - sh
        - -c
        - |
          echo "â³ Waiting for postgres:5432..."
          for i in $(seq 1 30); do
            if PGPASSWORD="$DB_PASSWORD" psql -h postgres.nova-staging.svc.cluster.local -U "$DB_USER" -d postgres -c "SELECT 1" 2>/dev/null; then
              echo "âœ“ postgres is ready"
              exit 0
            fi
            sleep 2
          done
          exit 1
        env:
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: DB_USER
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: DB_PASSWORD

---
# feature-store ä¾èµ–ï¼špostgres + kafka + redis (ç‰¹å¾å­˜å‚¨)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: feature-store
spec:
  template:
    spec:
      initContainers:
      - name: wait-for-postgres
        image: postgres:15-alpine
        command:
        - sh
        - -c
        - |
          echo "â³ Waiting for postgres:5432..."
          for i in $(seq 1 30); do
            if PGPASSWORD="$DB_PASSWORD" psql -h postgres.nova-staging.svc.cluster.local -U "$DB_USER" -d postgres -c "SELECT 1" 2>/dev/null; then
              echo "âœ“ postgres is ready"
              exit 0
            fi
            sleep 2
          done
          exit 1
        env:
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: DB_USER
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: DB_PASSWORD

      - name: wait-for-kafka
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          echo "â³ Waiting for kafka:9092..."
          for i in $(seq 1 30); do
            if nc -zv kafka.nova-staging.svc.cluster.local 9092 2>/dev/null; then
              echo "âœ“ kafka is ready"
              exit 0
            fi
            sleep 2
          done
          exit 1

      - name: wait-for-redis
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          echo "â³ Waiting for redis:6379..."
          for i in $(seq 1 30); do
            if nc -zv redis-cluster.nova-staging.svc.cluster.local 6379 2>/dev/null; then
              echo "âœ“ redis is ready"
              exit 0
            fi
            sleep 2
          done
          exit 1
