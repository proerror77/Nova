# Redis Standalone for Nova Staging
# Single-node Redis with persistence for caching, sessions, and rate limiting
# Used by: notification-service, ranking-service, realtime-chat-service
# Port: 6379
# NOTE: Staging uses standalone mode (replicas: 1) for simplicity.
#       For production, consider Redis Cluster with 3+ nodes.

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-cluster-config
  namespace: nova-staging
  labels:
    app: redis-cluster
data:
  redis.conf: |
    # Redis Standalone configuration for Staging
    port 6379
    bind 0.0.0.0

    # Disable cluster mode for single-node staging
    cluster-enabled no

    # Persistence - RDB snapshots
    save 900 1
    save 300 10
    save 60 10000
    dbfilename dump.rdb
    dir /var/lib/redis

    # AOF persistence for durability
    appendonly yes
    appendfsync everysec
    appendfilename "appendonly.aof"

    # Memory management
    maxmemory 450mb
    maxmemory-policy allkeys-lru

    # Timeout and keepalive
    timeout 300
    tcp-keepalive 300

    # Logging
    loglevel notice

    # Databases
    databases 16

    # Security (no password for staging)
    # For production, use: requirepass <strong-password>
    protected-mode no

  redis-init.sh: |
    #!/bin/bash
    set -e

    echo "Redis Standalone Initialization - $(date)"
    echo "========================================"

    REDIS_HOST="redis-cluster-0.redis-cluster-headless.nova-staging.svc.cluster.local"

    # Wait for Redis to be ready
    echo "Waiting for Redis to be ready..."
    for retry in $(seq 1 30); do
      if redis-cli -h "$REDIS_HOST" -p 6379 ping 2>/dev/null | grep -q PONG; then
        echo "‚úì Redis is ready"
        break
      fi

      if [ $retry -eq 30 ]; then
        echo "‚ùå Redis timeout"
        exit 1
      fi

      echo "  Attempt $retry/30..."
      sleep 2
    done

    echo ""
    echo "========================================"
    echo "‚úÖ Redis Initialization Complete"
    echo ""
    echo "Redis Info:"
    redis-cli -h "$REDIS_HOST" -p 6379 INFO server | head -10
    echo ""
    echo "Memory Info:"
    redis-cli -h "$REDIS_HOST" -p 6379 INFO memory | grep -E "used_memory_human|maxmemory_human"

---
apiVersion: v1
kind: Service
metadata:
  name: redis-cluster-headless
  namespace: nova-staging
  labels:
    app: redis-cluster
spec:
  type: ClusterIP
  clusterIP: None
  selector:
    app: redis-cluster
  ports:
  - name: client
    port: 6379
    targetPort: 6379
    protocol: TCP

---
apiVersion: v1
kind: Service
metadata:
  name: redis-cluster
  namespace: nova-staging
  labels:
    app: redis-cluster
spec:
  type: ClusterIP
  selector:
    app: redis-cluster
  ports:
  - name: client
    port: 6379
    targetPort: 6379
    protocol: TCP
  - name: metrics
    port: 9121
    targetPort: 9121
    protocol: TCP

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis-cluster
  namespace: nova-staging
  labels:
    app: redis-cluster
spec:
  serviceName: redis-cluster-headless
  replicas: 1
  selector:
    matchLabels:
      app: redis-cluster
  template:
    metadata:
      labels:
        app: redis-cluster
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values: [redis-cluster]
              topologyKey: kubernetes.io/hostname

      securityContext:
        fsGroup: 999
        runAsNonRoot: true
        runAsUser: 999

      # Init container removed - circular dependency issue
      # Cluster initialization handled by separate Job after all pods are Running

      containers:
      - name: redis
        image: redis:7-alpine
        command:
        - redis-server
        - /etc/redis/redis.conf

        ports:
        - name: client
          containerPort: 6379
          protocol: TCP

        env:
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace

        livenessProbe:
          exec:
            command:
            - redis-cli
            - ping
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3

        readinessProbe:
          exec:
            command:
            - redis-cli
            - ping
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 1
          failureThreshold: 3

        resources:
          requests:
            cpu: 50m
            memory: 256Mi
          limits:
            cpu: 300m
            memory: 512Mi

        volumeMounts:
        - name: redis-config
          mountPath: /etc/redis
          readOnly: true
        - name: redis-data
          mountPath: /var/lib/redis

        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 999
          capabilities:
            drop:
            - ALL

      volumes:
      - name: redis-config
        configMap:
          name: redis-cluster-config
          items:
          - key: redis.conf
            path: redis.conf
      - name: redis-data
        emptyDir: {}

  volumeClaimTemplates:
  - metadata:
      name: redis-data
      labels:
        app: redis-cluster
    spec:
      accessModes:
      - ReadWriteOnce
      storageClassName: standard-rwo
      resources:
        requests:
          storage: 10Gi

---
# Redis initialization Job - verifies Redis is ready and performs health check
# This Job is idempotent and can be safely re-run
apiVersion: batch/v1
kind: Job
metadata:
  name: redis-init
  namespace: nova-staging
  labels:
    app: redis-cluster
    component: init
spec:
  ttlSecondsAfterFinished: 3600
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: redis-init
    spec:
      restartPolicy: Never
      initContainers:
      - name: wait-for-redis
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          echo "Waiting for Redis StatefulSet to be ready..."
          for i in $(seq 1 60); do
            if nc -z redis-cluster-0.redis-cluster-headless.nova-staging.svc.cluster.local 6379 2>/dev/null; then
              echo "‚úì Redis port 6379 is open"
              exit 0
            fi
            echo "  Attempt $i/60, retrying..."
            sleep 2
          done
          echo "‚ùå Redis is not ready"
          exit 1
      containers:
      - name: redis-init
        image: redis:7-alpine
        command:
        - sh
        - -c
        - |
          set -e
          echo "üî¥ Redis Initialization - $(date)"
          echo "========================================"

          REDIS_HOST="redis-cluster-0.redis-cluster-headless.nova-staging.svc.cluster.local"

          # Verify Redis is responding
          echo "Verifying Redis connection..."
          if ! redis-cli -h "$REDIS_HOST" -p 6379 ping | grep -q PONG; then
            echo "‚ùå Redis is not responding to PING"
            exit 1
          fi
          echo "‚úì Redis PING successful"

          # Check Redis mode (should be standalone, not cluster)
          echo ""
          echo "Checking Redis mode..."
          MODE=$(redis-cli -h "$REDIS_HOST" -p 6379 INFO cluster 2>/dev/null | grep cluster_enabled | cut -d: -f2 | tr -d '\r')
          if [ "$MODE" = "1" ]; then
            echo "‚ö†Ô∏è  Warning: Redis is running in cluster mode but staging expects standalone"
          else
            echo "‚úì Redis is running in standalone mode (expected for staging)"
          fi

          # Display Redis info
          echo ""
          echo "========================================"
          echo "üìä Redis Server Info:"
          redis-cli -h "$REDIS_HOST" -p 6379 INFO server | grep -E "redis_version|os:|arch_bits|process_id|uptime"

          echo ""
          echo "üíæ Memory Info:"
          redis-cli -h "$REDIS_HOST" -p 6379 INFO memory | grep -E "used_memory_human|maxmemory_human|mem_fragmentation"

          echo ""
          echo "üíø Persistence Info:"
          redis-cli -h "$REDIS_HOST" -p 6379 INFO persistence | grep -E "rdb_|aof_"

          echo ""
          echo "üìà Stats:"
          redis-cli -h "$REDIS_HOST" -p 6379 INFO stats | grep -E "total_connections|instantaneous_ops|keyspace"

          echo ""
          echo "========================================"
          echo "‚úÖ Redis Initialization Complete"
          echo "Redis is ready to accept connections at:"
          echo "  - redis-cluster.nova-staging.svc.cluster.local:6379"
          echo "  - redis-cluster-0.redis-cluster-headless.nova-staging.svc.cluster.local:6379"
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 128Mi

---
# Prometheus ServiceMonitor for Redis metrics (optional)
apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-exporter-config
  namespace: nova-staging
data:
  redis-exporter.sh: |
    #!/bin/sh
    # Simple redis-exporter sidecar can be added if needed
    # For now, Redis exposes metrics via INFO command
    exec redis_exporter \
      -redis.addr=redis-cluster-0.redis-cluster-headless.nova-staging.svc.cluster.local:6379 \
      -redis.password="" \
      -namespace=redis \
      -check-single-stream
