# SQLx æ•°æ®åº“è¿ç§» Job
# åœ¨æœåŠ¡å¯åŠ¨å‰è‡ªåŠ¨è¿è¡Œæ‰€æœ‰æ•°æ®åº“è¿ç§»è„šæœ¬
# ä¿è¯æ•°æ®åº“ schema æœ€æ–°

apiVersion: v1
kind: ConfigMap
metadata:
  name: sqlx-migrate-script
  namespace: nova-staging
  labels:
    app: sqlx-migrate
data:
  run-migrations.sh: |
    #!/bin/bash
    set -euo pipefail

    echo "ðŸ—„ï¸  SQLx Migration Runner - Starting at $(date)"
    echo "========================================"

    # é…ç½®
    DB_HOST="${DB_HOST:-postgres.nova-staging.svc.cluster.local}"
    DB_PORT="${DB_PORT:-5432}"
    DB_USER="${DB_USER:-nova_staging}"
    DB_RETRY_LIMIT=30
    DB_RETRY_COUNT=0

    # ç­‰å¾… PostgreSQL å°±ç»ª
    echo "â³ Waiting for PostgreSQL at $DB_HOST:$DB_PORT..."
    while [ $DB_RETRY_COUNT -lt $DB_RETRY_LIMIT ]; do
      if PGPASSWORD="$DB_PASSWORD" psql \
          -h "$DB_HOST" \
          -p "$DB_PORT" \
          -U "$DB_USER" \
          -d postgres \
          -c "SELECT 1" 2>/dev/null; then
        echo "âœ“ PostgreSQL is ready"
        break
      fi
      DB_RETRY_COUNT=$((DB_RETRY_COUNT + 1))
      echo "  Attempt $DB_RETRY_COUNT/$DB_RETRY_LIMIT..."
      sleep 2
    done

    if [ $DB_RETRY_COUNT -eq $DB_RETRY_LIMIT ]; then
      echo "âŒ PostgreSQL connection timeout after $((DB_RETRY_LIMIT * 2)) seconds"
      exit 1
    fi

    # æž„å»ºæ•°æ®åº“ URL
    DATABASE_URL="postgresql://$DB_USER:$DB_PASSWORD@$DB_HOST:$DB_PORT"

    # èŽ·å–æ‰€æœ‰éœ€è¦è¿ç§»çš„æ•°æ®åº“åˆ—è¡¨
    DATABASES=(
      "nova_auth"
      "nova_user"
      "nova_content"
      "nova_feed"
      "nova_messaging"
      "nova_search"
      "nova_notification"
      "nova_media"
      "nova_analytics"
      "nova_graph"
      "nova_ranking"
      "nova_feature_store"
      "nova_identity"
      "nova_trust_safety"
      "nova_realtime_chat"
    )

    echo ""
    echo "ðŸ”„ Running migrations for ${#DATABASES[@]} databases..."
    echo "========================================"

    FAILED=0
    SUCCEEDED=0

    for DB in "${DATABASES[@]}"; do
      echo ""
      echo "ðŸ“¦ Database: $DB"

      # åˆ›å»ºæ•°æ®åº“ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
      PGPASSWORD="$DB_PASSWORD" psql \
        -h "$DB_HOST" \
        -p "$DB_PORT" \
        -U "$DB_USER" \
        -d postgres \
        -c "CREATE DATABASE $DB;" 2>/dev/null || true

      # è¿è¡Œè¿ç§»
      DB_URL="$DATABASE_URL/$DB"

      if sqlx database create --database-url "$DB_URL" 2>/dev/null || true; then
        echo "  âœ“ Database created/verified"
      fi

      # åº”ç”¨è¿ç§»è„šæœ¬ï¼ˆä»Ž ConfigMap çš„ SQL æ–‡ä»¶ï¼‰
      if [ -d "/migrations/$DB" ]; then
        for migration in /migrations/$DB/*.sql; do
          if [ -f "$migration" ]; then
            echo "  â†’ Applying $(basename $migration)..."
            PGPASSWORD="$DB_PASSWORD" psql \
              -h "$DB_HOST" \
              -p "$DB_PORT" \
              -U "$DB_USER" \
              -d "$DB" \
              -f "$migration" \
              -v ON_ERROR_STOP=1 \
              --quiet || {
              echo "  âš ï¸  Migration $(basename $migration) skipped (may already be applied)"
            }
          fi
        done
        echo "  âœ“ All migrations applied"
        SUCCEEDED=$((SUCCEEDED + 1))
      else
        echo "  â„¹ï¸  No migrations found for $DB (using auto-init)"
        SUCCEEDED=$((SUCCEEDED + 1))
      fi
    done

    echo ""
    echo "========================================"
    echo "âœ… Migration Complete"
    echo "   Databases: $SUCCEEDED succeeded, $FAILED failed"
    echo "   Time: $(date)"
    exit 0

---
apiVersion: batch/v1
kind: Job
metadata:
  name: sqlx-migrate
  namespace: nova-staging
  labels:
    app: sqlx-migrate
    job-type: database-migration
  annotations:
    description: "Run SQLx database migrations for all Nova services"
    version: "1.0"
spec:
  # Job å®ŒæˆåŽ 1 å°æ—¶è‡ªåŠ¨æ¸…ç†
  ttlSecondsAfterFinished: 3600

  # é‡è¯•ç­–ç•¥
  backoffLimit: 3

  # è¶…æ—¶æ—¶é—´ï¼ˆ15 åˆ†é’Ÿï¼‰
  activeDeadlineSeconds: 900

  template:
    metadata:
      labels:
        app: sqlx-migrate
        job-type: database-migration
    spec:
      # åªè¿è¡Œä¸€æ¬¡
      restartPolicy: Never

      serviceAccountName: default

      # åˆå§‹åŒ–å®¹å™¨ï¼šéªŒè¯ä¾èµ–
      initContainers:
      - name: wait-for-postgres
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          echo "Waiting for PostgreSQL..."
          for i in $(seq 1 30); do
            if nc -zv postgres.nova-staging.svc.cluster.local 5432; then
              echo "âœ“ PostgreSQL is ready"
              exit 0
            fi
            echo "Attempt $i/30, retrying in 2 seconds..."
            sleep 2
          done
          echo "âŒ PostgreSQL not ready"
          exit 1

      # ä¸»å®¹å™¨ï¼šè¿è¡Œè¿ç§»
      containers:
      - name: sqlx-migrate
        image: postgres:15-alpine  # åŒ…å« psql å’ŒåŸºç¡€å·¥å…·

        command:
        - /bin/sh
        - -c
        - |
          # å®‰è£… sqlx-cli
          apk add --no-cache curl bash

          # ä¸‹è½½ sqlx-cliï¼ˆå¯é€‰ï¼Œä½¿ç”¨ psql ä¹Ÿå¯ä»¥ï¼‰
          # curl -L https://github.com/launchbadge/sqlx-cli/releases/download/v0.7.3/sqlx-v0.7.3-x86_64-unknown-linux-musl.tar.gz | tar xz -C /usr/local/bin

          # è¿è¡Œè¿ç§»è„šæœ¬
          bash /migrations/run-migrations.sh

        # çŽ¯å¢ƒå˜é‡
        env:
        - name: DB_HOST
          value: "postgres.nova-staging.svc.cluster.local"
        - name: DB_PORT
          value: "5432"
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: username
              optional: false
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: password
              optional: false

        # èµ„æºé™åˆ¶
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi

        # å·æŒ‚è½½
        volumeMounts:
        - name: migrate-script
          mountPath: /migrations
          readOnly: true

      # å·å®šä¹‰
      volumes:
      - name: migrate-script
        configMap:
          name: sqlx-migrate-script
          defaultMode: 0755

      # Pod å¹²æ‰°é¢„ç®—ï¼ˆç¡®ä¿è¿ç§»ç¨³å®šè¿è¡Œï¼‰
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values: [postgres]
              topologyKey: kubernetes.io/hostname

---
# ä¸ºäº†åœ¨ staging åˆå§‹åŒ–æ—¶è‡ªåŠ¨è¿è¡Œè¿ç§»ï¼Œåˆ›å»ºä¸€ä¸ªä¾èµ–çš„èµ„æº
apiVersion: v1
kind: ConfigMap
metadata:
  name: migration-status
  namespace: nova-staging
  labels:
    app: sqlx-migrate
data:
  status: "pending"  # åˆå§‹çŠ¶æ€ï¼špending -> running -> completed
