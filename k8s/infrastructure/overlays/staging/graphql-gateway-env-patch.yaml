# GraphQL Gateway Service URL patches for staging
# Configure correct service URLs for gRPC connections with mTLS
# IMPORTANT: Use GRPC_* prefix for URLs read by grpc-clients library

apiVersion: apps/v1
kind: Deployment
metadata:
  name: graphql-gateway
spec:
  template:
    spec:
      containers:
      - name: graphql-gateway
        env:
        # ============================================================
        # gRPC Service URLs (GRPC_* prefix required by grpc-clients lib)
        # All internal services use https:// for mTLS
        # 端口配置与 staging 集群实际运行一致
        # ============================================================

        # Feed service - gRPC port 9084 with mTLS
        - name: GRPC_FEED_SERVICE_URL
          value: "https://feed-service.nova-staging.svc.cluster.local:9084"

        # Content service - gRPC port 9080 with mTLS
        - name: GRPC_CONTENT_SERVICE_URL
          value: "https://content-service.nova-staging.svc.cluster.local:9080"

        # Search service - gRPC port 9086 (HTTP is 8086)
        - name: GRPC_SEARCH_SERVICE_URL
          value: "http://search-service.nova-staging.svc.cluster.local:9086"

        # Media service - gRPC port 9085 with mTLS
        - name: GRPC_MEDIA_SERVICE_URL
          value: "https://media-service.nova-staging.svc.cluster.local:9085"

        # Identity service - gRPC port 50051 with mTLS
        - name: GRPC_IDENTITY_SERVICE_URL
          value: "https://identity-service.nova-staging.svc.cluster.local:50051"

        # Social service - gRPC port 50052 with mTLS
        - name: GRPC_SOCIAL_SERVICE_URL
          value: "https://social-service.nova-staging.svc.cluster.local:50052"

        # Chat service - gRPC on 9095 with mTLS (via grpc-mtls-shared)
        - name: GRPC_CHAT_SERVICE_URL
          value: "https://realtime-chat-service.nova-staging.svc.cluster.local:9095"

        # Chat service HTTP URL for Matrix API proxy (port 8080)
        - name: CHAT_SERVICE_HTTP_URL
          value: "http://realtime-chat-service:8080"

        # ============================================================
        # Notification and Graph services (now using GrpcConfig)
        # ============================================================
        - name: GRPC_NOTIFICATION_SERVICE_URL
          value: "http://notification-service.nova-staging.svc.cluster.local:9093"
        - name: GRPC_GRAPH_SERVICE_URL
          value: "https://graph-service.nova-staging.svc.cluster.local:9080"

        # ============================================================
        # TLS/mTLS Configuration
        # Certificate SAN: *.nova-staging.svc.cluster.local (wildcard)
        # ============================================================
        - name: GRPC_TLS_ENABLED
          value: "true"
        - name: GRPC_TLS_CA_CERT_PATH
          value: "/etc/nova/certs/ca.crt"
        # Domain name for TLS verification - wildcard cert allows any *.nova-staging
        - name: GRPC_TLS_DOMAIN_NAME
          value: "feed-service.nova-staging.svc.cluster.local"

        # ============================================================
        # Alice AI Configuration
        # OpenAI-compatible API (tu-zi.com)
        # ============================================================
        - name: OPENAI_API_BASE_URL
          value: "https://api.tu-zi.com/v1"
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: ten-agent-secrets
              key: OPENAI_API_KEY
        - name: GRPC_TLS_CLIENT_CERT_PATH
          value: "/etc/nova/certs/client.crt"
        - name: GRPC_TLS_CLIENT_KEY_PATH
          value: "/etc/nova/certs/client.key"

        volumeMounts:
        - name: grpc-mtls-shared
          mountPath: /etc/nova/certs
          readOnly: true

      volumes:
      - name: grpc-mtls-shared
        secret:
          secretName: grpc-mtls-shared
