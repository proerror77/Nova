# GraphQL Gateway Service URL patches for staging
# Fix: Configure correct service URLs for gRPC connections
apiVersion: apps/v1
kind: Deployment
metadata:
  name: graphql-gateway
spec:
  template:
    spec:
      containers:
      - name: graphql-gateway
        env:
        # Search service uses port 50057 (gRPC) in staging
        # The default config.rs uses port 50060 which doesn't exist
        - name: SEARCH_SERVICE_URL
          value: "http://search-service.nova-staging.svc.cluster.local:50057"
        # Content service gRPC port
        - name: CONTENT_SERVICE_URL
          value: "http://content-service.nova-staging.svc.cluster.local:50051"
        # Notification service gRPC port
        - name: NOTIFICATION_SERVICE_URL
          value: "http://notification-service.nova-staging.svc.cluster.local:50051"
        # Feed service gRPC port (9084 is the actual gRPC port)
        - name: FEED_SERVICE_URL
          value: "http://feed-service.nova-staging.svc.cluster.local:9084"
        # Media service gRPC port
        - name: MEDIA_SERVICE_URL
          value: "http://media-service.nova-staging.svc.cluster.local:50051"
        # gRPC client configuration (TLS/mTLS) for identity-service and core services
        - name: GRPC_IDENTITY_SERVICE_URL
          value: "https://identity-service.nova-staging.svc.cluster.local:50051"
        - name: GRPC_TLS_ENABLED
          value: "true"
        - name: GRPC_TLS_CA_CERT_PATH
          value: "/etc/nova/certs/ca.crt"
        - name: GRPC_TLS_DOMAIN_NAME
          value: "identity-service.nova-staging.svc.cluster.local"
        - name: GRPC_TLS_CLIENT_CERT_PATH
          value: "/etc/nova/certs/client.crt"
        - name: GRPC_TLS_CLIENT_KEY_PATH
          value: "/etc/nova/certs/client.key"
        volumeMounts:
        - name: grpc-mtls-shared
          mountPath: /etc/nova/certs
          readOnly: true
      volumes:
      - name: grpc-mtls-shared
        secret:
          secretName: grpc-mtls-shared
