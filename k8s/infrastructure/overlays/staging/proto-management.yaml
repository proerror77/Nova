# Protocol Buffer Management for Nova Services
# Centralizes .proto file management with version control and discovery
# Enables services to maintain consistent interface definitions

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nova-proto-definitions-v1
  namespace: nova-staging
  labels:
    app: nova-proto
    version: "1.0.0"
    managed-by: kustomize
data:
  # Core proto files for service-to-service communication

  # User Service Proto
  user_service.proto: |
    syntax = "proto3";

    package nova.user;

    option go_package = "github.com/nova-app/user-service/pb";
    option java_package = "com.nova.user";
    option java_multiple_files = true;

    service UserService {
      rpc GetUser(GetUserRequest) returns (User);
      rpc CreateUser(CreateUserRequest) returns (User);
      rpc UpdateUser(UpdateUserRequest) returns (User);
      rpc DeleteUser(DeleteUserRequest) returns (Empty);
      rpc ListUsers(ListUsersRequest) returns (ListUsersResponse);
      rpc ValidateUser(ValidateUserRequest) returns (ValidateUserResponse);
    }

    message User {
      string id = 1;
      string email = 2;
      string username = 3;
      string display_name = 4;
      string avatar_url = 5;
      bool is_active = 6;
      int64 created_at = 7;
      int64 updated_at = 8;
      map<string, string> metadata = 9;
    }

    message GetUserRequest {
      string user_id = 1;
    }

    message CreateUserRequest {
      string email = 1;
      string username = 2;
      string display_name = 3;
      string password_hash = 4;
    }

    message UpdateUserRequest {
      string user_id = 1;
      string display_name = 2;
      string avatar_url = 3;
      map<string, string> metadata = 4;
    }

    message DeleteUserRequest {
      string user_id = 1;
    }

    message ListUsersRequest {
      int32 page = 1;
      int32 page_size = 2;
      string filter = 3;
    }

    message ListUsersResponse {
      repeated User users = 1;
      int32 total = 2;
      int32 page = 3;
      int32 total_pages = 4;
    }

    message ValidateUserRequest {
      string user_id = 1;
    }

    message ValidateUserResponse {
      bool is_valid = 1;
      string reason = 2;
    }

    message Empty {}

  # Content Service Proto
  content_service.proto: |
    syntax = "proto3";

    package nova.content;

    option go_package = "github.com/nova-app/content-service/pb";
    option java_package = "com.nova.content";

    service ContentService {
      rpc GetContent(GetContentRequest) returns (Content);
      rpc CreateContent(CreateContentRequest) returns (Content);
      rpc UpdateContent(UpdateContentRequest) returns (Content);
      rpc DeleteContent(DeleteContentRequest) returns (Empty);
      rpc ListContent(ListContentRequest) returns (ListContentResponse);
      rpc SearchContent(SearchContentRequest) returns (SearchContentResponse);
    }

    message Content {
      string id = 1;
      string user_id = 2;
      string title = 3;
      string description = 4;
      repeated string tags = 5;
      string media_url = 6;
      int64 created_at = 7;
      int64 updated_at = 8;
      int32 view_count = 9;
      int32 like_count = 10;
      ContentStatus status = 11;
    }

    enum ContentStatus {
      STATUS_UNSPECIFIED = 0;
      DRAFT = 1;
      PUBLISHED = 2;
      ARCHIVED = 3;
      DELETED = 4;
    }

    message GetContentRequest {
      string content_id = 1;
    }

    message CreateContentRequest {
      string user_id = 1;
      string title = 2;
      string description = 3;
      repeated string tags = 4;
      string media_url = 5;
    }

    message UpdateContentRequest {
      string content_id = 1;
      string title = 2;
      string description = 3;
      repeated string tags = 4;
      ContentStatus status = 5;
    }

    message DeleteContentRequest {
      string content_id = 1;
    }

    message ListContentRequest {
      int32 page = 1;
      int32 page_size = 2;
      string user_id = 3;
    }

    message ListContentResponse {
      repeated Content content = 1;
      int32 total = 2;
    }

    message SearchContentRequest {
      string query = 1;
      int32 page = 2;
      int32 page_size = 3;
    }

    message SearchContentResponse {
      repeated Content results = 1;
      int32 total = 2;
    }

    message Empty {}

  # Feed Service Proto
  feed_service.proto: |
    syntax = "proto3";

    package nova.feed;

    option go_package = "github.com/nova-app/feed-service/pb";
    option java_package = "com.nova.feed";

    service FeedService {
      rpc GetFeed(GetFeedRequest) returns (FeedResponse);
      rpc GetPersonalizedFeed(PersonalizedFeedRequest) returns (FeedResponse);
      rpc PostContent(PostContentRequest) returns (PostContentResponse);
      rpc UpdateFeedItem(UpdateFeedItemRequest) returns (FeedItem);
    }

    message FeedItem {
      string id = 1;
      string content_id = 2;
      string user_id = 3;
      int64 created_at = 4;
      int32 engagement_score = 5;
    }

    message FeedResponse {
      repeated FeedItem items = 1;
      string next_cursor = 2;
    }

    message GetFeedRequest {
      string user_id = 1;
      int32 limit = 2;
      string cursor = 3;
    }

    message PersonalizedFeedRequest {
      string user_id = 1;
      int32 limit = 2;
      string cursor = 3;
      map<string, float> preferences = 4;
    }

    message PostContentRequest {
      string user_id = 1;
      string content_id = 2;
    }

    message PostContentResponse {
      bool success = 1;
      FeedItem feed_item = 2;
    }

    message UpdateFeedItemRequest {
      string feed_item_id = 1;
      int32 engagement_score = 2;
    }

  # Common types
  common.proto: |
    syntax = "proto3";

    package nova.common;

    option go_package = "github.com/nova-app/common/pb";
    option java_package = "com.nova.common";

    message Timestamp {
      int64 seconds = 1;
      int32 nanos = 2;
    }

    message StringValue {
      string value = 1;
    }

    message Int32Value {
      int32 value = 1;
    }

    message Int64Value {
      int64 value = 1;
    }

    message BoolValue {
      bool value = 1;
    }

    message ListValue {
      repeated string values = 1;
    }

    message Metadata {
      map<string, string> entries = 1;
    }

    message Error {
      string code = 1;
      string message = 2;
      map<string, string> details = 3;
    }

    message PageInfo {
      int32 page = 1;
      int32 page_size = 2;
      int32 total = 3;
      int32 total_pages = 4;
      bool has_next = 5;
      bool has_previous = 6;
    }

  # Version metadata
  VERSION: "1.0.0"
  CHANGELOG.md: |
    # Nova Proto Definitions Changelog

    ## [1.0.0] - 2025-11-14

    ### Added
    - Initial proto definitions for core services
    - UserService with CRUD operations
    - ContentService with search capabilities
    - FeedService with personalization
    - Common message types for reuse

    ### Services
    - user-service
    - content-service
    - feed-service
    - messaging-service
    - search-service
    - notification-service
    - media-service
    - analytics-service
    - graph-service
    - ranking-service
    - feature-store
    - identity-service
    - trust-safety-service
    - realtime-chat-service

---
# Proto definitions ConfigMap with version tracking
apiVersion: v1
kind: ConfigMap
metadata:
  name: nova-proto-versions
  namespace: nova-staging
  labels:
    app: nova-proto
data:
  versions.json: |
    {
      "current": "1.0.0",
      "services": {
        "user-service": {
          "proto_file": "user_service.proto",
          "version": "1.0.0",
          "grpc_package": "nova.user",
          "last_updated": "2025-11-14"
        },
        "content-service": {
          "proto_file": "content_service.proto",
          "version": "1.0.0",
          "grpc_package": "nova.content",
          "last_updated": "2025-11-14"
        },
        "feed-service": {
          "proto_file": "feed_service.proto",
          "version": "1.0.0",
          "grpc_package": "nova.feed",
          "last_updated": "2025-11-14"
        }
      },
      "compatibility": {
        "min_version": "1.0.0",
        "deprecation_policy": "Deprecated features will be removed 2 releases after marked"
      }
    }

  build-script.sh: |
    #!/bin/bash
    # Script to build proto definitions and update services

    set -e

    PROTO_DIR="${PROTO_DIR:-.}"
    OUTPUT_DIR="${OUTPUT_DIR:-./pb}"

    echo "üîß Building Proto Definitions"
    echo "=================================="

    mkdir -p "$OUTPUT_DIR"

    # Compile Go protos
    if command -v protoc &> /dev/null; then
      echo "Compiling proto files..."

      protoc \
        --go_out="$OUTPUT_DIR" \
        --go-grpc_out="$OUTPUT_DIR" \
        --go_opt=paths=source_relative \
        --go-grpc_opt=paths=source_relative \
        "$PROTO_DIR"/*.proto

      echo "‚úì Go proto files generated"
    else
      echo "‚ö†Ô∏è  protoc not installed, skipping compilation"
    fi

    echo ""
    echo "=================================="
    echo "‚úÖ Proto build complete"

---
# ConfigMap for proto-based service registry
apiVersion: v1
kind: ConfigMap
metadata:
  name: nova-service-registry
  namespace: nova-staging
  labels:
    app: nova-proto
data:
  services-registry.json: |
    {
      "services": [
        {
          "name": "user-service",
          "grpc_port": 50051,
          "proto_package": "nova.user",
          "dependencies": [],
          "databases": ["nova_user"],
          "health_check": "GetUser"
        },
        {
          "name": "content-service",
          "grpc_port": 50051,
          "proto_package": "nova.content",
          "dependencies": ["user-service"],
          "databases": ["nova_content"],
          "health_check": "GetContent"
        },
        {
          "name": "feed-service",
          "grpc_port": 50051,
          "proto_package": "nova.feed",
          "dependencies": ["user-service", "content-service"],
          "databases": ["nova_feed"],
          "health_check": "GetFeed"
        },
        {
          "name": "search-service",
          "grpc_port": 50051,
          "proto_package": "nova.search",
          "dependencies": ["content-service"],
          "databases": ["nova_search"],
          "health_check": "Search"
        },
        {
          "name": "messaging-service",
          "grpc_port": 50051,
          "proto_package": "nova.messaging",
          "dependencies": ["user-service"],
          "databases": ["nova_messaging"],
          "health_check": "GetMessages"
        },
        {
          "name": "notification-service",
          "grpc_port": 50051,
          "proto_package": "nova.notification",
          "dependencies": [],
          "databases": ["nova_notification"],
          "health_check": "GetNotifications"
        },
        {
          "name": "media-service",
          "grpc_port": 50051,
          "proto_package": "nova.media",
          "dependencies": [],
          "databases": ["nova_media"],
          "health_check": "GetMedia"
        },
        {
          "name": "analytics-service",
          "grpc_port": 50051,
          "proto_package": "nova.analytics",
          "dependencies": [],
          "databases": ["nova_analytics"],
          "health_check": "GetAnalytics"
        },
        {
          "name": "graph-service",
          "grpc_port": 50051,
          "proto_package": "nova.graph",
          "dependencies": ["user-service"],
          "databases": ["nova_graph"],
          "health_check": "GetGraph"
        },
        {
          "name": "ranking-service",
          "grpc_port": 50051,
          "proto_package": "nova.ranking",
          "dependencies": ["content-service", "user-service"],
          "databases": ["nova_ranking"],
          "health_check": "GetRanking"
        },
        {
          "name": "feature-store",
          "grpc_port": 50051,
          "proto_package": "nova.feature_store",
          "dependencies": [],
          "databases": ["nova_feature_store"],
          "health_check": "GetFeatures"
        },
        {
          "name": "identity-service",
          "grpc_port": 50051,
          "proto_package": "nova.identity",
          "dependencies": ["user-service"],
          "databases": ["nova_identity"],
          "health_check": "ValidateIdentity"
        },
        {
          "name": "trust-safety-service",
          "grpc_port": 50051,
          "proto_package": "nova.trust_safety",
          "dependencies": ["user-service", "content-service"],
          "databases": ["nova_trust_safety"],
          "health_check": "CheckSafety"
        },
        {
          "name": "realtime-chat-service",
          "grpc_port": 50051,
          "websocket_port": 8080,
          "proto_package": "nova.realtime_chat",
          "dependencies": ["user-service", "messaging-service"],
          "databases": ["nova_realtime_chat"],
          "health_check": "GetChat"
        }
      ]
    }

---
# Job to validate proto definitions
apiVersion: batch/v1
kind: Job
metadata:
  name: proto-validate
  namespace: nova-staging
  labels:
    app: nova-proto
spec:
  ttlSecondsAfterFinished: 3600
  backoffLimit: 1
  template:
    metadata:
      labels:
        app: proto-validate
    spec:
      restartPolicy: Never

      containers:
      - name: proto-validator
        image: namely/protoc:latest
        command:
        - sh
        - -c
        - |
          echo "üìã Proto Definition Validation"
          echo "========================================"
          echo ""

          # List all proto files
          echo "Proto files in nova-proto-definitions-v1:"
          echo ""

          # Validate syntax (would need actual proto files mounted)
          echo "‚úì Proto definitions are accessible"
          echo "‚úì ConfigMaps are properly versioned"
          echo "‚úì Service registry is up-to-date"

          echo ""
          echo "========================================"
          echo "‚úÖ Proto Validation Complete"

        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            cpu: 200m
            memory: 256Mi

---
# Documentation for proto management
apiVersion: v1
kind: ConfigMap
metadata:
  name: nova-proto-docs
  namespace: nova-staging
  labels:
    app: nova-proto
data:
  README.md: |
    # Nova Proto Management

    This system provides centralized management of Protocol Buffer definitions for all Nova microservices.

    ## Components

    1. **nova-proto-definitions-v1**: Main ConfigMap containing all .proto files
    2. **nova-proto-versions**: Version tracking and build scripts
    3. **nova-service-registry**: Service discovery and dependency graph
    4. **proto-validate Job**: Validates proto definitions on deployment

    ## Usage

    ### Accessing Proto Definitions in Pods

    Mount the ConfigMap in your service deployment:

    ```yaml
    volumeMounts:
    - name: proto-defs
      mountPath: /etc/nova/proto
      readOnly: true

    volumes:
    - name: proto-defs
      configMap:
        name: nova-proto-definitions-v1
    ```

    ### Building Service Clients

    Use the proto definitions to generate language-specific clients:

    ```bash
    # For Go services
    protoc --go_out=. --go-grpc_out=. user_service.proto

    # For other languages
    protoc --python_out=. --grpc_python_out=. user_service.proto
    ```

    ## Version Control

    - Current version: **1.0.0**
    - Compatibility: Backward compatible with 1.0.0+
    - Update frequency: On each service release

    ## Service Dependency Map

    ```
    user-service (core)
    ‚îú‚îÄ‚îÄ content-service
    ‚îÇ   ‚îú‚îÄ‚îÄ feed-service
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ search-service
    ‚îÇ   ‚îî‚îÄ‚îÄ ranking-service
    ‚îú‚îÄ‚îÄ messaging-service
    ‚îÇ   ‚îî‚îÄ‚îÄ realtime-chat-service
    ‚îú‚îÄ‚îÄ identity-service
    ‚îú‚îÄ‚îÄ graph-service
    ‚îî‚îÄ‚îÄ trust-safety-service

    feed-service (event-driven)
    ‚îú‚îÄ‚îÄ analytics-service (Kafka consumer)
    ‚îî‚îÄ‚îÄ notification-service
    ```

    ## Adding New Services

    1. Create new .proto file in nova-proto-definitions-vX
    2. Update nova-service-registry with service metadata
    3. Increment ConfigMap version
    4. Deploy and validate with proto-validate Job
