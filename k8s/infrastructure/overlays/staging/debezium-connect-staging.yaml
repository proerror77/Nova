##############################################################################
# Kafka Connect (Debezium) Deployment for Staging
# CDC pipeline from PostgreSQL to Kafka
#
# Components:
# - Kafka Connect worker with Debezium PostgreSQL connector
# - REST API on port 8083 for connector management
# - Connects to Kafka cluster in nova-staging namespace
#
# CDC Connectors:
# - nova-content-cdc: posts, comments, likes from nova_content DB
# - nova-graph-cdc: follows from nova_graph DB
##############################################################################

---
apiVersion: v1
kind: Service
metadata:
  name: kafka-connect
  namespace: nova-staging
  labels:
    app: kafka-connect
    component: cdc
spec:
  type: ClusterIP
  ports:
  - name: rest
    port: 8083
    targetPort: 8083
    protocol: TCP
  selector:
    app: kafka-connect

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kafka-connect
  namespace: nova-staging
  labels:
    app: kafka-connect
    component: cdc
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kafka-connect
  template:
    metadata:
      labels:
        app: kafka-connect
        component: cdc
    spec:
      initContainers:
      # Wait for Kafka to be ready
      - name: wait-for-kafka
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          echo "Waiting for Kafka..."
          for i in $(seq 1 60); do
            if nc -z kafka.nova-staging.svc.cluster.local 9092 2>/dev/null; then
              echo "Kafka is ready"
              exit 0
            fi
            echo "  Attempt $i/60, retrying..."
            sleep 5
          done
          echo "Kafka is not ready"
          exit 1

      containers:
      - name: kafka-connect
        image: debezium/connect:2.4
        imagePullPolicy: IfNotPresent
        ports:
        - name: rest
          containerPort: 8083
          protocol: TCP

        env:
        # Kafka Connect configuration
        - name: BOOTSTRAP_SERVERS
          value: "kafka.nova-staging.svc.cluster.local:9092"
        - name: GROUP_ID
          value: "nova-cdc-connect-staging"
        - name: CONFIG_STORAGE_TOPIC
          value: "connect-configs"
        - name: OFFSET_STORAGE_TOPIC
          value: "connect-offsets"
        - name: STATUS_STORAGE_TOPIC
          value: "connect-status"

        # Replication factor (1 for single-node Kafka in staging)
        - name: CONFIG_STORAGE_REPLICATION_FACTOR
          value: "1"
        - name: OFFSET_STORAGE_REPLICATION_FACTOR
          value: "1"
        - name: STATUS_STORAGE_REPLICATION_FACTOR
          value: "1"

        # Converter configuration (schema-less JSON)
        - name: KEY_CONVERTER
          value: "org.apache.kafka.connect.json.JsonConverter"
        - name: VALUE_CONVERTER
          value: "org.apache.kafka.connect.json.JsonConverter"
        - name: KEY_CONVERTER_SCHEMAS_ENABLE
          value: "false"
        - name: VALUE_CONVERTER_SCHEMAS_ENABLE
          value: "false"

        # Logging
        - name: LOG_LEVEL
          value: "INFO"
        - name: CONNECT_LOG4J_LOGGERS
          value: "org.apache.kafka.connect=INFO,io.debezium=INFO"

        # Database credentials from secret
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: DB_USER
              optional: false
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: DB_PASSWORD
              optional: false

        resources:
          requests:
            cpu: 100m
            memory: 512Mi
          limits:
            cpu: 500m
            memory: 1Gi

        livenessProbe:
          httpGet:
            path: /
            port: rest
          initialDelaySeconds: 120
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3

        readinessProbe:
          httpGet:
            path: /connectors
            port: rest
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 3

      restartPolicy: Always
      terminationGracePeriodSeconds: 60

---
##############################################################################
# Debezium CDC Connector Initialization Job
# Deploys PostgreSQL CDC connectors for nova_content and nova_graph databases
##############################################################################

apiVersion: batch/v1
kind: Job
metadata:
  name: debezium-cdc-connector-init
  namespace: nova-staging
  labels:
    app: kafka-connect
    component: cdc-init
spec:
  ttlSecondsAfterFinished: 3600
  backoffLimit: 10
  template:
    metadata:
      labels:
        app: kafka-connect
        component: cdc-init
    spec:
      restartPolicy: OnFailure

      initContainers:
      # Wait for Kafka Connect REST API to be ready
      - name: wait-for-connect
        image: curlimages/curl:latest
        command:
        - /bin/sh
        - -c
        - |
          echo "Waiting for Kafka Connect REST API..."
          for i in $(seq 1 60); do
            if curl -sf http://kafka-connect.nova-staging.svc.cluster.local:8083/ > /dev/null 2>&1; then
              echo "Kafka Connect is ready!"
              exit 0
            fi
            echo "  Attempt $i/60, Kafka Connect not ready..."
            sleep 10
          done
          echo "Kafka Connect failed to start"
          exit 1

      containers:
      - name: deploy-connector
        image: curlimages/curl:latest
        env:
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: DB_USER
              optional: false
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: DB_PASSWORD
              optional: false
        command:
        - /bin/sh
        - -c
        - |
          set -e

          CONNECT_URL="http://kafka-connect.nova-staging.svc.cluster.local:8083"

          echo "=============================================="
          echo "  Debezium CDC Connectors Deployment"
          echo "=============================================="
          echo ""

          # ================================================
          # Deploy nova-content-cdc connector
          # Tables: posts, comments, likes
          # ================================================
          CONNECTOR_NAME="nova-content-cdc"
          echo "Deploying connector: ${CONNECTOR_NAME}"

          if curl -sf "${CONNECT_URL}/connectors/${CONNECTOR_NAME}" > /dev/null 2>&1; then
            echo "  Connector ${CONNECTOR_NAME} already exists, skipping..."
          else
            curl -sf -X POST "${CONNECT_URL}/connectors" \
              -H "Content-Type: application/json" \
              -d '{
                "name": "nova-content-cdc",
                "config": {
                  "connector.class": "io.debezium.connector.postgresql.PostgresConnector",
                  "tasks.max": "1",
                  "database.hostname": "postgres.nova-staging.svc.cluster.local",
                  "database.port": "5432",
                  "database.user": "'"${POSTGRES_USER}"'",
                  "database.password": "'"${POSTGRES_PASSWORD}"'",
                  "database.dbname": "nova_content",
                  "database.server.name": "nova-content",
                  "schema.history.internal.kafka.bootstrap.servers": "kafka.nova-staging.svc.cluster.local:9092",
                  "schema.history.internal.kafka.topic": "schemahistory.nova-content-cdc",
                  "plugin.name": "pgoutput",
                  "publication.name": "content_cdc_publication",
                  "publication.autocreate.mode": "filtered",
                  "slot.name": "content_cdc_slot",
                  "table.include.list": "public.posts,public.comments,public.likes",
                  "topic.prefix": "nova-content",
                  "topic.creation.enable": "true",
                  "topic.creation.default.replication.factor": "1",
                  "topic.creation.default.partitions": "3",
                  "key.converter": "org.apache.kafka.connect.json.JsonConverter",
                  "key.converter.schemas.enable": "false",
                  "value.converter": "org.apache.kafka.connect.json.JsonConverter",
                  "value.converter.schemas.enable": "false",
                  "transforms": "route",
                  "transforms.route.type": "org.apache.kafka.connect.transforms.RegexRouter",
                  "transforms.route.regex": "nova-content\\.public\\.(.+)",
                  "transforms.route.replacement": "cdc.$1",
                  "snapshot.mode": "initial",
                  "decimal.handling.mode": "string",
                  "time.precision.mode": "connect",
                  "heartbeat.interval.ms": "30000",
                  "errors.tolerance": "all",
                  "errors.log.enable": "true",
                  "errors.log.include.messages": "true",
                  "errors.deadletterqueue.topic.name": "dlq.nova-content-cdc",
                  "errors.deadletterqueue.topic.replication.factor": "1",
                  "errors.deadletterqueue.context.headers.enable": "true"
                }
              }'
            echo "  Connector ${CONNECTOR_NAME} created"
          fi
          echo ""

          # ================================================
          # Deploy nova-graph-cdc connector
          # Tables: follows
          # ================================================
          CONNECTOR_NAME="nova-graph-cdc"
          echo "Deploying connector: ${CONNECTOR_NAME}"

          if curl -sf "${CONNECT_URL}/connectors/${CONNECTOR_NAME}" > /dev/null 2>&1; then
            echo "  Connector ${CONNECTOR_NAME} already exists, skipping..."
          else
            curl -sf -X POST "${CONNECT_URL}/connectors" \
              -H "Content-Type: application/json" \
              -d '{
                "name": "nova-graph-cdc",
                "config": {
                  "connector.class": "io.debezium.connector.postgresql.PostgresConnector",
                  "tasks.max": "1",
                  "database.hostname": "postgres.nova-staging.svc.cluster.local",
                  "database.port": "5432",
                  "database.user": "'"${POSTGRES_USER}"'",
                  "database.password": "'"${POSTGRES_PASSWORD}"'",
                  "database.dbname": "nova_graph",
                  "database.server.name": "nova-graph",
                  "schema.history.internal.kafka.bootstrap.servers": "kafka.nova-staging.svc.cluster.local:9092",
                  "schema.history.internal.kafka.topic": "schemahistory.nova-graph-cdc",
                  "plugin.name": "pgoutput",
                  "publication.name": "graph_cdc_publication",
                  "publication.autocreate.mode": "filtered",
                  "slot.name": "graph_cdc_slot",
                  "table.include.list": "public.follows",
                  "topic.prefix": "nova-graph",
                  "topic.creation.enable": "true",
                  "topic.creation.default.replication.factor": "1",
                  "topic.creation.default.partitions": "3",
                  "key.converter": "org.apache.kafka.connect.json.JsonConverter",
                  "key.converter.schemas.enable": "false",
                  "value.converter": "org.apache.kafka.connect.json.JsonConverter",
                  "value.converter.schemas.enable": "false",
                  "transforms": "route",
                  "transforms.route.type": "org.apache.kafka.connect.transforms.RegexRouter",
                  "transforms.route.regex": "nova-graph\\.public\\.(.+)",
                  "transforms.route.replacement": "cdc.$1",
                  "snapshot.mode": "initial",
                  "decimal.handling.mode": "string",
                  "time.precision.mode": "connect",
                  "heartbeat.interval.ms": "30000",
                  "errors.tolerance": "all",
                  "errors.log.enable": "true",
                  "errors.log.include.messages": "true",
                  "errors.deadletterqueue.topic.name": "dlq.nova-graph-cdc",
                  "errors.deadletterqueue.topic.replication.factor": "1",
                  "errors.deadletterqueue.context.headers.enable": "true"
                }
              }'
            echo "  Connector ${CONNECTOR_NAME} created"
          fi
          echo ""

          # Wait for connectors to initialize
          echo "Waiting for connectors to start..."
          sleep 15

          # ================================================
          # Deploy nova-auth-cdc connector
          # Tables: users (user profile data for analytics)
          # ================================================
          CONNECTOR_NAME="nova-auth-cdc"
          echo "Deploying connector: ${CONNECTOR_NAME}"

          if curl -sf "${CONNECT_URL}/connectors/${CONNECTOR_NAME}" > /dev/null 2>&1; then
            echo "  Connector ${CONNECTOR_NAME} already exists, skipping..."
          else
            curl -sf -X POST "${CONNECT_URL}/connectors" \
              -H "Content-Type: application/json" \
              -d '{
                "name": "nova-auth-cdc",
                "config": {
                  "connector.class": "io.debezium.connector.postgresql.PostgresConnector",
                  "tasks.max": "1",
                  "database.hostname": "postgres.nova-staging.svc.cluster.local",
                  "database.port": "5432",
                  "database.user": "'"${POSTGRES_USER}"'",
                  "database.password": "'"${POSTGRES_PASSWORD}"'",
                  "database.dbname": "nova_auth",
                  "database.server.name": "nova-auth",
                  "schema.history.internal.kafka.bootstrap.servers": "kafka.nova-staging.svc.cluster.local:9092",
                  "schema.history.internal.kafka.topic": "schemahistory.nova-auth-cdc",
                  "plugin.name": "pgoutput",
                  "publication.name": "auth_cdc_publication",
                  "publication.autocreate.mode": "filtered",
                  "slot.name": "auth_cdc_slot",
                  "table.include.list": "public.users",
                  "topic.prefix": "nova-auth",
                  "topic.creation.enable": "true",
                  "topic.creation.default.replication.factor": "1",
                  "topic.creation.default.partitions": "3",
                  "key.converter": "org.apache.kafka.connect.json.JsonConverter",
                  "key.converter.schemas.enable": "false",
                  "value.converter": "org.apache.kafka.connect.json.JsonConverter",
                  "value.converter.schemas.enable": "false",
                  "transforms": "route",
                  "transforms.route.type": "org.apache.kafka.connect.transforms.RegexRouter",
                  "transforms.route.regex": "nova-auth\\.public\\.(.+)",
                  "transforms.route.replacement": "cdc.$1",
                  "snapshot.mode": "initial",
                  "decimal.handling.mode": "string",
                  "time.precision.mode": "connect",
                  "heartbeat.interval.ms": "30000",
                  "errors.tolerance": "all",
                  "errors.log.enable": "true",
                  "errors.log.include.messages": "true",
                  "errors.deadletterqueue.topic.name": "dlq.nova-auth-cdc",
                  "errors.deadletterqueue.topic.replication.factor": "1",
                  "errors.deadletterqueue.context.headers.enable": "true"
                }
              }'
            echo "  Connector ${CONNECTOR_NAME} created"
          fi
          echo ""

          # Wait for connectors to initialize
          echo "Waiting for connectors to start..."
          sleep 15

          # Check connector statuses
          echo ""
          echo "Connector Statuses:"
          echo "-------------------"
          for connector in nova-content-cdc nova-graph-cdc nova-auth-cdc; do
            echo ""
            echo "${connector}:"
            curl -s "${CONNECT_URL}/connectors/${connector}/status" | head -100
          done

          echo ""
          echo "=============================================="
          echo "  CDC Connectors Deployment Complete"
          echo "=============================================="

        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 128Mi
