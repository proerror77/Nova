apiVersion: batch/v1
kind: CronJob
metadata:
  name: feed-candidates-refresh
  labels:
    app: feed-etl
    component: data-pipeline
spec:
  schedule: "*/5 * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      template:
        metadata:
          labels:
            app: feed-etl
            component: data-pipeline
        spec:
          serviceAccountName: content-service
          restartPolicy: OnFailure
          volumes:
            - name: grpc-mtls-shared
              secret:
                secretName: grpc-mtls-shared
          containers:
            - name: feed-etl
              image: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/content-service:c24eff97f64c63a9d832a1cc882c547e4fde65ee
              command: ["/app/content-service"]
              args: ["--mode", "feed-refresh"]
              resources:
                requests:
                  cpu: "200m"
                  memory: "512Mi"
                limits:
                  cpu: "1000m"
                  memory: "1Gi"
              envFrom:
                - configMapRef:
                    name: content-service-config
                - secretRef:
                    name: content-service-secret
              env:
                - name: RUST_LOG
                  value: "info,content_service::jobs=debug"
                - name: CLICKHOUSE_URL
                  value: "http://clickhouse.nova-staging.svc.cluster.local:8123"
                - name: CLICKHOUSE_DATABASE
                  value: "analytics"
                - name: CLICKHOUSE_USERNAME
                  valueFrom:
                    secretKeyRef:
                      name: nova-clickhouse-credentials
                      key: CLICKHOUSE_USER
                - name: CLICKHOUSE_USER
                  valueFrom:
                    secretKeyRef:
                      name: nova-clickhouse-credentials
                      key: CLICKHOUSE_USER
                - name: CLICKHOUSE_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: nova-clickhouse-credentials
                      key: CLICKHOUSE_PASSWORD
                - name: CLICKHOUSE_QUERY_TIMEOUT_MS
                  value: "120000"
                - name: DATABASE_URL
                  valueFrom:
                    secretKeyRef:
                      name: nova-db-credentials
                      key: content-db-url
                - name: DATABASE_MAX_CONNECTIONS
                  value: "5"
                - name: SKIP_MIGRATIONS
                  value: "true"
                - name: KAFKA_BROKERS
                  valueFrom:
                    configMapKeyRef:
                      name: nova-config
                      key: KAFKA_BROKERS
                - name: REDIS_URL
                  valueFrom:
                    secretKeyRef:
                      name: nova-redis-credentials
                      key: REDIS_URL
                - name: GRPC_TLS_ENABLED
                  value: "true"
                - name: GRPC_TLS_DOMAIN_NAME
                  value: "content-service.nova-staging.svc.cluster.local"
                - name: GRPC_TLS_CA_CERT_PATH
                  value: "/etc/nova/certs/ca.crt"
                - name: GRPC_TLS_CLIENT_CERT_PATH
                  value: "/etc/nova/certs/client.crt"
                - name: GRPC_TLS_CLIENT_KEY_PATH
                  value: "/etc/nova/certs/client.key"
                - name: GRPC_CLIENT_CA_CERT_PATH
                  value: "/etc/nova/certs/ca.crt"
                - name: GRPC_REQUIRE_CLIENT_CERT
                  value: "true"
                - name: GRPC_IDENTITY_SERVICE_TIER
                  value: "1"
                - name: GRPC_SOCIAL_SERVICE_TIER
                  value: "1"
                - name: GRPC_RANKING_SERVICE_TIER
                  value: "1"
                - name: GRPC_IDENTITY_SERVICE_URL
                  value: "https://identity-service.nova-staging.svc.cluster.local:50051"
                - name: GRPC_CONTENT_SERVICE_URL
                  value: "https://content-service.nova-staging.svc.cluster.local:9080"
                - name: GRPC_FEED_SERVICE_URL
                  value: "https://feed-service.nova-staging.svc.cluster.local:9084"
                - name: GRPC_SEARCH_SERVICE_URL
                  value: "http://search-service.nova-staging.svc.cluster.local:50057"
                - name: GRPC_MEDIA_SERVICE_URL
                  value: "https://media-service.nova-staging.svc.cluster.local:9082"
                - name: GRPC_NOTIFICATION_SERVICE_URL
                  value: "http://notification-service.nova-staging.svc.cluster.local:9093"
                - name: GRPC_ANALYTICS_SERVICE_URL
                  value: "https://analytics-service.nova-staging.svc.cluster.local:9090"
                - name: GRPC_GRAPH_SERVICE_URL
                  value: "https://graph-service.nova-staging.svc.cluster.local:9080"
                - name: GRPC_SOCIAL_SERVICE_URL
                  value: "https://social-service.nova-staging.svc.cluster.local:50052"
                - name: GRPC_CHAT_SERVICE_URL
                  value: "https://realtime-chat-service.nova-staging.svc.cluster.local:9095"
                - name: GRPC_RANKING_SERVICE_URL
                  value: "https://ranking-service.nova-staging.svc.cluster.local:9094"
                - name: GRPC_TRUST_SAFETY_SERVICE_URL
                  value: "https://trust-safety-service.nova-staging.svc.cluster.local:9097"
                - name: GRPC_FEATURE_STORE_TIER
                  value: "2"
                - name: FEED_REFRESH_RUN_ONCE
                  value: "true"
              volumeMounts:
                - name: grpc-mtls-shared
                  mountPath: /etc/nova/certs
                  readOnly: true
---
# Manual trigger job for initial data load
apiVersion: batch/v1
kind: Job
metadata:
  name: feed-candidates-initial-load
  labels:
    app: feed-etl
    component: data-pipeline
spec:
  backoffLimit: 3
  activeDeadlineSeconds: 600
  template:
    metadata:
      labels:
        app: feed-etl
        component: data-pipeline
    spec:
      serviceAccountName: content-service
      restartPolicy: OnFailure
      volumes:
        - name: grpc-mtls-shared
          secret:
            secretName: grpc-mtls-shared
      containers:
        - name: feed-etl
          image: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/content-service:c24eff97f64c63a9d832a1cc882c547e4fde65ee
          command: ["/app/content-service"]
          args: ["--mode", "feed-refresh"]
          resources:
            requests:
              cpu: "500m"
              memory: "1Gi"
            limits:
              cpu: "2000m"
              memory: "2Gi"
          envFrom:
            - configMapRef:
                name: content-service-config
            - secretRef:
                name: content-service-secret
          env:
            - name: RUST_LOG
              value: "info,content_service::jobs=debug"
            - name: CLICKHOUSE_URL
              value: "http://clickhouse.nova-staging.svc.cluster.local:8123"
            - name: CLICKHOUSE_DATABASE
              value: "analytics"
            - name: CLICKHOUSE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: nova-clickhouse-credentials
                  key: CLICKHOUSE_USER
            - name: CLICKHOUSE_USER
              valueFrom:
                secretKeyRef:
                  name: nova-clickhouse-credentials
                  key: CLICKHOUSE_USER
            - name: CLICKHOUSE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: nova-clickhouse-credentials
                  key: CLICKHOUSE_PASSWORD
            - name: CLICKHOUSE_QUERY_TIMEOUT_MS
              value: "300000"
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: nova-db-credentials
                  key: content-db-url
            - name: DATABASE_MAX_CONNECTIONS
              value: "5"
            - name: SKIP_MIGRATIONS
              value: "true"
            - name: KAFKA_BROKERS
              valueFrom:
                configMapKeyRef:
                  name: nova-config
                  key: KAFKA_BROKERS
            - name: REDIS_URL
              valueFrom:
                secretKeyRef:
                  name: nova-redis-credentials
                  key: REDIS_URL
            - name: GRPC_TLS_ENABLED
              value: "true"
            - name: GRPC_TLS_DOMAIN_NAME
              value: "content-service.nova-staging.svc.cluster.local"
            - name: GRPC_TLS_CA_CERT_PATH
              value: "/etc/nova/certs/ca.crt"
            - name: GRPC_TLS_CLIENT_CERT_PATH
              value: "/etc/nova/certs/client.crt"
            - name: GRPC_TLS_CLIENT_KEY_PATH
              value: "/etc/nova/certs/client.key"
            - name: GRPC_CLIENT_CA_CERT_PATH
              value: "/etc/nova/certs/ca.crt"
            - name: GRPC_REQUIRE_CLIENT_CERT
              value: "true"
            - name: GRPC_IDENTITY_SERVICE_TIER
              value: "1"
            - name: GRPC_SOCIAL_SERVICE_TIER
              value: "1"
            - name: GRPC_RANKING_SERVICE_TIER
              value: "1"
            - name: GRPC_IDENTITY_SERVICE_URL
              value: "https://identity-service.nova-staging.svc.cluster.local:50051"
            - name: GRPC_CONTENT_SERVICE_URL
              value: "https://content-service.nova-staging.svc.cluster.local:9080"
            - name: GRPC_FEED_SERVICE_URL
              value: "https://feed-service.nova-staging.svc.cluster.local:9084"
            - name: GRPC_SEARCH_SERVICE_URL
              value: "http://search-service.nova-staging.svc.cluster.local:50057"
            - name: GRPC_MEDIA_SERVICE_URL
              value: "https://media-service.nova-staging.svc.cluster.local:9082"
            - name: GRPC_NOTIFICATION_SERVICE_URL
              value: "http://notification-service.nova-staging.svc.cluster.local:9093"
            - name: GRPC_ANALYTICS_SERVICE_URL
              value: "https://analytics-service.nova-staging.svc.cluster.local:9090"
            - name: GRPC_GRAPH_SERVICE_URL
              value: "https://graph-service.nova-staging.svc.cluster.local:9080"
            - name: GRPC_SOCIAL_SERVICE_URL
              value: "https://social-service.nova-staging.svc.cluster.local:50052"
            - name: GRPC_CHAT_SERVICE_URL
              value: "https://realtime-chat-service.nova-staging.svc.cluster.local:9095"
            - name: GRPC_RANKING_SERVICE_URL
              value: "https://ranking-service.nova-staging.svc.cluster.local:9094"
            - name: GRPC_TRUST_SAFETY_SERVICE_URL
              value: "https://trust-safety-service.nova-staging.svc.cluster.local:9097"
            - name: GRPC_FEATURE_STORE_TIER
              value: "2"
            - name: FEED_REFRESH_RUN_ONCE
              value: "true"
          volumeMounts:
            - name: grpc-mtls-shared
              mountPath: /etc/nova/certs
              readOnly: true
