---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: messaging-requeue-stale-claims
  namespace: nova-messaging
spec:
  schedule: "*/1 * * * *"  # every minute
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 2
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: requeue-stale
              image: postgres:15-alpine
              env:
                - name: DATABASE_URL
                  valueFrom:
                    secretKeyRef:
                      name: messaging-service-secret
                      key: DATABASE_URL
              command:
                - /bin/sh
                - -c
                - |
                  psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -c 'SELECT requeue_stale_notification_jobs(5);'
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: messaging-cleanup-failed-jobs
  namespace: nova-messaging
spec:
  schedule: "23 3 * * *"  # every day at 03:23
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 2
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: cleanup-failed
              image: postgres:15-alpine
              env:
                - name: DATABASE_URL
                  valueFrom:
                    secretKeyRef:
                      name: messaging-service-secret
                      key: DATABASE_URL
              command:
                - /bin/sh
                - -c
                - |
                  psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -c 'SELECT cleanup_failed_notification_jobs(30);'

