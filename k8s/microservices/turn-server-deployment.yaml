---
# TURN Server Deployment for WebRTC Video Calls
# Handles NAT traversal for peer-to-peer video connections
# ConfigMap for coturn configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: turn-server-config
data:
  turnserver.conf: |
    # Listening ports
    listening-port=3478
    listening-ip=0.0.0.0
    alt-listening-port=443

    # External IP for clients to connect to
    external-ip=${EXTERNAL_IP}

    # Relay ports
    relay-ip=0.0.0.0
    min-port=49152
    max-port=65535

    # Credentials
    realm=${REALM}

    # Authentication (Matrix-compatible short-term credentials)
    use-auth-secret
    static-auth-secret=${TURN_SHARED_SECRET}
    fingerprint
    lt-cred-mech

    # Verbose logging
    log-file=/var/log/turn/turn.log

---
# Secret for TURN server credentials
apiVersion: v1
kind: Secret
metadata:
  name: turn-server-secret
type: Opaque
stringData:
  TURN_SHARED_SECRET: "changeme-in-production"  # TODO: Change in production
  REALM: "turn.staging.gcp.icered.com"
  EXTERNAL_IP: "34.84.3.228"  # Staging LoadBalancer IP

---
# Service for TURN server (UDP for media)
apiVersion: v1
kind: Service
metadata:
  name: turn-server
  labels:
    app: nova
    component: turn-server
spec:
  type: LoadBalancer
  ports:
    # TURN/STUN UDP ports
    - name: turn-udp
      port: 3478
      targetPort: 3478
      protocol: UDP
    - name: turn-udp-alt
      port: 443
      targetPort: 443
      protocol: UDP
  selector:
    app: nova
    component: turn-server
  externalTrafficPolicy: Local  # Preserve source IP for NAT traversal

---
# Service for TURN server (TCP fallback)
apiVersion: v1
kind: Service
metadata:
  name: turn-server-tcp
  labels:
    app: nova
    component: turn-server
spec:
  type: LoadBalancer
  ports:
    - name: turn-tcp
      port: 3478
      targetPort: 3478
      protocol: TCP
    - name: turn-tcp-alt
      port: 443
      targetPort: 443
      protocol: TCP
  selector:
    app: nova
    component: turn-server
  externalTrafficPolicy: Local  # Preserve source IP for NAT traversal

---
# Deployment for coturn TURN server
apiVersion: apps/v1
kind: Deployment
metadata:
  name: turn-server
  labels:
    app: nova
    component: turn-server
  annotations:
    description: "TURN server for WebRTC NAT traversal"
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: nova
      component: turn-server
  template:
    metadata:
      labels:
        app: nova
        component: turn-server
    spec:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      initContainers:
        - name: config-envsubst
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              cat /etc/coturn-template/turnserver.conf | \
                sed "s|\${EXTERNAL_IP}|$EXTERNAL_IP|g" | \
                sed "s|\${REALM}|$REALM|g" | \
                sed "s|\${TURN_SHARED_SECRET}|$TURN_SHARED_SECRET|g" > /etc/coturn/turnserver.conf
              cat /etc/coturn/turnserver.conf
          env:
            - name: EXTERNAL_IP
              valueFrom:
                secretKeyRef:
                  name: turn-server-secret
                  key: EXTERNAL_IP
            - name: TURN_SHARED_SECRET
              valueFrom:
                secretKeyRef:
                  name: turn-server-secret
                  key: TURN_SHARED_SECRET
            - name: REALM
              valueFrom:
                secretKeyRef:
                  name: turn-server-secret
                  key: REALM
          volumeMounts:
            - name: config-template
              mountPath: /etc/coturn-template
              readOnly: true
            - name: config
              mountPath: /etc/coturn
      containers:
        - name: turn-server
          image: coturn/coturn:latest
          imagePullPolicy: IfNotPresent

          ports:
            # TURN/STUN UDP
            - name: turn-udp
              containerPort: 3478
              protocol: UDP
            - name: turn-udp-alt
              containerPort: 443
              protocol: UDP
            # TURN TCP
            - name: turn-tcp
              containerPort: 3478
              protocol: TCP
            - name: turn-tcp-alt
              containerPort: 443
              protocol: TCP

          env:
            - name: EXTERNAL_IP
              valueFrom:
                secretKeyRef:
                  name: turn-server-secret
                  key: EXTERNAL_IP
            - name: TURN_SHARED_SECRET
              valueFrom:
                secretKeyRef:
                  name: turn-server-secret
                  key: TURN_SHARED_SECRET
            - name: REALM
              valueFrom:
                secretKeyRef:
                  name: turn-server-secret
                  key: REALM

          # Resource limits
          resources:
            requests:
              cpu: 500m
              memory: 256Mi
            limits:
              cpu: 2000m
              memory: 1Gi

          # Volume mount for configuration
          volumeMounts:
            - name: config
              mountPath: /etc/coturn
              readOnly: true
            - name: logs
              mountPath: /var/log/turn

          # Health check
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - "echo 'STUN' | nc -w 1 localhost 3478 || exit 1"
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3

          # Security context
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              add:
                - NET_BIND_SERVICE

      # Volumes
      volumes:
        - name: config-template
          configMap:
            name: turn-server-config
        - name: config
          emptyDir: {}
        - name: logs
          emptyDir: {}

      # Node affinity for dedicated TURN node (optional)
      # affinity:
      #   nodeAffinity:
      #     preferredDuringSchedulingIgnoredDuringExecution:
      #       - weight: 100
      #         preference:
      #           matchExpressions:
      #             - key: turn-server
      #               operator: In
      #               values:
      #                 - "true"

---
# HorizontalPodAutoscaler for TURN server (optional)
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: turn-server-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: turn-server

  minReplicas: 1
  maxReplicas: 3

  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 80

    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 85

---
# ServiceMonitor for Prometheus (if using Prometheus operator)
# Uncomment if you have Prometheus operator installed
# apiVersion: monitoring.coreos.com/v1
# kind: ServiceMonitor
# metadata:
#   name: turn-server
#   namespace: nova-turn
#   labels:
#     app: nova
#     component: turn-server
# spec:
#   selector:
#     matchLabels:
#       app: nova
#       component: turn-server
#   endpoints:
#     - port: prometheus
#       interval: 30s
