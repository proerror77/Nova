# ============================================
# VLM Service Deployment
# ============================================
#
# Vision Language Model service for real-time image analysis.
# Consumes Kafka events and processes posts with images.

apiVersion: apps/v1
kind: Deployment
metadata:
  name: vlm-service
  namespace: nova-staging
  labels:
    app: vlm-service
    component: vlm
spec:
  replicas: 1
  selector:
    matchLabels:
      app: vlm-service
  template:
    metadata:
      labels:
        app: vlm-service
        component: vlm
    spec:
      serviceAccountName: vlm-service
      containers:
      - name: vlm-service
        image: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/vlm-service:latest
        imagePullPolicy: Always
        command: ["/app/vlm-service"]
        args: ["--mode", "consumer"]
        ports:
        - name: grpc
          containerPort: 50060
          protocol: TCP
        env:
        # ============================================
        # 應用配置
        # ============================================
        - name: RUST_LOG
          value: "info,vlm_service=debug,rdkafka=warn"
        - name: SERVICE_NAME
          value: "vlm-service"
        - name: GRPC_PORT
          value: "50060"

        # ============================================
        # VLM 配置
        # ============================================
        - name: MAX_TAGS
          value: "15"
        - name: MIN_TAG_CONFIDENCE
          value: "0.3"
        - name: CHANNEL_MIN_CONFIDENCE
          value: "0.25"
        - name: MAX_CHANNELS
          value: "3"
        - name: RATE_LIMIT_RPS
          value: "10"
        - name: CACHE_TTL_SECONDS
          value: "3600"

        # ============================================
        # Google Cloud Vision API
        # ============================================
        - name: GOOGLE_VISION_API_KEY
          valueFrom:
            secretKeyRef:
              name: vlm-api-credentials
              key: GOOGLE_VISION_API_KEY

        # ============================================
        # PostgreSQL 配置
        # ============================================
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: DATABASE_URL

        # ============================================
        # Redis 配置
        # ============================================
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: nova-redis-credentials
              key: REDIS_URL

        # ============================================
        # Kafka 配置
        # ============================================
        - name: KAFKA_BROKERS
          value: "nova-kafka-kafka-bootstrap.kafka.svc.cluster.local:9092"
        - name: KAFKA_EVENTS_TOPIC
          value: "vlm.post.created"

        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"

        livenessProbe:
          grpc:
            port: 50060
          initialDelaySeconds: 30
          periodSeconds: 10

        readinessProbe:
          grpc:
            port: 50060
          initialDelaySeconds: 5
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: vlm-service
  namespace: nova-staging
  labels:
    app: vlm-service
    component: vlm
spec:
  type: ClusterIP
  ports:
  - name: grpc
    port: 50060
    targetPort: 50060
    protocol: TCP
  selector:
    app: vlm-service
