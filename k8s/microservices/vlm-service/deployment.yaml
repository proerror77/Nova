# ============================================
# VLM Service Deployment
# ============================================
#
# Vision Language Model service for real-time image analysis.
# Consumes Kafka events and processes posts with images.

apiVersion: apps/v1
kind: Deployment
metadata:
  name: vlm-service
  namespace: nova-staging
  labels:
    app: vlm-service
    component: vlm
spec:
  replicas: 1
  selector:
    matchLabels:
      app: vlm-service
  template:
    metadata:
      labels:
        app: vlm-service
        component: vlm
    spec:
      serviceAccountName: vlm-service
      containers:
      - name: vlm-service
        image: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/vlm-service:latest
        imagePullPolicy: Always
        command: ["/app/vlm-service"]
        args: ["--mode", "consumer"]
        ports:
        - name: grpc
          containerPort: 50060
          protocol: TCP
        env:
        # ============================================
        # 應用配置
        # ============================================
        - name: RUST_LOG
          value: "info,vlm_service=debug,rdkafka=warn"
        - name: SERVICE_NAME
          value: "vlm-service"
        - name: GRPC_PORT
          value: "50060"

        # ============================================
        # VLM 配置
        # ============================================
        - name: MAX_TAGS
          value: "15"
        - name: MIN_TAG_CONFIDENCE
          value: "0.3"
        - name: CHANNEL_MIN_CONFIDENCE
          value: "0.25"
        - name: MAX_CHANNELS
          value: "3"
        - name: RATE_LIMIT_RPS
          value: "10"
        - name: CACHE_TTL_SECONDS
          value: "3600"

        # ============================================
        # Google Cloud Vision API (using Service Account Key)
        # ============================================
        - name: USE_ADC
          value: "true"
        - name: GOOGLE_APPLICATION_CREDENTIALS
          value: "/var/secrets/google/credentials.json"

        # ============================================
        # PostgreSQL 配置 (nova_content database)
        # ============================================
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: vlm-db-credentials
              key: DATABASE_URL

        # ============================================
        # Redis 配置
        # ============================================
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: nova-redis-credentials
              key: REDIS_URL

        # ============================================
        # Kafka 配置
        # ============================================
        - name: KAFKA_BROKERS
          value: "kafka.nova-staging.svc.cluster.local:9092"
        - name: KAFKA_EVENTS_TOPIC
          value: "vlm.post.created"

        resources:
          requests:
            cpu: "50m"
            memory: "64Mi"
          limits:
            cpu: "500m"
            memory: "256Mi"

        # Kafka consumer doesn't expose a server, use exec probe
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - test -f /proc/1/status
          initialDelaySeconds: 10
          periodSeconds: 30
          failureThreshold: 3

        readinessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - test -f /proc/1/status
          initialDelaySeconds: 5
          periodSeconds: 10
          failureThreshold: 3

        volumeMounts:
        - name: gcp-credentials
          mountPath: /var/secrets/google
          readOnly: true

      volumes:
      - name: gcp-credentials
        secret:
          secretName: vlm-gcp-credentials

---
apiVersion: v1
kind: Service
metadata:
  name: vlm-service
  namespace: nova-staging
  labels:
    app: vlm-service
    component: vlm
spec:
  type: ClusterIP
  ports:
  - name: grpc
    port: 50060
    targetPort: 50060
    protocol: TCP
  selector:
    app: vlm-service
