apiVersion: apps/v1
kind: Deployment
metadata:
  name: ten-agent
  namespace: nova-staging
  labels:
    app: ten-agent
    app.kubernetes.io/name: ten-agent
    app.kubernetes.io/component: ai-voice
    app.kubernetes.io/part-of: nova
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ten-agent
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        app: ten-agent
        app.kubernetes.io/name: ten-agent
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: ten-agent
      
      # 安全上下文
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      
      containers:
        - name: ten-agent
          # 使用自建的 Alice Voice Service
          # 需要先構建並推送到 GCR: 
          # docker build -t gcr.io/banded-pad-479802-k9/alice-voice-service:latest backend/services/alice-voice-service/
          # docker push gcr.io/banded-pad-479802-k9/alice-voice-service:latest
          image: gcr.io/banded-pad-479802-k9/alice-voice-service:latest
          imagePullPolicy: Always
          
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          
          # 環境變數 - 從 ConfigMap
          envFrom:
            - configMapRef:
                name: ten-agent-config
          
          # 環境變數 - 從 Secret
          env:
            - name: AGORA_APP_ID
              valueFrom:
                secretKeyRef:
                  name: ten-agent-secrets
                  key: AGORA_APP_ID
            - name: AGORA_APP_CERTIFICATE
              valueFrom:
                secretKeyRef:
                  name: ten-agent-secrets
                  key: AGORA_APP_CERTIFICATE
            - name: DEEPGRAM_API_KEY
              valueFrom:
                secretKeyRef:
                  name: ten-agent-secrets
                  key: DEEPGRAM_API_KEY
            - name: OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: ten-agent-secrets
                  key: OPENAI_API_KEY
            - name: ELEVENLABS_API_KEY
              valueFrom:
                secretKeyRef:
                  name: ten-agent-secrets
                  key: ELEVENLABS_API_KEY
          
          # 資源限制 (降低以適應 staging 環境)
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 1Gi
          
          # 健康檢查
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          
          readinessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          
          # 安全上下文
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL
      
      # 調度策略
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app: ten-agent
                topologyKey: kubernetes.io/hostname
      
      # 優雅終止
      terminationGracePeriodSeconds: 30
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ten-agent
  namespace: nova-staging
  labels:
    app: ten-agent
