# Nova Staging æ¶æ„è®¾è®¡

## ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Developer Workflow                        â”‚
â”‚                                                                  â”‚
â”‚  git push origin main                                           â”‚
â”‚         â”‚                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   GitHub Actions CI/CD Pipeline                 â”‚
â”‚                                                                  â”‚
â”‚  .github/workflows/staging-deploy.yml                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Job 1: build-and-push (8 services, max-parallel: 2)      â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚   â”‚
â”‚  â”‚  â”‚ auth-service â”‚  â”‚ user-service â”‚ (parallel)           â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚   â”‚
â”‚  â”‚         â”‚          â”‚      â”‚                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”                            â”‚   â”‚
â”‚  â”‚  â”‚ Docker Buildx (linux/amd64)                          â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚   â”‚
â”‚  â”‚         â”‚                                                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚
â”‚  â”‚  â”‚ AWS ECR Registry                              â”‚      â”‚   â”‚
â”‚  â”‚  â”‚ 025434362120.dkr.ecr.ap-northeast-1.amazonaws â”‚      â”‚   â”‚
â”‚  â”‚  â”‚ .com/nova/{service}:{commit-sha}              â”‚      â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Job 2: update-deployment                                â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  kustomize edit set image \                             â”‚   â”‚
â”‚  â”‚    nova/auth-service=...:abc123def456 \                â”‚   â”‚
â”‚  â”‚    nova/user-service=...:abc123def456 \                â”‚   â”‚
â”‚  â”‚    ...                                                  â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  git add k8s/infrastructure/overlays/staging/...        â”‚   â”‚
â”‚  â”‚  git commit -m "chore(staging): update image tags..."   â”‚   â”‚
â”‚  â”‚  git push origin main                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Job 3: deploy-to-staging                                â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  (Notifies ArgoCD to check for changes)                 â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  Reference: nova-staging Application                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Job 4: smoke-test                                        â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  bash scripts/smoke-staging.sh                          â”‚   â”‚
â”‚  â”‚  - Check /health endpoints                              â”‚   â”‚
â”‚  â”‚  - Check /metrics endpoints                             â”‚   â”‚
â”‚  â”‚  - Verify Redis Sentinel                                â”‚   â”‚
â”‚  â”‚  - Verify Kafka availability                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Git Repository (main branch)                 â”‚
â”‚                                                                  â”‚
â”‚  k8s/infrastructure/overlays/staging/kustomization.yaml        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ images:                                                   â”‚   â”‚
â”‚  â”‚ - name: nova/auth-service                               â”‚   â”‚
â”‚  â”‚   newTag: abc123def456...                               â”‚   â”‚
â”‚  â”‚ - name: nova/user-service                               â”‚   â”‚
â”‚  â”‚   newTag: abc123def456...                               â”‚   â”‚
â”‚  â”‚ ...                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ArgoCD (GitOps Controller)                   â”‚
â”‚                                                                  â”‚
â”‚  Application: nova-staging                                     â”‚
â”‚  - Watch: main branch                                          â”‚
â”‚  - Path: k8s/infrastructure/overlays/staging                   â”‚
â”‚  - Sync: automated (prune: true, selfHeal: true)              â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ When changes detected:                                   â”‚   â”‚
â”‚  â”‚ 1. Pull latest kustomization.yaml                        â”‚   â”‚
â”‚  â”‚ 2. Run: kustomize build                                  â”‚   â”‚
â”‚  â”‚ 3. Render final K8s manifests                            â”‚   â”‚
â”‚  â”‚ 4. kubectl apply -f manifests.yaml                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Kubernetes Staging Cluster (EKS)                   â”‚
â”‚                                                                  â”‚
â”‚  Namespace: nova                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Deployments (2 replicas each, staging resources):        â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚   auth-      â”‚  â”‚    user-     â”‚  â”‚   content-   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  service     â”‚  â”‚   service    â”‚  â”‚   service    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ 100m CPU     â”‚  â”‚ 100m CPU     â”‚  â”‚ 100m CPU     â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ 256Mi mem    â”‚  â”‚ 256Mi mem    â”‚  â”‚ 256Mi mem    â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚   feed-      â”‚  â”‚   media-     â”‚  â”‚ messaging-   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  service     â”‚  â”‚   service    â”‚  â”‚   service    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ 100m CPU     â”‚  â”‚ 100m CPU     â”‚  â”‚ 100m CPU     â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ 512Mi mem    â”‚  â”‚ 512Mi mem    â”‚  â”‚ 512Mi mem    â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚   â”‚
â”‚  â”‚  â”‚   search-    â”‚  â”‚ streaming-   â”‚                     â”‚   â”‚
â”‚  â”‚  â”‚  service     â”‚  â”‚   service    â”‚                     â”‚   â”‚
â”‚  â”‚  â”‚              â”‚  â”‚              â”‚                     â”‚   â”‚
â”‚  â”‚  â”‚ 200m CPU     â”‚  â”‚ 100m CPU     â”‚                     â”‚   â”‚
â”‚  â”‚  â”‚ 512Mi mem    â”‚  â”‚ 512Mi mem    â”‚                     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Services (ClusterIP + Ingress):                          â”‚   â”‚
â”‚  â”‚  - auth-service:8084                                    â”‚   â”‚
â”‚  â”‚  - user-service:8080                                    â”‚   â”‚
â”‚  â”‚  - content-service:8081                                 â”‚   â”‚
â”‚  â”‚  - ... (and 5 more)                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. GitHub Actions Workflow (staging-deploy.yml)

**è´£ä»»**: è‡ªåŠ¨åŒ– CI/CD æµç¨‹

**Jobs**:
1. **build-and-push**
   - ä¸º 8 ä¸ªå¾®æœåŠ¡æ„å»º Docker é•œåƒ
   - ä½¿ç”¨ Docker Buildx æ”¯æŒ linux/amd64
   - æ¨é€åˆ° AWS ECR
   - ä½¿ç”¨ registry cache åŠ é€Ÿåç»­æ„å»º

2. **update-deployment**
   - ä¸‹è½½ kustomize CLI
   - ä¿®æ”¹ `k8s/infrastructure/overlays/staging/kustomization.yaml`
   - æ›´æ–°é•œåƒæ ‡ç­¾ä¸ºå½“å‰ commit SHA
   - æäº¤å¹¶æ¨é€åˆ° main åˆ†æ”¯

3. **deploy-to-staging**
   - éªŒè¯ staging kustomization å­˜åœ¨
   - è¾“å‡º ArgoCD Application å‚è€ƒæ¨¡æ¿
   - ArgoCD ç›‘å¬ main åˆ†æ”¯çš„å˜æ›´è‡ªåŠ¨éƒ¨ç½²

4. **smoke-test**
   - ç­‰å¾… ArgoCD åŒæ­¥å®Œæˆ
   - è¿è¡Œ `scripts/smoke-staging.sh`
   - éªŒè¯æ‰€æœ‰æœåŠ¡å¥åº·

5. **notify-completion**
   - è¾“å‡ºéƒ¨ç½²æ€»ç»“
   - æä¾›è°ƒè¯•å‘½ä»¤

### 2. Kustomize Overlay (staging)

**æ–‡ä»¶ç»“æ„**:
```
k8s/infrastructure/
â”œâ”€â”€ base/                          # æ‰€æœ‰ç¯å¢ƒå…±äº«çš„åŸºç¡€é…ç½®
â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â””â”€â”€ ...
â””â”€â”€ overlays/
    â”œâ”€â”€ dev/                       # å¼€å‘ç¯å¢ƒç‰¹å®šé…ç½®
    â”‚   â”œâ”€â”€ kustomization.yaml
    â”‚   â””â”€â”€ deployment-patch.yaml
    â”œâ”€â”€ prod/                      # ç”Ÿäº§ç¯å¢ƒç‰¹å®šé…ç½®
    â”‚   â”œâ”€â”€ kustomization.yaml
    â”‚   â””â”€â”€ deployment-patch.yaml
    â””â”€â”€ staging/                   # ğŸ“¦ Staging ç¯å¢ƒç‰¹å®šé…ç½®
        â”œâ”€â”€ kustomization.yaml     # 8 ä¸ªæœåŠ¡çš„é•œåƒæ ‡ç­¾ + å‰¯æœ¬æ•° + èµ„æº
        â””â”€â”€ deployment-patch.yaml  # Staging ç‰¹å®šçš„èµ„æºé™åˆ¶
```

**Staging ç‰¹æ€§**:
- **é•œåƒæ ‡ç­¾**: é€šè¿‡ GitHub Actions åŠ¨æ€æ›´æ–°ä¸º commit SHA
- **å‰¯æœ¬æ•°**: 2 ä¸ª (é«˜å¯ç”¨)
- **èµ„æºé™åˆ¶**: ä¸­ç­‰ (100-200m CPU, 256Mi-512Mi å†…å­˜)
- **ç¯å¢ƒå˜é‡**: `APP_ENV=staging`, `LOG_LEVEL=info`

### 3. ArgoCD Application

**é…ç½®** (manual - éœ€è¦æ‰‹åŠ¨åˆ›å»º):
```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: nova-staging
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/proerror77/Nova.git
    targetRevision: main              # ç›‘å¬ main åˆ†æ”¯
    path: k8s/infrastructure/overlays/staging
  destination:
    server: https://kubernetes.default.svc
    namespace: nova
  syncPolicy:
    automated:
      prune: true      # åˆ é™¤æœªåœ¨ Git ä¸­çš„èµ„æº
      selfHeal: true   # å¦‚æœé›†ç¾¤åç¦» Git è‡ªåŠ¨åŒæ­¥
    syncOptions:
    - CreateNamespace=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
```

### 4. Smoke Testing

**è„šæœ¬**: `scripts/smoke-staging.sh`

**éªŒè¯**:
- âœ… æ‰€æœ‰ Pod å°±ç»ª
- âœ… `/health` ç«¯ç‚¹å¯ç”¨ (8 ä¸ªæœåŠ¡)
- âœ… `/metrics` ç«¯ç‚¹å¯ç”¨ (Prometheus)
- âœ… Redis Sentinel æ‹“æ‰‘ (å¯é€‰)
- âœ… Kafka ä¸»é¢˜åˆ—è¡¨ (å¯é€‰)

---

## æ•°æ®æµç¤ºä¾‹

### åœºæ™¯: æ¨é€æ–°ä»£ç åˆ° main

```
æ—¶é—´    äº‹ä»¶                           è¯´æ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T+0s   git push origin main           å¼€å‘è€…æ¨é€ä»£ç 

T+5s   GitHub Actions è§¦å‘            æ£€æµ‹åˆ° backend/ ç›®å½•å˜æ›´

T+10s  build-and-push å¼€å§‹            8 ä¸ªæœåŠ¡å¹¶è¡Œæ„å»º
       - auth-service
       - user-service
       - content-service
       ... (6 more, max-parallel: 2)

T+8m   æ‰€æœ‰é•œåƒæ¨é€åˆ° ECR             å®Œæˆæ—¶é—´çº¦ 8 åˆ†é’Ÿ

T+8m   update-deployment å¼€å§‹         kustomize ä¿®æ”¹é•œåƒæ ‡ç­¾
       before: newTag: latest
       after:  newTag: abc123def456

T+8m   git push å®Œæˆ                  å˜æ›´æ¨é€åˆ° main åˆ†æ”¯

T+8m   ArgoCD æ£€æµ‹å˜æ›´               webhook æˆ–å®šæ—¶è½®è¯¢

T+11m  ArgoCD å¼€å§‹åŒæ­¥               kustomize build + kubectl apply

T+13m  Pods å¯åŠ¨                     8 ä¸ª Deployment å„ 2 ä¸ªå‰¯æœ¬

T+14m  smoke-test å¼€å§‹               éªŒè¯æ‰€æœ‰æœåŠ¡å¥åº·

T+15m  éƒ¨ç½²å®Œæˆ                      æ–°ä»£ç åœ¨ staging è¿è¡Œ
       æ‰€æœ‰æ£€æŸ¥é€šè¿‡ âœ…
```

---

## èµ„æºåˆ†é…

### Staging ç¯å¢ƒèµ„æº

| æœåŠ¡ | Replicas | CPU Request | Memory Request | CPU Limit | Memory Limit |
|------|----------|-------------|----------------|-----------|--------------|
| auth-service | 2 | 100m | 256Mi | 500m | 512Mi |
| user-service | 2 | 100m | 256Mi | 500m | 512Mi |
| content-service | 2 | 100m | 256Mi | 500m | 512Mi |
| feed-service | 2 | 100m | 512Mi | 500m | 1Gi |
| media-service | 2 | 100m | 512Mi | 500m | 1Gi |
| messaging-service | 2 | 100m | 512Mi | 500m | 1Gi |
| search-service | 2 | 200m | 512Mi | 1000m | 2Gi |
| streaming-service | 2 | 100m | 512Mi | 500m | 1Gi |

**æ€»è®¡**: 16 Podsï¼Œæ€»èµ„æºéœ€æ±‚çº¦ 9 æ ¸ CPUï¼Œ6.5 GB å†…å­˜

---

## ä¸å…¶ä»–ç¯å¢ƒçš„å¯¹æ¯”

### Dev ç¯å¢ƒ
```
Trigger: Manual / PR
Image:   dev-latest
Replicas: 1
Resources: Minimal (50m CPU, 128Mi mem)
Path: k8s/infrastructure/overlays/dev
```

### Staging ç¯å¢ƒ
```
Trigger: main branch push
Image:   commit SHA + latest
Replicas: 2
Resources: Medium (100-200m CPU, 256Mi-512Mi mem)
Path: k8s/infrastructure/overlays/staging
```

### Production ç¯å¢ƒ
```
Trigger: Release tag
Image:   release tag
Replicas: 3+
Resources: High (depends on service)
Path: k8s/infrastructure/overlays/prod
```

---

## æ•…éšœè½¬ç§»å’Œé«˜å¯ç”¨æ€§

### Staging çº§åˆ«
- **å‰¯æœ¬æ•°**: 2 ä¸ª Podï¼ˆè‡³å°‘ 1 ä¸ªå­˜æ´»ï¼‰
- **å¥åº·æ£€æŸ¥**: liveness + readiness probes
- **è‡ªæˆ‘ä¿®å¤**: ArgoCD selfHeal è‡ªåŠ¨æ¢å¤åç¦»çš„èµ„æº

### ArgoCD çº§åˆ«
- **é‡è¯•æœºåˆ¶**: å¤±è´¥é‡è¯• 5 æ¬¡ï¼ŒæŒ‡æ•°é€€é¿
- **è‡ªåŠ¨åŒæ­¥**: è‡ªåŠ¨åŒæ­¥å¯ç”¨ï¼Œå¼‚å¸¸è‡ªåŠ¨ä¿®å¤
- **èµ„æºå‰ªæ**: å·²åˆ é™¤çš„èµ„æºè‡ªåŠ¨æ¸…ç†

---

## å®‰å…¨æ€§è€ƒè™‘

1. **é•œåƒå®‰å…¨**
   - æ‰€æœ‰é•œåƒä»ç§æœ‰ ECR registry æ‹‰å–
   - é•œåƒæ‰«æ (ECR å†…ç½®æ¼æ´æ‰«æ)
   - imagePullPolicy: Always

2. **è®¿é—®æ§åˆ¶**
   - ArgoCD RBAC é…ç½®
   - Kubernetes RBAC (nova namespace)
   - GitHub Actions secrets (AWS_ROLE_ARN)
   - GitHub Actions OIDC è®¤è¯ (no long-lived keys)

3. **ç½‘ç»œéš”ç¦»**
   - Staging K8s é›†ç¾¤ç‹¬ç«‹
   - ä¸ç”Ÿäº§ç¯å¢ƒç½‘ç»œéš”ç¦»
   - å¯é€‰: NetworkPolicy é™åˆ¶æµé‡

---

## ç›‘æ§å’Œå¯è§‚æµ‹æ€§

### Prometheus æŒ‡æ ‡
- `/metrics` ç«¯ç‚¹åœ¨æ¯ä¸ªæœåŠ¡
- Prometheus scrape é…ç½®ç›‘å¬ 8080/8081/8082/8083/8084/3000/8000

### æ—¥å¿—
- stdout/stderr æ—¥å¿—
- é€šè¿‡ kubectl logs æŸ¥çœ‹
- å¯é€‰: Fluentd/Filebeat æ”¶é›†åˆ° ELK/CloudWatch

### äº‹ä»¶
- Kubernetes events
- ArgoCD application logs
- GitHub Actions workflow logs

---

## æ€§èƒ½ä¼˜åŒ–

### Docker æ„å»ºä¼˜åŒ–
- **Layer caching**: ä½¿ç”¨ registry cache
- **Buildx parallelization**: max-parallel: 2
- **Multi-platform**: linux/amd64 specific

### ArgoCD ä¼˜åŒ–
- **æ¯”è¾ƒç»“æœç¼“å­˜**: argocd.argoproj.io/compare-result: "false"
- **å¼‚æ­¥å¤„ç†**: ä¸é˜»å¡ webhook è¿”å›
- **èµ„æºå®šé¢**: ResourceQuota é˜²æ­¢å•ä¸ªåº”ç”¨å ç”¨è¿‡å¤š

---

## æ€»ç»“

Staging ç¯å¢ƒçš„å®Œæ•´æµç¨‹ï¼š

```
æ¨é€ä»£ç 
   â†“
GitHub Actions è‡ªåŠ¨åŒ–
   - æ„å»º + æ¨é€é•œåƒ
   - æ›´æ–°éƒ¨ç½²æ¸…å•
   â†“
Git å˜æ›´
   â†“
ArgoCD æ£€æµ‹å¹¶åŒæ­¥
   - kustomize build
   - kubectl apply
   â†“
Kubernetes éƒ¨ç½²
   - æ–° Pods å¯åŠ¨
   - æ—§ Pods å…³é—­ (rolling update)
   â†“
çƒŸé›¾æµ‹è¯•éªŒè¯
   - å¥åº·æ£€æŸ¥
   - åŠŸèƒ½éªŒè¯
   â†“
âœ… Staging ç¯å¢ƒå°±ç»ª
```

è¿™ä¸ªæ¶æ„å®ç°äº†ï¼š
- âœ… **å®Œå…¨è‡ªåŠ¨åŒ–**: æ— éœ€æ‰‹åŠ¨ä»‹å…¥
- âœ… **Git ä¸­å¿ƒåŒ–**: æ‰€æœ‰å˜æ›´éƒ½åœ¨ Git ä¸­å¯å®¡è®¡
- âœ… **å£°æ˜å¼**: ä½¿ç”¨ Kustomize å’Œ ArgoCD å£°æ˜å¼éƒ¨ç½²
- âœ… **å¯è§‚æµ‹**: å®Œæ•´çš„æ—¥å¿—ã€æŒ‡æ ‡ã€äº‹ä»¶è·Ÿè¸ª
- âœ… **å¿«é€Ÿåé¦ˆ**: 15 åˆ†é’Ÿå†…è·å¾—éƒ¨ç½²ç»“æœ
