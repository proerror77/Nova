services:
  # ============================================
  # PostgreSQL Database
  # ============================================
  postgres:
    image: debezium/postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-nova_auth}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    ports:
      - "${POSTGRES_PORT:-55432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/migrations:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - nova-network


  # ============================================
  # Redis Cache
  # ============================================
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --requirepass ${REDIS_PASSWORD:-redis123}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - nova-network

  # ============================================
  # Zookeeper (for Kafka)
  # ============================================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.1
    restart: unless-stopped
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data
    networks:
      - nova-network

  # ============================================
  # Kafka Broker
  # ============================================
  kafka:
    image: confluentinc/cp-kafka:7.6.1
    restart: unless-stopped
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:29092
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
    ports:
      - "29092:29092"
    volumes:
      - kafka_data:/var/lib/kafka/data
    networks:
      - nova-network

  # ============================================
  # Kafka Connect / Debezium
  # ============================================
  debezium:
    image: debezium/connect:2.5
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_started
    environment:
      BOOTSTRAP_SERVERS: kafka:9092
      GROUP_ID: 1
      CONFIG_STORAGE_TOPIC: debezium_config
      OFFSET_STORAGE_TOPIC: debezium_offsets
      STATUS_STORAGE_TOPIC: debezium_status
      KEY_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      KEY_CONVERTER_SCHEMAS_ENABLE: "false"
      VALUE_CONVERTER_SCHEMAS_ENABLE: "false"
      ENABLE_DEBEZIUM_SCRIPTING: "true"
    ports:
      - "8083:8083"
    networks:
      - nova-network

  # ============================================
  # Kafka UI (observability)
  # ============================================
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    restart: unless-stopped
    depends_on:
      kafka:
        condition: service_started
    environment:
      KAFKA_CLUSTERS_0_NAME: nova-cluster
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
      KAFKA_CLUSTERS_0_KAFKACONNECT_0_NAME: debezium
      KAFKA_CLUSTERS_0_KAFKACONNECT_0_ADDRESS: http://debezium:8083
    networks:
      - nova-network

  # ============================================
  # ClickHouse (OLAP)
  # ============================================
  clickhouse:
    image: clickhouse/clickhouse-server:23.8
    restart: unless-stopped
    environment:
      CLICKHOUSE_DB: nova_feed
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: clickhouse
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    ports:
      - "8123:8123"   # HTTP
      - "9000:9000"   # Native TCP
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - clickhouse_logs:/var/log/clickhouse-server
      - ./backend/clickhouse:/docker-entrypoint-initdb.d
    healthcheck:
      test:
        [
          "CMD",
          "bash",
          "-c",
          "clickhouse-client --user=default --password=clickhouse --query='SELECT 1'"
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - nova-network

  # ============================================
  # Neo4j (Graph DB)
  # ============================================
  neo4j:
    image: neo4j:5.23
    restart: unless-stopped
    environment:
      # Use supported env for official image; default password must not be 'neo4j'
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:-novaPass_ChangeMe}
      - NEO4J_server_memory_pagecache_size=256M
      - NEO4J_server_memory_heap_max__size=512M
    ports:
      - "7474:7474"   # HTTP
      - "7687:7687"   # Bolt
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    healthcheck:
      test: ["CMD", "bash", "-lc", "/var/lib/neo4j/bin/cypher-shell -u ${NEO4J_USER:-neo4j} -p ${NEO4J_PASSWORD:-novaPass_ChangeMe} 'RETURN 1' || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10
    networks:
      - nova-network

  # ============================================
  # API Gateway (Nginx Reverse Proxy)
  # ============================================
  api-gateway:
    image: nginx:1.25-alpine
    restart: unless-stopped
    ports:
      - "3000:80"
    volumes:
      - ./backend/nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./backend/nginx/openapi:/etc/nginx/openapi:ro
    depends_on:
      - search-service
      - identity-service
    networks:
      - nova-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ============================================
  # Identity Service (gRPC - Replaces auth-service, Phase G)
  # ============================================
  identity-service:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: runtime
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # Application
      APP_ENV: development
      SERVER_HOST: 0.0.0.0
      SERVER_PORT: 9080
      RUST_LOG: identity_service=debug,info

      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-nova_auth}
      DATABASE_MAX_CONNECTIONS: 10
      DATABASE_MIN_CONNECTIONS: 2
      DATABASE_CONNECTION_TIMEOUT: 5
      DATABASE_IDLE_TIMEOUT: 300
      DATABASE_ACQUIRE_TIMEOUT: 10

      # Redis
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis123}@redis:6379/0
      REDIS_POOL_SIZE: 10

      # Kafka
      KAFKA_BROKERS: kafka:9092
      KAFKA_TOPIC_PREFIX: identity
      KAFKA_PRODUCER_TIMEOUT: 30

      # JWT (RS256 keys loaded from AWS Secrets Manager or env vars)
      JWT_SIGNING_KEY: ${JWT_PRIVATE_KEY:-}
      JWT_VALIDATION_KEY: ${JWT_PUBLIC_KEY:-}
      JWT_ALGORITHM: RS256
      JWT_ISSUER: nova-identity-service
      JWT_AUDIENCE: nova-api
      JWT_EXPIRY_SECONDS: 900

      # Email (SMTP)
      EMAIL_FROM_ADDRESS: ${EMAIL_FROM_ADDRESS:-noreply@nova.local}
      EMAIL_FROM_NAME: ${EMAIL_FROM_NAME:-Nova Platform}
      EMAIL_SMTP_HOST: ${EMAIL_SMTP_HOST:-}
      EMAIL_SMTP_PORT: ${EMAIL_SMTP_PORT:-587}
      EMAIL_SMTP_USERNAME: ${EMAIL_SMTP_USERNAME:-}
      EMAIL_SMTP_PASSWORD: ${EMAIL_SMTP_PASSWORD:-}
      EMAIL_SMTP_TLS: ${EMAIL_SMTP_TLS:-true}

      # OAuth Providers
      OAUTH_GOOGLE_CLIENT_ID: ${OAUTH_GOOGLE_CLIENT_ID:-}
      OAUTH_GOOGLE_CLIENT_SECRET: ${OAUTH_GOOGLE_CLIENT_SECRET:-}
      OAUTH_GOOGLE_REDIRECT_URI: ${OAUTH_GOOGLE_REDIRECT_URI:-http://localhost:3000/auth/google/callback}

      OAUTH_GITHUB_CLIENT_ID: ${OAUTH_GITHUB_CLIENT_ID:-}
      OAUTH_GITHUB_CLIENT_SECRET: ${OAUTH_GITHUB_CLIENT_SECRET:-}
      OAUTH_GITHUB_REDIRECT_URI: ${OAUTH_GITHUB_REDIRECT_URI:-http://localhost:3000/auth/github/callback}

      OAUTH_APPLE_CLIENT_ID: ${OAUTH_APPLE_CLIENT_ID:-}
      OAUTH_APPLE_TEAM_ID: ${OAUTH_APPLE_TEAM_ID:-}
      OAUTH_APPLE_KEY_ID: ${OAUTH_APPLE_KEY_ID:-}
      OAUTH_APPLE_PRIVATE_KEY: ${OAUTH_APPLE_PRIVATE_KEY:-}
      OAUTH_APPLE_REDIRECT_URI: ${OAUTH_APPLE_REDIRECT_URI:-http://localhost:3000/auth/apple/callback}

      OAUTH_WECHAT_APP_ID: ${OAUTH_WECHAT_APP_ID:-}
      OAUTH_WECHAT_APP_SECRET: ${OAUTH_WECHAT_APP_SECRET:-}
      OAUTH_WECHAT_REDIRECT_URI: ${OAUTH_WECHAT_REDIRECT_URI:-http://localhost:3000/auth/wechat/callback}

      # AWS Secrets Manager (Production)
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AWS_SECRETS_JWT_NAME: ${AWS_SECRETS_JWT_NAME:-}

      # Observability
      OTEL_EXPORTER_JAEGER_AGENT_HOST: jaeger
      OTEL_EXPORTER_JAEGER_AGENT_PORT: 6831

    ports:
      - "${IDENTITY_SERVICE_PORT:-9080}:9080"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_started
    networks:
      - nova-network
    healthcheck:
      test: ["CMD-SHELL", "grpc_health_probe -addr=localhost:9080 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

  # ============================================
  # Messaging Service (WS Gateway for DMs)
  # ============================================
  turn-server:
    image: coturn/coturn:4.6
    restart: unless-stopped
    command:
      - turnserver
      - --config
      - /etc/coturn/turnserver.conf
    volumes:
      - ./infra/turn/turnserver.conf:/etc/coturn/turnserver.conf:ro
    ports:
      - "3478:3478"
      - "3478:3478/udp"
      - "5349:5349"
      - "5349:5349/udp"
    networks:
      - nova-network

  # ============================================
  # Messaging Service (WebSocket API)
  # ============================================
  messaging-service:
    build:
      context: ./backend
      dockerfile: Dockerfile.messaging
    restart: unless-stopped
    environment:
      RTC_TURN_USERNAME: novauser
      RTC_TURN_PASSWORD: nova-pass
      RTC_ICE_TTL_SECONDS: 3600

      # APNs push notifications
      APNS_CERTIFICATE_PATH: ${APNS_CERTIFICATE_PATH:-/app/certs/apns_cert.p12}
      APNS_CERTIFICATE_PASSPHRASE: ${APNS_CERTIFICATE_PASSPHRASE:-}
      APNS_BUNDLE_ID: ${APNS_BUNDLE_ID:-com.example.nova}
      APNS_IS_PRODUCTION: ${APNS_IS_PRODUCTION:-false}
      JWT_PUBLIC_KEY_FILE: /app/certs/public_key.pem

      # JWT public key sourced from env_file (.env) or secrets

      # 32-byte key (base64) for server-side encryption used by messaging-service endpoints
      # Random dev key; replace in production
      SECRETBOX_KEY_B64: dGVzdGluZy10ZXN0aW5nLXRlc3RpbmctdGVzdGluZy10ZXN0aW5nMDA=
    volumes:
      - ./backend/keys:/app/certs:ro
    # NOTE: Internal port 3000 is NOT exposed to host
    # Access via API Gateway (api-gateway:3000) instead
    # Uncomment below for direct debugging access:
    # ports:
    #   - "8085:3000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_started
    networks:
      - nova-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ============================================
  # Streaming Services
  # ============================================
  streaming-ingest:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: runtime
    restart: unless-stopped
    environment:
      RUST_LOG: info
      APP_ENV: development
      RTMP_BIND_ADDR: "0.0.0.0:1935"
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-nova_auth}
      KAFKA_BROKERS: kafka:9092
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis123}@redis:6379/0
    ports:
      - "1935:1935"  # RTMP
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_started
      redis:
        condition: service_healthy
    networks:
      - nova-network

  streaming-transcode:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: runtime
    restart: unless-stopped
    environment:
      RUST_LOG: info
      APP_ENV: development
      KAFKA_BROKERS: kafka:9092
      KAFKA_CONSUMER_TOPIC: stream-frames
      SEGMENT_OUTPUT_DIR: /var/segments
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis123}@redis:6379/1
      MOCK_FFMPEG: "true"
    depends_on:
      kafka:
        condition: service_started
      redis:
        condition: service_healthy
    volumes:
      - streaming_segments:/var/segments
    networks:
      - nova-network

  streaming-delivery:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: runtime
    restart: unless-stopped
    environment:
      RUST_LOG: info
      APP_ENV: development
      APP_HOST: 0.0.0.0
      APP_PORT: 8080
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis123}@redis:6379/2
    ports:
      - "8082:8080"  # HLS/DASH delivery
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - nova-network

  streaming-api:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: runtime
    restart: unless-stopped
    environment:
      RUST_LOG: info
      APP_ENV: development
      APP_HOST: 0.0.0.0
      APP_PORT: 8081
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-nova_auth}
      KAFKA_BROKERS: kafka:9092
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis123}@redis:6379/3
    ports:
      - "8081:8081"  # Management API
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_started
      redis:
        condition: service_healthy
    networks:
      - nova-network

  # ============================================
  # Milvus (Vector DB) - Standalone
  # ============================================
  milvus:
    image: milvusdb/milvus:v2.4.3
    restart: unless-stopped
    entrypoint: ["/tini", "--"]
    command: ["milvus", "run", "standalone"]
    depends_on:
      minio:
        condition: service_healthy
    ports:
      - "19530:19530"   # gRPC
      - "9091:9091"     # HTTP
    environment:
      ETCD_USE_EMBED: "true"
      MINIO_USE_EMBED: "false"
      MINIO_ADDRESS: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_BUCKET_NAME: ${MINIO_BUCKET_NAME:-a-bucket}
      LOG_LEVEL: info
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/api/v1/health"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - nova-network

  # ============================================
  # MinIO (Object Storage for Milvus)
  # ============================================
  minio:
    image: minio/minio:RELEASE.2024-09-22T00-33-43Z
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    ports:
      - "9002:9000"
      - "9003:9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - nova-network

  # ============================================
  # Search Service (Axum)
  # ============================================
  search-service:
    build:
      context: ./backend/search-service
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-nova_auth}
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis123}@redis:6379/0
      PORT: 8086
      RUST_LOG: search_service=debug,tower_http=debug
    # NOTE: Internal port 8086 is NOT exposed to host
    # Access via API Gateway (api-gateway:3000) instead
    # Uncomment below for direct debugging access:
    # ports:
    #   - "8086:8086"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - nova-network

  # ============================================
  # Recommendation Service (Rust Actix-web)
  # ============================================
  recommendation-service:
    build:
      context: ./backend/recommendation-service
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # Application
      APP_ENV: development
      APP_PORT: 8000
      RUST_LOG: info,recommendation_service=debug
      LOG_LEVEL: debug

      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-nova_auth}
      DATABASE_MAX_CONNECTIONS: 10

      # Redis
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis123}@redis:6379/1

      # Kafka
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      KAFKA_GROUP_ID: recommendation-service-group

      # Recommendation Models
      COLLAB_MODEL_PATH: ./models/collaborative.bin
      CONTENT_MODEL_PATH: ./models/content.bin
      ONNX_MODEL_PATH: ./models/ranker.onnx
      ENABLE_AB_TESTING: "true"

      # gRPC
      USER_SERVICE_GRPC_URL: http://identity-service:9080
      USER_SERVICE_GRPC_TIMEOUT_SECS: 30

      # Neo4j for social graph
      NEO4J_ENABLED: "true"
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-neo4j}

      # Milvus Vector Search
      MILVUS_URL: http://milvus:19530
    # NOTE: Internal port 8000 is NOT exposed to host
    # Access via API Gateway (api-gateway:3000) instead
    # Uncomment below for direct debugging access:
    # ports:
    #   - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      milvus:
        condition: service_healthy
    networks:
      - nova-network
    volumes:
      - ./backend/recommendation-service/models:/app/models

  # ============================================
  # Milvus Vector Database
  # ============================================
  # milvus: (removed duplicate definition, using the one at line 612 instead)

  # ============================================
  # Analytics Service (CDC Consumer for ClickHouse)
  # ============================================
  analytics-service:
    build:
      context: .
      dockerfile: ./backend/analytics-service/Dockerfile
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # Application
      APP_ENV: development
      PORT: 8087
      RUST_LOG: info,analytics_service=debug

      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-nova_auth}
      DATABASE_MAX_CONNECTIONS: 10

      # Kafka
      KAFKA_BROKERS: kafka:9092

      # ClickHouse
      CLICKHOUSE_URL: http://clickhouse:8123
      CLICKHOUSE_DATABASE: nova_feed
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-clickhouse}

      # CDC Consumer (enabled by default)
      CDC_CONSUMER_ENABLED: "true"
      CDC_TOPICS: cdc.posts,cdc.follows,cdc.comments,cdc.likes
      CDC_CONSUMER_GROUP: analytics-cdc-consumer-v1
      CDC_MAX_CONCURRENT_INSERTS: 10

      # Outbox Publisher
      OUTBOX_PUBLISHER_ENABLED: "true"
    # NOTE: Internal ports are NOT exposed to host
    # Access via API Gateway (api-gateway:3000) instead
    # Uncomment below for direct debugging access:
    # ports:
    #   - "8087:8087"
    #   - "9087:9087"  # gRPC
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_started
      clickhouse:
        condition: service_healthy
      debezium:
        condition: service_started
    networks:
      - nova-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8087/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

  # ============================================
  # Content Service (Feed Ranking & Posts API)
  # ============================================
  content-service:
    build:
      context: .
      dockerfile: ./backend/content-service/Dockerfile
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # Application
      APP_ENV: development
      CONTENT_SERVICE_HOST: 0.0.0.0
      CONTENT_SERVICE_PORT: 8088
      RUST_LOG: info,content_service=debug

      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-nova_auth}
      DATABASE_MAX_CONNECTIONS: 20

      # Redis
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis123}@redis:6379/0

      # Kafka
      KAFKA_BROKERS: kafka:9092
      KAFKA_EVENTS_TOPIC: nova-events

      # ClickHouse (for feed ranking)
      CLICKHOUSE_URL: http://clickhouse:8123
      CLICKHOUSE_DATABASE: nova_feed
      CLICKHOUSE_USERNAME: default
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-clickhouse}
      CLICKHOUSE_QUERY_TIMEOUT_MS: 2000

      # Feed Ranking Config
      FEED_FRESHNESS_WEIGHT: "0.3"
      FEED_ENGAGEMENT_WEIGHT: "0.4"
      FEED_AFFINITY_WEIGHT: "0.3"
      FEED_FRESHNESS_LAMBDA: "0.1"
      FEED_MAX_CANDIDATES: "1000"
      FEED_CANDIDATE_PREFETCH_MULTIPLIER: "5"
      FEED_FALLBACK_CACHE_TTL_SECS: "60"
      FEED_MAX_CONSECUTIVE_SAME_AUTHOR: "2"
      FEED_FILTER_SEEN_POSTS: "true"

      # CORS
      CORS_ALLOWED_ORIGINS: "http://localhost:3000"
    # NOTE: Internal port is NOT exposed to host
    # Access via API Gateway (api-gateway:3000) instead
    # Uncomment below for direct debugging access:
    # ports:
    #   - "8088:8088"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_started
      clickhouse:
        condition: service_healthy
      analytics-service:
        condition: service_healthy
    networks:
      - nova-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8088/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

  # ============================================
  # Admin API (Backend for Admin Dashboard)
  # ============================================
  admin-api:
    build:
      context: .
      dockerfile: ./admin-api/Dockerfile
    restart: unless-stopped
    environment:
      # Application
      APP_ENV: development
      SERVER_HOST: 0.0.0.0
      SERVER_PORT: 8080
      RUST_LOG: admin_api=debug,info

      # Database (shared with main services, uses admin schema)
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-nova_auth}
      DATABASE_MAX_CONNECTIONS: 10

      # Redis (shared)
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis123}@redis:6379/5

      # JWT
      JWT_SECRET: ${ADMIN_JWT_SECRET:-admin-jwt-secret-change-in-production}
      JWT_EXPIRY_HOURS: 24
    ports:
      - "${ADMIN_API_PORT:-8090}:8080"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - nova-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ============================================
  # Admin Web (Frontend Dashboard)
  # ============================================
  admin-web:
    build:
      context: ./admin-web
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "${ADMIN_WEB_PORT:-3001}:80"
    depends_on:
      - admin-api
    networks:
      - nova-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1/"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ============================================
  # MailHog (Email testing - development only)
  # ============================================
  mailhog:
    image: mailhog/mailhog:latest
    restart: unless-stopped
    ports:
      - "1025:1025"  # SMTP
      - "8025:8025"  # Web UI
    networks:
      - nova-network

  # ============================================
  # Jaeger (Distributed Tracing)
  # ============================================
  jaeger:
    image: jaegertracing/all-in-one:latest
    restart: unless-stopped
    ports:
      - "6831:6831/udp"  # Jaeger agent (UDP)
      - "6832:6832/udp"  # Jaeger agent (UDP compact)
      - "5778:5778"      # Jaeger agent (HTTP)
      - "16686:16686"    # Jaeger UI
      - "14268:14268"    # Jaeger collector (HTTP)
      - "14250:14250"    # Jaeger collector (gRPC)
      - "9411:9411"      # Zipkin compatible endpoint
    environment:
      COLLECTOR_ZIPKIN_HOST_PORT: ":9411"
      COLLECTOR_OTLP_ENABLED: "true"
    networks:
      - nova-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:16686/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

# ============================================
# Volumes
# ============================================
volumes:
  postgres_data:
    driver: local
  postgres_data_messaging:
    driver: local
  redis_data:
    driver: local
  zookeeper_data:
    driver: local
  kafka_data:
    driver: local
  clickhouse_data:
    driver: local
  clickhouse_logs:
    driver: local
  streaming_segments:
    driver: local
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  minio_data:
    driver: local
  milvus_data:
    driver: local

# ============================================
# Networks
# ============================================
networks:
  nova-network:
    driver: bridge
