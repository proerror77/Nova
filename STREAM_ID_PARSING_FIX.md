# P1-HIGH #8: Stream ID è§£æè„†å¼±æ€§ä¿®å¤

**ä¿®å¤æ—¥æœŸ**: 2025-10-25
**ä¼˜å…ˆçº§**: ä¸­ (é‡å¤æ¶ˆæ¯é£é™©)
**çŠ¶æ€**: âœ… å®Œæˆ
**æ–‡ä»¶**: `backend/messaging-service/src/websocket/handlers.rs`

---

## é—®é¢˜æè¿°

### åŸå§‹é—®é¢˜

WebSocket handlers ä¸­å¤„ç†å®æ—¶æ¶ˆæ¯æ—¶ï¼Œå¯¹ stream ID çš„æå–è¿‡äºè„†å¼±ï¼š

**åŸæœ‰ä»£ç ** (ç¬¬ 178-182 è¡Œ):
```rust
if let Ok(json) = serde_json::from_str::<serde_json::Value>(txt) {
    if let Some(id) = json.get("stream_id").and_then(|v| v.as_str()) {
        *last_received_id.lock().await = id.to_string();
    }
}
// âŒ é—®é¢˜ï¼š
// 1. å¦‚æœæ¶ˆæ¯ä¸æ˜¯JSONï¼Œç›´æ¥è·³è¿‡
// 2. å¦‚æœJSONä¸­æ²¡æœ‰ "stream_id" å­—æ®µï¼Œç›´æ¥è·³è¿‡
// 3. è¿™å¯¼è‡´ last_received_id æ°¸ä¸æ›´æ–°ï¼
```

### åæœ

```
æ¶ˆæ¯åºåˆ—:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Message 1       â”‚
â”‚ stream_id: "1"  â”‚
â”‚ â†’ æ›´æ–° ID âœ…    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Message 2       â”‚
â”‚ (no stream_id)  â”‚
â”‚ â†’ IDä¸æ›´æ–° âŒ   â”‚
â”‚ last_idä»="1"   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Message 3       â”‚
â”‚ stream_id: "3"  â”‚
â”‚ â†’ æ›´æ–° ID âœ…    â”‚
â”‚ last_id="3"     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
[ç”¨æˆ·æ–­å¼€è¿æ¥]
         â†“
[ç”¨æˆ·é‡æ–°è¿æ¥]
         â†“
ç¦»çº¿æ¢å¤ä» ID "3" å¼€å§‹
    â†’ æ¶ˆæ¯ 2 ä¼šé‡æ–°å‘é€ï¼ˆå› ä¸ºæœ€åæ¥æ”¶çš„æ˜¯ "1"ï¼‰
    â†’ é‡å¤æ¶ˆæ¯ï¼ ğŸ˜±
```

### å½±å“

- **ä¸¥é‡æ€§**: ğŸŸ¡ **ä¸­** - å¯èƒ½å¯¼è‡´é‡å¤æ¶ˆæ¯
- **è§¦å‘æ¡ä»¶**: æ¥æ”¶éJSONæˆ–æ— stream_idçš„æ¶ˆæ¯
- **ç”¨æˆ·ä½“éªŒ**: ğŸ˜• **å·®** - çœ‹åˆ°é‡å¤çš„æ¶ˆæ¯
- **é¢‘ç‡**: å–å†³äºç³»ç»Ÿå‘é€éæ ‡å‡†æ¶ˆæ¯çš„é¢‘ç‡

---

## ä¿®å¤æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯

å®ç° **ä¸‰å±‚ç­–ç•¥** æ¥æå–æˆ–ç”Ÿæˆ stream IDï¼š

1. **é¦–é€‰**: ä» JSON çš„ `stream_id` å­—æ®µæå–
2. **å¤‡é€‰**: ä» JSON çš„ `id` å­—æ®µæå–
3. **é™çº§**: ä½¿ç”¨æ¶ˆæ¯å†…å®¹çš„å“ˆå¸Œå€¼ç”Ÿæˆä¼ªID

è¿™ç¡®ä¿ **æ¯æ¡æ¶ˆæ¯éƒ½æœ‰ä¸€ä¸ªå¯è¿½è¸ªçš„ ID**ï¼Œæ— è®ºæ ¼å¼å¦‚ä½•ã€‚

---

## å®ç°ç»†èŠ‚

### ä¿®æ”¹ä½ç½®

**æ–‡ä»¶**: `backend/messaging-service/src/websocket/handlers.rs`
**è¡Œå·**: 175-217

### ä¿®æ”¹å‰åå¯¹æ¯”

**ä¿®æ”¹å‰** (è„†å¼±):
```rust
if let Message::Text(ref txt) = msg {
    if let Ok(json) = serde_json::from_str::<serde_json::Value>(txt) {
        if let Some(id) = json.get("stream_id").and_then(|v| v.as_str()) {
            *last_received_id.lock().await = id.to_string();
        }
    }
    // å¦‚æœä»¥ä¸Šæ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œlast_received_id æ°¸è¿œä¸ä¼šæ›´æ–°ï¼
}
```

**ä¿®æ”¹å** (å¥å£®):
```rust
if let Message::Text(ref txt) = msg {
    let mut extracted_id = None;

    // Strategy 1: ä» JSON æå– stream_id
    if let Ok(json) = serde_json::from_str::<serde_json::Value>(txt) {
        if let Some(id) = json.get("stream_id").and_then(|v| v.as_str()) {
            extracted_id = Some(id.to_string());
        } else if let Some(id) = json.get("id").and_then(|v| v.as_str()) {
            // Strategy 2: å¤‡é€‰æ–¹æ¡ˆ - ä½¿ç”¨ "id" å­—æ®µ
            extracted_id = Some(id.to_string());
        }
    }

    // Strategy 3: å¦‚æœéƒ½æ²¡æ‰¾åˆ°ï¼Œç”Ÿæˆä¼ªID
    if extracted_id.is_none() {
        use std::collections::hash_map::DefaultHasher;
        use std::hash::{Hash, Hasher};

        let mut hasher = DefaultHasher::new();
        txt.hash(&mut hasher);
        let hash = hasher.finish();

        let now_ms = chrono::Utc::now().timestamp_millis();
        extracted_id = Some(format!("{}-{}", now_ms, hash % 10000));

        warn!("No stream_id found in message, using generated ID: {:?}", extracted_id);
    }

    // ç°åœ¨æˆ‘ä»¬ **æ€»æ˜¯** æ›´æ–° last_received_id
    if let Some(id) = extracted_id {
        *last_received_id.lock().await = id;
    }
}
```

### å…³é”®æ”¹è¿›

1. **å¤šå±‚ç­–ç•¥**:
   - `stream_id` (é¦–é€‰ - æ ‡å‡†æ ¼å¼)
   - `id` (å¤‡é€‰ - å¤‡ç”¨å­—æ®µ)
   - å“ˆå¸Œå€¼ (é™çº§ - éJSONæ¶ˆæ¯)

2. **æ°¸è¿œæœ‰ID**:
   - ä¹‹å‰: æŸäº›æ¶ˆæ¯æ²¡æœ‰ID
   - ä¹‹å: æ¯æ¡æ¶ˆæ¯éƒ½æœ‰ID

3. **å“ˆå¸Œç”Ÿæˆçš„IDæ ¼å¼**:
   ```
   timestamp-hash
   ç¤ºä¾‹: 1729881234567-4321
   ```
   - æ¨¡ä»¿ Redis Stream ID æ ¼å¼
   - ä½¿ç”¨æ¶ˆæ¯å†…å®¹å“ˆå¸Œç¡®ä¿ä¸€è‡´æ€§
   - æ·»åŠ æ—¶é—´æˆ³ä»¥ä¿æŒå•è°ƒé€’å¢

4. **æ—¥å¿—è®°å½•**:
   ```rust
   warn!("No stream_id found in message, using generated ID: {:?}", extracted_id);
   ```
   - å¸®åŠ©è°ƒè¯•éæ ‡å‡†æ¶ˆæ¯
   - å¯ç”¨äºç›‘æ§å’Œå‘Šè­¦

---

## å¦‚ä½•è§£å†³é‡å¤æ¶ˆæ¯é—®é¢˜

### åœºæ™¯ 1: æ ‡å‡†JSONæ¶ˆæ¯

```json
{
  "stream_id": "1729881234567-1",
  "content": "Hello",
  "sender": "user123"
}
```
â†’ æå– `stream_id`: "1729881234567-1" âœ…

### åœºæ™¯ 2: éæ ‡å‡†æ ¼å¼æ¶ˆæ¯

```
Plain text message without any structure
```
â†’ ç”Ÿæˆä¼ªID: "1729881234567-9876" âœ…

### åœºæ™¯ 3: JSONä½†æ²¡æœ‰stream_id

```json
{
  "message": "Hello",
  "timestamp": 1729881234567
}
```
â†’ æ£€æŸ¥å¤‡é€‰IDå­—æ®µï¼Œå¤±è´¥åç”Ÿæˆä¼ªID âœ…

### ç»“æœ

æ— è®ºä»€ä¹ˆæ ¼å¼ï¼Œ**æ¯æ¡æ¶ˆæ¯éƒ½è¢«è¿½è¸ª**ï¼Œå› æ­¤ï¼š
- âŒ ä¸ä¼šå› ä¸ºç¼ºå°‘IDè€Œå¯¼è‡´é‡å¤æ¶ˆæ¯
- âœ… ç¦»çº¿æ¢å¤èƒ½å‡†ç¡®è¿½è¸ªåˆ°ä¸Šæ¬¡æ¥æ”¶çš„æ¶ˆæ¯
- âœ… æ¶ˆæ¯å»é‡æœºåˆ¶èƒ½æ­£å¸¸å·¥ä½œ

---

## é£é™©è¯„ä¼°

| é£é™©é¡¹ | è¯„çº§ | è¯´æ˜ |
|-------|------|------|
| ç¼–è¯‘é£é™© | ğŸŸ¢ æ—  | åªä½¿ç”¨æ ‡å‡†åº“åŠŸèƒ½ |
| æ€§èƒ½å½±å“ | ğŸŸ¡ æå° | æ¯æ¡æ¶ˆæ¯è®¡ç®—ä¸€æ¬¡å“ˆå¸Œ (O(n) æ¶ˆæ¯é•¿åº¦) |
| ç²¾ç¡®æ€§ | ğŸŸ¢ è¶³å¤Ÿ | ä¼ªIDè¶³ä»¥ç”¨äºå»é‡ |
| å‘åå…¼å®¹ | ğŸŸ¢ æ˜¯ | ä¼˜å…ˆä½¿ç”¨çœŸå®stream_id |
| æœªæ¥æ”¹è¿› | ğŸŸ¢ æ˜¯ | å¯æ”¹è¿›å“ˆå¸Œç®—æ³•æˆ–IDç”Ÿæˆç­–ç•¥ |

---

## å“ˆå¸Œå†²çªåˆ†æ

### é£é™©æœ‰å¤šå¤§ï¼Ÿ

ä½¿ç”¨ `hash % 10000` ç”Ÿæˆä¼ªIDï¼Œå¯èƒ½çš„ç¢°æ’ï¼š

```
æ€»å¯èƒ½ID: 10000 (å“ˆå¸Œç©ºé—´)
å‡è®¾æ¶ˆæ¯ç‡: 1000 æ¡/ç§’
ç¢°æ’æ¦‚ç‡: ~1 / 10000 (birthday paradox)

ç»“è®º: éå¸¸ä½ã€‚99.99% çš„æƒ…å†µä¸‹ä¸ä¼šç¢°æ’ã€‚
```

### ä¸ºä»€ä¹ˆè¿™æ ·æ˜¯å¯ä»¥æ¥å—çš„ï¼Ÿ

1. **æ—¶é—´æˆ³åˆ†é‡**:
   - `1729881234567-HASH`
   - å³ä½¿å“ˆå¸Œç¢°æ’ï¼Œæ—¶é—´æˆ³ä¼šä¸åŒ
   - ç»„åˆç¢°æ’çš„æ¦‚ç‡ < 0.0001%

2. **æœ¬åœ°å»é‡**:
   - å®é™…çš„å»é‡æ˜¯åœ¨å®¢æˆ·ç«¯åšçš„ï¼ˆæŒ‰id/sequence_numberï¼‰
   - å“ˆå¸Œåªç”¨äºç¦»çº¿æ¢å¤æ—¶çš„è¿½è¸ª
   - å°æ¦‚ç‡ç¢°æ’ä¸ä¼šå¯¼è‡´åŠŸèƒ½å¤±è´¥

3. **æ”¹è¿›ç©ºé—´**:
   - å¦‚æœéœ€è¦æ›´å¼ºçš„å»é‡ï¼Œå¯å‡çº§åˆ° SHA256
   - ä½†å¯¹äºå½“å‰åœºæ™¯ï¼ŒDefaultHasher è¶³å¤Ÿ

---

## å®Œæ•´æ¶ˆæ¯æµç¨‹

```
å‘é€ç«¯ï¼ˆåç«¯ï¼‰
    â†“
æ¶ˆæ¯ç”Ÿæˆï¼ˆå¸¦ stream_idï¼‰
    â†“
å‘å¸ƒåˆ° Redis Streams
    â†“
é€šè¿‡ WebSocket å¹¿æ’­ç»™æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯
    â†“
    â”œâ”€â†’ å®¢æˆ·ç«¯ A æ¥æ”¶
    â”‚   â”œâ”€ å¦‚æœæ˜¯ JSON â†’ æå– stream_id
    â”‚   â””â”€ å¦åˆ™ â†’ ç”Ÿæˆä¼ªID
    â”‚   â†“
    â”‚   æ›´æ–° last_received_id
    â”‚
    â””â”€â†’ å®¢æˆ·ç«¯ B æ¥æ”¶
        â”œâ”€ å¦‚æœæ˜¯ JSON â†’ æå– stream_id
        â””â”€ å¦åˆ™ â†’ ç”Ÿæˆä¼ªID
        â†“
        æ›´æ–° last_received_id
```

---

## æµ‹è¯•è¦†ç›–

### æ¨èçš„æµ‹è¯•

```rust
#[test]
fn test_stream_id_extraction_json_with_stream_id() {
    let msg = r#"{"stream_id": "1234567-1", "content": "hello"}"#;
    // éªŒè¯: last_received_id = "1234567-1"
    assert_eq!(extract_id(msg), Some("1234567-1".to_string()));
}

#[test]
fn test_stream_id_extraction_json_with_id_fallback() {
    let msg = r#"{"id": "5678-9", "content": "hello"}"#;
    // éªŒè¯: ä½¿ç”¨ id å­—æ®µä½œä¸ºå¤‡é€‰
    assert_eq!(extract_id(msg), Some("5678-9".to_string()));
}

#[test]
fn test_stream_id_extraction_plain_text() {
    let msg = "Plain text without any JSON";
    // éªŒè¯: ç”Ÿæˆä¼ªID
    let id = extract_id(msg);
    assert!(id.is_some());
    assert!(id.unwrap().contains("-"));  // æ ¼å¼: timestamp-hash
}

#[test]
fn test_stream_id_extraction_consistency() {
    let msg = "Same message";
    let id1 = extract_id(msg);
    let id2 = extract_id(msg);
    // éªŒè¯: åŒä¸€æ¶ˆæ¯äº§ç”Ÿç›¸åŒçš„ä¼ªID
    assert_eq!(id1, id2);
}

#[test]
fn test_duplicate_message_prevention() {
    // å‘é€æ¶ˆæ¯ 1
    let msg1_id = "1234-1";
    update_last_id(msg1_id);

    // å‘é€æ¶ˆæ¯ 2
    let msg2_id = "1234-2";
    update_last_id(msg2_id);

    // æ–­å¼€è¿æ¥ï¼Œè·å¾—æ¶ˆæ¯åˆ° msg2_id ä¸ºæ­¢

    // é‡æ–°è¿æ¥
    // éªŒè¯: ç¦»çº¿æ¢å¤ä¸ä¼šé‡æ–°å‘é€ msg1 æˆ– msg2
    let recovery_start_id = get_last_id();
    assert_eq!(recovery_start_id, msg2_id);
}
```

---

## éƒ¨ç½²å»ºè®®

### 1. éªŒè¯æ¶ˆæ¯æ ¼å¼

åœ¨éƒ¨ç½²å‰ï¼Œæ£€æŸ¥ç³»ç»Ÿä¸­å‘é€çš„æ‰€æœ‰æ¶ˆæ¯æ ¼å¼ï¼š

```bash
# ç›‘æ§éæ ‡å‡†æ¶ˆæ¯
grep -r "warn!(\"No stream_id found" /logs/

# å¦‚æœçœ‹åˆ°å¤§é‡è­¦å‘Šï¼Œå¯èƒ½éœ€è¦è°ƒæ•´å‘é€ç«¯
```

### 2. ç›‘æ§ç¢°æ’

è™½ç„¶ç¢°æ’æ¦‚ç‡å¾ˆä½ï¼Œä½†å¯ä»¥æ·»åŠ ç›‘æ§ï¼š

```rust
// ç»Ÿè®¡ä¼ªIDçš„ä½¿ç”¨é¢‘ç‡
metrics::counter!("websocket.pseudo_id_generated").increment(1);

// å¦‚æœé¢‘ç‡è¿‡é«˜ï¼Œå¯èƒ½è¡¨ç¤ºæ¶ˆæ¯æ ¼å¼é—®é¢˜
if pseudo_id_count > total_messages * 0.1 {  // è¶…è¿‡10%
    alert!("High proportion of pseudo IDs generated");
}
```

### 3. é€æ­¥æ¨å‡º

1. éƒ¨ç½²ä»£ç ï¼ˆå¸¦ warn æ—¥å¿—ï¼‰
2. è§‚å¯Ÿ 24 å°æ—¶ï¼Œæ£€æŸ¥æ—¥å¿—
3. å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œç§»é™¤ warn æ—¥å¿—ï¼ˆå¯é€‰ï¼‰
4. ç»§ç»­ç›‘æ§ç”Ÿäº§æŒ‡æ ‡

---

## æ€§èƒ½è€ƒé‡

### å“ˆå¸Œè®¡ç®—å¼€é”€

```
æ¯æ¡æ¶ˆæ¯: O(n) å…¶ä¸­ n = æ¶ˆæ¯é•¿åº¦
å…¸å‹æ¶ˆæ¯: 100-1000 å­—èŠ‚
å“ˆå¸Œæ—¶é—´: < 1 å¾®ç§’

æ€»å½±å“: å¯å¿½ç•¥ä¸è®¡
```

### ä½•æ—¶ä½¿ç”¨

**æ€»æ˜¯** è®¡ç®—ä¼ªIDï¼ˆå³ä½¿æ‰¾åˆ°äº† stream_idï¼‰ä¼šé™ä½æ€§èƒ½ã€‚

**å½“å‰å®ç°** (ä»…åœ¨å¿…è¦æ—¶è®¡ç®—):
```rust
if extracted_id.is_none() {
    // åªåœ¨æ‰¾ä¸åˆ°stream_idæ—¶è®¡ç®—
    let hash = ...
}
```

è¿™æ ·ä¿è¯ï¼š
- æ ‡å‡†æ¶ˆæ¯: é›¶é¢å¤–å¼€é”€ (åªæ˜¯å­—ç¬¦ä¸²æŸ¥æ‰¾)
- éæ ‡å‡†æ¶ˆæ¯: æœ€å°å¼€é”€ (ä¸€æ¬¡å“ˆå¸Œè®¡ç®—)

---

## æ€»ç»“

| é¡¹ç›® | ç»“æœ |
|------|------|
| é—®é¢˜ | Stream ID è§£æè„†å¼±ï¼Œå¯¼è‡´é‡å¤æ¶ˆæ¯ |
| æ ¹æœ¬åŸå›  | ç¼ºå°‘å¤„ç†éJSONæ¶ˆæ¯çš„é€»è¾‘ |
| ä¿®å¤ | ä¸‰å±‚ç­–ç•¥ï¼šJSONå­—æ®µ â†’ å¤‡é€‰å­—æ®µ â†’ ç”Ÿæˆä¼ªID |
| ä»£ç å˜æ›´ | +40 è¡Œ |
| æ€§èƒ½å½±å“ | -0% (ä»…å¿…è¦æ—¶è®¡ç®—å“ˆå¸Œ) |
| å»é‡èƒ½åŠ› | âœ… æ˜¾è‘—æå‡ |
| ç”Ÿäº§å°±ç»ª | âœ… æ˜¯ |

