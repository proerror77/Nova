#!/bin/bash
#
# Nova ä»£ç ä¸Šä¼ è„šæœ¬
# è‡ªåŠ¨åŒ–æµç¨‹: commit â†’ update â†’ push â†’ åˆ›å»º/æ›´æ–° PR
#
# ç”¨æ³•:
#   ./upload                    # äº¤äº’å¼è¾“å…¥ commit message
#   ./upload "commit message"   # ç›´æ¥æŒ‡å®š commit message
#   ./upload --help             # æ˜¾ç¤ºå¸®åŠ©
#

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
DEFAULT_BASE_BRANCH="main"
PROJECT_DIR="$(cd "$(dirname "$0")" && pwd)"

# å¸®åŠ©ä¿¡æ¯
show_help() {
    echo -e "${CYAN}Nova ä»£ç ä¸Šä¼ è„šæœ¬${NC}"
    echo ""
    echo "ç”¨æ³•:"
    echo "  ./upload                     äº¤äº’å¼æ¨¡å¼"
    echo "  ./upload \"commit message\"   ç›´æ¥æäº¤"
    echo "  ./upload --status            æŸ¥çœ‹å½“å‰çŠ¶æ€"
    echo "  ./upload --help              æ˜¾ç¤ºå¸®åŠ©"
    echo ""
    echo "æµç¨‹:"
    echo "  1. git add (æš‚å­˜æ›´æ”¹)"
    echo "  2. git commit (æäº¤)"
    echo "  3. git pull --rebase (æ›´æ–°)"
    echo "  4. git push (æ¨é€åˆ°è¿œç¨‹åˆ†æ”¯)"
    echo "  5. åˆ›å»ºæˆ–æ›´æ–° PR"
    exit 0
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}       Git çŠ¶æ€${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    # å½“å‰åˆ†æ”¯
    CURRENT_BRANCH=$(git branch --show-current)
    echo -e "${BLUE}åˆ†æ”¯:${NC} $CURRENT_BRANCH"

    # PR çŠ¶æ€
    PR_INFO=$(gh pr list --head "$CURRENT_BRANCH" --state open --json number,title,url 2>/dev/null || echo "[]")
    if [ "$PR_INFO" != "[]" ]; then
        PR_NUM=$(echo "$PR_INFO" | jq -r '.[0].number')
        PR_URL=$(echo "$PR_INFO" | jq -r '.[0].url')
        echo -e "${GREEN}PR:${NC} #$PR_NUM - $PR_URL"
    else
        echo -e "${YELLOW}PR:${NC} æ— æ´»è·ƒçš„ PR"
    fi

    echo ""
    echo -e "${BLUE}æ–‡ä»¶çŠ¶æ€:${NC}"
    git status --short

    echo ""
    echo -e "${BLUE}å¾…æ¨é€çš„æäº¤:${NC}"
    UNPUSHED=$(git log origin/$CURRENT_BRANCH..HEAD --oneline 2>/dev/null || echo "")
    if [ -z "$UNPUSHED" ]; then
        echo "  (æ— )"
    else
        echo "$UNPUSHED" | sed 's/^/  /'
    fi
    exit 0
}

# ä¸»æµç¨‹
main() {
    cd "$PROJECT_DIR"

    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}       Nova ä»£ç ä¸Šä¼ ${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    # è·å–å½“å‰åˆ†æ”¯
    CURRENT_BRANCH=$(git branch --show-current)
    echo -e "${BLUE}å½“å‰åˆ†æ”¯:${NC} $CURRENT_BRANCH"

    # æ£€æŸ¥æ˜¯å¦åœ¨ main åˆ†æ”¯
    if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "master" ]; then
        echo -e "${RED}é”™è¯¯: ä¸èƒ½ç›´æ¥åœ¨ $CURRENT_BRANCH åˆ†æ”¯ä¸Šæ“ä½œ${NC}"
        echo -e "${YELLOW}è¯·å…ˆåˆ›å»ºåŠŸèƒ½åˆ†æ”¯: git checkout -b feature/your-feature${NC}"
        exit 1
    fi

    # Step 1: æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
    echo ""
    echo -e "${YELLOW}[1/5] æ£€æŸ¥æ›´æ”¹...${NC}"

    CHANGES=$(git status --porcelain)
    if [ -z "$CHANGES" ]; then
        echo -e "${GREEN}  âœ“ æ²¡æœ‰å¾…æäº¤çš„æ›´æ”¹${NC}"

        # æ£€æŸ¥æ˜¯å¦æœ‰æœªæ¨é€çš„æäº¤
        UNPUSHED=$(git log origin/$CURRENT_BRANCH..HEAD --oneline 2>/dev/null || echo "")
        if [ -z "$UNPUSHED" ]; then
            echo -e "${YELLOW}  æ²¡æœ‰éœ€è¦ä¸Šä¼ çš„å†…å®¹${NC}"
            exit 0
        else
            echo -e "${BLUE}  æœ‰æœªæ¨é€çš„æäº¤ï¼Œç»§ç»­æ¨é€...${NC}"
            SKIP_COMMIT=true
        fi
    else
        echo -e "${GREEN}  âœ“ å‘ç° $(echo "$CHANGES" | wc -l | tr -d ' ') ä¸ªæ–‡ä»¶æœ‰æ›´æ”¹${NC}"
        git status --short | sed 's/^/    /'
        SKIP_COMMIT=false
    fi

    # Step 2: Commit
    if [ "$SKIP_COMMIT" != "true" ]; then
        echo ""
        echo -e "${YELLOW}[2/5] æäº¤æ›´æ”¹...${NC}"

        # è·å– commit message
        if [ -n "$COMMIT_MSG" ]; then
            MSG="$COMMIT_MSG"
        else
            echo -e "${BLUE}è¯·è¾“å…¥ commit message (æˆ–æŒ‰ Enter ä½¿ç”¨é»˜è®¤):${NC}"
            read -r MSG
            if [ -z "$MSG" ]; then
                # ç”Ÿæˆé»˜è®¤ message
                MSG="chore: update $(date +%Y-%m-%d)"
            fi
        fi

        # æ·»åŠ å¹¶æäº¤
        git add .
        git commit -m "$MSG

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"

        echo -e "${GREEN}  âœ“ å·²æäº¤${NC}"
    else
        echo ""
        echo -e "${YELLOW}[2/5] è·³è¿‡æäº¤ (æ— æ–°æ›´æ”¹)${NC}"
    fi

    # Step 3: Update (pull --rebase)
    echo ""
    echo -e "${YELLOW}[3/5] åŒæ­¥è¿œç¨‹æ›´æ–°...${NC}"

    if git pull --rebase origin "$CURRENT_BRANCH" 2>/dev/null; then
        echo -e "${GREEN}  âœ“ å·²åŒæ­¥${NC}"
    else
        echo -e "${BLUE}  è¿œç¨‹åˆ†æ”¯ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°åˆ†æ”¯${NC}"
    fi

    # Step 4: Push
    echo ""
    echo -e "${YELLOW}[4/5] æ¨é€åˆ°è¿œç¨‹...${NC}"

    git push -u origin "$CURRENT_BRANCH"
    echo -e "${GREEN}  âœ“ å·²æ¨é€${NC}"

    # Step 5: Create or update PR
    echo ""
    echo -e "${YELLOW}[5/5] å¤„ç† Pull Request...${NC}"

    # æ£€æŸ¥æ˜¯å¦å·²æœ‰ PR
    EXISTING_PR=$(gh pr list --head "$CURRENT_BRANCH" --state open --json number,url 2>/dev/null || echo "[]")

    if [ "$EXISTING_PR" != "[]" ]; then
        PR_NUM=$(echo "$EXISTING_PR" | jq -r '.[0].number')
        PR_URL=$(echo "$EXISTING_PR" | jq -r '.[0].url')
        echo -e "${GREEN}  âœ“ PR å·²å­˜åœ¨: #$PR_NUM${NC}"
        echo -e "${BLUE}    $PR_URL${NC}"
    else
        # åˆ›å»ºæ–° PR
        echo -e "${BLUE}  åˆ›å»ºæ–° PR...${NC}"

        # è·å–æœ€è¿‘çš„ commit ä¿¡æ¯ä½œä¸º PR æ ‡é¢˜
        PR_TITLE=$(git log -1 --pretty=%s)

        # è·å–åˆ†æ”¯çš„æ‰€æœ‰ commit ä½œä¸º PR body
        COMMITS=$(git log origin/$DEFAULT_BASE_BRANCH..HEAD --pretty="- %s" 2>/dev/null || git log -5 --pretty="- %s")

        PR_BODY="## Summary
$COMMITS

## Test plan
- [ ] Tested locally
- [ ] Code review completed

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)"

        PR_URL=$(gh pr create \
            --base "$DEFAULT_BASE_BRANCH" \
            --head "$CURRENT_BRANCH" \
            --title "$PR_TITLE" \
            --body "$PR_BODY" 2>&1)

        if [ $? -eq 0 ]; then
            echo -e "${GREEN}  âœ“ PR å·²åˆ›å»º${NC}"
            echo -e "${BLUE}    $PR_URL${NC}"
        else
            echo -e "${YELLOW}  PR åˆ›å»ºå¤±è´¥æˆ–å·²å­˜åœ¨: $PR_URL${NC}"
        fi
    fi

    # å®Œæˆ
    echo ""
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}  âœ“ ä¸Šä¼ å®Œæˆ!${NC}"
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
}

# å‚æ•°å¤„ç†
case "${1:-}" in
    --help|-h)
        show_help
        ;;
    --status|-s)
        show_status
        ;;
    "")
        COMMIT_MSG=""
        main
        ;;
    *)
        COMMIT_MSG="$1"
        main
        ;;
esac
