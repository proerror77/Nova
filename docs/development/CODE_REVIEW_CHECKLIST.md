# Nova 项目代码审查检查清单

**最后更新**: 2025-11-10  
**范围**: Rust后端微服务 + iOS Swift客户端  
**基准**: CLAUDE.md + Linus Torvalds代码品味标准

---

## 安全审查 (P0 Blockers)

### 认证与授权

- [ ] **JWT中间件** (`backend/graphql-gateway/src/middleware/jwt.rs` - 234行)
  - [ ] 验证JWT_SECRET是否使用环境变量（非硬编码）
  - [ ] 检查令牌过期时间配置是否合理
  - [ ] 确认签名算法是否为推荐算法（HS256/RS256）
  - [ ] 验证失败的错误处理是否返回401而非500
  - [ ] 检查是否有令牌刷新机制
  - **关键问题**: 第91行 `.expect("JWT_SECRET environment variable must be set")` 会panic，应改为错误处理

- [ ] **OAuth2实现** (`backend/auth-service/src/services/oauth.rs` - 745行)
  - [ ] 状态参数（state）是否被验证以防CSRF
  - [ ] 重定向URI是否被严格验证
  - [ ] 授权码是否一次性使用
  - [ ] 刷新令牌存储是否安全（秘密存储）

- [ ] **权限检查** (所有gRPC服务)
  - [ ] 每个端点是否都验证用户身份
  - [ ] 是否有基于角色的访问控制(RBAC)检查
  - [ ] 用户是否只能访问自己的资源

### 密码与加密

- [ ] **密码哈希** (`backend/libs/crypto-core/`)
  - [ ] Argon2配置是否使用推荐参数（>19MB内存）
  - [ ] 是否使用随机盐值（每个用户不同）
  - [ ] 旧密码格式迁移计划是否存在

- [ ] **E2EE通讯** (`backend/messaging-service/src/grpc/mod.rs` - 1167行)
  - [ ] AES-GCM是否正确使用（IV随机、AEAD标签验证）
  - [ ] 密钥交换协议是否安全（Diffie-Hellman/ECDH）
  - [ ] 消息验证码是否正确生成
  - [ ] 密钥存储是否安全（不在日志中）

- [ ] **JWT签名** (`backend/libs/crypto-core/src/jwt.rs` - 617行)
  - [ ] 签名密钥是否与加密密钥分离
  - [ ] 密钥轮换机制是否存在
  - [ ] 过期令牌是否从缓存清理

### 数据安全

- [ ] **凭证与密钥存储**
  - [ ] 是否有硬编码密钥/API密钥/数据库密码
  - [ ] AWS密钥是否从IAM角色获取（非环境变量）
  - [ ] 密钥是否出现在日志或错误消息中
  - [ ] .env文件是否被.gitignore正确忽略

- [ ] **个人身份信息(PII)处理**
  - [ ] 日志中是否包含用户邮箱/电话/地址
  - [ ] 数据库备份是否被加密
  - [ ] 删除用户数据时是否进行深度清理（所有关联表）

- [ ] **数据库查询**
  - [ ] 所有查询是否使用参数化（无字符串拼接）
  - [ ] 是否有SQL注入风险（raw string concatenation）
  - [ ] 外键约束是否正确设置（ON DELETE RESTRICT等）

### 网络安全

- [ ] **TLS/HTTPS**
  - [ ] gRPC是否强制使用TLS
  - [ ] HTTP是否重定向到HTTPS
  - [ ] 证书验证是否被跳过（如 `danger: allow self-signed`）

- [ ] **CORS配置** (`backend/graphql-gateway/`)
  - [ ] 允许的源是否过于宽泛（不使用 `*`）
  - [ ] 是否允许危险的HTTP方法（PUT/DELETE）
  - [ ] 凭证是否需要（secure cookie时）

- [ ] **Rate Limiting**
  - [ ] 是否对登录端点进行速率限制
  - [ ] 是否有DDoS防护
  - [ ] 限制是否基于IP或用户ID

---

## 代码质量审查 (P1)

### 复杂度与可维护性

- [ ] **文件大小** (目标 < 500行，最多 < 700行)
  - [ ] `content-service/src/grpc/server.rs` (**1268行** - 🔴需拆分)
    - 建议：分离 PostService、CommentService 为独立模块
  - [ ] `messaging-service/src/grpc/mod.rs` (**1167行** - 🔴需拆分)
  - [ ] `user-service/src/main.rs` (**1099行** - 🔴需拆分)
  - [ ] 其他 > 800行 的文件列表

- [ ] **函数长度** (目标 < 50行，最多 < 100行)
  - [ ] 扫描所有 > 100行的函数
  - [ ] 识别是否有多个职责的函数

- [ ] **嵌套深度** (目标 < 3层，最多 < 4层)
  - [ ] 是否有 5+ 层嵌套 if/match
  - [ ] 是否使用了卫语句（guard clauses）

- [ ] **循环复杂度**
  - [ ] 大量 if/else 是否可用 match 或模式匹配
  - [ ] 重复的条件检查是否可提取为函数

### 错误处理

- [ ] **panic! vs Result**
  - [ ] 是否有不必要的 `.unwrap()` 或 `.expect()`
  - [ ] I/O操作是否都返回 Result（不panic）
  - [ ] 外部API调用是否都处理错误

- [ ] **错误信息**
  - [ ] 错误消息是否清晰、可调试
  - [ ] 错误堆栈是否有上下文信息
  - [ ] 是否使用了 `.context()` (anyhow) 或自定义错误类型

- [ ] **回滚与恢复**
  - [ ] 事务是否在失败时自动回滚
  - [ ] 部分操作失败时是否有补偿操作

### 性能

- [ ] **数据库查询**
  - [ ] 是否有 N+1 查询问题（循环中查询）
  - [ ] 索引是否被使用（EXPLAIN ANALYZE）
  - [ ] 连接池配置是否合理（超时、最大连接数）

- [ ] **缓存策略**
  - [ ] Redis缓存键是否包含版本/时间戳
  - [ ] 缓存失效策略是否清晰（TTL、主动清理）
  - [ ] 缓存穿透、击穿、雪崩问题是否处理

- [ ] **异步与并发**
  - [ ] 是否有阻塞操作在异步代码中（.blocking()）
  - [ ] tokio::spawn() 是否监控返回值
  - [ ] 是否有死锁风险（互斥量嵌套）

### 测试覆盖

- [ ] **单元测试**
  - [ ] 所有公共函数是否都有测试
  - [ ] 错误路径是否都有测试
  - [ ] 边界值是否被测试（0, -1, MAX_INT等）

- [ ] **集成测试**
  - [ ] 关键gRPC端点是否都有集成测试
  - [ ] 数据库事务是否被测试（回滚、并发）
  - [ ] 第三方服务调用是否被mock

- [ ] **测试隔离性**
  - [ ] 测试是否依赖执行顺序
  - [ ] 测试数据是否被正确清理
  - [ ] 是否使用了 testcontainers（数据库隔离）

---

## 架构审查 (P1)

### 微服务边界

- [ ] **服务职责划分**
  - [ ] 是否违反单一职责原则
  - [ ] 是否有服务间的环形依赖
  - [ ] 跨服务调用是否通过API网关

- [ ] **数据所有权**
  - [ ] 每个服务是否有独立的数据库
  - [ ] 是否有跨服务的数据一致性问题
  - [ ] 事件驱动是否用于异步同步

- [ ] **通信方式**
  - [ ] 是否使用同步(gRPC/HTTP)还是异步(Kafka)
  - [ ] 超时与重试策略是否配置
  - [ ] 熔断器是否实现（`middleware/circuit_breaker.rs`）

### 配置管理

- [ ] **环境变量**
  - [ ] 是否所有配置都从环境变量读取
  - [ ] 是否有敏感值（密钥、密码）在代码中
  - [ ] 本地开发是否使用 .env.example

- [ ] **特性开关**
  - [ ] 新功能是否使用特性开关
  - [ ] 是否有回滚机制

### 扩展性

- [ ] **水平扩展**
  - [ ] 是否使用无状态设计
  - [ ] 会话存储是否外部化（Redis）
  - [ ] 是否有分布式锁（处理并发）

- [ ] **向后兼容性**
  - [ ] API版本控制是否清晰（v1, v2）
  - [ ] 数据库迁移是否遵循扩展-收缩模式
  - [ ] 废弃API是否有过渡期（3个版本以上）

---

## 特定服务审查

### GraphQL网关

**文件**: `backend/graphql-gateway/src/`  
**总行数**: 1,743行

- [ ] **schema/auth.rs** (99行)
  - [ ] 是否验证了所有输入字段
  - [ ] 错误消息是否泄露敏感信息

- [ ] **schema/user.rs** (125行)
  - [ ] 用户查询是否检查权限（只看自己数据）
  - [ ] 批量操作是否有限制（max_count）

- [ ] **schema/content.rs** (137行)
  - [ ] 内容可见性检查（私密/公开）
  - [ ] 删除操作是否需要所有者验证

- [ ] **clients.rs** (254行)
  - [ ] 超时是否已设置（所有调用）
  - [ ] 重试逻辑是否合理（exponential backoff）
  - [ ] 流式响应是否正确处理

### Auth Service

**文件**: `backend/auth-service/src/`  
**最大文件**: `grpc/mod.rs` (956行)

- [ ] **token生成**
  - [ ] 签名密钥源是否安全
  - [ ] 令牌过期时间是否合理（access: 15min, refresh: 7day）
  - [ ] 撤销机制是否存在（黑名单/白名单）

- [ ] **OAuth2流程**
  - [ ] 所有重定向是否验证
  - [ ] PKCE是否用于移动/SPA应用
  - [ ] 授权码是否有过期时间

- [ ] **第三方集成**
  - [ ] 是否验证ID令牌（检查签名）
  - [ ] 是否同步用户数据（邮箱、头像）

### Messaging Service

**文件**: `backend/messaging-service/src/`  
**最大文件**: `grpc/mod.rs` (1167行)

- [ ] **E2EE实现**
  - [ ] 密钥交换是否安全（ECDH）
  - [ ] 消息顺序是否保证（序列号）
  - [ ] 双棘轮算法(Double Ratchet)是否使用

- [ ] **离线消息**
  - [ ] 消息存储是否加密（不使用明文）
  - [ ] 消息过期策略是否清晰

### Content Service

**文件**: `backend/content-service/src/`  
**最大文件**: `grpc/server.rs` (1268行) 🔴 **需要重构**

- [ ] **权限检查** (第82-98行范围)
  - [ ] 获取帖子是否检查所有者权限
  - [ ] 删除帖子是否只允许所有者
  - [ ] 编辑评论是否检查所有者

- [ ] **缓存** (`services/mod.rs`)
  - [ ] 缓存键是否包含用户ID（隐私）
  - [ ] 缓存失效是否及时

### Feed Service

**文件**: `backend/feed-service/src/`  
**重点文件**: `grpc.rs` (895行), `handlers/recommendation.rs`

- [ ] **推荐算法**
  - [ ] 是否基于用户历史（可能泄露隐私）
  - [ ] 推荐多样性是否足够（避免信息茧房）
  - [ ] A/B测试是否记录（用户体验）

- [ ] **图形数据库** (`services/graph/neo4j.rs`)
  - [ ] 关系数据是否被缓存
  - [ ] 查询是否有超时保护

---

## iOS审查清单

### 关键文件

- [ ] **AuthService.swift**
  - [ ] 令牌刷新是否自动进行
  - [ ] 过期令牌是否清理
  - [ ] 生物识别(Face ID/Touch ID)是否正确使用

- [ ] **NetworkService / API调用**
  - [ ] 是否使用 URLSession 而非网络库
  - [ ] SSL证书验证是否启用
  - [ ] 是否有证书固定(Certificate Pinning)

- [ ] **本地数据存储**
  - [ ] 敏感数据是否使用 Keychain
  - [ ] UserDefaults 中是否存储敏感信息
  - [ ] Core Data 是否加密

- [ ] **权限请求**
  - [ ] Info.plist 是否有清晰的权限说明
  - [ ] 位置/麦克风/相机权限是否必要
  - [ ] 权限拒绝时是否有友好提示

---

## 部署与基础设施

### Kubernetes配置

- [ ] **镜像安全**
  - [ ] Dockerfile是否使用 scratch/distroless 基础镜像
  - [ ] 是否有漏洞扫描(Trivy)

- [ ] **资源限制**
  - [ ] CPU/内存限制是否合理
  - [ ] 启动探针(startup probe)是否设置
  - [ ] 存活探针(liveness probe)是否设置

- [ ] **秘密管理**
  - [ ] 是否使用 External Secrets Operator
  - [ ] 是否避免了hardcoded secrets

### 日志与监控

- [ ] **日志安全**
  - [ ] 是否过滤了敏感信息(PII)
  - [ ] 日志存储是否有访问控制
  - [ ] 日志保留期是否合理

- [ ] **监控告警**
  - [ ] 失败登录是否被监控
  - [ ] 异常行为是否被检测
  - [ ] 容错转移是否被监控

---

## 检查清单使用说明

### 如何使用

1. **第一阶段**: 安全审查 (P0 Blockers)
   - 必须100%通过才能merge
   - 每个项目前打上 ✅ 或 ❌

2. **第二阶段**: 代码质量 (P1)
   - 不是必须项，但强烈建议
   - 标记为 ⚠️ 的项可待改进

3. **第三阶段**: 架构审查 (P1)
   - 仅在大规模变更时进行

### 记录格式

```
## 审查日期: 2025-11-10
## 审查人: [姓名]
## PR: #XXX

### 安全审查结果
- [✅] JWT中间件: 通过，配置正确
- [❌] OAuth2: 发现CSRF风险，需修复

### 建议
- 将 content-service/grpc/server.rs 拆分为3个模块
- 添加集成测试覆盖E2EE场景

### 批准状态
[✅] 可以合并 / [⏳] 待改进 / [❌] 拒绝
```

