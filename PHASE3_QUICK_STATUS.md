# Phase 3 å¿«é€ŸçŠ¶æ€ | ä»£ç åˆ†æ + åˆ†é˜¶æ®µæŒ‡å—

## ğŸ¯ æ ¸å¿ƒå‘ç°

| æ–¹é¢ | çŠ¶æ€ | è¯¦æƒ… |
|-----|------|------|
| **æ•´ä½“å®Œæˆåº¦** | 60% | Phase 1-2 åŸºç¡€å·²æœ‰ï¼ŒPhase 3 æ ¸å¿ƒç¼ºå¤± |
| **å…³é”®é˜»å¡** | 2 é¡¹ CRITICAL | CDC consumer âŒ Events consumer âŒ |
| **å®æ–½å·¥ä½œé‡** | 15-20 å¤© | 2 äººå›¢é˜Ÿ Ã— 1.5-2 å‘¨ |
| **ä¸ç°æœ‰ä»£ç å…¼å®¹** | âœ… 100% | æ— éœ€é‡æ„ï¼Œä»…éœ€æ‰©å±• |

---

## âœ… ç°æœ‰èµ„äº§

```
Feed Ranking Service (src/services/feed_ranking.rs)
  â”œâ”€ ä¸‰ç»´æ’åºç®—æ³• (freshness/engagement/affinity) âœ“
  â”œâ”€ ClickHouse æŸ¥è¯¢ç”Ÿæˆ âœ“
  â”œâ”€ Redis ç¼“å­˜é›†æˆ âœ“
  â””â”€ å€™é€‰é›†å»é‡ âœ“

ClickHouse é›†æˆ (src/db/ch_client.rs)
  â”œâ”€ è¿æ¥æ±  + é‡è¯•é€»è¾‘ âœ“
  â”œâ”€ æŸ¥è¯¢æ‰§è¡Œ âœ“
  â””â”€ ååºåˆ—åŒ– âœ“

Redis ç¼“å­˜ (src/cache/feed_cache.rs)
  â”œâ”€ TTL è¿‡æœŸ âœ“
  â”œâ”€ å›¾æ¡ˆå¤±æ•ˆ âœ“
  â””â”€ å»é‡è¿½è¸ª âœ“

èƒŒæ™¯ Jobs (src/jobs/)
  â”œâ”€ Trending Generator âœ“
  â”œâ”€ Suggested Users Generator âœ“
  â””â”€ Job æ¡†æ¶ âœ“

Events Pipeline (éƒ¨åˆ†)
  â”œâ”€ HTTP ç«¯ç‚¹ âœ“
  â”œâ”€ Kafka ç”Ÿäº§è€… âœ“
  â””â”€ âŒ æ¶ˆè´¹è€…ç¼ºå¤±
```

---

## âŒ å…³é”®ç¼ºå¤±

### P0 - å¿…é¡»å®Œæˆï¼ˆå¦åˆ™ Phase 3 æ— æ³•å¯åŠ¨ï¼‰

**1. CDC æ¶ˆè´¹è€…æœåŠ¡** (3-5 å¤©)
```
å½“å‰é—®é¢˜ï¼šPostgreSQL å˜æ›´ â†’ Kafka â†’ [æ— äººæ¶ˆè´¹] âœ—
éœ€è¦ï¼šPostgreSQL â†’ Kafka â†’ CDC Consumer â†’ ClickHouse âœ“

æ–‡ä»¶ï¼šsrc/services/cdc/
  - consumer.rs (200 LOC)
  - offset_manager.rs (150 LOC)
  - models.rs (100 LOC)
```

**2. Events æ¶ˆè´¹è€…æœåŠ¡** (2-3 å¤©)
```
å½“å‰é—®é¢˜ï¼šå®¢æˆ·ç«¯äº‹ä»¶ â†’ Kafka â†’ [æ— äººæ¶ˆè´¹] âœ—
éœ€è¦ï¼šå®¢æˆ·ç«¯äº‹ä»¶ â†’ Kafka â†’ Events Consumer â†’ ClickHouse âœ“

æ–‡ä»¶ï¼šsrc/services/events/
  - consumer.rs (250 LOC)
  - dedup.rs (150 LOC)
  - models.rs (100 LOC)
```

### P1 - é«˜ä¼˜å…ˆçº§ï¼ˆé˜»å¡å¤§éƒ¨åˆ†åŠŸèƒ½ï¼‰

**3. ClickHouse ç‰©åŒ–è§†å›¾** (2 å¤©)
```
å½“å‰ï¼šEvents è¡¨ 10M+ è¡Œ â†’ æŸ¥è¯¢æ—¶æ‰«å…¨è¡¨ â†’ 3-5s âœ—
éœ€è¦ï¼šç‰©åŒ–è§†å›¾è‡ªåŠ¨èšåˆ â†’ æŸ¥è¯¢æ—¶é—´ 200-300ms âœ“

æ–‡ä»¶ï¼šinfra/clickhouse/views/
  - mv_post_metrics_1h.sql
  - mv_user_author_90d.sql
```

**4. Circuit Breaker** (1 å¤©)
```
å½“å‰ï¼šClickHouse æ•…éšœ â†’ æ•´ä¸ª Feed ä¸å¯ç”¨ âœ—
éœ€è¦ï¼šClickHouse æ•…éšœ â†’ è‡ªåŠ¨å›é€€ PostgreSQL âœ“

æ–‡ä»¶ï¼šsrc/middleware/
  - circuit_breaker.rs (200 LOC)
```

### P2 - ä¸­ä¼˜å…ˆçº§

**5. å®æ—¶ç¼“å­˜å¤±æ•ˆ** (1 å¤©)
**6. CDC ç®¡é“æŒ‡æ ‡** (2 å¤©)
**7. æ­»ä¿¡é˜Ÿåˆ—** (1 å¤©)

---

## ğŸ“… å»ºè®®æ—¶é—´è¡¨

```
Week 1: Phase 1 - åŸºç¡€ç®¡é“
  Mon: CDC Consumer åŸºç¡€ + Offset ç®¡ç†
  Tue: CDC Consumer å®Œæˆ + æµ‹è¯•
  Wed: Events Consumer åŸºç¡€
  Thu: Events Consumer å®Œæˆ + å»é‡
  Fri: é›†æˆæµ‹è¯• + ä¿®å¤
  â†’ å¯äº¤ä»˜ï¼šå®Œæ•´çš„äº‹ä»¶ç®¡é“ï¼ˆ0 ä¸¢å¤±ï¼‰

Week 2: Phase 2 - æ ¸å¿ƒåŠŸèƒ½
  Mon: ClickHouse ç‰©åŒ–è§†å›¾
  Tue: Circuit Breaker å®ç°
  Wed: å®æ—¶ç¼“å­˜å¤±æ•ˆ
  Thu: æŒ‡æ ‡æ”¶é›† (15+ metrics)
  Fri: ç«¯åˆ°ç«¯æµ‹è¯•
  â†’ å¯äº¤ä»˜ï¼šæ€§èƒ½è¾¾æ ‡ (P95 â‰¤150ms)

Week 3: Phase 3 - ä¼˜åŒ–å’Œéƒ¨ç½²
  Mon-Tue: æ€§èƒ½ä¼˜åŒ–
  Wed-Thu: å‹åŠ›æµ‹è¯• (1k RPS)
  Fri: æ–‡æ¡£ + ç”Ÿäº§éƒ¨ç½²
  â†’ å¯äº¤ä»˜ï¼šç”Ÿäº§å°±ç»ª
```

---

## ğŸ”§ å®æ–½è·¯å¾„

### Option A: è‡ªåŠ¨æ¸è¿›å¼å®æ–½
- æˆ‘è‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰ 127 é¡¹ä»»åŠ¡
- 2-3 å°æ—¶å®Œæˆï¼ˆä»£ç ç”Ÿæˆï¼‰
- éœ€è¦ä½ æ‰‹åŠ¨æµ‹è¯•å’Œè°ƒæ•´

### Option B: åˆ†é˜¶æ®µæŒ‡å¯¼ âœ… æ¨è
- Phase 1: æˆ‘æä¾›è¯¦ç»†ä»£ç æ¡†æ¶ + æ­¥éª¤
- ä½ æ‰‹åŠ¨å®æ–½ï¼ˆç¡®ä¿ç†è§£ï¼‰
- Phase 2+: åŸºäº Phase 1 ç»“æœè°ƒæ•´
- **ä¼˜åŠ¿**: å­¦ä¹ ã€æ§åˆ¶ã€è´¨é‡ä¿è¯

### Option C: å’¨è¯¢æ¨¡å¼
- æˆ‘ä½œä¸ºæ¶æ„å¸ˆæå»ºè®®
- ä½ çš„å›¢é˜Ÿè´Ÿè´£å®æ–½
- å‘¨ 1-2 å›é¡¾ + è°ƒæ•´

---

## ğŸ“„ å¯ç”¨æ–‡æ¡£

å·²ä¸ºä½ ç”Ÿæˆï¼š

1. **PHASE3_IMPLEMENTATION_GUIDE.md** (å½“å‰æ–‡ä»¶ä¸Šä¸€ä¸ª)
   - è¯¦ç»†çš„ Phase 1 å®æ–½æ­¥éª¤
   - ä»£ç æ¡†æ¶å’Œé›†æˆç‚¹
   - æµ‹è¯•ç­–ç•¥

2. **backend/user-service/PHASE3_ANALYSIS.md**
   - å®Œæ•´çš„ä»£ç åˆ†æï¼ˆ831 è¡Œï¼‰
   - ç»„ä»¶è¯„ä¼°å’Œå»ºè®®

3. **backend/user-service/PHASE3_CRITICAL_GAPS.md**
   - 10 ä¸ªé˜»å¡é¡¹æ·±åº¦åˆ†æ
   - ä»£ç ç¤ºä¾‹ã€å·¥ä½œé‡ä¼°è®¡

4. **backend/user-service/PHASE3_QUICK_SUMMARY.txt**
   - å¿«é€Ÿå‚è€ƒã€å¯è§†åŒ–è®¡åˆ†

---

## ğŸ¯ ä¸‹ä¸€æ­¥

**è¯·ç¡®è®¤**ï¼š

1. **é€‰æ‹©å®æ–½æ¨¡å¼** (A/B/C)
2. **ç¡®è®¤æ—¶é—´è¡¨** (èƒ½å¦æŠ•å…¥ 1-2 å‘¨)
3. **æŒ‡å®šå›¢é˜Ÿæˆå‘˜** (è°è´Ÿè´£ CDC/Events)
4. **åŸºç¡€è®¾æ–½å‡†å¤‡**:
   - [ ] PostgreSQL + Debezium å·²é…ç½®
   - [ ] Kafka é›†ç¾¤å¯ç”¨
   - [ ] ClickHouse å®ä¾‹å¯ç”¨
   - [ ] Redis é›†ç¾¤å¯ç”¨

---

## ğŸ“Š æˆåŠŸæŒ‡æ ‡

å®Œæˆ Phase 3 åï¼Œç³»ç»Ÿåº”è¯¥è¾¾åˆ°ï¼š

```
âœ“ äº‹ä»¶åˆ°å¯è§å»¶è¿Ÿ P95 â‰¤5s
âœ“ Feed API P95 â‰¤150ms (Redis hit) / â‰¤800ms (CH)
âœ“ ç¼“å­˜å‘½ä¸­ç‡ â‰¥90%
âœ“ Kafka æ¶ˆè´¹è€…å»¶è¿Ÿ <10s
âœ“ ç³»ç»Ÿå¯ç”¨æ€§ â‰¥99.5% (with fallback)
âœ“ å»é‡ç‡ 100%
âœ“ 0 äº‹ä»¶ä¸¢å¤±
```

---

**å‡†å¤‡å¥½å¼€å§‹ Phase 3 äº†å—ï¼ŸğŸ‘€**
