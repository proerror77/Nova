# Social Service gRPC Contract

**Package**: `nova.social_service.v1`
**Proto File**: `social.proto`
**Generated Code**: Auto-generated by `build.rs` during `cargo build`

---

## Overview

The Social Service handles all social interaction features for posts:
- **Likes**: Like/unlike posts, get like status and counts
- **Shares**: Share posts (repost, story, DM, external), track share counts
- **Comments**: Create, update, delete comments with nested replies

---

## Service Structure

### 16 RPC Methods

| Category | RPC Method | Purpose |
|----------|-----------|---------|
| **Like** | `CreateLike` | Like a post (idempotent) |
| | `DeleteLike` | Unlike a post (idempotent) |
| | `GetLikeStatus` | Check if user liked a post |
| | `GetLikeCount` | Get total like count for a post |
| | `GetLikers` | List users who liked a post (paginated) |
| **Share** | `CreateShare` | Share a post (repost/story/DM/external) |
| | `GetShareCount` | Get total share count |
| | `GetShares` | List shares for a post (paginated) |
| **Comment** | `CreateComment` | Add a comment (supports nested replies) |
| | `UpdateComment` | Edit a comment |
| | `DeleteComment` | Delete a comment |
| | `GetComment` | Fetch a single comment |
| | `ListComments` | List comments for a post (paginated, sorted) |
| | `GetCommentCount` | Get total comment count |
| **Batch** | `BatchGetLikeStatus` | Check like status for multiple posts |
| | `BatchGetCounts` | Get like/comment/share counts for multiple posts |

---

## Key Design Decisions

### 1. Idempotency
- `CreateLike`: Returns success even if like already exists
- `DeleteLike`: Returns success even if like doesn't exist
- **Reasoning**: Prevents double-like/double-unlike bugs from network retries

### 2. Cursor-Based Pagination
- All list operations use `cursor` + `has_more` pattern
- **Reasoning**: Scalable for large datasets (no OFFSET performance issues)

### 3. Batch Operations
- `BatchGetLikeStatus`: Check like status for up to 100 posts at once
- `BatchGetCounts`: Get like/comment/share counts for up to 100 posts
- **Reasoning**: Prevents N+1 queries when rendering feeds

### 4. Comment Nesting
- `parent_comment_id` field supports threaded discussions
- `reply_count` field tracks direct replies
- **Reasoning**: Enables Twitter-style comment threads

### 5. Share Types
```protobuf
enum ShareType {
  SHARE_TYPE_REPOST = 1;    // Quote tweet / repost to feed
  SHARE_TYPE_STORY = 2;     // 24-hour story share
  SHARE_TYPE_DM = 3;        // Direct message share
  SHARE_TYPE_EXTERNAL = 4;  // Share outside platform
}
```
**Reasoning**: Different share types have different privacy/notification rules

### 6. Comment Sorting
```protobuf
enum CommentSort {
  COMMENT_SORT_NEWEST = 1;   // Default: most recent first
  COMMENT_SORT_OLDEST = 2;   // Chronological order
  COMMENT_SORT_POPULAR = 3;  // Sort by like_count
}
```
**Reasoning**: Supports different UX patterns (Twitter vs Reddit)

---

## Message Field Constraints

### Validation Rules (Enforced Server-Side)

| Field | Constraint | Reasoning |
|-------|-----------|-----------|
| `comment.content` | max 2000 chars | Prevent abuse, ensure readability |
| `batch_requests.post_ids` | max 100 items | Prevent resource exhaustion |
| `limit` parameters | max 100 | Balance performance vs UX |
| `cursor` | opaque string | Enable pagination implementation flexibility |

---

## Error Handling Patterns

### Standard gRPC Status Codes

| Scenario | Status Code | Details Field |
|----------|------------|---------------|
| Post not found | `NOT_FOUND` | `post_id: <uuid>` |
| Comment not found | `NOT_FOUND` | `comment_id: <uuid>` |
| Invalid content | `INVALID_ARGUMENT` | `field: content, reason: "max 2000 chars"` |
| Unauthorized delete | `PERMISSION_DENIED` | `reason: "not comment author"` |
| Batch too large | `INVALID_ARGUMENT` | `max_items: 100, provided: 150` |

---

## Usage Examples

### Create Like (Idempotent)
```rust
let request = CreateLikeRequest {
    post_id: "550e8400-e29b-41d4-a716-446655440000".to_string(),
    user_id: "6ba7b810-9dad-11d1-80b4-00c04fd430c8".to_string(),
};

let response = client.create_like(request).await?;
// response.success = true (even if already liked)
// response.new_like_count = 42
```

### List Comments (Paginated)
```rust
let request = ListCommentsRequest {
    post_id: "550e8400-e29b-41d4-a716-446655440000".to_string(),
    limit: 50,
    cursor: "".to_string(),  // First page
    sort: CommentSort::Popular as i32,
};

let response = client.list_comments(request).await?;
// response.comments = [...]
// response.next_cursor = "eyJpZCI6IjEyMyJ9"
// response.has_more = true
```

### Batch Get Counts (Feed Optimization)
```rust
let request = BatchGetCountsRequest {
    post_ids: vec![
        "post-1".to_string(),
        "post-2".to_string(),
        "post-3".to_string(),
    ],
};

let response = client.batch_get_counts(request).await?;
// response.counts = {
//   "post-1": PostCounts { like_count: 42, comment_count: 7, share_count: 3 },
//   "post-2": PostCounts { like_count: 15, comment_count: 2, share_count: 0 },
//   ...
// }
```

---

## Code Generation

### Automatic Generation via `build.rs`
```rust
// backend/social-service/build.rs
fn main() -> Result<(), Box<dyn std::error::Error>> {
    tonic_build::configure()
        .build_server(true)
        .build_client(false)
        .compile(&["proto/social.proto"], &["proto"])?;
    Ok(())
}
```

Generated code location:
```
target/debug/build/social-service-<hash>/out/
├── nova.social_service.v1.rs
```

### Import Generated Code
```rust
// In src/main.rs or lib.rs
pub mod proto {
    tonic::include_proto!("nova.social_service.v1");
}
```

---

## Testing Strategy

### Unit Tests
- Test message serialization/deserialization
- Validate field constraints (e.g., max content length)

### Integration Tests
- Test all 16 RPC methods
- Verify idempotency (CreateLike, DeleteLike)
- Test pagination (cursor, has_more)
- Test batch operations (max 100 items)

### Load Tests
- Batch operations under high load
- Pagination with large datasets
- Concurrent like/unlike operations

---

## Migration from Placeholder

**Before** (placeholder):
```protobuf
package social;
service SocialService {
  // TODO: Define RPC methods
}
```

**After** (complete contract):
- 16 fully-defined RPC methods
- 3 enums (ShareType, CommentSort)
- 35 message types
- Comprehensive documentation

---

## Future Extensions

### Possible Additions (Backward Compatible)
1. **Like on Comments**: Add `CreateCommentLike` RPC
2. **Bookmark**: Add bookmark operations (similar to Like)
3. **Reaction Types**: Extend beyond binary like (e.g., emoji reactions)
4. **Edit History**: Add `GetCommentHistory` RPC

### Enum Extension Pattern
```protobuf
// Safe to add new values (backward compatible)
enum ShareType {
  SHARE_TYPE_UNSPECIFIED = 0;  // Always keep this
  SHARE_TYPE_REPOST = 1;
  SHARE_TYPE_STORY = 2;
  SHARE_TYPE_DM = 3;
  SHARE_TYPE_EXTERNAL = 4;
  // SHARE_TYPE_COLLAB = 5;  // Future: collaborative posts
}
```

---

## Related Services

- **Content Service**: Owns `posts` table, provides post metadata
- **User Service**: Provides user profile data for likers/commenters
- **Notification Service**: Receives events for like/comment/share notifications
- **Feed Service**: Uses `BatchGetCounts` for feed rendering

---

## Validation Checklist

- [x] All 16 RPCs defined
- [x] Request/response messages for all RPCs
- [x] Pagination support (cursor + has_more)
- [x] Batch operations for optimization
- [x] Idempotent operations (CreateLike, DeleteLike)
- [x] Comment nesting support (parent_comment_id)
- [x] Share type enum
- [x] Comment sort enum
- [x] Timestamp fields use `google.protobuf.Timestamp`
- [x] Package name follows convention (`nova.social_service.v1`)
- [x] Proto3 syntax
- [x] Comprehensive inline comments

---

**Status**: ✅ Complete and validated with `protoc`
**Last Updated**: 2025-11-12
**Phase**: Phase B (Service Contracts)
