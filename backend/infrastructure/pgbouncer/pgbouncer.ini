;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; PgBouncer Configuration File
;; Version: 1.21
;; Purpose: Connection pooling for PostgreSQL in microservices architecture
;;
;; Problem: 12+ services × 3 replicas × 16 pool_size = 576 connections
;;          PostgreSQL max_connections = 200 → Connection exhaustion
;; Solution: PgBouncer (transaction mode) multiplexes 500+ clients to 50 backend connections
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;;; DATABASE DEFINITIONS
;;;
;; Format: dbname = connstring
;; The connstring is forwarded to PostgreSQL as-is, except for query_timeout
;; and client_encoding options which are reserved for PgBouncer.
;;;

[databases]

; Main Nova database - All microservices connect through this definition
nova = host=postgres port=5432 dbname=nova pool_size=50 min_pool_size=10

; Health check database (for monitoring)
pgbouncer = host=postgres port=5432 dbname=postgres pool_size=2 connect_timeout=3

;;; PgBouncer CORE SETTINGS
;;;
;; Mandatory settings:
;; - listen_addr: IP address(es) to listen on
;; - listen_port: Port number to listen on
;; - auth_type: Authentication scheme
;; - auth_file: User credentials file
;; - pool_mode: How to manage database connections
;;;

[pgbouncer]

;;; NETWORKING
;;; General connection settings

; What address to listen on; use * for all IPv4
listen_addr = 0.0.0.0

; What port to listen on
listen_port = 6432

; Listen backlog: maximum number of waiting connections
listen_backlog = 1024

; Seconds to wait before giving up on getting a connection from the server
server_connect_timeout = 15

; How long the server connection is allowed to stay alive
server_lifetime = 3600

; Time that a connection can be idle in the pool before disconnection
server_idle_timeout = 600

; If server connection is idle more than this, use DISCARD ALL before returning to pool
server_idle_in_transaction_session_timeout = 0

; Connection check delay (frequency of health checks)
server_check_delay = 30

; Query to use for checking server connection health
server_check_query = SELECT 1

;;; CLIENT CONNECTION LIMITS
;;; Settings for client-side connection management

; Maximum number of client connections allowed (total across all pools)
max_client_conn = 500

; Minimum number of database connections to keep open in each pool
min_pool_size = 10

; Preferred number of free connections to keep in each database pool
default_pool_size = 50

; Number of connections to drop when shedding connections
reserve_pool_size = 5

; How many seconds after reserve_pool_size is reached before dropping excess
reserve_pool_timeout = 3

; Maximum database connections allowed to be created
max_db_connections = 100

; Maximum connections a single user can have
max_user_connections = 100

;;; POOL MANAGEMENT
;;; Settings for connection pool modes and timing

; Pool mode: transaction (RECOMMENDED for microservices)
; - session: return connection to pool after client disconnects (default, slow)
; - transaction: return connection after transaction finishes (fast, good for microservices)
; - statement: return after each statement (aggressive, requires autocommit mode)
pool_mode = transaction

; Close server connection after this many seconds of being connected
connection_lifetime = 3600

;;; AUTHENTICATION
;;; Authentication mode and file settings

; Password authentication type: scram-sha-256 (RECOMMENDED for production)
; Other options: md5 (weak), plain (insecure), trust (no auth), pam
auth_type = scram-sha-256

; Path to file with usernames and passwords for authentication
; Format: "username" "password" or "username" "SCRAM-SHA-256$..."
auth_file = /etc/pgbouncer/userlist.txt

; User to use when 'any' user connects
auth_user = nobody

;;; LOGGING
;;; Logging configuration for PgBouncer

; Syslog facility (LOCAL0-LOCAL7, USER, DAEMON)
syslog_facility = LOCAL0

; Enable syslog logging
syslog = 0

; Log file path
logfile = /var/log/pgbouncer/pgbouncer.log

; Verbosity level (0-8, where higher = more verbose)
;  0 = only warnings
;  1 = client connect/disconnect, auth failures
;  2 = slightly interesting server-side info
;  3 = useful information
;  4 = exact SQL from clients
;  5 = SQL from clients continued
;  6 = detailed user protocol info
;  7 = detailed server protocol info
;  8 = packets sent/received
verbose = 2

; Log connections and disconnections
log_connections = 1
log_disconnections = 1

; Log pooler errors
log_pooler_errors = 1

; Log client events (connections, disconnections)
log_client_events = 1

; Log server events (errors, problems)
log_server_events = 1

; Prefix for log lines
syslog_prefix = "pgbouncer"

; Application name visible in PostgreSQL pg_stat_activity
application_name = pgbouncer

;;; TIMEOUTS
;;; Query timeout settings for safety

; Abort queries running longer than this many seconds (0 = disabled)
; IMPORTANT: Set this larger than your longest expected query
query_timeout = 60

; Log queries running longer than this many seconds (helps identify slow queries)
query_wait_timeout = 120

; Close client connection if no query submitted for this many seconds
client_idle_timeout = 900

; How many seconds after a login attempt is considered timed out
login_timeout = 15

; Max time for server connection to respond (detection of network problems)
server_connect_timeout = 15

;;; PERFORMANCE & MEMORY
;;; Configuration for tuning performance

; Maximum size of allowed packet in bytes
pkt_buf = 4096

; Limit for client connections per remote address (0 = disabled)
max_clientaddr_conn = 0

;;; SECURITY
;;; Security and dangerous settings

; SSL mode: disable, allow, prefer, require, verify-ca, verify-full
ssl = disable

; Disable dangerous SQL commands for security reasons
; Dangerous commands: LOAD, ALTER SYSTEM, CREATE/ALTER/DROP DATABASE
disable_pqexec = 1

; Comma-separated list of databases to deny access to
; deny_db_list = template0, template1

; Comma-separated list of databases to allow access to (if set, only these allowed)
; allow_db_list =

;;; ADMIN INTERFACE
;;; Special database 'pgbouncer' access control

; Admin users allowed to login to pgbouncer admin console
admin_users = admin

; Users allowed to log in to stats console
stats_users = admin, stats_user

;;; END OF FILE ;;;
