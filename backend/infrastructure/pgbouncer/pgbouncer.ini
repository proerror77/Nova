# PgBouncer Configuration for Nova Backend
# Based on Codex P0 recommendation for connection pooling

[databases]
# Identity Service Database (critical auth path)
identity_db = host=postgres-primary.nova.svc.cluster.local port=5432 dbname=identity
identity_db_replica = host=postgres-replica.nova.svc.cluster.local port=5432 dbname=identity

# User Service Database
user_db = host=postgres-primary.nova.svc.cluster.local port=5432 dbname=users
user_db_replica = host=postgres-replica.nova.svc.cluster.local port=5432 dbname=users

# Content Service Database
content_db = host=postgres-primary.nova.svc.cluster.local port=5432 dbname=content
content_db_replica = host=postgres-replica.nova.svc.cluster.local port=5432 dbname=content

# Social Service Database (high read volume)
social_db = host=postgres-primary.nova.svc.cluster.local port=5432 dbname=social
social_db_replica = host=postgres-replica.nova.svc.cluster.local port=5432 dbname=social

# Communication Service Database
communication_db = host=postgres-primary.nova.svc.cluster.local port=5432 dbname=communication
communication_db_replica = host=postgres-replica.nova.svc.cluster.local port=5432 dbname=communication

# Media Service Database
media_db = host=postgres-primary.nova.svc.cluster.local port=5432 dbname=media
media_db_replica = host=postgres-replica.nova.svc.cluster.local port=5432 dbname=media

# Search Service Database (read-only projections)
search_db = host=postgres-replica.nova.svc.cluster.local port=5432 dbname=search

# Events Service Database (write-heavy)
events_db = host=postgres-primary.nova.svc.cluster.local port=5432 dbname=events

[pgbouncer]
# Connection pool settings (per Codex recommendations)
listen_addr = 0.0.0.0
listen_port = 6432

# Authentication
auth_type = scram-sha-256
auth_file = /etc/pgbouncer/userlist.txt

# Pool modes
# Transaction pooling for most services (recommended by Codex)
pool_mode = transaction

# Pool size limits (Codex: modest 8-16 per service)
default_pool_size = 12
min_pool_size = 4
reserve_pool_size = 4
reserve_pool_timeout = 5

# Maximum connections (prevent connection storm)
max_client_conn = 1000
max_db_connections = 100

# Per-user connection limits (per service)
max_user_connections = 16

# Timeouts (aligned with Codex recommendations)
server_connect_timeout = 5
server_login_retry = 3
query_timeout = 30
query_wait_timeout = 10
client_idle_timeout = 300
server_idle_timeout = 300
server_lifetime = 3600

# TCP keepalive
tcp_keepalive = 1
tcp_keepcnt = 3
tcp_keepidle = 5
tcp_keepintvl = 5

# Logging
admin_users = pgbouncer
stats_users = pgbouncer, monitoring

logfile = /var/log/pgbouncer/pgbouncer.log
pidfile = /var/run/pgbouncer/pgbouncer.pid

# Log settings
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
log_stats = 1
stats_period = 60

# Security
server_tls_sslmode = require
server_tls_protocols = TLSv1.3
server_tls_ca_file = /etc/pgbouncer/ca.crt

client_tls_sslmode = prefer
client_tls_protocols = TLSv1.3
client_tls_ca_file = /etc/pgbouncer/ca.crt
client_tls_cert_file = /etc/pgbouncer/client.crt
client_tls_key_file = /etc/pgbouncer/client.key

# Disable dangerous features
ignore_startup_parameters = extra_float_digits
disable_pqexec = 1