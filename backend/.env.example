# ==============================================
# Nova Backend - Environment Configuration (Phase E)
# ==============================================
# This file contains all configuration parameters for 14 microservices
# Copy this file to .env and modify values for your environment

# ⚠️  SECURITY WARNING ⚠️
# DO NOT commit actual secrets to this file
# DO NOT use these placeholder values in production
# Replace ALL values with environment-specific credentials
# For production: Use AWS Secrets Manager via External Secrets Operator

# ==============================================
# Environment
# ==============================================
APP_ENV=development  # development | staging | production
LOG_LEVEL=info       # trace | debug | info | warn | error
RUST_LOG=info,nova=debug

# ==============================================
# Database - PostgreSQL (Unified)
# ==============================================
DATABASE_URL=postgresql://postgres:postgres@postgres:5432/nova
DATABASE_MAX_CONNECTIONS=10
DATABASE_MIN_CONNECTIONS=2
DATABASE_ACQUIRE_TIMEOUT_SECS=30
DATABASE_IDLE_TIMEOUT_SECS=600
DATABASE_MAX_LIFETIME_SECS=1800

# Database migrations (set to 'false' to skip migrations on startup)
RUN_MIGRATIONS=true

# ==============================================
# Redis Cache
# ==============================================
REDIS_URL=redis://redis:6379
REDIS_POOL_SIZE=20
REDIS_CONNECTION_TIMEOUT_SECS=5
# Redis command timeout (milliseconds)
# Prevents cascading failures when Redis is slow or unresponsive
# Default: 3000ms (3 seconds), minimum: 500ms
REDIS_COMMAND_TIMEOUT_MS=3000

# ==============================================
# ClickHouse (Feed/Ranking Analytics)
# ==============================================
CLICKHOUSE_URL=http://clickhouse:8123
CLICKHOUSE_DATABASE=nova_feed
CLICKHOUSE_USERNAME=default
CLICKHOUSE_PASSWORD=

# ==============================================
# Neo4j (Social Graph)
# ==============================================
NEO4J_URI=neo4j://neo4j:7687
NEO4J_USER=neo4j
NEO4J_PASSWORD=password
NEO4J_DATABASE=neo4j

# ==============================================
# Kafka (Event Streaming)
# ==============================================
KAFKA_BROKERS=kafka:9092
KAFKA_CONSUMER_GROUP_ID=nova-consumer-v1
KAFKA_AUTO_OFFSET_RESET=earliest  # earliest | latest
KAFKA_ENABLE_AUTO_COMMIT=false

# Kafka Topics (Unified)
KAFKA_AUTH_EVENTS_TOPIC=nova.auth.events
KAFKA_USER_EVENTS_TOPIC=nova.user.events
KAFKA_CONTENT_EVENTS_TOPIC=nova.content.events
KAFKA_CHAT_EVENTS_TOPIC=nova.chat.events
KAFKA_FEED_EVENTS_TOPIC=nova.feed.events
KAFKA_NOTIFICATION_EVENTS_TOPIC=nova.notification.events
KAFKA_SOCIAL_EVENTS_TOPIC=nova.social.events

# ==============================================
# Elasticsearch (Full-Text Search)
# ==============================================
ELASTICSEARCH_URL=http://elasticsearch:9200
ELASTICSEARCH_POST_INDEX=nova_posts
ELASTICSEARCH_USER_INDEX=nova_users
ELASTICSEARCH_CHAT_INDEX=nova_chat_messages

# ==============================================
# MinIO / S3 (Media Storage)
# ==============================================
AWS_REGION=us-east-1
AWS_S3_BUCKET=nova-media
AWS_ACCESS_KEY_ID=minioadmin
AWS_SECRET_ACCESS_KEY=minioadmin
AWS_S3_ENDPOINT=http://minio:9000  # MinIO local endpoint

# Production S3 (uncomment for production)
# AWS_S3_ENDPOINT=
# AWS_ACCESS_KEY_ID=YOUR_AWS_ACCESS_KEY_ID_HERE
# AWS_SECRET_ACCESS_KEY=YOUR_AWS_SECRET_ACCESS_KEY_HERE

# ==============================================
# JWT Authentication (Identity Service)
# ==============================================
# Generate keys with: openssl genpkey -algorithm RSA -out private_key.pem -pkeyopt rsa_keygen_bits:2048
# Extract public key: openssl rsa -pubout -in private_key.pem -out public_key.pem
JWT_PRIVATE_KEY_PEM="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----"
JWT_PUBLIC_KEY_PEM="-----BEGIN PUBLIC KEY-----\n...\n-----END PUBLIC KEY-----"

# Alternative: Load from files (if not provided as environment variables)
JWT_PRIVATE_KEY_PATH=/etc/secrets/jwt_private.pem
JWT_PUBLIC_KEY_PATH=/etc/secrets/jwt_public.pem

# JWT token expiration
JWT_ACCESS_TOKEN_EXPIRES_IN_MINUTES=15
JWT_REFRESH_TOKEN_EXPIRES_IN_DAYS=30

# ==============================================
# OAuth Providers (Identity Service)
# ==============================================
# Google OAuth 2.0
OAUTH_GOOGLE_CLIENT_ID=YOUR_GOOGLE_OAUTH_CLIENT_ID
OAUTH_GOOGLE_CLIENT_SECRET=YOUR_GOOGLE_OAUTH_CLIENT_SECRET
OAUTH_GOOGLE_REDIRECT_URI=http://localhost:8081/api/v1/auth/oauth/google/callback

# Apple Sign In
# Get these from Apple Developer Portal > Certificates, Identifiers & Profiles > Keys
OAUTH_APPLE_TEAM_ID=YOUR_APPLE_TEAM_ID
OAUTH_APPLE_CLIENT_ID=YOUR_APPLE_SERVICE_ID
OAUTH_APPLE_KEY_ID=YOUR_APPLE_KEY_ID
OAUTH_APPLE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----"
OAUTH_APPLE_REDIRECT_URI=http://localhost:8081/api/v1/auth/oauth/apple/callback

# GitHub OAuth (optional)
OAUTH_GITHUB_CLIENT_ID=YOUR_GITHUB_OAUTH_CLIENT_ID
OAUTH_GITHUB_CLIENT_SECRET=YOUR_GITHUB_OAUTH_CLIENT_SECRET

# ==============================================
# SMTP (Email Notifications)
# ==============================================
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USERNAME=apikey
SMTP_PASSWORD=YOUR_SMTP_PASSWORD_OR_API_KEY_HERE
SMTP_FROM_EMAIL=noreply@nova.app
SMTP_FROM_NAME=Nova

# Development: Use MailHog for testing
# SMTP_HOST=mailhog
# SMTP_PORT=1025

# ==============================================
# Push Notifications
# ==============================================
# APNs (iOS)
APNS_KEY_ID=YOUR_APNS_KEY_ID
APNS_TEAM_ID=YOUR_APNS_TEAM_ID
APNS_PRIVATE_KEY_PATH=/etc/secrets/apns_auth_key.p8
APNS_ENVIRONMENT=development  # development | production

# FCM (Android)
FCM_PROJECT_ID=YOUR_GCP_PROJECT_ID
FCM_SERVICE_ACCOUNT_PATH=/etc/secrets/fcm_service_account.json

# ==============================================
# Service Ports (HTTP) - Phase E Services
# ==============================================
# gRPC ports are automatically calculated as HTTP_PORT + 1000

# Identity & User Services
IDENTITY_SERVICE_HTTP_PORT=8081
IDENTITY_SERVICE_GRPC_PORT=9081
USER_SERVICE_HTTP_PORT=8080
USER_SERVICE_GRPC_PORT=9080

# Content & Social Services
CONTENT_SERVICE_HTTP_PORT=8082
CONTENT_SERVICE_GRPC_PORT=9082
SOCIAL_SERVICE_HTTP_PORT=8093
SOCIAL_SERVICE_GRPC_PORT=9093

# Feed & Ranking Services
FEED_SERVICE_HTTP_PORT=8084
FEED_SERVICE_GRPC_PORT=9084
RANKING_SERVICE_HTTP_PORT=8092
RANKING_SERVICE_GRPC_PORT=9092

# Graph & Feature Store
GRAPH_SERVICE_HTTP_PORT=8091
GRAPH_SERVICE_GRPC_PORT=9091
FEATURE_STORE_HTTP_PORT=8096
FEATURE_STORE_GRPC_PORT=9096

# Media & Realtime Services
MEDIA_SERVICE_HTTP_PORT=8085
MEDIA_SERVICE_GRPC_PORT=9085
REALTIME_CHAT_SERVICE_HTTP_PORT=8086
REALTIME_CHAT_SERVICE_GRPC_PORT=9086

# Utility Services
SEARCH_SERVICE_HTTP_PORT=8087
SEARCH_SERVICE_GRPC_PORT=9087
NOTIFICATION_SERVICE_HTTP_PORT=8088
NOTIFICATION_SERVICE_GRPC_PORT=9088
ANALYTICS_SERVICE_HTTP_PORT=8094
ANALYTICS_SERVICE_GRPC_PORT=9094
TRUST_SAFETY_SERVICE_HTTP_PORT=8095
TRUST_SAFETY_SERVICE_GRPC_PORT=9095

# API Gateway
GRAPHQL_GATEWAY_PORT=8000

# ==============================================
# Service Hosts (Inter-Service Communication)
# ==============================================
IDENTITY_SERVICE_HOST=identity-service
USER_SERVICE_HOST=user-service
CONTENT_SERVICE_HOST=content-service
FEED_SERVICE_HOST=feed-service
MEDIA_SERVICE_HOST=media-service
REALTIME_CHAT_SERVICE_HOST=realtime-chat-service
SEARCH_SERVICE_HOST=search-service
NOTIFICATION_SERVICE_HOST=notification-service
GRAPH_SERVICE_HOST=graph-service
RANKING_SERVICE_HOST=ranking-service
SOCIAL_SERVICE_HOST=social-service
ANALYTICS_SERVICE_HOST=analytics-service
TRUST_SAFETY_SERVICE_HOST=trust-safety-service
FEATURE_STORE_HOST=feature-store
GRAPHQL_GATEWAY_HOST=graphql-gateway

# ==============================================
# gRPC Configuration (Centralized)
# ==============================================
# Service URLs (default to internal Docker DNS)
GRPC_IDENTITY_SERVICE_URL=http://identity-service:9081
GRPC_USER_SERVICE_URL=http://user-service:9080
GRPC_CONTENT_SERVICE_URL=http://content-service:9082
GRPC_FEED_SERVICE_URL=http://feed-service:9084
GRPC_MEDIA_SERVICE_URL=http://media-service:9085
GRPC_REALTIME_CHAT_SERVICE_URL=http://realtime-chat-service:9086
GRPC_SEARCH_SERVICE_URL=http://search-service:9087
GRPC_NOTIFICATION_SERVICE_URL=http://notification-service:9088
GRPC_GRAPH_SERVICE_URL=http://graph-service:9091
GRPC_RANKING_SERVICE_URL=http://ranking-service:9092
GRPC_SOCIAL_SERVICE_URL=http://social-service:9093
GRPC_ANALYTICS_SERVICE_URL=http://analytics-service:9094
GRPC_TRUST_SAFETY_SERVICE_URL=http://trust-safety-service:9095
GRPC_FEATURE_STORE_URL=http://feature-store:9096

# Connection settings
GRPC_CONNECTION_TIMEOUT_SECS=10
GRPC_REQUEST_TIMEOUT_SECS=30
GRPC_MAX_CONCURRENT_STREAMS=1000
GRPC_KEEPALIVE_INTERVAL_SECS=30
GRPC_KEEPALIVE_TIMEOUT_SECS=10
GRPC_ENABLE_CONNECTION_POOLING=true
GRPC_CONNECTION_POOL_SIZE=10

# TLS/mTLS (REQUIRED for staging and production)
GRPC_TLS_ENABLED=false  # Set to true for staging/production
GRPC_TLS_DOMAIN_NAME=internal.nova
GRPC_TLS_CA_CERT_PATH=/etc/certs/ca.pem
GRPC_TLS_CLIENT_CERT_PATH=/etc/certs/client.pem
GRPC_TLS_CLIENT_KEY_PATH=/etc/certs/client.key

# ==============================================
# Rate Limiting
# ==============================================
RATE_LIMIT_MAX_REQUESTS=100
RATE_LIMIT_WINDOW_SECS=60

# ==============================================
# Security
# ==============================================
# CORS allowed origins (comma-separated)
CORS_ALLOWED_ORIGINS=http://localhost:3000,https://nova.app

# Session timeout
SESSION_TIMEOUT_MINUTES=60

# ==============================================
# Monitoring & Observability
# ==============================================
PROMETHEUS_PORT=9090
JAEGER_AGENT_HOST=jaeger-agent
JAEGER_AGENT_PORT=6831

# Metrics & Tracing
ENABLE_TRACING=true
SENTRY_DSN=

# ==============================================
# Feature Flags
# ==============================================
FEATURE_VIDEO_CALLING=true
FEATURE_LOCATION_SHARING=true
FEATURE_TRENDING_ENABLED=true
FEATURE_E2EE_ENABLED=true
FEATURE_GROUP_CALLS=true
FEATURE_FEED_SORTING=true
FEATURE_VIDEO_TRANSCODING=true
FEATURE_REAL_TIME_NOTIFICATIONS=true

# ==============================================
# Development/Testing
# ==============================================
# Set to 'true' to disable authentication checks (DEV ONLY)
DISABLE_AUTH=false

# Set to 'true' to enable detailed SQL query logging
DEBUG_SQL_QUERIES=false

# Mock external services for testing
MOCK_EXTERNAL_SERVICES=false
