syntax = "proto3";
package nova.content_service.v2;

import "google/api/annotations.proto";

option go_package = "github.com/nova/api/gen/go/services_v2;services_v2";

// Content Service - Post and Channel Management
// Minimal content-service surface used by feed-service and social integrations.

enum ContentStatus {
  CONTENT_STATUS_UNSPECIFIED = 0;
  CONTENT_STATUS_DRAFT = 1;
  CONTENT_STATUS_PUBLISHED = 2;
  CONTENT_STATUS_MODERATED = 3;
  CONTENT_STATUS_DELETED = 4;
}

enum Visibility {
  VISIBILITY_UNSPECIFIED = 0;
  VISIBILITY_PUBLIC = 1;
  VISIBILITY_FOLLOWERS = 2;
  VISIBILITY_PRIVATE = 3;
}

message Post {
  string id = 1;
  string author_id = 2;
  string content = 3;
  int64 created_at = 4;
  int64 updated_at = 5;
  int64 deleted_at = 6;
  ContentStatus status = 7;
  repeated string media_ids = 8;  // Media IDs associated with this post
  repeated string media_urls = 9; // CDN URLs for attached media (populated by service)
  string media_type = 10;         // Type of media: "image", "video", "live_photo", "mixed", "none"
  repeated string thumbnail_urls = 11; // CDN URLs for thumbnails (fallbacks to media_urls when absent)
  string author_account_type = 12; // Account type when post was created: "primary" or "alias"
}

message CreatePostRequest {
  string author_id = 1;
  string content = 2;
  repeated string media_urls = 3;  // CDN URLs for attached media (images/videos)
  string media_type = 4;           // Type of media: "image", "video", "live_photo", "mixed", "none"
  repeated string channel_ids = 5; // Channel UUIDs or slugs to tag this post with (max 3)
  string author_account_type = 6;  // Account type: "primary" or "alias" (Issue #259)
}

message CreatePostResponse {
  Post post = 1;
}

message GetPostRequest { string post_id = 1; }
message GetPostResponse {
  Post post = 1;
  bool found = 2;
}

message GetPostsByIdsRequest { repeated string post_ids = 1; }
message GetPostsByIdsResponse {
  repeated Post posts = 1;
  repeated string not_found_ids = 2;
}

message GetUserPostsRequest {
  string user_id = 1;
  int32 limit = 2;
  int32 offset = 3;
  ContentStatus status = 4;
}

message GetUserPostsResponse {
  repeated Post posts = 1;
  int32 total_count = 2;
  bool has_more = 3;
}

message ListRecentPostsRequest {
  int32 limit = 1;
  string exclude_user_id = 2;
}
message ListRecentPostsResponse { repeated string post_ids = 1; }

message ListTrendingPostsRequest {
  int32 limit = 1;
  string exclude_user_id = 2;
}
message ListTrendingPostsResponse { repeated string post_ids = 1; }

message UpdatePostRequest {
  string post_id = 1;
  string content = 2;
  Visibility visibility = 3;
  bool comments_enabled = 4;
}
message UpdatePostResponse { Post post = 1; }

message DeletePostRequest {
  string post_id = 1;
  string user_id = 2;
}
message DeletePostResponse {
  string post_id = 1;
  int64 deleted_at = 2;
}

// ============================================================================
// Channels (category/interest definition)
// ============================================================================
message Channel {
  string id = 1;
  string name = 2;
  string description = 3;
  string category = 4;
  uint32 subscriber_count = 5;
  string slug = 6;              // URL-friendly unique identifier
  string icon_url = 7;          // Channel icon image URL
  int32 display_order = 8;      // Ordering priority (lower = first)
  bool is_enabled = 9;          // Whether channel is visible to users
  string topic_keywords = 10;   // JSON array of keywords for AI classification
}

message ListChannelsRequest {
  int32 limit = 1;
  int32 offset = 2;
  string category = 3;
  bool enabled_only = 4;  // If true, only return channels where is_enabled=true
}

message ListChannelsResponse {
  repeated Channel channels = 1;
  int32 total = 2;
}

message GetChannelRequest {
  string id = 1;
}

message GetChannelResponse {
  Channel channel = 1;
  bool found = 2;
}

// ListPostsByChannel - Get posts associated with a specific channel
message ListPostsByChannelRequest {
  string channel_id = 1;  // Channel UUID or slug
  int32 limit = 2;
  string cursor = 3;      // Base64 encoded pagination cursor (post_id:created_at)
}

message ListPostsByChannelResponse {
  repeated string post_ids = 1;
  string next_cursor = 2;
  bool has_more = 3;
}

// ListPostsByUsers - Get posts from multiple users with timestamp-based pagination
// Used for efficient feed generation - returns posts sorted by created_at DESC
message ListPostsByUsersRequest {
  repeated string user_ids = 1;       // List of user IDs to fetch posts from
  int32 limit = 2;                    // Max posts to return (1-100)
  int64 before_timestamp = 3;         // Return posts created before this Unix timestamp (0 = no filter)
  string before_post_id = 4;          // For tie-breaking: exclude posts with this ID or later at same timestamp
}

message PostWithTimestamp {
  string post_id = 1;
  int64 created_at = 2;               // Unix timestamp for cursor construction
}

message ListPostsByUsersResponse {
  repeated PostWithTimestamp posts = 1;
  int64 next_cursor_timestamp = 2;    // Timestamp for next page cursor (0 if no more)
  string next_cursor_post_id = 3;     // Post ID for tie-breaking
  bool has_more = 4;
}

// ============================================================================
// User Liked/Saved Posts (SQL JOIN optimized queries)
// ============================================================================

// Get posts liked by a user - uses SQL JOIN for single-query efficiency
message GetUserLikedPostsRequest {
  string user_id = 1;
  int32 limit = 2;
  int32 offset = 3;
}

message GetUserLikedPostsResponse {
  repeated Post posts = 1;
  int32 total_count = 2;
  bool has_more = 3;
}

// Get posts saved/bookmarked by a user - uses SQL JOIN for single-query efficiency
message GetUserSavedPostsRequest {
  string user_id = 1;
  int32 limit = 2;
  int32 offset = 3;
}

message GetUserSavedPostsResponse {
  repeated Post posts = 1;
  int32 total_count = 2;
  bool has_more = 3;
}

service ContentService {
  // Post CRUD operations
  rpc CreatePost(CreatePostRequest) returns (CreatePostResponse) {
    option (google.api.http) = {
      post: "/api/v2/content/post/create"
      body: "*"
      additional_bindings {
        post: "/api/v2/content"
        body: "*"
      }
    };
  }

  rpc GetPost(GetPostRequest) returns (GetPostResponse) {
    option (google.api.http) = {
      get: "/api/v2/content/post/{post_id}"
      additional_bindings {
        get: "/api/v2/content/{post_id}"
      }
    };
  }

  rpc GetPostsByIds(GetPostsByIdsRequest) returns (GetPostsByIdsResponse) {
    option (google.api.http) = {
      post: "/api/v2/content/posts/batch"
      body: "*"
    };
  }

  rpc GetUserPosts(GetUserPostsRequest) returns (GetUserPostsResponse) {
    option (google.api.http) = {
      get: "/api/v2/content/posts/author/{user_id}"
      additional_bindings {
        get: "/api/v2/content/user/{user_id}"
      }
    };
  }

  rpc ListRecentPosts(ListRecentPostsRequest) returns (ListRecentPostsResponse) {
    option (google.api.http) = {
      get: "/api/v2/content/posts/recent"
    };
  }

  rpc ListTrendingPosts(ListTrendingPostsRequest) returns (ListTrendingPostsResponse) {
    option (google.api.http) = {
      get: "/api/v2/content/posts/trending"
    };
  }

  rpc UpdatePost(UpdatePostRequest) returns (UpdatePostResponse) {
    option (google.api.http) = {
      put: "/api/v2/content/post/update/{post_id}"
      body: "*"
      additional_bindings {
        put: "/api/v2/content/{post_id}"
        body: "*"
      }
    };
  }

  rpc DeletePost(DeletePostRequest) returns (DeletePostResponse) {
    option (google.api.http) = {
      delete: "/api/v2/content/post/delete/{post_id}"
      additional_bindings {
        delete: "/api/v2/content/{post_id}"
      }
    };
  }

  // Channels
  rpc ListChannels(ListChannelsRequest) returns (ListChannelsResponse) {
    option (google.api.http) = {
      get: "/api/v2/channels"
    };
  }

  rpc GetChannel(GetChannelRequest) returns (GetChannelResponse) {
    option (google.api.http) = {
      get: "/api/v2/channels/{id}"
    };
  }

  rpc ListPostsByChannel(ListPostsByChannelRequest) returns (ListPostsByChannelResponse) {
    option (google.api.http) = {
      get: "/api/v2/channels/{channel_id}/posts"
    };
  }

  // ListPostsByUsers - Batch fetch posts from multiple users with timestamp cursor pagination
  // Used by feed-service to efficiently generate chronological feeds
  rpc ListPostsByUsers(ListPostsByUsersRequest) returns (ListPostsByUsersResponse) {
    option (google.api.http) = {
      post: "/api/v2/content/posts/by-users"
      body: "*"
    };
  }

  // User Liked/Saved Posts - SQL JOIN optimized for single-query efficiency
  // These avoid the N+1 problem of fetching IDs then posts separately

  rpc GetUserLikedPosts(GetUserLikedPostsRequest) returns (GetUserLikedPostsResponse) {
    option (google.api.http) = {
      get: "/api/v2/content/user/{user_id}/liked"
    };
  }

  rpc GetUserSavedPosts(GetUserSavedPostsRequest) returns (GetUserSavedPostsResponse) {
    option (google.api.http) = {
      get: "/api/v2/content/user/{user_id}/saved"
    };
  }
}
