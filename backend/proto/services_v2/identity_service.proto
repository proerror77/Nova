syntax = "proto3";
package nova.identity.v1;

import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";

// ============================================================================
// Identity Service - Authentication, Authorization & User Identity
//
// Owns: users, user_profiles, user_settings, sessions, refresh_tokens, revoked_tokens
// Responsibilities:
//   - User registration and identity management
//   - Login/Logout (session management)
//   - Token validation and refresh
//   - Password reset
//   - User profile management (display_name, bio, avatar_url, etc.)
//   - User settings management (dm_permission, notifications, privacy, etc.)
//
// P0 Migration Note: user_profiles and user_settings have been consolidated into
// identity-service as the SINGLE SOURCE OF TRUTH. Other services should read
// user settings via identity-service gRPC API, not maintain local copies.
// See: backend/docs/zitadel-nova-integration.md
// ============================================================================

service IdentityService {
  // ========== Authentication ==========
  rpc Register(RegisterRequest) returns (RegisterResponse);
  rpc Login(LoginRequest) returns (LoginResponse);
  rpc Logout(LogoutRequest) returns (google.protobuf.Empty);
  rpc RefreshToken(RefreshTokenRequest) returns (RefreshTokenResponse);

  // ========== Verification ==========
  rpc VerifyToken(VerifyTokenRequest) returns (VerifyTokenResponse);
  rpc VerifyPassword(VerifyPasswordRequest) returns (VerifyPasswordResponse);

  // ========== Password Management ==========
  rpc ChangePassword(ChangePasswordRequest) returns (google.protobuf.Empty);
  rpc RequestPasswordReset(RequestPasswordResetRequest) returns (google.protobuf.Empty);
  rpc ResetPassword(ResetPasswordRequest) returns (google.protobuf.Empty);

  // ========== Session Management ==========
  rpc RevokeToken(RevokeTokenRequest) returns (google.protobuf.Empty);
  rpc RevokeAllUserTokens(RevokeAllUserTokensRequest) returns (google.protobuf.Empty);
  rpc ListActiveSessions(ListActiveSessionsRequest) returns (ListActiveSessionsResponse);

  // ========== OAuth/SSO ==========
  // Start OAuth flow - returns authorization URL to redirect user to
  rpc StartOAuthFlow(StartOAuthFlowRequest) returns (StartOAuthFlowResponse);
  // Complete OAuth flow - exchange authorization code for tokens
  rpc CompleteOAuthFlow(CompleteOAuthFlowRequest) returns (CompleteOAuthFlowResponse);
  // List linked OAuth providers for a user
  rpc ListOAuthConnections(ListOAuthConnectionsRequest) returns (ListOAuthConnectionsResponse);
  // Unlink an OAuth provider from user account
  rpc UnlinkOAuthProvider(UnlinkOAuthProviderRequest) returns (google.protobuf.Empty);

  // ========== Account Management (Multi-account & Alias) ==========
  // List all accounts for a user (primary + aliases)
  rpc ListAccounts(ListAccountsRequest) returns (ListAccountsResponse);
  // Switch to a different account (returns new tokens)
  rpc SwitchAccount(SwitchAccountRequest) returns (SwitchAccountResponse);
  // Create a new alias account
  rpc CreateAliasAccount(CreateAliasAccountRequest) returns (CreateAliasAccountResponse);
  // Update an existing alias account
  rpc UpdateAliasAccount(UpdateAliasAccountRequest) returns (UpdateAliasAccountResponse);
  // Get alias account details
  rpc GetAliasAccount(GetAliasAccountRequest) returns (GetAliasAccountResponse);
  // Delete an alias account
  rpc DeleteAliasAccount(DeleteAliasAccountRequest) returns (google.protobuf.Empty);

  // ========== Passkey/WebAuthn ==========
  rpc StartPasskeyRegistration(StartPasskeyRegistrationRequest) returns (StartPasskeyRegistrationResponse);
  rpc CompletePasskeyRegistration(CompletePasskeyRegistrationRequest) returns (CompletePasskeyRegistrationResponse);
  rpc StartPasskeyAuthentication(StartPasskeyAuthenticationRequest) returns (StartPasskeyAuthenticationResponse);
  rpc CompletePasskeyAuthentication(CompletePasskeyAuthenticationRequest) returns (CompletePasskeyAuthenticationResponse);
  rpc ListPasskeys(ListPasskeysRequest) returns (ListPasskeysResponse);
  rpc RevokePasskey(RevokePasskeyRequest) returns (google.protobuf.Empty);
  rpc RenamePasskey(RenamePasskeyRequest) returns (google.protobuf.Empty);
}

// ============================================================================
// Messages
// ============================================================================

// -------- Registration --------
message RegisterRequest {
  string email = 1;          // User email (unique)
  string username = 2;       // Username (unique)
  string password = 3;       // Plain text password (will be hashed)
  string display_name = 4;   // Optional display name
}

message RegisterResponse {
  string user_id = 1;        // UUID of created user
  string access_token = 2;   // JWT access token
  string refresh_token = 3;  // JWT refresh token
  int64 expires_at = 4;      // Access token expiration (unix timestamp)
}

// -------- Login --------
message LoginRequest {
  string email_or_username = 1;  // Email or username
  string password = 2;            // Plain text password
  string device_id = 3;           // Optional device identifier
  string user_agent = 4;          // Optional user agent string
}

message LoginResponse {
  string user_id = 1;
  string access_token = 2;
  string refresh_token = 3;
  int64 expires_at = 4;

  // User info (for convenience, avoid extra gRPC call)
  string username = 5;
  string email = 6;
  bool is_verified = 7;
}

// -------- Logout --------
message LogoutRequest {
  string access_token = 1;   // Token to revoke
}

// -------- Token Refresh --------
message RefreshTokenRequest {
  string refresh_token = 1;
}

message RefreshTokenResponse {
  string access_token = 1;
  string refresh_token = 2;  // New refresh token (rotation)
  int64 expires_at = 3;
}

// -------- Token Verification --------
message VerifyTokenRequest {
  string access_token = 1;
}

message VerifyTokenResponse {
  bool is_valid = 1;
  string user_id = 2;        // Empty if invalid
  string email = 3;
  string username = 4;
  repeated string roles = 5; // User roles (e.g., "admin", "moderator")
  int64 expires_at = 6;
  bool is_revoked = 7;
}

// -------- Password Verification (for other services) --------
message VerifyPasswordRequest {
  string user_id = 1;        // UUID of user
  string password = 2;       // Plain text password to verify
}

message VerifyPasswordResponse {
  bool is_valid = 1;
}

// -------- Password Change --------
message ChangePasswordRequest {
  string user_id = 1;
  string old_password = 2;
  string new_password = 3;
}

// -------- Password Reset --------
message RequestPasswordResetRequest {
  string email = 1;
}

message ResetPasswordRequest {
  string reset_token = 1;    // Token from email link
  string new_password = 2;
}

// -------- Token Revocation --------
message RevokeTokenRequest {
  string access_token = 1;
}

message RevokeAllUserTokensRequest {
  string user_id = 1;
}

// -------- Session Listing --------
message ListActiveSessionsRequest {
  string user_id = 1;
}

message Session {
  string session_id = 1;
  string device_id = 2;
  string user_agent = 3;
  string ip_address = 4;
  google.protobuf.Timestamp created_at = 5;
  google.protobuf.Timestamp last_active = 6;
}

message ListActiveSessionsResponse {
  repeated Session sessions = 1;
}

// ============================================================================
// Events Published by Identity Service
// ============================================================================

// Kafka Topic: identity.user.registered
message UserRegisteredEvent {
  string user_id = 1;
  string email = 2;
  string username = 3;
  string display_name = 4;
  google.protobuf.Timestamp registered_at = 5;
}

// Kafka Topic: identity.user.logged_in
message UserLoggedInEvent {
  string user_id = 1;
  string session_id = 2;
  string device_id = 3;
  string ip_address = 4;
  google.protobuf.Timestamp logged_in_at = 5;
}

// Kafka Topic: identity.session.revoked
message SessionRevokedEvent {
  string user_id = 1;
  string session_id = 2;
  string reason = 3;
  google.protobuf.Timestamp revoked_at = 4;
}

// Kafka Topic: identity.password.changed
message PasswordChangedEvent {
  string user_id = 1;
  google.protobuf.Timestamp changed_at = 2;
}

// ============================================================================
// OAuth/SSO Messages
// ============================================================================

// Supported OAuth providers
enum OAuthProvider {
  OAUTH_PROVIDER_UNSPECIFIED = 0;
  OAUTH_PROVIDER_GOOGLE = 1;
  OAUTH_PROVIDER_APPLE = 2;
}

// -------- Start OAuth Flow --------
message StartOAuthFlowRequest {
  OAuthProvider provider = 1;      // OAuth provider (google, apple, etc.)
  string redirect_uri = 2;         // Callback URL after OAuth completes
  string invite_code = 3;          // Optional invite code for new user registration
}

message StartOAuthFlowResponse {
  string authorization_url = 1;    // URL to redirect user to for OAuth
  string state = 2;                // State token for CSRF protection
}

// -------- Complete OAuth Flow --------
message CompleteOAuthFlowRequest {
  string state = 1;                // State token from StartOAuthFlowResponse
  string code = 2;                 // Authorization code from OAuth provider
  string redirect_uri = 3;         // Same redirect URI used in start flow
  string invite_code = 4;          // Optional invite code (for new user registration)
}

message CompleteOAuthFlowResponse {
  string user_id = 1;
  string access_token = 2;
  string refresh_token = 3;
  int64 expires_at = 4;

  // User info
  string username = 5;
  string email = 6;
  bool is_new_user = 7;            // True if this OAuth login created a new account
}

// -------- List OAuth Connections --------
message ListOAuthConnectionsRequest {
  string user_id = 1;
}

message OAuthConnection {
  string id = 1;                   // Connection UUID
  OAuthProvider provider = 2;      // OAuth provider
  string provider_user_id = 3;     // User's ID on the provider
  string email = 4;                // Email from provider (may differ from account email)
  string name = 5;                 // Name from provider
  string picture_url = 6;          // Profile picture URL from provider
  google.protobuf.Timestamp connected_at = 7;
  google.protobuf.Timestamp last_used_at = 8;
}

message ListOAuthConnectionsResponse {
  repeated OAuthConnection connections = 1;
}

// -------- Unlink OAuth Provider --------
message UnlinkOAuthProviderRequest {
  string user_id = 1;
  OAuthProvider provider = 2;      // Provider to unlink
}

// ============================================================================
// OAuth Events
// ============================================================================

// Kafka Topic: identity.oauth.connected
message OAuthConnectedEvent {
  string user_id = 1;
  string provider = 2;             // "google", "apple", etc.
  string provider_user_id = 3;
  bool is_new_user = 4;
  google.protobuf.Timestamp connected_at = 5;
}

// Kafka Topic: identity.oauth.disconnected
message OAuthDisconnectedEvent {
  string user_id = 1;
  string provider = 2;
  google.protobuf.Timestamp disconnected_at = 3;
}

// ============================================================================
// Account Management Messages (Multi-account & Alias)
// ============================================================================

// Gender enum for alias accounts
enum Gender {
  GENDER_UNSPECIFIED = 0;
  GENDER_MALE = 1;
  GENDER_FEMALE = 2;
  GENDER_OTHER = 3;
  GENDER_PREFER_NOT_TO_SAY = 4;
}

// Account representation (both primary and alias accounts)
message Account {
  string id = 1;                           // Account UUID
  string user_id = 2;                      // Owner user UUID (same for primary and all aliases)
  string username = 3;                     // Username
  string display_name = 4;                 // Display name
  string avatar_url = 5;                   // Avatar URL
  bool is_primary = 6;                     // True for main account
  bool is_active = 7;                      // Currently active account
  bool is_alias = 8;                       // True for alias accounts
  int64 last_active_at = 9;                // Unix timestamp
  int64 created_at = 10;                   // Unix timestamp

  // Alias-specific fields (only populated for alias accounts)
  string alias_name = 11;                  // Alias display name
  string date_of_birth = 12;               // Date of birth (YYYY-MM-DD)
  Gender gender = 13;                      // Gender
  string profession = 14;                  // Profession/occupation
  string location = 15;                    // Location
}

// -------- List Accounts --------
message ListAccountsRequest {
  string user_id = 1;                      // User to list accounts for
}

message ListAccountsResponse {
  repeated Account accounts = 1;           // All accounts (primary + aliases)
  string current_account_id = 2;           // Currently active account ID
}

// -------- Switch Account --------
message SwitchAccountRequest {
  string user_id = 1;                      // Current user ID
  string target_account_id = 2;            // Account ID to switch to
}

message SwitchAccountResponse {
  bool success = 1;
  string access_token = 2;                 // New access token for switched account
  string refresh_token = 3;                // New refresh token
  Account account = 4;                     // Switched account details
}

// -------- Create Alias Account --------
message CreateAliasAccountRequest {
  string user_id = 1;                      // Owner user ID
  string alias_name = 2;                   // Required: Alias display name
  string avatar_url = 3;                   // Optional: Avatar URL
  string date_of_birth = 4;                // Optional: Date of birth
  Gender gender = 5;                       // Optional: Gender
  string profession = 6;                   // Optional: Profession
  string location = 7;                     // Optional: Location
}

message CreateAliasAccountResponse {
  Account account = 1;                     // Created alias account
}

// -------- Update Alias Account --------
message UpdateAliasAccountRequest {
  string account_id = 1;                   // Alias account ID to update
  string user_id = 2;                      // Owner user ID (for authorization)
  string alias_name = 3;                   // Updated alias name
  string avatar_url = 4;                   // Updated avatar URL
  string date_of_birth = 5;                // Updated date of birth
  Gender gender = 6;                       // Updated gender
  string profession = 7;                   // Updated profession
  string location = 8;                     // Updated location
}

message UpdateAliasAccountResponse {
  Account account = 1;                     // Updated alias account
}

// -------- Get Alias Account --------
message GetAliasAccountRequest {
  string account_id = 1;                   // Alias account ID
  string user_id = 2;                      // Owner user ID (for authorization)
}

message GetAliasAccountResponse {
  Account account = 1;                     // Alias account details
}

// -------- Delete Alias Account --------
message DeleteAliasAccountRequest {
  string account_id = 1;                   // Alias account ID to delete
  string user_id = 2;                      // Owner user ID (for authorization)
}

// ============================================================================
// Account Management Events
// ============================================================================

// Kafka Topic: identity.alias.created
message AliasAccountCreatedEvent {
  string user_id = 1;
  string account_id = 2;
  string alias_name = 3;
  google.protobuf.Timestamp created_at = 4;
}

// Kafka Topic: identity.alias.updated
message AliasAccountUpdatedEvent {
  string user_id = 1;
  string account_id = 2;
  string alias_name = 3;
  google.protobuf.Timestamp updated_at = 4;
}

// Kafka Topic: identity.alias.deleted
message AliasAccountDeletedEvent {
  string user_id = 1;
  string account_id = 2;
  google.protobuf.Timestamp deleted_at = 3;
}

// Kafka Topic: identity.account.switched
message AccountSwitchedEvent {
  string user_id = 1;
  string from_account_id = 2;
  string to_account_id = 3;
  google.protobuf.Timestamp switched_at = 4;
}

// ============================================================================
// Passkey/WebAuthn Messages
// ============================================================================

message StartPasskeyRegistrationRequest {
  string user_id = 1;
  string credential_name = 2;
  string device_type = 3;
  string os_version = 4;
}

message StartPasskeyRegistrationResponse {
  string challenge_id = 1;
  string options_json = 2;
}

message CompletePasskeyRegistrationRequest {
  string challenge_id = 1;
  string attestation_json = 2;
  string credential_name = 3;
  string device_type = 4;
  string os_version = 5;
}

message CompletePasskeyRegistrationResponse {
  string credential_id = 1;
  string credential_name = 2;
}

message StartPasskeyAuthenticationRequest {
  string user_id = 1;
}

message StartPasskeyAuthenticationResponse {
  string challenge_id = 1;
  string options_json = 2;
}

message CompletePasskeyAuthenticationRequest {
  string challenge_id = 1;
  string assertion_json = 2;
}

message CompletePasskeyAuthenticationResponse {
  string user_id = 1;
  string credential_id = 2;
  string access_token = 3;
  string refresh_token = 4;
  int64 expires_at = 5;
  string username = 6;
  string email = 7;
}

message ListPasskeysRequest {
  string user_id = 1;
}

message PasskeyCredential {
  string id = 1;
  string credential_name = 2;
  string device_type = 3;
  string os_version = 4;
  bool backup_eligible = 5;
  bool backup_state = 6;
  repeated string transports = 7;
  google.protobuf.Timestamp created_at = 8;
  google.protobuf.Timestamp last_used_at = 9;
  bool is_active = 10;
}

message ListPasskeysResponse {
  repeated PasskeyCredential passkeys = 1;
}

message RevokePasskeyRequest {
  string user_id = 1;
  string credential_id = 2;
  string reason = 3;
}

message RenamePasskeyRequest {
  string user_id = 1;
  string credential_id = 2;
  string new_name = 3;
}
