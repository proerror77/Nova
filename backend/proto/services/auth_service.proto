syntax = "proto3";
package nova.identity_service.v2;

import "common.proto";
import "google/protobuf/wrappers.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";
import "google/api/annotations.proto";

// ============================================================================
// Auth Service gRPC API
//
// This service provides user authentication, authorization, and identity
// management for all other services in Nova backend.
//
// Key responsibilities:
//   - User registration and login
//   - Token validation and verification
//   - User information retrieval
//   - Permission and role checking
// ============================================================================

// Message: Represents a basic user
message User {
  string id = 1;                    // UUID of the user
  string email = 2;                 // User's email address
  string username = 3;              // User's username (unique)
  int64 created_at = 4;            // Unix timestamp (seconds)
  bool is_active = 5;               // Whether user account is active
  int32 failed_login_attempts = 6;  // Current failed login count
  optional int64 locked_until = 7;  // Unix timestamp (seconds) when lockout expires
}

// ============================================================================
// Get User by ID
// ============================================================================

message GetUserRequest {
  string user_id = 1;  // UUID of the user to retrieve
}

message GetUserResponse {
  User user = 1;
  optional .nova.common.v2.ErrorStatus error = 2;
}

// ============================================================================
// Get Multiple Users by IDs (batch operation)
// ============================================================================

message GetUsersByIdsRequest {
  repeated string user_ids = 1;  // List of user UUIDs
}

message GetUsersByIdsResponse {
  repeated User users = 1;
  optional .nova.common.v2.ErrorStatus error = 2;
}

// ============================================================================
// Verify Token Validity
// ============================================================================

message VerifyTokenRequest {
  string token = 1;  // JWT token to verify
}

message VerifyTokenResponse {
  bool is_valid = 1;           // Whether token is valid
  string user_id = 2;          // UUID of token owner (if valid)
  string email = 3;            // Email of token owner (if valid)
  string username = 4;         // Username of token owner (if valid)
  int64 expires_at = 5;        // Unix timestamp when token expires
  bool is_revoked = 6;         // Whether token has been revoked
  optional .nova.common.v2.ErrorStatus error = 7;
}

// ============================================================================
// Check User Exists
// ============================================================================

message CheckUserExistsRequest {
  string user_id = 1;  // UUID to check
}

message CheckUserExistsResponse {
  bool exists = 1;
}

// ============================================================================
// Get User by Email
// ============================================================================

message GetUserByEmailRequest {
  string email = 1;  // Email address to look up
}

message GetUserByEmailResponse {
  User user = 1;
  optional .nova.common.v2.ErrorStatus error = 2;
}

message GetUserByUsernameRequest {
  string username = 1;  // Username to look up
}

message GetUserByUsernameResponse {
  User user = 1;
  optional .nova.common.v2.ErrorStatus error = 2;
}

// ============================================================================
// List Users (with pagination)
// ============================================================================

message ListUsersRequest {
  int32 limit = 1;    // Number of results (max 100)
  int32 offset = 2;   // Pagination offset
  string search = 3;  // Optional search term (email or username)
}

message ListUsersResponse {
  repeated User users = 1;
  int32 total_count = 2;
  optional .nova.common.v2.ErrorStatus error = 3;
}

// ============================================================================
// Check User Has Permission
// ============================================================================

message CheckPermissionRequest {
  string user_id = 1;
  string permission = 2;  // e.g., "posts:create", "users:delete"
}

message CheckPermissionResponse {
  bool has_permission = 1;
  optional .nova.common.v2.ErrorStatus error = 2;
}

// ============================================================================
// Get User Permissions
// ============================================================================

message GetUserPermissionsRequest {
  string user_id = 1;
}

message GetUserPermissionsResponse {
  repeated string permissions = 1;
  repeated string roles = 2;
  optional .nova.common.v2.ErrorStatus error = 3;
}

// ============================================================================
// Record Failed Login Attempt
// ============================================================================

message RecordFailedLoginRequest {
  string user_id = 1;
  int32 max_attempts = 2;         // Maximum failed attempts before lockout
  int32 lock_duration_secs = 3;   // Duration of lockout in seconds
}

message RecordFailedLoginResponse {
  int32 failed_attempts = 1;
  bool is_locked = 2;
  optional int64 locked_until = 3;  // Unix timestamp (seconds) if locked
  optional .nova.common.v2.ErrorStatus error = 4;
}

// ============================================================================
// User Profile Management (single-writer via auth-service)
// ============================================================================

message UpdateUserProfileRequest {
  string user_id = 1;
  optional string display_name = 2;
  optional string bio = 3;
  optional string avatar_url = 4;
  optional string cover_photo_url = 5;
  optional string location = 6;
  optional bool is_private = 7;        // STANDARDIZED: is_private (not private_account)
  // Extended profile fields
  optional string first_name = 8;
  optional string last_name = 9;
  optional string date_of_birth = 10;  // ISO 8601 date format (YYYY-MM-DD)
  Gender gender = 11;                  // STANDARDIZED: Gender enum (not string)
}

// NOTE: Field naming aligned with proto/services_v2/common/user.proto (source of truth)
message UserProfile {
  string user_id = 1;
  string username = 2;
  optional string email = 3;
  optional string display_name = 4;
  optional string bio = 5;
  optional string avatar_url = 6;
  optional string cover_photo_url = 7;
  optional string location = 8;
  bool is_private = 9;                 // STANDARDIZED: is_private (not private_account)
  int64 created_at = 10;               // TODO: Migrate to google.protobuf.Timestamp
  int64 updated_at = 11;               // TODO: Migrate to google.protobuf.Timestamp
  // Extended profile fields
  optional string first_name = 12;
  optional string last_name = 13;
  optional string date_of_birth = 14;  // ISO 8601 date format (YYYY-MM-DD)
  Gender gender = 15;                  // STANDARDIZED: Gender enum (not string)
}

message UpdateUserProfileResponse {
  optional UserProfile profile = 1;
  optional .nova.common.v2.ErrorStatus error = 2;
}

// ============================================================================
// Get Multiple User Profiles by IDs (batch operation)
// ============================================================================

message GetUserProfilesByIdsRequest {
  repeated string user_ids = 1;  // List of user UUIDs
}

message GetUserProfilesByIdsResponse {
  repeated UserProfile profiles = 1;
  optional .nova.common.v2.ErrorStatus error = 2;
}

// ============================================================================
// Public Key Management (E2EE messaging support)
// ============================================================================

message UpsertUserPublicKeyRequest {
  string user_id = 1;
  string public_key = 2;
}

message UpsertUserPublicKeyResponse {
  bool success = 1;
  optional .nova.common.v2.ErrorStatus error = 2;
}

message GetUserPublicKeyRequest {
  string user_id = 1;
}

message GetUserPublicKeyResponse {
  bool found = 1;
  optional string public_key = 2;
  optional .nova.common.v2.ErrorStatus error = 3;
}

// ============================================================================
// User Registration (Phase 0 - 009-A: auth-register-login)
// ============================================================================

message RegisterRequest {
  string email = 1;        // User email address (must be valid format)
  string username = 2;     // User username (3-32 chars, alphanumeric + underscore)
  string password = 3;     // User password (validated by zxcvbn score >= 3)
  string invite_code = 4;  // Required: valid invite code for registration
  optional string display_name = 5;  // Optional display name (defaults to username if not provided)
}

message RegisterResponse {
  string user_id = 1;         // UUID of newly created user
  string token = 2;           // JWT access token (RS256 signed, expires_in=3600s)
  string refresh_token = 3;   // Refresh token (stateless or stored in sessions table)
  int64 expires_in = 4;       // Seconds until access_token expires
}

// ============================================================================
// User Login (Phase 0 - 009-A: auth-register-login)
// ============================================================================

message LoginRequest {
  string email = 1;      // User email address
  string password = 2;   // User password (plain text - validated against hash)
  // Device information for session tracking
  string device_id = 3;      // Optional: unique device identifier
  string device_name = 4;    // Optional: device name (e.g., "iPhone 15 Pro")
  string device_type = 5;    // Optional: device type (iOS, macOS, Android, Web)
  string os_version = 6;     // Optional: OS version (e.g., "iOS 18.0")
  string user_agent = 7;     // Optional: user agent string
}

message LoginResponse {
  string user_id = 1;         // UUID of authenticated user
  string token = 2;           // JWT access token (RS256 signed, expires_in=3600s)
  string refresh_token = 3;   // Refresh token
  int64 expires_in = 4;       // Seconds until access_token expires
}

// ============================================================================
// Token Refresh (Phase 0 - 009-A: auth-register-login)
// ============================================================================

message RefreshTokenRequest {
  string refresh_token = 1;   // Refresh token (from previous login/register)
}

message RefreshTokenResponse {
  string token = 1;           // New JWT access token (RS256 signed, expires_in=3600s)
  int64 expires_in = 2;       // Seconds until new access_token expires
  string refresh_token = 3;   // New refresh token (rotation for extended sessions like IG/Twitter)
}

// ============================================================================ 
// Invitations (lightweight invite code for sign-up)
// ============================================================================
message GenerateInviteRequest {
  string issuer_user_id = 1;
  optional string target_email = 2;
  optional string target_phone = 3;
  optional int64 expires_at = 4; // unix seconds
}

message GenerateInviteResponse {
  string code = 1;
  string invite_url = 2;
  int64 expires_at = 3;
}

message RedeemInviteRequest {
  string code = 1;
  string new_user_id = 2;
}

message RedeemInviteResponse {
  bool success = 1;
}

message ListInvitationsRequest {
  string user_id = 1;
  optional int32 limit = 2;
  optional int32 offset = 3;
}

message InvitationInfo {
  string code = 1;
  string invite_url = 2;
  int64 created_at = 3;
  int64 expires_at = 4;
  bool is_redeemed = 5;
  optional string redeemed_by_user_id = 6;
  optional int64 redeemed_at = 7;
}

message ListInvitationsResponse {
  repeated InvitationInfo invitations = 1;
  int32 total = 2;
}

message GetInvitationStatsRequest {
  string user_id = 1;
}

message GetInvitationStatsResponse {
  int32 total_generated = 1;
  int32 total_redeemed = 2;
  int32 total_pending = 3;
  int32 total_expired = 4;
}

// ============================================================================
// Invite Quota Management
// ============================================================================
message GetInviteQuotaRequest {
  string user_id = 1;
}

message GetInviteQuotaResponse {
  int32 total_quota = 1;           // Total invite quota
  int32 used_quota = 2;            // Already generated invites
  int32 remaining_quota = 3;       // Remaining invites available
  int32 successful_referrals = 4;  // Count of successful referrals
}

// ============================================================================
// Send Invite via Channel (SMS, Email, Link)
// ============================================================================
message SendInviteRequest {
  string user_id = 1;              // Issuer user ID
  string channel = 2;              // "sms", "email", "link"
  optional string recipient = 3;   // Phone number or email (required for sms/email)
  optional string message = 4;     // Custom message to include
}

message SendInviteResponse {
  bool success = 1;
  string invite_code = 2;
  string invite_url = 3;           // Firebase Dynamic Link URL
  string share_text = 4;           // Pre-formatted share message
  optional string delivery_id = 5; // Tracking ID for SMS/Email delivery
  optional string error = 6;
}

// ============================================================================
// Validate Invite Code (check before registration)
// ============================================================================
message ValidateInviteRequest {
  string code = 1;
}

message ValidateInviteResponse {
  bool is_valid = 1;
  optional string issuer_username = 2;  // Who sent the invite
  optional int64 expires_at = 3;
  optional string error = 4;  // "expired", "already_used", "not_found"
}

// ============================================================================
// Referral Chain Info
// ============================================================================
message GetReferralInfoRequest {
  string user_id = 1;
}

message ReferralUser {
  string user_id = 1;
  string username = 2;
  optional string avatar_url = 3;
  int64 joined_at = 4;
  string status = 5;  // "pending", "active"
}

message GetReferralInfoResponse {
  optional ReferralUser referred_by = 1;    // Who invited this user
  repeated ReferralUser referrals = 2;      // Users this user invited
  int32 total_referrals = 3;
  int32 active_referrals = 4;
}

// ============================================================================
// User Settings (P0: user-service migration)
// ============================================================================

// NOTE: Field naming aligned with proto/services_v2/common/user.proto (source of truth)
message UserSettings {
  string user_id = 1;
  DMPermission dm_permission = 2;     // STANDARDIZED: DMPermission enum
  bool email_notifications = 3;
  bool push_notifications = 4;
  bool marketing_emails = 5;
  string timezone = 6;
  string language = 7;
  bool dark_mode = 8;
  PrivacyLevel privacy_level = 9;     // STANDARDIZED: PrivacyLevel enum
  // Field 10 removed: allow_messages merged into dm_permission enum
  bool show_online_status = 11;
  int64 created_at = 12;              // TODO: Migrate to google.protobuf.Timestamp
  int64 updated_at = 13;              // TODO: Migrate to google.protobuf.Timestamp
}

message GetUserSettingsRequest {
  string user_id = 1;
}

message GetUserSettingsResponse {
  UserSettings settings = 1;
  optional .nova.common.v2.ErrorStatus error = 2;
}

message UpdateUserSettingsRequest {
  string user_id = 1;
  optional DMPermission dm_permission = 2;     // STANDARDIZED: DMPermission enum
  optional bool email_notifications = 3;
  optional bool push_notifications = 4;
  optional bool marketing_emails = 5;
  optional string timezone = 6;
  optional string language = 7;
  optional bool dark_mode = 8;
  optional PrivacyLevel privacy_level = 9;     // STANDARDIZED: PrivacyLevel enum
  // Field 10 removed: allow_messages merged into dm_permission enum
  optional bool show_online_status = 11;
}

message UpdateUserSettingsResponse {
  UserSettings settings = 1;
  optional .nova.common.v2.ErrorStatus error = 2;
}

// ============================================================================
// Devices (session-associated devices)
// ============================================================================
message Device {
  string id = 1;
  string name = 2;
  string device_type = 3;
  string os = 4;
  int64 last_active = 5;
  bool is_current = 6;
}

message ListDevicesRequest {
  string user_id = 1;
  int32 limit = 2;
  int32 offset = 3;
}

message ListDevicesResponse {
  repeated Device devices = 1;
  int32 total = 2;
}

message LogoutDeviceRequest {
  string user_id = 1;
  string device_id = 2;
  bool all = 3;
}

message LogoutDeviceResponse {
  bool success = 1;
}

message GetCurrentDeviceRequest {
  string user_id = 1;
  optional string device_id = 2;
}

message GetCurrentDeviceResponse {
  optional Device device = 1;
}

// ============================================================================ 
// User channel subscriptions (stored with profile)
// ============================================================================
message ListUserChannelsRequest {
  string user_id = 1;
}

message ListUserChannelsResponse {
  repeated string channel_ids = 1;
}

message UpdateUserChannelsRequest {
  string user_id = 1;
  repeated string subscribe_ids = 2;
  repeated string unsubscribe_ids = 3;
}

message UpdateUserChannelsResponse {
  repeated string channel_ids = 1;
}

// ============================================================================
// OAuth/SSO (Google, Apple)
// ============================================================================

// Supported OAuth providers
enum OAuthProvider {
  OAUTH_PROVIDER_UNSPECIFIED = 0;
  OAUTH_PROVIDER_GOOGLE = 1;
  OAUTH_PROVIDER_APPLE = 2;
}

// Start OAuth flow - returns authorization URL
message StartOAuthFlowRequest {
  OAuthProvider provider = 1;       // OAuth provider to authenticate with
  string redirect_uri = 2;          // Client callback URL after OAuth completes
  optional string invite_code = 3;  // Optional invite code for new user registration
}

message StartOAuthFlowResponse {
  string authorization_url = 1;     // URL to redirect user to for OAuth
  string state = 2;                 // State token for CSRF protection (store client-side)
}

// Complete OAuth flow - exchange code for tokens
message CompleteOAuthFlowRequest {
  string state = 1;                 // State token from StartOAuthFlowResponse
  string code = 2;                  // Authorization code from OAuth provider callback
  string redirect_uri = 3;          // Same redirect URI used in StartOAuthFlow
  optional string invite_code = 4;  // Invite code for new user registration (Nova is invite-only)
}

message CompleteOAuthFlowResponse {
  string user_id = 1;               // UUID of authenticated user
  string token = 2;                 // JWT access token
  string refresh_token = 3;         // Refresh token
  int64 expires_in = 4;             // Seconds until access_token expires
  string username = 5;              // Username
  string email = 6;                 // Email address
  bool is_new_user = 7;             // True if this OAuth login created a new account
}

// List linked OAuth providers for a user
message ListOAuthConnectionsRequest {
  string user_id = 1;
}

message OAuthConnectionInfo {
  string id = 1;                    // Connection UUID
  OAuthProvider provider = 2;       // OAuth provider
  string provider_user_id = 3;      // User's ID on the provider
  optional string email = 4;        // Email from provider (may differ from account email)
  optional string name = 5;         // Name from provider
  optional string picture_url = 6;  // Profile picture URL from provider
  int64 connected_at = 7;           // Unix timestamp when connected
  int64 last_used_at = 8;           // Unix timestamp when last used for login
}

message ListOAuthConnectionsResponse {
  repeated OAuthConnectionInfo connections = 1;
}

// Unlink an OAuth provider from user account
message UnlinkOAuthProviderRequest {
  string user_id = 1;
  OAuthProvider provider = 2;       // Provider to unlink
}

message UnlinkOAuthProviderResponse {
  bool success = 1;
  optional string error = 2;        // Error message if unlink failed
}

// Apple Sign-In native flow (iOS native authentication)
message AppleNativeSignInRequest {
  string authorization_code = 1;    // Authorization code from ASAuthorizationAppleIDCredential
  string identity_token = 2;        // JWT identity token from Apple
  string user_identifier = 3;       // Apple user identifier (stable across devices)
  optional string email = 4;        // Email (only provided on first sign-in)
  optional string given_name = 5;   // First name (only provided on first sign-in)
  optional string family_name = 6;  // Last name (only provided on first sign-in)
  optional string invite_code = 7;  // Invite code for new user registration
  // Device info for session tracking
  optional string device_id = 8;    // Device UUID (identifierForVendor on iOS)
  optional string device_name = 9;  // Device name (e.g., "John's iPhone")
  optional string device_type = 10; // Device type (e.g., "iOS", "macOS")
  optional string os_version = 11;  // OS version (e.g., "iOS 18.0")
  optional string user_agent = 12;  // User agent string
}

message AppleNativeSignInResponse {
  string user_id = 1;               // UUID of authenticated user
  string token = 2;                 // JWT access token
  string refresh_token = 3;         // Refresh token
  int64 expires_in = 4;             // Seconds until access_token expires
  string username = 5;              // Username
  string email = 6;                 // Email address
  bool is_new_user = 7;             // True if this created a new account
}

// ============================================================================
// Phone Authentication (SMS OTP)
// ============================================================================

// Request to send SMS verification code
message SendPhoneCodeRequest {
  string phone_number = 1;  // Phone number in E.164 format (e.g., +14155551234)
}

message SendPhoneCodeResponse {
  bool success = 1;
  optional string message = 2;
  int32 expires_in = 3;  // Seconds until code expires (default: 300)
}

// Request to verify SMS code
message VerifyPhoneCodeRequest {
  string phone_number = 1;  // Phone number in E.164 format
  string code = 2;          // 6-digit verification code
}

message VerifyPhoneCodeResponse {
  bool success = 1;
  optional string verification_token = 2;  // Token to use for registration/login
  optional string message = 3;
}

// Request to register with verified phone number
message PhoneRegisterRequest {
  string phone_number = 1;        // Verified phone number
  string verification_token = 2;  // Token from VerifyPhoneCodeResponse
  string username = 3;            // Desired username
  string password = 4;            // Account password
  optional string display_name = 5;
}

message PhoneRegisterResponse {
  string user_id = 1;
  string token = 2;
  string refresh_token = 3;
  int64 expires_in = 4;
  string username = 5;
  bool is_new_user = 6;
}

// Request to login with verified phone number
message PhoneLoginRequest {
  string phone_number = 1;        // Phone number in E.164 format
  string verification_token = 2;  // Token from VerifyPhoneCodeResponse
}

message PhoneLoginResponse {
  string user_id = 1;
  string token = 2;
  string refresh_token = 3;
  int64 expires_in = 4;
  string username = 5;
}

// ============================================================================
// Password Reset
// ============================================================================

message RequestPasswordResetRequest {
  string email = 1;  // Email address to send reset link to
}

message ResetPasswordRequest {
  string reset_token = 1;   // Token from email link
  string new_password = 2;  // New password (will be validated and hashed)
}

message PasswordResetResponse {
  bool success = 1;
}

// ============================================================================
// Auth Service Definition
// ============================================================================

service AuthService {
  // User Registration
  rpc Register(RegisterRequest) returns (RegisterResponse) {
    option (google.api.http) = {
      post: "/api/v2/auth/register"
      body: "*"
    };
  }

  // User Login
  rpc Login(LoginRequest) returns (LoginResponse) {
    option (google.api.http) = {
      post: "/api/v2/auth/login"
      body: "*"
    };
  }

  // Token Refresh
  rpc Refresh(RefreshTokenRequest) returns (RefreshTokenResponse) {
    option (google.api.http) = {
      post: "/api/v2/auth/refresh"
      body: "*"
    };
  }

  // Get single user by ID
  rpc GetUser(GetUserRequest) returns (GetUserResponse) {
    option (google.api.http) = {
      get: "/api/v2/auth/users/{user_id}"
    };
  }

  // Get multiple users in a single batch request
  rpc GetUsersByIds(GetUsersByIdsRequest) returns (GetUsersByIdsResponse) {
    option (google.api.http) = {
      post: "/api/v2/auth/users/batch"
      body: "*"
    };
  }

  // Verify JWT token validity
  rpc VerifyToken(VerifyTokenRequest) returns (VerifyTokenResponse) {
    option (google.api.http) = {
      post: "/api/v2/auth/verify"
      body: "*"
    };
  }

  // Check if user exists
  rpc CheckUserExists(CheckUserExistsRequest) returns (CheckUserExistsResponse) {
    option (google.api.http) = {
      get: "/api/v2/auth/users/{user_id}/exists"
    };
  }

  // Get user by email address
  rpc GetUserByEmail(GetUserByEmailRequest) returns (GetUserByEmailResponse) {
    option (google.api.http) = {
      get: "/api/v2/auth/users/by-email"
    };
  }

  // Get user by username
  rpc GetUserByUsername(GetUserByUsernameRequest) returns (GetUserByUsernameResponse) {
    option (google.api.http) = {
      get: "/api/v2/auth/users/by-username/{username}"
    };
  }

  // List users with pagination and search
  rpc ListUsers(ListUsersRequest) returns (ListUsersResponse) {
    option (google.api.http) = {
      get: "/api/v2/auth/users"
    };
  }

  // Check if user has specific permission
  rpc CheckPermission(CheckPermissionRequest) returns (CheckPermissionResponse) {
    option (google.api.http) = {
      get: "/api/v2/auth/permissions/check"
    };
  }

  // Get all permissions for a user
  rpc GetUserPermissions(GetUserPermissionsRequest) returns (GetUserPermissionsResponse) {
    option (google.api.http) = {
      get: "/api/v2/auth/users/{user_id}/permissions"
    };
  }

  // Record a failed login attempt (internal)
  rpc RecordFailedLogin(RecordFailedLoginRequest) returns (RecordFailedLoginResponse);

  // Update mutable user profile fields
  rpc UpdateUserProfile(UpdateUserProfileRequest) returns (UpdateUserProfileResponse) {
    option (google.api.http) = {
      put: "/api/v2/auth/users/{user_id}/profile"
      body: "*"
    };
  }

  // Get multiple user profiles in a single batch request
  rpc GetUserProfilesByIds(GetUserProfilesByIdsRequest) returns (GetUserProfilesByIdsResponse) {
    option (google.api.http) = {
      post: "/api/v2/auth/users/profiles/batch"
      body: "*"
    };
  }

  // Manage user public keys for E2E encryption
  rpc UpsertUserPublicKey(UpsertUserPublicKeyRequest) returns (UpsertUserPublicKeyResponse) {
    option (google.api.http) = {
      put: "/api/v2/auth/users/{user_id}/public-key"
      body: "*"
    };
  }
  rpc GetUserPublicKey(GetUserPublicKeyRequest) returns (GetUserPublicKeyResponse) {
    option (google.api.http) = {
      get: "/api/v2/auth/users/{user_id}/public-key"
    };
  }

  // Invitations
  rpc GenerateInvite(GenerateInviteRequest) returns (GenerateInviteResponse) {
    option (google.api.http) = {
      post: "/api/v2/auth/invites"
      body: "*"
    };
  }
  rpc RedeemInvite(RedeemInviteRequest) returns (RedeemInviteResponse) {
    option (google.api.http) = {
      post: "/api/v2/auth/invites/redeem"
      body: "*"
    };
  }
  rpc ListInvitations(ListInvitationsRequest) returns (ListInvitationsResponse) {
    option (google.api.http) = {
      get: "/api/v2/auth/invites"
    };
  }
  rpc GetInvitationStats(GetInvitationStatsRequest) returns (GetInvitationStatsResponse) {
    option (google.api.http) = {
      get: "/api/v2/auth/invites/stats"
    };
  }

  // Invite Quota
  rpc GetInviteQuota(GetInviteQuotaRequest) returns (GetInviteQuotaResponse) {
    option (google.api.http) = {
      get: "/api/v2/auth/invites/quota"
    };
  }

  // Send Invite via Channel (SMS, Email, Link)
  rpc SendInvite(SendInviteRequest) returns (SendInviteResponse) {
    option (google.api.http) = {
      post: "/api/v2/auth/invites/send"
      body: "*"
    };
  }

  // Validate Invite Code (public - no auth required)
  rpc ValidateInvite(ValidateInviteRequest) returns (ValidateInviteResponse) {
    option (google.api.http) = {
      get: "/api/v2/auth/invites/validate"
    };
  }

  // Referral Info
  rpc GetReferralInfo(GetReferralInfoRequest) returns (GetReferralInfoResponse) {
    option (google.api.http) = {
      get: "/api/v2/auth/referrals"
    };
  }

  // Devices
  rpc ListDevices(ListDevicesRequest) returns (ListDevicesResponse) {
    option (google.api.http) = {
      get: "/api/v2/auth/devices"
    };
  }
  rpc LogoutDevice(LogoutDeviceRequest) returns (LogoutDeviceResponse) {
    option (google.api.http) = {
      post: "/api/v2/auth/devices/logout"
      body: "*"
    };
  }
  rpc GetCurrentDevice(GetCurrentDeviceRequest) returns (GetCurrentDeviceResponse) {
    option (google.api.http) = {
      get: "/api/v2/auth/devices/current"
    };
  }

  // User channel subscriptions
  rpc ListUserChannels(ListUserChannelsRequest) returns (ListUserChannelsResponse) {
    option (google.api.http) = {
      get: "/api/v2/auth/users/{user_id}/channels"
    };
  }
  rpc UpdateUserChannels(UpdateUserChannelsRequest) returns (UpdateUserChannelsResponse) {
    option (google.api.http) = {
      put: "/api/v2/auth/users/{user_id}/channels"
      body: "*"
    };
  }

  // User Settings (P0: user-service migration)
  rpc GetUserSettings(GetUserSettingsRequest) returns (GetUserSettingsResponse) {
    option (google.api.http) = {
      get: "/api/v2/auth/users/{user_id}/settings"
    };
  }
  rpc UpdateUserSettings(UpdateUserSettingsRequest) returns (UpdateUserSettingsResponse) {
    option (google.api.http) = {
      put: "/api/v2/auth/users/{user_id}/settings"
      body: "*"
    };
  }

  // ========== OAuth/SSO ==========
  // Start OAuth flow - returns authorization URL to redirect user to
  rpc StartOAuthFlow(StartOAuthFlowRequest) returns (StartOAuthFlowResponse) {
    option (google.api.http) = {
      post: "/api/v2/auth/oauth/start"
      body: "*"
    };
  }

  // Complete OAuth flow - exchange authorization code for tokens
  rpc CompleteOAuthFlow(CompleteOAuthFlowRequest) returns (CompleteOAuthFlowResponse) {
    option (google.api.http) = {
      post: "/api/v2/auth/oauth/callback"
      body: "*"
    };
  }

  // List linked OAuth providers for a user
  rpc ListOAuthConnections(ListOAuthConnectionsRequest) returns (ListOAuthConnectionsResponse) {
    option (google.api.http) = {
      get: "/api/v2/auth/users/{user_id}/oauth"
    };
  }

  // Unlink an OAuth provider from user account
  rpc UnlinkOAuthProvider(UnlinkOAuthProviderRequest) returns (UnlinkOAuthProviderResponse) {
    option (google.api.http) = {
      delete: "/api/v2/auth/users/{user_id}/oauth/{provider}"
    };
  }

  // Apple Sign-In native flow (for iOS apps using ASAuthorizationAppleIDCredential)
  rpc AppleNativeSignIn(AppleNativeSignInRequest) returns (AppleNativeSignInResponse) {
    option (google.api.http) = {
      post: "/api/v2/auth/oauth/apple/native"
      body: "*"
    };
  }

  // ========== Password Reset ==========
  // Request password reset email (public - no auth required)
  rpc RequestPasswordReset(RequestPasswordResetRequest) returns (PasswordResetResponse) {
    option (google.api.http) = {
      post: "/api/v2/auth/password/reset/request"
      body: "*"
    };
  }

  // Reset password using token from email
  rpc ResetPassword(ResetPasswordRequest) returns (PasswordResetResponse) {
    option (google.api.http) = {
      post: "/api/v2/auth/password/reset"
      body: "*"
    };
  }

  // ========== Phone Authentication (SMS OTP) ==========
  // Send verification code to phone number (public - no auth required)
  rpc SendPhoneCode(SendPhoneCodeRequest) returns (SendPhoneCodeResponse) {
    option (google.api.http) = {
      post: "/api/v2/auth/phone/send-code"
      body: "*"
    };
  }

  // Verify SMS code (public - no auth required)
  rpc VerifyPhoneCode(VerifyPhoneCodeRequest) returns (VerifyPhoneCodeResponse) {
    option (google.api.http) = {
      post: "/api/v2/auth/phone/verify"
      body: "*"
    };
  }

  // Register new user with verified phone number (public - no auth required)
  rpc PhoneRegister(PhoneRegisterRequest) returns (PhoneRegisterResponse) {
    option (google.api.http) = {
      post: "/api/v2/auth/phone/register"
      body: "*"
    };
  }

  // Login with verified phone number (public - no auth required)
  rpc PhoneLogin(PhoneLoginRequest) returns (PhoneLoginResponse) {
    option (google.api.http) = {
      post: "/api/v2/auth/phone/login"
      body: "*"
    };
  }

  // ========== Account Management (Multi-account & Alias) ==========
  // List all accounts for a user (primary + aliases)
  rpc ListAccounts(ListAccountsRequest) returns (ListAccountsResponse) {
    option (google.api.http) = {
      get: "/api/v2/accounts"
    };
  }

  // Switch to a different account (returns new tokens)
  rpc SwitchAccount(SwitchAccountRequest) returns (SwitchAccountResponse) {
    option (google.api.http) = {
      post: "/api/v2/accounts/switch"
      body: "*"
    };
  }

  // Create a new alias account
  rpc CreateAliasAccount(CreateAliasAccountRequest) returns (CreateAliasAccountResponse) {
    option (google.api.http) = {
      post: "/api/v2/accounts/alias"
      body: "*"
    };
  }

  // Update an existing alias account
  rpc UpdateAliasAccount(UpdateAliasAccountRequest) returns (UpdateAliasAccountResponse) {
    option (google.api.http) = {
      put: "/api/v2/accounts/alias/{account_id}"
      body: "*"
    };
  }

  // Get alias account details
  rpc GetAliasAccount(GetAliasAccountRequest) returns (GetAliasAccountResponse) {
    option (google.api.http) = {
      get: "/api/v2/accounts/alias/{account_id}"
    };
  }

  // Delete an alias account
  rpc DeleteAliasAccount(DeleteAliasAccountRequest) returns (DeleteAliasAccountResponse) {
    option (google.api.http) = {
      delete: "/api/v2/accounts/alias/{account_id}"
    };
  }

  // ========== Passkey/WebAuthn ==========

  // Start passkey registration - returns WebAuthn challenge options
  rpc StartPasskeyRegistration(StartPasskeyRegistrationRequest) returns (StartPasskeyRegistrationResponse) {
    option (google.api.http) = {
      post: "/api/v2/passkey/register/start"
      body: "*"
    };
  }

  // Complete passkey registration - stores credential
  rpc CompletePasskeyRegistration(CompletePasskeyRegistrationRequest) returns (CompletePasskeyRegistrationResponse) {
    option (google.api.http) = {
      post: "/api/v2/passkey/register/complete"
      body: "*"
    };
  }

  // Start passkey authentication - returns WebAuthn challenge options
  rpc StartPasskeyAuthentication(StartPasskeyAuthenticationRequest) returns (StartPasskeyAuthenticationResponse) {
    option (google.api.http) = {
      post: "/api/v2/passkey/auth/start"
      body: "*"
    };
  }

  // Complete passkey authentication - validates assertion and returns tokens
  rpc CompletePasskeyAuthentication(CompletePasskeyAuthenticationRequest) returns (CompletePasskeyAuthenticationResponse) {
    option (google.api.http) = {
      post: "/api/v2/passkey/auth/complete"
      body: "*"
    };
  }

  // List all passkeys for a user
  rpc ListPasskeys(ListPasskeysRequest) returns (ListPasskeysResponse) {
    option (google.api.http) = {
      get: "/api/v2/passkey/list/{user_id}"
    };
  }

  // Revoke a passkey credential
  rpc RevokePasskey(RevokePasskeyRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      delete: "/api/v2/passkey/{credential_id}"
    };
  }

  // Rename a passkey credential
  rpc RenamePasskey(RenamePasskeyRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      patch: "/api/v2/passkey/{credential_id}"
      body: "*"
    };
  }
}

// ============================================================================
// Account Management Messages (Multi-account & Alias)
// ============================================================================

// STANDARDIZED: Canonical enums aligned with proto/services_v2/common/user.proto
enum Gender {
  GENDER_UNSPECIFIED = 0;
  GENDER_MALE = 1;
  GENDER_FEMALE = 2;
  GENDER_OTHER = 3;
  GENDER_PREFER_NOT_TO_SAY = 4;
}

enum PrivacyLevel {
  PRIVACY_LEVEL_UNSPECIFIED = 0;
  PRIVACY_LEVEL_PUBLIC = 1;
  PRIVACY_LEVEL_FRIENDS_ONLY = 2;
  PRIVACY_LEVEL_PRIVATE = 3;
}

enum DMPermission {
  DM_PERMISSION_UNSPECIFIED = 0;
  DM_PERMISSION_ANYONE = 1;
  DM_PERMISSION_FOLLOWERS = 2;
  DM_PERMISSION_MUTUALS = 3;
  DM_PERMISSION_NOBODY = 4;
}

// Account representation (both primary and alias accounts)
message Account {
  string id = 1;                           // Account UUID
  string user_id = 2;                      // Owner user UUID
  string username = 3;                     // Username
  string display_name = 4;                 // Display name
  string avatar_url = 5;                   // Avatar URL
  bool is_primary = 6;                     // True for main account
  bool is_active = 7;                      // Currently active account
  bool is_alias = 8;                       // True for alias accounts
  int64 last_active_at = 9;                // Unix timestamp
  int64 created_at = 10;                   // Unix timestamp

  // Alias-specific fields (only populated for alias accounts)
  string alias_name = 11;                  // Alias display name
  string date_of_birth = 12;               // Date of birth (YYYY-MM-DD)
  Gender gender = 13;                      // Gender
  string profession = 14;                  // Profession/occupation
  string location = 15;                    // Location
}

// -------- List Accounts --------
message ListAccountsRequest {
  string user_id = 1;                      // User to list accounts for
}

message ListAccountsResponse {
  repeated Account accounts = 1;           // All accounts (primary + aliases)
  string current_account_id = 2;           // Currently active account ID
}

// -------- Switch Account --------
message SwitchAccountRequest {
  string user_id = 1;                      // Current user ID
  string target_account_id = 2;            // Account ID to switch to
}

message SwitchAccountResponse {
  bool success = 1;
  string access_token = 2;                 // New access token
  string refresh_token = 3;                // New refresh token
  Account account = 4;                     // Switched account details
}

// -------- Create Alias Account --------
message CreateAliasAccountRequest {
  string user_id = 1;                      // Owner user ID
  string alias_name = 2;                   // Required: Alias display name
  string avatar_url = 3;                   // Optional: Avatar URL
  string date_of_birth = 4;                // Optional: Date of birth (YYYY-MM-DD)
  Gender gender = 5;                       // Optional: Gender
  string profession = 6;                   // Optional: Profession
  string location = 7;                     // Optional: Location
}

message CreateAliasAccountResponse {
  Account account = 1;                     // Created alias account
}

// -------- Update Alias Account --------
message UpdateAliasAccountRequest {
  string account_id = 1;                   // Alias account ID to update
  string user_id = 2;                      // Owner user ID (for authorization)
  string alias_name = 3;                   // Updated alias name
  string avatar_url = 4;                   // Updated avatar URL
  string date_of_birth = 5;                // Updated date of birth
  Gender gender = 6;                       // Updated gender
  string profession = 7;                   // Updated profession
  string location = 8;                     // Updated location
}

message UpdateAliasAccountResponse {
  Account account = 1;                     // Updated alias account
}

// -------- Get Alias Account --------
message GetAliasAccountRequest {
  string account_id = 1;                   // Alias account ID
  string user_id = 2;                      // Owner user ID (for authorization)
}

message GetAliasAccountResponse {
  Account account = 1;                     // Alias account details
}

// -------- Delete Alias Account --------
message DeleteAliasAccountRequest {
  string account_id = 1;                   // Alias account ID to delete
  string user_id = 2;                      // Owner user ID (for authorization)
}

message DeleteAliasAccountResponse {
  bool success = 1;
}

// ============================================================================
// Passkey/WebAuthn Messages
// ============================================================================

message StartPasskeyRegistrationRequest {
  string user_id = 1;
  string credential_name = 2;
  string device_type = 3;
  string os_version = 4;
}

message StartPasskeyRegistrationResponse {
  string challenge_id = 1;
  string options_json = 2;
}

message CompletePasskeyRegistrationRequest {
  string challenge_id = 1;
  string attestation_json = 2;
  string credential_name = 3;
  string device_type = 4;
  string os_version = 5;
}

message CompletePasskeyRegistrationResponse {
  string credential_id = 1;
  string credential_name = 2;
}

message StartPasskeyAuthenticationRequest {
  string user_id = 1;
}

message StartPasskeyAuthenticationResponse {
  string challenge_id = 1;
  string options_json = 2;
}

message CompletePasskeyAuthenticationRequest {
  string challenge_id = 1;
  string assertion_json = 2;
}

message CompletePasskeyAuthenticationResponse {
  string user_id = 1;
  string credential_id = 2;
  string access_token = 3;
  string refresh_token = 4;
  int64 expires_at = 5;
  string username = 6;
  string email = 7;
}

message ListPasskeysRequest {
  string user_id = 1;
}

message PasskeyCredential {
  string id = 1;
  string credential_name = 2;
  string device_type = 3;
  string os_version = 4;
  bool backup_eligible = 5;
  bool backup_state = 6;
  repeated string transports = 7;
  google.protobuf.Timestamp created_at = 8;
  google.protobuf.Timestamp last_used_at = 9;
  bool is_active = 10;
}

message ListPasskeysResponse {
  repeated PasskeyCredential passkeys = 1;
}

message RevokePasskeyRequest {
  string user_id = 1;
  string credential_id = 2;
  string reason = 3;
}

message RenamePasskeyRequest {
  string user_id = 1;
  string credential_id = 2;
  string new_name = 3;
}
