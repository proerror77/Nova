apiVersion: apps/v1
kind: Deployment
metadata:
  name: thumb-worker
  namespace: nova-staging
  labels:
    app: thumb-worker
    tier: backend
  annotations:
    environment: staging
spec:
  replicas: 1
  selector:
    matchLabels:
      app: thumb-worker
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        app: thumb-worker
        component: thumb-worker
        tier: backend
      annotations:
        environment: staging
    spec:
      serviceAccountName: media-service
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        fsGroup: 1000
      containers:
      - name: thumb-worker
        image: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/media-service:ed9a07a54b335134c492b5eed456a9f9a689886f
        imagePullPolicy: Always
        command: ["/app/thumb-worker"]
        env:
        # Database - use nova_media database
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: media-db-url
        - name: CONTENT_DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: nova-db-credentials
              key: media-db-url
        # GCS configuration
        - name: GCS_BUCKET
          value: "nova-media-staging"
        - name: GCS_SERVICE_ACCOUNT_JSON_PATH
          value: "/var/secrets/gcs/service-account.json"
        # Kafka configuration (use FQDN for cross-namespace)
        - name: KAFKA_BROKERS
          value: "kafka.nova-staging.svc.cluster.local:9092"
        - name: KAFKA_TOPIC
          value: "nova.media.events"
        - name: KAFKA_GROUP_ID
          value: "thumbnail-worker"
        # Thumbnail configuration
        - name: THUMB_MAX_DIMENSION
          value: "600"
        - name: THUMB_QUALITY
          value: "85"
        - name: BATCH_INTERVAL_SECS
          value: "300"
        # Logging
        - name: RUST_LOG
          value: "info,thumb_worker=debug,media_service=debug"
        resources:
          requests:
            cpu: "50m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
        volumeMounts:
        - name: gcs-sa
          mountPath: /var/secrets/gcs
          readOnly: true
        - name: tmp
          mountPath: /tmp
      volumes:
      - name: gcs-sa
        secret:
          secretName: media-service-sa
      - name: tmp
        emptyDir: {}
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 50
            preference:
              matchExpressions:
              - key: tier
                operator: In
                values:
                - backend
