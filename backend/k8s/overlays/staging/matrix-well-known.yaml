# Matrix Well-Known Configuration for Client Auto-Discovery
# This allows Matrix clients (including iOS app) to automatically discover
# the homeserver configuration for staging.nova.app
#
# Clients will fetch these from:
#   https://staging.nova.app/.well-known/matrix/client
#   https://staging.nova.app/.well-known/matrix/server

---
# ConfigMap containing Matrix well-known JSON files
apiVersion: v1
kind: ConfigMap
metadata:
  name: matrix-well-known
  namespace: nova-backend
  labels:
    app: matrix-synapse
    environment: staging
data:
  # Client discovery configuration
  # Tells clients where to find the homeserver and identity server
  client: |
    {
      "m.homeserver": {
        "base_url": "https://matrix.staging.nova.app"
      },
      "m.identity_server": {
        "base_url": "https://matrix.staging.nova.app"
      },
      "org.matrix.msc3575.proxy": {
        "url": "https://matrix.staging.nova.app"
      }
    }

  # Server discovery configuration
  # Used for federation (though we have federation disabled)
  server: |
    {
      "m.server": "matrix.staging.nova.app:443"
    }

---
# Deployment for serving well-known files
# This is a lightweight nginx server that serves the static JSON files
apiVersion: apps/v1
kind: Deployment
metadata:
  name: matrix-well-known
  namespace: nova-backend
  labels:
    app: matrix-well-known
    environment: staging
spec:
  replicas: 1
  selector:
    matchLabels:
      app: matrix-well-known
  template:
    metadata:
      labels:
        app: matrix-well-known
    spec:
      containers:
        - name: nginx
          image: nginx:1.25-alpine
          ports:
            - name: http
              containerPort: 80
              protocol: TCP
          volumeMounts:
            - name: well-known-config
              mountPath: /etc/nginx/conf.d/default.conf
              subPath: nginx.conf
              readOnly: true
            - name: well-known-files
              mountPath: /usr/share/nginx/html/.well-known/matrix
              readOnly: true
          resources:
            requests:
              memory: "16Mi"
              cpu: "10m"
            limits:
              memory: "64Mi"
              cpu: "50m"
          livenessProbe:
            httpGet:
              path: /.well-known/matrix/client
              port: 80
            initialDelaySeconds: 5
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /.well-known/matrix/client
              port: 80
            initialDelaySeconds: 2
            periodSeconds: 5
      volumes:
        - name: well-known-files
          configMap:
            name: matrix-well-known
        - name: well-known-config
          configMap:
            name: matrix-well-known-nginx

---
# Nginx configuration for serving well-known files
apiVersion: v1
kind: ConfigMap
metadata:
  name: matrix-well-known-nginx
  namespace: nova-backend
  labels:
    app: matrix-well-known
data:
  nginx.conf: |
    server {
        listen 80;
        server_name _;

        root /usr/share/nginx/html;

        # CORS headers for Matrix client discovery
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization";
        add_header Content-Type application/json;

        # Serve well-known files
        location /.well-known/matrix/client {
            default_type application/json;
            alias /usr/share/nginx/html/.well-known/matrix/client;
        }

        location /.well-known/matrix/server {
            default_type application/json;
            alias /usr/share/nginx/html/.well-known/matrix/server;
        }

        # Health check
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }

---
# Service for well-known server
apiVersion: v1
kind: Service
metadata:
  name: matrix-well-known
  namespace: nova-backend
  labels:
    app: matrix-well-known
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 80
      targetPort: 80
      protocol: TCP
  selector:
    app: matrix-well-known

---
# Ingress for staging.nova.app well-known endpoints (using GCE Ingress)
# This serves the well-known files from the main domain
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: matrix-well-known-ingress
  namespace: nova-backend
  annotations:
    kubernetes.io/ingress.class: gce
    networking.gke.io/managed-certificates: nova-staging-well-known-cert
spec:
  ingressClassName: gce
  rules:
    - host: staging.nova.app
      http:
        paths:
          - path: /.well-known/matrix/*
            pathType: ImplementationSpecific
            backend:
              service:
                name: matrix-well-known
                port:
                  number: 80
---
# GKE Managed Certificate for staging.nova.app well-known
apiVersion: networking.gke.io/v1
kind: ManagedCertificate
metadata:
  name: nova-staging-well-known-cert
  namespace: nova-backend
spec:
  domains:
    - staging.nova.app
