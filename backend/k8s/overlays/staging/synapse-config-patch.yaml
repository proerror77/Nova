# Staging Synapse OIDC SSO configuration (Strategic Merge Patch)
# This replaces homeserver.yaml to enable OIDC authentication via Zitadel
apiVersion: v1
kind: ConfigMap
metadata:
  name: matrix-synapse-config
  namespace: nova-backend
data:
  homeserver.yaml: |
    # Synapse homeserver configuration - STAGING with OIDC
    # Auto-generated for Nova internal messaging

    server_name: "staging.gcp.icered.com"
    pid_file: /data/homeserver.pid
    report_stats: false
    public_baseurl: "https://matrix.staging.gcp.icered.com/"

    # TURN (WebRTC) configuration
    turn_uris:
      - "turn:turn.staging.gcp.icered.com:3478?transport=udp"
      - "turn:turn.staging.gcp.icered.com:3478?transport=tcp"
      - "turn:turn.staging.gcp.icered.com:443?transport=tcp"
    turn_shared_secret_path: "/secrets/turn_shared_secret"
    turn_user_lifetime: "1h"

    # Listeners
    listeners:
      - port: 8008
        tls: false
        type: http
        x_forwarded: true
        resources:
          - names: [client, federation]
            compress: false

    # Database (PostgreSQL)
    database:
      name: psycopg2
      args:
        user: synapse
        password: "POSTGRES_PASSWORD_PLACEHOLDER"
        database: synapse
        host: postgres
        port: 5432
        cp_min: 5
        cp_max: 10

    # Logging
    log_config: "/data/log.config"

    # Media storage
    media_store_path: /data/media_store
    max_upload_size: 50M

    # Registration (disabled - use OIDC SSO)
    enable_registration: false
    enable_registration_without_verification: false
    registration_shared_secret_path: "/secrets/registration_shared_secret"

    # OIDC SSO Configuration - Zitadel integration (public client)
    oidc_providers:
      - idp_id: zitadel
        idp_name: "Nova Login"
        issuer: "https://id.staging.gcp.icered.com"
        client_id: "synapse-nova-staging"
        client_secret_path: "/secrets/oidc_client_secret"
        client_auth_method: client_secret_basic
        scopes: ["openid", "profile", "email"]
        authorization_endpoint: "https://id.staging.gcp.icered.com/oauth/v2/authorize"
        token_endpoint: "https://id.staging.gcp.icered.com/oauth/v2/token"
        userinfo_endpoint: "https://id.staging.gcp.icered.com/oidc/v1/userinfo"
        jwks_uri: "https://id.staging.gcp.icered.com/oauth/v2/keys"
        user_mapping_provider:
          config:
            localpart_template: "{{ user.preferred_username | default(user.sub) }}"
            display_name_template: "{{ user.name | default(user.preferred_username) }}"
        backchannel_logout_enabled: false

    # SSO settings
    sso:
      client_whitelist:
        - "https://matrix.staging.gcp.icered.com/"
        - "nova-staging://"
        - "icered://"

    # Session configuration for OIDC users
    session_lifetime: 90d
    refresh_token_lifetime: 90d
    refreshable_access_token_lifetime: 10m
    nonrefreshable_access_token_lifetime: 24h

    # Session timeout on inactivity
    ui_auth:
      session_timeout: "15m"

    # Federation (disabled for internal use)
    federation_domain_whitelist: []
    allow_public_rooms_over_federation: false
    allow_public_rooms_without_auth: false

    # Rate limiting (relaxed for internal service)
    rc_message:
      per_second: 100
      burst_count: 200
    rc_registration:
      per_second: 0.1
      burst_count: 3
    rc_login:
      address:
        per_second: 1
        burst_count: 10
      account:
        per_second: 1
        burst_count: 10
      failed_attempts:
        per_second: 0.5
        burst_count: 5

    # URL preview (disabled)
    url_preview_enabled: false

    # Push notifications (will integrate with nova notification-service)
    push:
      enabled: false

    # Metrics
    enable_metrics: true

    # Caching
    caches:
      global_factor: 0.5

    # Trusted key servers (none - internal only)
    trusted_key_servers: []
    suppress_key_server_warning: true

    # Report stats
    report_stats: false

    # Retention policy
    retention:
      enabled: true
      default_policy:
        min_lifetime: 1d
        max_lifetime: 365d

    # Sliding Sync (MSC3575) - DISABLED due to Synapse bug
    # The simplified_msc3575 implementation in Synapse 1.120.0 returns
    # "Internal server error" when queried. Traditional /sync works fine.
    # Disabled to force Matrix Rust SDK to use traditional sync.
    # Re-enable once Synapse fixes the issue or we upgrade.
    # See: https://github.com/matrix-org/synapse/issues (check for msc3575 bugs)
    experimental_features:
      msc3575_enabled: false

  log.config: |
    version: 1
    formatters:
      precise:
        format: '%(asctime)s - %(name)s - %(lineno)d - %(levelname)s - %(message)s'
    handlers:
      console:
        class: logging.StreamHandler
        formatter: precise
    loggers:
      synapse.storage.SQL:
        level: WARNING
    root:
      level: INFO
      handlers: [console]
    disable_existing_loggers: false
