apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../base
  - matrix-well-known.yaml
  - apple-well-known.yaml  # Passkey/WebAuthn AASA for iOS
  # Staging-specific new resources (truly new, not overrides)
  - synapse-ingress.yaml
  - zitadel-ingress.yaml
  # Identity service Zitadel sync secret (token must be set manually or via sealed-secrets)
  - identity-service-zitadel-secret.yaml

namespace: nova-backend

labels:
  - pairs:
      environment: staging

# Staging-specific configuration patches
patches:
  # Reduce replicas for all Deployments
  - target:
      kind: Deployment
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
  # Synapse config patch (replace entire ConfigMap data with OIDC config)
  - path: synapse-config-patch.yaml
  # Zitadel config patch for staging
  - path: zitadel-config-patch.yaml
  # Synapse resource limits for staging
  - target:
      kind: Deployment
      name: matrix-synapse
    path: matrix-synapse-resources-patch.yaml
  # Synapse OIDC secrets volume mount
  - target:
      kind: Deployment
      name: matrix-synapse
    path: synapse-oidc-volumes-patch.yaml
  # Zitadel resource limits for staging
  - target:
      kind: Deployment
      name: zitadel
    path: zitadel-resources-patch.yaml
  # Identity service Zitadel secret mount
  - target:
      kind: Deployment
      name: identity-service
    path: identity-service-zitadel-patch.yaml
  # Zitadel deployment strategy - use Recreate to avoid resource contention in staging
  - target:
      kind: Deployment
      name: zitadel
    patch: |-
      - op: replace
        path: /spec/strategy
        value:
          type: Recreate
  # Zitadel ConfigMap patch for cross-namespace PostgreSQL
  - target:
      kind: ConfigMap
      name: zitadel-config
    patch: |-
      - op: replace
        path: /data/ZITADEL_DATABASE_POSTGRES_HOST
        value: "postgres.nova-staging.svc.cluster.local"
  # Zitadel PVC storage class patch (use GKE default)
  - target:
      kind: PersistentVolumeClaim
      name: zitadel-data
    patch: |-
      - op: remove
        path: /spec/storageClassName
  # ConfigMap patch for staging environment
  # NOTE: APP_ENV kept as "development" to avoid TLS requirement in grpc-clients
  # TODO: Enable TLS and set APP_ENV=staging when TLS certificates are configured
  - target:
      kind: ConfigMap
      name: nova-backend-config
    patch: |-
      # - op: replace
      #   path: /data/APP_ENV
      #   value: "staging"
      - op: replace
        path: /data/LOG_LEVEL
        value: "debug"
      - op: replace
        path: /data/MATRIX_ENABLED
        value: "true"
      - op: replace
        path: /data/MATRIX_SERVICE_USER
        value: "@nova-service:staging.gcp.icered.com"
      - op: replace
        path: /data/MATRIX_DEVICE_NAME
        value: "nova-realtime-chat-service-staging"
      - op: replace
        path: /data/MATRIX_SERVER_NAME
        value: "staging.gcp.icered.com"
      - op: add
        path: /data/MATRIX_OIDC_ENABLED
        value: "true"
      - op: add
        path: /data/MATRIX_OIDC_ISSUER
        value: "https://id.staging.gcp.icered.com"
      - op: add
        path: /data/MATRIX_OIDC_CLIENT_ID
        value: "synapse-nova-staging"
      - op: add
        path: /data/ZITADEL_EXTERNAL_DOMAIN
        value: "id.staging.gcp.icered.com"
      # Enable Zitadel user sync for unified identity
      - op: replace
        path: /data/ZITADEL_SYNC_ENABLED
        value: "true"
      - op: replace
        path: /data/ZITADEL_API_URL
        value: "http://zitadel.nova-backend.svc.cluster.local:8080"

# Staging image tags - use full GAR registry path
images:
  # Backend services - remap to GAR
  - name: nova-analytics-service
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/analytics-service
    newTag: latest
  - name: nova-content-service
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/content-service
    newTag: latest
  - name: nova-feed-service
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/feed-service
    newTag: latest
  - name: nova-graph-service
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/graph-service
    newTag: latest
  - name: nova-graphql-gateway
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/graphql-gateway
    newTag: latest
  - name: nova-identity-service
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/identity-service
    newTag: latest
  - name: nova-media-service
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/media-service
    newTag: latest
  - name: nova-notification-service
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/notification-service
    newTag: latest
  - name: nova-ranking-service
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/ranking-service
    newTag: latest
  - name: nova-realtime-chat-service
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/realtime-chat-service
    newTag: latest
  - name: nova-search-service
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/search-service
    newTag: latest
  - name: nova-social-service
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/social-service
    newTag: latest
  - name: nova-trust-safety-service
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/trust-safety-service
    newTag: latest
  - name: nova-streaming-service
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/streaming-service
    newTag: latest
  # Thumb worker uses the same image as media-service
  - name: nova-thumb-worker
    newName: asia-northeast1-docker.pkg.dev/banded-pad-479802-k9/nova/media-service
    newTag: latest
  # Third-party services
  - name: matrixdotorg/synapse
    newTag: v1.120.0
  - name: ghcr.io/zitadel/zitadel
    newTag: v2.62.1
