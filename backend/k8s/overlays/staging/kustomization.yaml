apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../base
  - matrix-well-known.yaml
  # Staging-specific new resources (truly new, not overrides)
  - synapse-ingress.yaml
  - zitadel-ingress.yaml

namespace: nova-backend

labels:
  - pairs:
      environment: staging

# Staging-specific configuration patches
patches:
  # Reduce replicas for all Deployments
  - target:
      kind: Deployment
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
  # Synapse config patch (replace entire ConfigMap data with OIDC config)
  - path: synapse-config-patch.yaml
  # Zitadel config patch for staging
  - path: zitadel-config-patch.yaml
  # Synapse resource limits for staging
  - target:
      kind: Deployment
      name: matrix-synapse
    path: matrix-synapse-resources-patch.yaml
  # Synapse OIDC secrets volume mount
  - target:
      kind: Deployment
      name: matrix-synapse
    path: synapse-oidc-volumes-patch.yaml
  # Zitadel resource limits for staging
  - target:
      kind: Deployment
      name: zitadel
    path: zitadel-resources-patch.yaml
  # Zitadel ConfigMap patch for cross-namespace PostgreSQL
  - target:
      kind: ConfigMap
      name: zitadel-config
    patch: |-
      - op: replace
        path: /data/ZITADEL_DATABASE_POSTGRES_HOST
        value: "postgres.nova-staging.svc.cluster.local"
  # Zitadel PVC storage class patch (use GKE default)
  - target:
      kind: PersistentVolumeClaim
      name: zitadel-data
    patch: |-
      - op: remove
        path: /spec/storageClassName
  # ConfigMap patch for staging environment
  - target:
      kind: ConfigMap
      name: nova-backend-config
    patch: |-
      - op: replace
        path: /data/APP_ENV
        value: "staging"
      - op: replace
        path: /data/LOG_LEVEL
        value: "debug"
      - op: replace
        path: /data/MATRIX_ENABLED
        value: "true"
      - op: replace
        path: /data/MATRIX_SERVICE_USER
        value: "@nova-service:staging.nova.app"
      - op: replace
        path: /data/MATRIX_DEVICE_NAME
        value: "nova-realtime-chat-service-staging"
      - op: replace
        path: /data/MATRIX_SERVER_NAME
        value: "staging.nova.app"
      - op: add
        path: /data/MATRIX_OIDC_ENABLED
        value: "true"
      - op: add
        path: /data/MATRIX_OIDC_ISSUER
        value: "https://id.staging.nova.app"
      - op: add
        path: /data/MATRIX_OIDC_CLIENT_ID
        value: "synapse-nova-staging"
      - op: add
        path: /data/ZITADEL_EXTERNAL_DOMAIN
        value: "id.staging.nova.app"

# Staging image tags
images:
  - name: nova-realtime-chat-service
    newTag: staging
  - name: matrixdotorg/synapse
    newTag: v1.98.0
  - name: ghcr.io/zitadel/zitadel
    newTag: v2.62.1
