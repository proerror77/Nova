# Staging Synapse OIDC SSO configuration patch
# This updates homeserver.yaml to enable OIDC authentication via Zitadel

apiVersion: v1
kind: ConfigMap
metadata:
  name: matrix-synapse-config
  namespace: nova-backend
data:
  homeserver.yaml: |
    # Synapse homeserver configuration - STAGING with OIDC
    # Auto-generated for Nova internal messaging

    server_name: "staging.nova.app"
    pid_file: /data/homeserver.pid

    # Listeners
    listeners:
      - port: 8008
        tls: false
        type: http
        x_forwarded: true
        resources:
          - names: [client, federation]
            compress: false

    # Database (PostgreSQL)
    database:
      name: psycopg2
      args:
        user: synapse
        password: "POSTGRES_PASSWORD_PLACEHOLDER"
        database: synapse
        host: postgres
        port: 5432
        cp_min: 5
        cp_max: 10

    # Logging
    log_config: "/data/log.config"

    # Media storage
    media_store_path: /data/media_store
    max_upload_size: 50M

    # Registration (disabled - users created via OIDC)
    enable_registration: false
    enable_registration_without_verification: false
    registration_shared_secret_path: "/secrets/registration_shared_secret"

    # OIDC SSO Configuration - Nova via Zitadel
    oidc_providers:
      - idp_id: nova
        idp_name: "Nova"
        idp_brand: "org.nova"
        issuer: "https://id.staging.nova.app/"
        client_id: "synapse-nova-staging"
        client_secret_path: "/secrets/oidc_client_secret"
        scopes:
          - "openid"
          - "profile"
          - "email"
        authorization_endpoint: "https://id.staging.nova.app/oauth/v2/authorize"
        token_endpoint: "https://id.staging.nova.app/oauth/v2/token"
        userinfo_endpoint: "https://id.staging.nova.app/oidc/v1/userinfo"
        jwks_uri: "https://id.staging.nova.app/oauth/v2/keys"
        skip_verification: false
        enable_registration: true
        user_mapping_provider:
          config:
            subject_claim: "sub"
            # Creates mxid: @nova-<uuid>:staging.nova.app
            localpart_template: "nova-{{ user.sub }}"
            display_name_template: "{{ user.preferred_username | default(user.name) | default(user.email) }}"
            email_template: "{{ user.email }}"
        # Backchannel logout support for OIDC session management
        backchannel_logout_enabled: true
        # Backchannel logout URI - Synapse will register this with Zitadel
        backchannel_logout_uri: "https://matrix.staging.nova.app/_synapse/client/oidc/backchannel_logout"
        # Optional: Attribute requirements for grayscale testing / user whitelist
        # Uncomment to enable user filtering based on OIDC claims
        # attribute_requirements:
        #   - attribute: "email_verified"
        #     value: "true"
        #   - attribute: "groups"
        #     value: "nova-beta-testers"

    # SSO settings
    sso:
      client_whitelist:
        - "https://matrix.staging.nova.app/"
        - "nova-staging://"

    # Session configuration for OIDC users
    session_lifetime: 7d  # Sessions last 7 days by default
    refresh_token_lifetime: 90d  # Refresh tokens valid for 90 days
    refreshable_access_token_lifetime: 10m  # Access tokens refresh every 10 minutes
    nonrefreshable_access_token_lifetime: 24h  # Non-refreshable tokens last 24 hours

    # Session timeout on inactivity
    ui_auth:
      session_timeout: "15m"  # UI auth sessions timeout after 15 minutes

    # Federation (disabled for internal use)
    federation_domain_whitelist: []
    allow_public_rooms_over_federation: false
    allow_public_rooms_without_auth: false

    # Rate limiting (relaxed for internal service)
    rc_message:
      per_second: 100
      burst_count: 200
    rc_registration:
      per_second: 0.1
      burst_count: 3
    rc_login:
      address:
        per_second: 1
        burst_count: 10
      account:
        per_second: 1
        burst_count: 10
      failed_attempts:
        per_second: 0.5
        burst_count: 5

    # URL preview (disabled)
    url_preview_enabled: false

    # Push notifications (will integrate with nova notification-service)
    push:
      enabled: false

    # Metrics
    enable_metrics: true

    # Caching
    caches:
      global_factor: 0.5

    # Trusted key servers (none - internal only)
    trusted_key_servers: []
    suppress_key_server_warning: true

    # Report stats
    report_stats: false

    # Retention policy
    retention:
      enabled: true
      default_policy:
        min_lifetime: 1d
        max_lifetime: 365d

  log.config: |
    version: 1
    formatters:
      precise:
        format: '%(asctime)s - %(name)s - %(lineno)d - %(levelname)s - %(message)s'
    handlers:
      console:
        class: logging.StreamHandler
        formatter: precise
    loggers:
      synapse.storage.SQL:
        level: WARNING
    root:
      level: INFO
      handlers: [console]
    disable_existing_loggers: false

---
# Deployment patch to mount OIDC secrets
apiVersion: apps/v1
kind: Deployment
metadata:
  name: matrix-synapse
  namespace: nova-backend
spec:
  template:
    spec:
      containers:
        - name: synapse
          volumeMounts:
            - name: synapse-data
              mountPath: /data
            - name: synapse-config
              mountPath: /config
              readOnly: true
            - name: oidc-secrets
              mountPath: /secrets
              readOnly: true
      volumes:
        - name: synapse-data
          persistentVolumeClaim:
            claimName: matrix-synapse-data
        - name: synapse-config
          configMap:
            name: matrix-synapse-config
        - name: oidc-secrets
          secret:
            secretName: synapse-oidc-secrets

---
# Staging ingress for Matrix Synapse (with SSO support)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: matrix-synapse-ingress
  namespace: nova-backend
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-staging
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    # Required for proper SSO redirect handling
    nginx.ingress.kubernetes.io/configuration-snippet: |
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $host;
spec:
  tls:
    - hosts:
        - matrix.staging.nova.app
      secretName: matrix-synapse-tls-staging
  rules:
    - host: matrix.staging.nova.app
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: matrix-synapse
                port:
                  number: 8008
