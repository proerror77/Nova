# Nginx HLS Origin Server Configuration
# Serves HLS segments (.m3u8 playlists and .ts segments) to viewers
# CDN (CloudFront) pulls from this origin server

server {
    listen 80;
    server_name _;

    # Root directory (contains /hls/{stream_id}/ subdirectories)
    root /usr/share/nginx/html;

    # Disable access logging for HLS segments (high volume)
    access_log off;

    # Error log
    error_log /var/log/nginx/error.log warn;

    # =========================================================================
    # HLS Manifest and Segments
    # =========================================================================
    location /hls/ {
        # MIME types
        types {
            application/vnd.apple.mpegurl m3u8;
            video/mp2t ts;
        }

        # CORS headers (allow cross-origin playback)
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Range' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;

        # Cache-Control headers
        # Playlists (.m3u8): 1 second (must be ≤ segment duration)
        # Segments (.ts): 1 hour (immutable once created)
        location ~ \.m3u8$ {
            add_header Cache-Control "max-age=1, must-revalidate" always;
            add_header 'Access-Control-Allow-Origin' '*' always;
        }

        location ~ \.ts$ {
            add_header Cache-Control "max-age=3600, public, immutable" always;
            add_header 'Access-Control-Allow-Origin' '*' always;
        }

        # Handle OPTIONS (CORS preflight)
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS' always;
            add_header 'Access-Control-Max-Age' 86400;
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            add_header 'Content-Length' 0;
            return 204;
        }

        # Disable directory listing
        autoindex off;

        # Enable sendfile (efficient file serving)
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;

        # Buffer settings
        output_buffers 1 512k;
        postpone_output 1460;
    }

    # =========================================================================
    # Health Check Endpoint
    # =========================================================================
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    # =========================================================================
    # Deny access to hidden files
    # =========================================================================
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# =============================================================================
# Performance Tuning
# =============================================================================
# worker_processes auto;           # Use all CPU cores
# worker_connections 10000;         # Max concurrent connections per worker
# keepalive_timeout 65;             # Keep connections alive for 65 seconds
# client_max_body_size 0;           # No upload limit (GET-only server)

# =============================================================================
# Expected Directory Structure
# =============================================================================
# /usr/share/nginx/html/hls/
#   ├── {stream_id_1}/
#   │   ├── index.m3u8          # Master playlist
#   │   ├── seg-123456789-0.ts  # Segment 0
#   │   ├── seg-123456789-1.ts  # Segment 1
#   │   └── ...
#   ├── {stream_id_2}/
#   │   └── ...
#   └── ...

# =============================================================================
# CDN Configuration (CloudFront)
# =============================================================================
# Origin Domain: hls-origin.nova.com
# Origin Path: /hls
# Origin Protocol: HTTP (not HTTPS, internal network)
# Cache Behavior:
#   - Path Pattern: *.m3u8
#     - Min TTL: 0
#     - Default TTL: 1
#     - Max TTL: 1
#   - Path Pattern: *.ts
#     - Min TTL: 3600
#     - Default TTL: 3600
#     - Max TTL: 86400
# Origin Shield: Enabled (us-east-1)

# =============================================================================
# Example HLS URL
# =============================================================================
# Direct origin URL:
#   http://localhost:8089/hls/{stream_id}/index.m3u8
#
# CDN URL (production):
#   https://d1234567890.cloudfront.net/hls/{stream_id}/index.m3u8
#
# HTML5 Video Player:
#   <video controls>
#     <source src="https://cdn.nova.com/hls/{stream_id}/index.m3u8" type="application/vnd.apple.mpegurl">
#   </video>
