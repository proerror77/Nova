# Nova Backend - ä¾èµ–å…³ç³»ä¸å…³é”®è·¯å¾„åˆ†æ

## æœåŠ¡ä¾èµ–çŸ©é˜µ

```
               auth  user  content  feed  search  msg  notif  events  cdn  stream  media
auth           -     âœ…     -       -      -      -     -      -      -     -       -
user           âœ…    -      âœ…      âœ…     -      âœ…    -      âœ…     -     -       -
content        âœ…    âœ…     -       âœ…     âœ…     âœ…    -      âœ…     -     -       âœ…
feed           âœ…    âœ…     âœ…      -      âœ…     -     -      âœ…     -     -       -
search         -     âœ…     âœ…      âœ…     -      -     -      âœ…     -     -       -
messaging      âœ…    âœ…     -       -      -      -     âœ…     âœ…     -     -       -
notification   âœ…    âœ…     âœ…      -      -      âœ…    -      âœ…     -     -       -
events         âœ…    âœ…     âœ…      âœ…     âœ…     âœ…    âœ…      -      âœ…    âœ…      âœ…
cdn            -     -      âœ…      âœ…     -      -     -      -      -     -       âœ…
streaming      âœ…    âœ…     -       -      -      âœ…    âœ…     âœ…     -     -       -
media          âœ…    -      âœ…      -      -      -     -      âœ…     âœ…    -       -
```

## å…³é”®ä¾èµ–è·¯å¾„ï¼ˆä»æœ€ä½å±‚åˆ°æœ€é«˜å±‚ï¼‰

### ç¬¬ 0 å±‚ï¼šåŸºç¡€è®¾æ–½ï¼ˆæ— ä¾èµ–ï¼‰
```
PostgreSQL (66 migrations âœ…)
Redis 7.0 âœ…
Kafka 3.0 âœ…
```

### ç¬¬ 1 å±‚ï¼šæ— çŠ¶æ€è®¤è¯ï¼ˆåªä¾èµ–åŸºç¡€è®¾æ–½ï¼‰
```
auth-service (95% âœ…)
  â””â”€ ä¾èµ–: PostgreSQL, Redis, JWT crypto-core
  â””â”€ æä¾›: èº«ä»½éªŒè¯
  â””â”€ è¢«ä¾èµ–äº: æ‰€æœ‰å…¶ä»–æœåŠ¡
```

### ç¬¬ 2 å±‚ï¼šæ•°æ®æ‰€æœ‰æƒï¼ˆä¾èµ– authï¼‰
```
user-service (85% âœ…)
  â”œâ”€ ä¾èµ–: auth, PostgreSQL, Redis, CDC
  â”œâ”€ æä¾›: ç”¨æˆ·èµ„æ–™ã€ç¤¾äº¤å›¾è°±
  â””â”€ è¢«ä¾èµ–äº: content, feed, messaging, notification, streaming

content-service (75% â³)
  â”œâ”€ ä¾èµ–: auth, user, PostgreSQL, media-service
  â”œâ”€ æä¾›: å†…å®¹ CRUDã€å‚ä¸åº¦
  â””â”€ è¢«ä¾èµ–äº: feed, search, notification

messaging-service (100% âœ…)
  â”œâ”€ ä¾èµ–: auth, user, PostgreSQL, Redis, WebSocket
  â”œâ”€ æä¾›: æ¶ˆæ¯ã€å¯¹è¯ã€åŠ å¯†
  â””â”€ è¢«ä¾èµ–äº: notification, streaming, events
```

### ç¬¬ 3 å±‚ï¼šäº‹ä»¶é©±åŠ¨åŸºç¡€è®¾æ–½ï¼ˆä¾èµ–ç¬¬ 2 å±‚ï¼‰
```
events-service (10% âŒ å…³é”®é˜»å¡ç‚¹)
  â”œâ”€ ä¾èµ–: PostgreSQL (Outbox), Kafka, Schema Registry
  â”œâ”€ æä¾›: äº‹ä»¶å‘å¸ƒ/è®¢é˜…ã€CDC å¯é æ€§ä¿è¯
  â””â”€ è¢«ä¾èµ–äº: æ‰€æœ‰å…¶ä»–ä¸šåŠ¡æœåŠ¡ï¼ˆcontent, feed, notification, streaming, cdnï¼‰
  
  âš ï¸ è¿™æ˜¯æœ€å…³é”®çš„è·¯å¾„ï¼
  å¦‚æœè¿™ä¸ªåšä¸å¥½ï¼Œåç»­æ‰€æœ‰æœåŠ¡éƒ½ä¼šæœ‰æ•°æ®ä¸€è‡´æ€§é—®é¢˜
```

### ç¬¬ 4 å±‚ï¼šæœç´¢ä¸æ¨èï¼ˆä¾èµ–ç¬¬ 2-3 å±‚ï¼‰
```
search-service (5% âŒ)
  â”œâ”€ ä¾èµ–: PostgreSQL FTS, Redis, content-service
  â”œâ”€ æä¾›: å…¨æ–‡æœç´¢ã€å»ºè®®
  â””â”€ è¢«ä¾èµ–äº: feed-service

feed-service (70% â³)
  â”œâ”€ ä¾èµ–: user, content, search, events, PostgreSQL, Redis
  â”œâ”€ å¾…å®Œæˆ: Milvus, ONNX, Kafka consumer
  â”œâ”€ æä¾›: ä¸ªæ€§åŒ–æ¨è
  â””â”€ è¢«ä¾èµ–äº: å‰ç«¯ feed API
```

### ç¬¬ 5 å±‚ï¼šé€šçŸ¥ä¸é…é€ï¼ˆä¾èµ–ç¬¬ 3 å±‚ï¼‰
```
notification-service (15% âŒ)
  â”œâ”€ ä¾èµ–: events, PostgreSQL, Redis, APNs/FCM
  â”œâ”€ æä¾›: ç”¨æˆ·é€šçŸ¥
  â””â”€ è¢«ä¾èµ–äº: æ‰€æœ‰ç”¨æˆ·å¯¹é¢çš„æœåŠ¡

cdn-service (10% âŒ)
  â”œâ”€ ä¾èµ–: PostgreSQL, Redis, CloudFront/S3, media-service
  â”œâ”€ æä¾›: CDN URL ç”Ÿæˆã€ç¼“å­˜ç®¡ç†
  â””â”€ è¢«ä¾èµ–äº: content-service, media-service

streaming-service (65% â³)
  â”œâ”€ ä¾èµ–: events, notification, Redis, messaging
  â”œâ”€ æä¾›: ç›´æ’­åŠŸèƒ½
  â””â”€ è¢«ä¾èµ–äº: å‰ç«¯ç›´æ’­åŠŸèƒ½
```

---

## å…³é”®è·¯å¾„åˆ†æï¼ˆç”¨äºæ—¶é—´è§„åˆ’ï¼‰

### æœ€é•¿çš„ä¾èµ–é“¾ï¼ˆå†³å®šæ€»æ—¶é—´ï¼‰
```
1. PostgreSQL Schema (å®Œæˆ)
   â†“
2. auth-service (95% âœ…) [5h å‰©ä½™]
   â†“
3. user-service (85% âœ…) [10h å‰©ä½™]
   â†“
4. content-service (75% â³) [30h å‰©ä½™]
   â†“
5. events-service (10% âŒ) [110h] âš ï¸ å…³é”®é˜»å¡
   â†“
6. search-service (5% âŒ) [70h]
   â†“
7. feed-service (70% â³) [100h]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€» å…³é”®è·¯å¾„: 325 å°æ—¶ (æœ€åæƒ…å†µ)
```

### å¯å¹¶è¡Œçš„ä»»åŠ¡
```
æœç´¢ & æ¨èè½¨é“               äº‹ä»¶é©±åŠ¨è½¨é“              åª’ä½“è½¨é“
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”€â”€â”€â”€â”€â”€â”€â”€
content-service â”€â”€â”          events-service â”€â”€â”       media-svc
(30h å‰©ä½™)        â”‚          (110h)           â”‚       (5h å‰©ä½™)
                  â”œâ”€â†’ search-service (70h)    â”‚
                  â”‚                           â”œâ”€â†’ cdn-service (50h)
feed-service â—„â”€â”€â”€â”€â”¤                           â”‚
(100h)            â”‚   notification-svc â—„â”€â”€â”€â”€â”€â”€â”¤
                  â”‚   (80h)
                  â”‚
                  â””â”€â†’ streaming-svc â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      (65h)
```

---

## é˜»å¡ç‚¹è¯†åˆ«

### ğŸ”´ å…³é”®é˜»å¡ç‚¹ï¼ˆä¸èƒ½è·³è¿‡ï¼‰

#### 1. events-service æ¶æ„å†³ç­– (0-5 å¤©)
- **é—®é¢˜**: æ˜¯å¦ä½¿ç”¨ Outbox æ¨¡å¼ï¼Ÿ
- **å½±å“**: å†³å®šäº†æ‰€æœ‰æœåŠ¡çš„äº‹ä»¶å¯é æ€§
- **é£é™©**: å¦‚æœè¿™é‡Œè®¾è®¡ä¸å¯¹ï¼Œåç»­è¦é‡åš
- **å»ºè®®**: å¿…é¡»åœ¨ Phase 1 å®Œæˆï¼Œä¸èƒ½å»¶å

#### 2. é€šçŸ¥ç³»ç»Ÿæ•°æ®æ¨¡å‹ (5-10 å¤©)
- **é—®é¢˜**: notifications è¡¨ç»“æ„è®¾è®¡
  ```sql
  æ˜¯ç”¨å•ä¸€çµæ´»çš„ JSONB å­—æ®µï¼Ÿ
  è¿˜æ˜¯ä¸ºæ¯ç§ç±»å‹åˆ†å¼€è¡¨ï¼Ÿ
  ```
- **å½±å“**: å†³å®šäº†æŸ¥è¯¢æ€§èƒ½å’Œæ‰©å±•æ€§
- **å»ºè®®**: é‡‡ç”¨ç»Ÿä¸€çš„ metadata JSON + ç´¢å¼•æ–¹æ¡ˆ

#### 3. æœç´¢ç´¢å¼•ç­–ç•¥ (3-5 å¤©)
- **é—®é¢˜**: PostgreSQL FTS vs Elasticsearch vs Milvus
- **å½±å“**: Feed æ¨èæ’åºçš„å“åº”æ—¶é—´
- **å»ºè®®**: Phase 1 ç”¨ PostgreSQL FTSï¼ŒPhase 2 è€ƒè™‘ Elasticsearch

### ğŸŸ¡ ä¸­ç­‰é£é™©ç‚¹

| é£é™© | å½±å“ | ç¼“è§£ | æ—¶é—´ |
|------|------|------|------|
| Kafka partition rebalance | æ¶ˆæ¯å»¶è¿Ÿå°–å³° | æ¶ˆè´¹è€…ç¾¤ç»„é…ç½® | 2-3h |
| Redis ç¼“å­˜ä¸€è‡´æ€§ | Feed æ’åºé”™è¯¯ | ç¼“å­˜å¤±æ•ˆç­–ç•¥ | 3-5h |
| ONNX æ¨¡å‹æ€§èƒ½ | Feed P95 > 800ms | æ¨¡å‹é‡åŒ– + ç¼“å­˜ | 10-15h |
| gRPC è¿æ¥æ³„æ¼ | å†…å­˜æº¢å‡º | keepalive + timeout | 2-3h |

---

## å®ç°ç­–ç•¥ï¼šå…³é”®è·¯å¾„æ³• (Critical Path Method)

### æ¨èæ‰§è¡Œè®¡åˆ’ï¼ˆæœ€ä¼˜åŒ–ï¼‰

#### Week 1 (Day 1-5): æ¶æ„åŸºç¡€ [40h]
**å¹¶è¡Œè½¨é“ A**: åŸºç¡€è®¾æ–½
- [ ] PostgreSQL Outbox è¿ç§» (5h)
- [ ] Kafka Topic é…ç½®éªŒè¯ (3h)
- [ ] é”™è¯¯å¤„ç†ç»Ÿä¸€ (8h)
- [ ] gRPC æŒ‡æ ‡é›†æˆéªŒè¯ (5h)

**å¹¶è¡Œè½¨é“ B**: å®Œå–„å·²æœ‰æœåŠ¡
- [ ] auth-service å®Œæˆæœ€å 5% (5h)
- [ ] user-service ç¤¾äº¤å›¾è°±æŸ¥è¯¢ä¼˜åŒ– (10h)

#### Week 2 (Day 6-10): äº‹ä»¶ç³»ç»Ÿ [80h]
**å…³é”®è·¯å¾„**: events-service å¿…é¡»å®Œæˆ
- [ ] PublishEvent / PublishEvents (35h)
- [ ] Event Schema ç®¡ç† (20h)
- [ ] CDC Consumer é›†æˆ (15h)
- [ ] é›†æˆæµ‹è¯• (10h)

**å¹¶è¡Œ**: content-service å®Œå–„
- [ ] è¯„è®ºç³»ç»Ÿå®Œæ•´æ€§ (15h)
- [ ] è§†é¢‘å…³è”è¿ç§» (15h)

#### Week 3 (Day 11-15): æ¶ˆè´¹è€… [80h]
**å…³é”®è·¯å¾„**: é€šçŸ¥ç³»ç»Ÿ
- [ ] notification-service PostgreSQL è¡¨ (10h)
- [ ] CRUD å®ç° (25h)
- [ ] Kafka æ¶ˆè´¹ (20h)
- [ ] APNs é›†æˆ (15h)
- [ ] æµ‹è¯• (10h)

**å¹¶è¡Œ**: æœç´¢åŸºç¡€
- [ ] PostgreSQL FTS ç´¢å¼• (15h)
- [ ] FullTextSearch å®ç° (20h)

#### Week 4 (Day 16-20): Feed æ¨è [100h]
**å…³é”®è·¯å¾„**: feed-service å®Œæ•´
- [ ] search-service å®Œæˆ (30h: SearchUsers, SearchPosts, å»ºè®®)
- [ ] feed-service Kafka æ¶ˆè´¹ (25h)
- [ ] æ··åˆæ’åºç®—æ³• (30h)
- [ ] ç¼“å­˜ç­–ç•¥ (15h)

#### Week 5+ (Day 21+): ä¼˜åŒ–ä¸å®Œå–„
- [ ] ONNX æ¨¡å‹é›†æˆ (30h)
- [ ] streaming-service å®Œæˆ (65h)
- [ ] cdn-service å®Œæˆ (50h)
- [ ] æ€§èƒ½æµ‹è¯•ä¸ä¼˜åŒ– (40h)

---

## ä¾èµ–å£°æ˜ç¤ºä¾‹

æ¯ä¸ªæœåŠ¡åº”è¯¥åœ¨å…¶ README ä¸­æ¸…æ¥šåœ°å£°æ˜ï¼š

### messaging-service ç¤ºä¾‹
```
# ä¾èµ–å…³ç³»

## å¿…éœ€ä¾èµ– (ä¸¥æ ¼)
- auth-service (ç”¨æˆ·éªŒè¯) - gRPC:9080
- PostgreSQL 14+ (æ¶ˆæ¯å­˜å‚¨) - è¿ç§» 001-020
- Redis 7+ (WebSocket è¿æ¥ç®¡ç†)
- Kafka 3.0 (äº‹ä»¶å‘å¸ƒ) - Topic: nova.messaging.events

## å¯é€‰ä¾èµ– (ä¼˜é›…é™çº§)
- APNs SDK (iOS æ¨é€) - æ— åˆ™ç¦ç”¨æ¨é€
- Encryption keys (E2E) - æ— åˆ™ç¦ç”¨åŠ å¯†

## ä¾èµ–çš„ä¸Šæ¸¸äº‹ä»¶
- events:user.registered (æ–°ç”¨æˆ·)
- events:user.deleted (æ¸…ç†å¯¹è¯)

## äº§ç”Ÿçš„ä¸‹æ¸¸äº‹ä»¶
- events:message.sent (æ¶ˆæ¯å‘é€)
- events:message.deleted (æ¶ˆæ¯åˆ é™¤)
- notifications.required (æ¨é€è§¦å‘)
```

---

## é£é™©çŸ©é˜µ

```
é£é™©               æ¦‚ç‡  å½±å“  æ€»åˆ†  ç¼“è§£æ–¹æ¡ˆ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
events-svc è®¾è®¡ç¼ºé™·  30%  10   300  Week 1 å®Œæˆ
Kafka æ¶ˆæ¯ä¸¢å¤±       10%  9    90   Outbox æ¨¡å¼
ç¼“å­˜ä¸€è‡´æ€§           40%  8    320  ç¼“å­˜å¤±æ•ˆç­–ç•¥
ONNX æ¨¡å‹æ…¢          50%  6    300  é‡åŒ– + ç¼“å­˜
è·¨æœåŠ¡æ•°æ®ä¸ä¸€è‡´     20%  9    180  CDC + éªŒè¯
Redis è¿æ¥æ³„æ¼       15%  7    105  keepalive é…ç½®
```

**æœ€é«˜é£é™©**: events-service è®¾è®¡ + è·¨æœåŠ¡ä¸€è‡´æ€§
**å»ºè®®**: åœ¨ Week 1 ä¸­èŠ±é¢å¤– 20h è¿›è¡Œæ¶æ„è¯„å®¡å’Œè®¾è®¡éªŒè¯

---

## æˆåŠŸæŒ‡æ ‡ (æ¯å‘¨æ£€æŸ¥)

| Week | æœåŠ¡ | ç›®æ ‡ | æ£€æŸ¥ç‚¹ |
|------|------|------|--------|
| 1 | auth, user | åŸºç¡€å®Œæ•´ | auth: 100%, user: 100% |
| 2 | events | äº‹ä»¶å¯é  | Outbox: âœ…, Kafka: âœ…, æµ‹è¯•: > 10 |
| 3 | notif, search | æ¶ˆè´¹å°±ç»ª | notif: 80%, search: 70% |
| 4 | feed | æ¨èåŠŸèƒ½ | feed: 90%, P95 < 800ms |
| 5+ | stream, cdn | å®Œå–„æœåŠ¡ | æ€§èƒ½åŸºå‡†è¾¾æˆ |

---

**ç‰ˆæœ¬**: 1.0
**æ–¹æ³•è®º**: å…³é”®è·¯å¾„æ³• (Critical Path Method)
**çŠ¶æ€**: å‡†å¤‡å®æ–½
