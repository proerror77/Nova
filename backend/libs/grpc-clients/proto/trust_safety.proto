syntax = "proto3";
package nova.trust_safety.v2;

// Trust & Safety Service - Centralized UGC Moderation
service TrustSafetyService {
  // Moderate content before publishing (comprehensive check)
  rpc ModerateContent(ModerateContentRequest) returns (ModerateContentResponse);

  // Quick check if content is safe (lighter weight)
  rpc CheckContent(CheckContentRequest) returns (CheckContentResponse);

  // Submit appeal for rejected content
  rpc SubmitAppeal(SubmitAppealRequest) returns (SubmitAppealResponse);

  // Review appeal (admin only)
  rpc ReviewAppeal(ReviewAppealRequest) returns (ReviewAppealResponse);

  // Get moderation history for content/user
  rpc GetModerationHistory(GetModerationHistoryRequest) returns (GetModerationHistoryResponse);

  // P0: User Reports (from user-service migration)
  rpc SubmitReport(SubmitReportRequest) returns (SubmitReportResponse);
  rpc GetUserReports(GetUserReportsRequest) returns (GetUserReportsResponse);
  rpc ReviewReport(ReviewReportRequest) returns (ReviewReportResponse);

  // P0: User Warnings (from user-service migration)
  rpc IssueWarning(IssueWarningRequest) returns (IssueWarningResponse);
  rpc GetUserWarnings(GetUserWarningsRequest) returns (GetUserWarningsResponse);
  rpc AcknowledgeWarning(AcknowledgeWarningRequest) returns (AcknowledgeWarningResponse);

  // P0: User Bans (from user-service migration)
  rpc BanUser(BanUserRequest) returns (BanUserResponse);
  rpc LiftBan(LiftBanRequest) returns (LiftBanResponse);
  rpc CheckUserBan(CheckUserBanRequest) returns (CheckUserBanResponse);
  rpc GetUserBans(GetUserBansRequest) returns (GetUserBansResponse);
}

// ==================== Moderation Requests ====================

message ModerateContentRequest {
  string content_id = 1;          // Unique content identifier
  ContentType content_type = 2;   // Type of content
  string text = 3;                // Text content to moderate
  repeated string image_urls = 4; // Images to check for NSFW
  string user_id = 5;             // User ID for spam detection context
  ModerationContext context = 6;  // Additional context for spam detection
}

message CheckContentRequest {
  string text = 1;                // Text to check
  repeated string image_urls = 2; // Images to check
}

message GetModerationHistoryRequest {
  string user_id = 1;    // Optional: filter by user
  string content_id = 2; // Optional: filter by content
  int32 limit = 3;       // Max results (default: 50)
  int32 offset = 4;      // Pagination offset
}

// ==================== Moderation Context ====================

message ModerationContext {
  int64 seconds_since_last_post = 1; // Time since user's last post
  int32 recent_post_count = 2;       // Posts in last hour
  int64 account_age_days = 3;        // Account age in days
  bool is_verified = 4;              // Is verified user
}

// ==================== Moderation Responses ====================

message ModerateContentResponse {
  bool approved = 1;                  // Auto-approved (< threshold)
  RiskScore risk_score = 2;           // Detailed risk scores
  repeated string violations = 3;      // List of violations found
  string moderation_id = 4;           // Moderation log ID
  string rejection_reason = 5;        // Human-readable reason
}

message CheckContentResponse {
  bool is_safe = 1;                   // Quick safety check
  double overall_score = 2;           // 0.0 - 1.0 (higher = riskier)
  repeated string flags = 3;          // Quick flags (nsfw, toxic, spam)
}

message GetModerationHistoryResponse {
  repeated ModerationLog logs = 1;
  int32 total_count = 2;
}

// ==================== Risk Scores ====================

message RiskScore {
  double nsfw_score = 1;      // 0.0 - 1.0 (NSFW probability)
  double toxicity_score = 2;  // 0.0 - 1.0 (toxic text)
  double spam_score = 3;      // 0.0 - 1.0 (spam likelihood)
  double overall_score = 4;   // 0.0 - 1.0 (combined risk)

  // Detailed breakdown
  repeated string nsfw_categories = 5;  // e.g., ["nudity", "violence"]
  repeated string toxic_keywords = 6;   // Matched sensitive words
  repeated string spam_indicators = 7;  // e.g., ["repeated_content", "new_account"]
}

// ==================== Moderation Log ====================

message ModerationLog {
  string id = 1;
  string content_id = 2;
  string content_type = 3;
  string user_id = 4;
  RiskScore risk_score = 5;
  bool approved = 6;
  string rejection_reason = 7;
  string created_at = 8; // ISO 8601 timestamp
}

// ==================== Appeal System ====================

message SubmitAppealRequest {
  string moderation_id = 1; // Reference to moderation log
  string user_id = 2;       // User submitting appeal
  string reason = 3;        // Appeal reason (user-provided)
}

message SubmitAppealResponse {
  string appeal_id = 1;
  AppealStatus status = 2;
  string created_at = 3;
}

message ReviewAppealRequest {
  string appeal_id = 1;
  string admin_id = 2;
  AppealDecision decision = 3;
  string admin_note = 4; // Optional admin comment
}

message ReviewAppealResponse {
  string appeal_id = 1;
  AppealStatus status = 2;
  string reviewed_at = 3;
}

// ==================== Enums ====================

enum ContentType {
  CONTENT_TYPE_UNSPECIFIED = 0;
  POST = 1;
  COMMENT = 2;
  MESSAGE = 3;
  PROFILE_BIO = 4;
  PROFILE_NAME = 5;
}

enum AppealStatus {
  APPEAL_STATUS_UNSPECIFIED = 0;
  PENDING = 1;
  APPROVED = 2;
  REJECTED = 3;
}

enum AppealDecision {
  APPEAL_DECISION_UNSPECIFIED = 0;
  APPROVE = 1;  // Overturn moderation, approve content
  REJECT = 2;   // Uphold moderation decision
}

// ==================== P0: User Reports (from user-service) ====================

message SubmitReportRequest {
  string reporter_user_id = 1;          // User submitting the report
  string reported_user_id = 2;          // User being reported (optional)
  string reported_content_id = 3;       // Content being reported (optional)
  string reported_content_type = 4;     // 'post', 'comment', 'message', 'profile', 'user'
  ReportType report_type = 5;           // Type of report
  string description = 6;               // Optional description from reporter
}

message SubmitReportResponse {
  string report_id = 1;
  ReportStatus status = 2;
  string created_at = 3;
}

message GetUserReportsRequest {
  string user_id = 1;           // Get reports filed by this user
  ReportStatus status = 2;      // Filter by status (optional)
  int32 limit = 3;
  int32 offset = 4;
}

message GetUserReportsResponse {
  repeated UserReport reports = 1;
  int32 total_count = 2;
}

message ReviewReportRequest {
  string report_id = 1;
  string admin_id = 2;
  ReportResolution resolution = 3;
  string resolution_note = 4;
}

message ReviewReportResponse {
  string report_id = 1;
  ReportStatus status = 2;
  string reviewed_at = 3;
}

message UserReport {
  string id = 1;
  string reporter_user_id = 2;
  string reported_user_id = 3;
  string reported_content_id = 4;
  string reported_content_type = 5;
  ReportType report_type = 6;
  string description = 7;
  ReportStatus status = 8;
  string resolution = 9;
  string created_at = 10;
  string reviewed_at = 11;
}

enum ReportType {
  REPORT_TYPE_UNSPECIFIED = 0;
  SPAM = 1;
  HARASSMENT = 2;
  HATE_SPEECH = 3;
  NSFW_CONTENT = 4;
  IMPERSONATION = 5;
  VIOLENCE = 6;
  MISINFORMATION = 7;
  OTHER = 8;
}

enum ReportStatus {
  REPORT_STATUS_UNSPECIFIED = 0;
  REPORT_PENDING = 1;
  REPORT_REVIEWED = 2;
  REPORT_ACTIONED = 3;
  REPORT_DISMISSED = 4;
}

enum ReportResolution {
  RESOLUTION_UNSPECIFIED = 0;
  WARNING_ISSUED = 1;
  CONTENT_REMOVED = 2;
  USER_BANNED = 3;
  NO_ACTION = 4;
}

// ==================== P0: User Warnings (from user-service) ====================

message IssueWarningRequest {
  string user_id = 1;             // User receiving the warning
  WarningType warning_type = 2;
  WarningSeverity severity = 3;
  int32 strike_points = 4;        // Points toward ban threshold
  string reason = 5;
  string moderation_log_id = 6;   // Reference if applicable
  string report_id = 7;           // Reference if applicable
  string issued_by = 8;           // Admin user ID
  int64 expires_in_days = 9;      // 0 = permanent
}

message IssueWarningResponse {
  string warning_id = 1;
  int32 total_strike_points = 2;  // User's total active points
  bool auto_ban_triggered = 3;    // If this warning triggered an auto-ban
}

message GetUserWarningsRequest {
  string user_id = 1;
  bool active_only = 2;           // Only non-expired warnings
  int32 limit = 3;
  int32 offset = 4;
}

message GetUserWarningsResponse {
  repeated UserWarning warnings = 1;
  int32 total_strike_points = 2;
  int32 total_count = 3;
}

message AcknowledgeWarningRequest {
  string warning_id = 1;
  string user_id = 2;
}

message AcknowledgeWarningResponse {
  bool success = 1;
}

message UserWarning {
  string id = 1;
  string user_id = 2;
  WarningType warning_type = 3;
  WarningSeverity severity = 4;
  int32 strike_points = 5;
  string reason = 6;
  bool acknowledged = 7;
  string expires_at = 8;
  string created_at = 9;
}

enum WarningType {
  WARNING_TYPE_UNSPECIFIED = 0;
  CONTENT_VIOLATION = 1;
  SPAM_VIOLATION = 2;
  HARASSMENT_VIOLATION = 3;
  TOS_VIOLATION = 4;
  COMMUNITY_GUIDELINES = 5;
}

enum WarningSeverity {
  SEVERITY_UNSPECIFIED = 0;
  MILD = 1;
  MODERATE = 2;
  SEVERE = 3;
}

// ==================== P0: User Bans (from user-service) ====================

message BanUserRequest {
  string user_id = 1;
  BanType ban_type = 2;
  string reason = 3;
  string banned_by = 4;           // Admin user ID
  string warning_id = 5;          // Reference if applicable
  string report_id = 6;           // Reference if applicable
  int64 duration_hours = 7;       // 0 = permanent
}

message BanUserResponse {
  string ban_id = 1;
  string ends_at = 2;             // Empty for permanent
  bool success = 3;
}

message LiftBanRequest {
  string ban_id = 1;
  string lifted_by = 2;           // Admin user ID
  string lift_reason = 3;
}

message LiftBanResponse {
  bool success = 1;
}

message CheckUserBanRequest {
  string user_id = 1;
}

message CheckUserBanResponse {
  bool is_banned = 1;
  UserBan active_ban = 2;         // Current active ban if any
}

message GetUserBansRequest {
  string user_id = 1;
  bool active_only = 2;
  int32 limit = 3;
  int32 offset = 4;
}

message GetUserBansResponse {
  repeated UserBan bans = 1;
  int32 total_count = 2;
}

message UserBan {
  string id = 1;
  string user_id = 2;
  BanType ban_type = 3;
  string reason = 4;
  string banned_by = 5;
  string starts_at = 6;
  string ends_at = 7;             // Empty for permanent
  string lifted_at = 8;
  string lift_reason = 9;
  string created_at = 10;
}

enum BanType {
  BAN_TYPE_UNSPECIFIED = 0;
  TEMPORARY = 1;
  PERMANENT = 2;
  SHADOW = 3;  // User can post but content is hidden from others
}
