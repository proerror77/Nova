version: 0.2

# AWS CodeBuild æ„å»ºè§„èŒƒ
# æ„å»ºæ‰€æœ‰ 8 ä¸ª Nova å¾®æœåŠ¡å¹¶æ¨é€åˆ° ECR

env:
  variables:
    AWS_REGION: ap-northeast-1
    AWS_ACCOUNT_ID: "025434362120"
    ECR_REGISTRY_ALIAS: nova
    DOCKER_BUILDKIT: "1"
  parameter-store:
    DOCKER_USERNAME: /codebuild/docker/username
    DOCKER_PASSWORD: /codebuild/docker/password

phases:
  pre_build:
    commands:
      - echo "=== æ„å»ºé˜¶æ®µå¼€å§‹ $(date) ==="
      - echo "AWS è´¦æˆ·: $AWS_ACCOUNT_ID"
      - echo "AWS åŒºåŸŸ: $AWS_REGION"

      # ç™»å½•åˆ° ECR
      - echo "ğŸ” ç™»å½•åˆ° Amazon ECR..."
      - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

      # åˆ›å»º ECR ä»“åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
      - echo "ğŸ“¦ ç¡®ä¿ ECR ä»“åº“å­˜åœ¨..."
      - |
        for service in auth-service content-service feed-service media-service messaging-service search-service streaming-service; do
          aws ecr describe-repositories --repository-names "$ECR_REGISTRY_ALIAS/$service" --region $AWS_REGION 2>/dev/null || \
          aws ecr create-repository --repository-name "$ECR_REGISTRY_ALIAS/$service" --region $AWS_REGION
        done

      # è®¾ç½® Docker Buildx
      - echo "ğŸ”¨ è®¾ç½® Docker Buildx..."
      - docker buildx create --use --name multiarch-builder || docker buildx use multiarch-builder

  build:
    commands:
      - echo "ğŸš€ å¼€å§‹æ„å»ºæ‰€æœ‰æœåŠ¡..."
      - |
        SERVICES=(
          "auth-service"
          "content-service"
          "feed-service"
          "media-service"
          "messaging-service"
          "search-service"
          "streaming-service"
        )

        ECR_REGISTRY="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com"
        BUILD_FAILED=0

        for service in "${SERVICES[@]}"; do
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ æ„å»º $service..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          IMAGE_TAG="$ECR_REGISTRY/$ECR_REGISTRY_ALIAS/$service:latest"

          if docker buildx build \
            --platform linux/amd64 \
            --push \
            --progress=plain \
            -f "$service/Dockerfile" \
            -t "$IMAGE_TAG" \
            ./backend; then
            echo "âœ… $service æ„å»ºæˆåŠŸ"
          else
            echo "âŒ $service æ„å»ºå¤±è´¥"
            BUILD_FAILED=1
          fi
        done

        exit $BUILD_FAILED

  post_build:
    commands:
      - echo ""
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - echo "ğŸ“Š æ„å»ºå®Œæˆæ€»ç»“"
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - |
        echo "åˆ—å‡ºæ‰€æœ‰ ECR é•œåƒï¼š"
        aws ecr describe-images \
          --repository-name nova/auth-service \
          --region $AWS_REGION \
          --query 'imageDetails[*].[imageTag,imageSizeInBytes,imagePushedAt]' \
          --output table || echo "æŸ¥è¯¢é•œåƒåˆ—è¡¨"
      - echo "âœ¨ æ‰€æœ‰æœåŠ¡å·²æˆåŠŸæ¨é€åˆ° ECR"
      - echo "å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"

# ç¼“å­˜é…ç½®
cache:
  paths:
    - '/root/.cargo/**/*'
    - '/root/.docker/**/*'

# ä¸éœ€è¦è¾“å‡ºåˆ¶å“
artifacts:
  files:
    - buildspec.yml
  discard-paths: yes
