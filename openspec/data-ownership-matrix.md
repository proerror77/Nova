# Nova æ•¸æ“šæ‰€æœ‰æ¬ŠçŸ©é™£

**æœ€å¾Œæ›´æ–°**: 2025-11-05
**ç‹€æ…‹**: Phase 0 å®Œæˆ
**ç”¨é€”**: æ˜ç¢ºæ¯å€‹æœå‹™å°è¡¨çš„ CRUD è²¬ä»»ï¼Œæ”¯æŒæ‡‰ç”¨å±¤è§£è€¦èˆ‡æœ€çµ‚æ•¸æ“šåº«åˆ†é›¢

---

## ğŸ“‹ çŸ©é™£èªªæ˜

- **C** = Createï¼ˆå‰µå»ºï¼‰- æœå‹™å¯ä»¥æ’å…¥æ–°è¨˜éŒ„
- **R** = Readï¼ˆè®€å–ï¼‰- æœå‹™å¯ä»¥æŸ¥è©¢æ•¸æ“š
- **U** = Updateï¼ˆæ›´æ–°ï¼‰- æœå‹™å¯ä»¥ä¿®æ”¹ç¾æœ‰è¨˜éŒ„
- **D** = Deleteï¼ˆåˆªé™¤ï¼‰- æœå‹™å¯ä»¥åˆªé™¤è¨˜éŒ„

### æ‰€æœ‰æ¬Šè¦å‰‡

1. **Single-Writer åŸå‰‡**ï¼šæ¯å€‹è¡¨åªæœ‰ 1 å€‹æœå‹™å¯ä»¥ CREATE/UPDATE/DELETE
2. **å¤šè®€è€…å¯ä»¥**ï¼šå¤šå€‹æœå‹™å¯ä»¥ READ åŒä¸€å€‹è¡¨
3. **å…±äº«è¡¨ç•°å¸¸**ï¼š`users` å’Œ `user_profiles` ç”±å¤šå€‹æœå‹™å…±äº«ï¼ˆéœ€è¦é·ç§»åˆ° gRPCï¼‰

---

## ğŸ”„ å®Œæ•´æ•¸æ“šæ‰€æœ‰æ¬ŠçŸ©é™£

### ç”¨æˆ¶èˆ‡èªè­‰ï¼ˆæ‰€æœ‰è€…ï¼šAuth Serviceï¼‰

| è¡¨å | Auth | User | Content | Feed | Media | Messaging | Search | Streaming |
|------|------|------|---------|------|-------|-----------|--------|-----------|
| **users** | **CRUD** | R | R | R | R | R | R | R |
| **sessions** | **CRD** | â€” | â€” | â€” | â€” | â€” | â€” | â€” |
| **refresh_tokens** | **CRD** | â€” | â€” | â€” | â€” | â€” | â€” | â€” |
| **auth_logs** | **C** | â€” | â€” | â€” | â€” | â€” | â€” | â€” |
| **two_fa_sessions** | **CRUD** | â€” | â€” | â€” | â€” | â€” | â€” | â€” |
| **two_fa_backup_codes** | **CRUD** | â€” | â€” | â€” | â€” | â€” | â€” | â€” |
| **email_verifications** | **CRD** | â€” | â€” | â€” | â€” | â€” | â€” | â€” |
| **password_resets** | **CRD** | â€” | â€” | â€” | â€” | â€” | â€” | â€” |

**èªªæ˜**:
- Auth Service æ˜¯ç”¨æˆ¶èªè­‰çš„å–®ä¸€æ¬Šå¨æº
- å…¶ä»–æœå‹™é€šé gRPC èª¿ç”¨ `AuthService.GetUser()` å’Œ `VerifyToken()`
- Auth ç®¡ç†æœƒè©±ã€åˆ·æ–°ä»¤ç‰Œå’Œé›™å› ç´ èªè­‰

---

### ç”¨æˆ¶æª”æ¡ˆï¼ˆæ‰€æœ‰è€…ï¼šUser Serviceï¼‰

| è¡¨å | Auth | User | Content | Feed | Media | Messaging | Search | Streaming |
|------|------|------|---------|------|-------|-----------|--------|-----------|
| **user_feed_preferences** | â€” | **CRUD** | â€” | R | â€” | â€” | â€” | â€” |
| **social_metadata** | â€” | **CRUD** | R | R | â€” | â€” | â€” | â€” |

**èªªæ˜**:
- User Service ç®¡ç†ç”¨æˆ¶åå¥½å’Œç¤¾äº¤å…ƒæ•¸æ“š
- Feed Service è®€å–é€™äº›æ•¸æ“šç”¨æ–¼å€‹æ€§åŒ–æ¨è–¦

---

### ç¤¾äº¤é—œä¿‚ï¼ˆæ‰€æœ‰è€…ï¼šUser Serviceï¼‰

| è¡¨å | Auth | User | Content | Feed | Media | Messaging | Search | Streaming |
|------|------|------|---------|------|-------|-----------|--------|-----------|
| **follows** | â€” | **CRUD** | R | R | â€” | â€” | R | â€” |
| **public.social_metadata** | â€” | **CRUD** | R | R | â€” | â€” | R | â€” |

**èªªæ˜**:
- User Service ç®¡ç†é—œæ³¨é—œä¿‚
- Content/Feed/Search è®€å–é—œä¿‚ç”¨æ–¼å…§å®¹éæ¿¾å’Œæ¨è–¦

---

### å…§å®¹ç®¡ç†ï¼ˆæ‰€æœ‰è€…ï¼šContent Serviceï¼‰

| è¡¨å | Auth | User | Content | Feed | Media | Messaging | Search | Streaming |
|------|------|------|---------|------|-------|-----------|--------|-----------|
| **posts** | â€” | R | **CRUD** | R | â€” | â€” | R | â€” |
| **comments** | â€” | R | **CRUD** | R | â€” | â€” | R | â€” |
| **likes** | â€” | R | **CRUD** | R | â€” | â€” | R | â€” |
| **post_metadata** | â€” | R | **CRUD** | R | â€” | â€” | R | â€” |
| **post_images** | â€” | â€” | **CRUD** | R | R | â€” | R | â€” |

**èªªæ˜**:
- Content Service æ˜¯å¸–å­ã€è©•è«–ã€é»è´Šçš„å–®ä¸€æ¬Šå¨æº
- Media Service è®€å–åœ–ç‰‡ä¿¡æ¯ç”¨æ–¼è™•ç†
- Feed Service è®€å–ç”¨æ–¼æ’åº
- Search Service è®€å–ç”¨æ–¼å…¨æ–‡ç´¢å¼•

---

### å…§å®¹èˆ‡è¦–é »é—œè¯ï¼ˆæ‰€æœ‰è€…ï¼šMedia Serviceï¼‰

| è¡¨å | Auth | User | Content | Feed | Media | Messaging | Search | Streaming |
|------|------|------|---------|------|-------|-----------|--------|-----------|
| **public.videos** | â€” | â€” | R | R | **CRUD** | â€” | R | R |
| **public.video_engagement** | â€” | â€” | R | R | **CRU** | â€” | R | R |
| **upload_sessions** | â€” | â€” | R | â€” | **CRUD** | â€” | â€” | â€” |

**èªªæ˜**:
- Media Service ç®¡ç†è¦–é »è™•ç†å’Œå…ƒæ•¸æ“š
- Streaming Service è®€å–è¦–é »ä¿¡æ¯ç”¨æ–¼ç›´æ’­
- å…¶ä»–æœå‹™é€šé gRPC èª¿ç”¨ `MediaService.GetVideo()` è€Œä¸æ˜¯ç›´æ¥è®€å–è¡¨

---

### å¯¦æ™‚é€šè¨Šï¼ˆæ‰€æœ‰è€…ï¼šMessaging Serviceï¼‰

| è¡¨å | Auth | User | Content | Feed | Media | Messaging | Search | Streaming |
|------|------|------|---------|------|-------|-----------|--------|-----------|
| **conversations** | â€” | R | â€” | â€” | â€” | **CRUD** | â€” | â€” |
| **messages** | â€” | R | â€” | â€” | â€” | **CRUD** | R | â€” |
| **message_reactions** | â€” | â€” | â€” | â€” | â€” | **CRUD** | â€” | â€” |
| **key_exchanges** | â€” | â€” | â€” | â€” | â€” | **CRUD** | â€” | â€” |
| **device_keys** | â€” | â€” | â€” | â€” | â€” | **CRUD** | â€” | â€” |

**èªªæ˜**:
- Messaging Service æ˜¯ç§ä¿¡ã€å°è©±çš„å–®ä¸€æ¬Šå¨æº
- User Service è®€å–å°è©±ä¿¡æ¯ï¼ˆç”¨æ–¼é—œä¿‚ç¢ºèªï¼‰
- ç«¯åˆ°ç«¯åŠ å¯†å¯†é‘°ç”± Messaging Service ç®¡ç†

---

### ç›´æ’­ï¼ˆæ‰€æœ‰è€…ï¼šStreaming Serviceï¼‰

| è¡¨å | Auth | User | Content | Feed | Media | Messaging | Search | Streaming |
|------|------|------|---------|------|-------|-----------|--------|-----------|
| **streams** | â€” | R | â€” | â€” | R | â€” | â€” | **CRUD** |
| **stream_keys** | â€” | â€” | â€” | â€” | â€” | â€” | â€” | **CRUD** |
| **viewer_sessions** | â€” | â€” | â€” | â€” | â€” | â€” | â€” | **CRUD** |
| **stream_metrics_\*** | â€” | â€” | â€” | â€” | â€” | â€” | â€” | **C** |
| **quality_levels** | â€” | â€” | â€” | â€” | â€” | â€” | â€” | **CRUD** |

**èªªæ˜**:
- Streaming Service ç®¡ç†ç›´æ’­æµã€æŸ¥çœ‹å™¨æœƒè©±å’ŒæŒ‡æ¨™
- æ™‚é–“åºåˆ—æ•¸æ“šï¼ˆ`stream_metrics_*`ï¼‰æŒ‰æœˆåˆ†å€ç”¨æ–¼æ€§èƒ½

---

## ğŸ” éœ€è¦ gRPC åŒ…è£çš„å…±äº«è¡¨

### usersï¼ˆå½“å‰è·¨æœå‹™è®€å–ï¼‰

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â”‚ ç•¶å‰ç‹€æ…‹ï¼ˆå–®æ•¸æ“šåº«ä¸­ï¼‰                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ‰€æœ‰æœå‹™ç›´æ¥è®€å– users è¡¨               â”‚
â”‚ âŒ å•é¡Œï¼šè¡¨æ¨¡å¼æ˜¯éš±å« API               â”‚
â”‚ âŒ é¢¨éšªï¼šæ”¹ä¸€å€‹å­—æ®µå½±éŸ¿æ‰€æœ‰æœå‹™         â”‚
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

é·ç§»æ–¹æ¡ˆï¼ˆPhase 1ï¼‰ï¼š
  Service 1        Service 2        Service 3
      â”‚                â”‚                 â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                  gRPC Gateway
                  (AuthService)
                       â”‚
                  users è¡¨ï¼ˆå–®ä¸€çœŸæºï¼‰
```

### posts / comments / likesï¼ˆå½“å‰è·¨æœå‹™è®€å–ï¼‰

```
Content Service æ‡‰è©²æä¾› gRPC ç«¯é»ï¼š
  - GetPost(id) â†’ å®Œæ•´å¸–å­ä¿¡æ¯
  - GetComments(post_id) â†’ è©•è«–åˆ—è¡¨
  - GetLikes(post_id) â†’ é»è´Šç”¨æˆ¶åˆ—è¡¨
```

---

## ğŸ“Š æœå‹™ç´šåˆ¥æ•¸æ“šçµ±è¨ˆ

| æœå‹™ | æ“æœ‰è¡¨æ•¸ | å¯è®€è¡¨æ•¸ | è·è²¬ |
|------|---------|---------|------|
| **Auth Service** | 8 | 11 | èº«ä»½é©—è­‰ã€ä»¤ç‰Œã€æœƒè©± |
| **User Service** | 2 | 8 | ç”¨æˆ¶æª”æ¡ˆã€ç¤¾äº¤é—œä¿‚ |
| **Content Service** | 5 | 10 | å¸–å­ã€è©•è«–ã€é»è´Š |
| **Feed Service** | 0 | 10 | æ¨è–¦æ’åºï¼ˆåªè®€ï¼‰ |
| **Media Service** | 3 | 8 | è¦–é »è™•ç†ã€è½‰ç¢¼ |
| **Messaging Service** | 5 | 2 | ç§ä¿¡ã€åŠ å¯†ã€èŠå¤© |
| **Search Service** | 0 | 10 | å…¨æ–‡æœç´¢ï¼ˆåªè®€ï¼‰ |
| **Streaming Service** | 4 | 3 | ç›´æ’­ã€æµåª’é«” |

**Total Tables**: 38
**Single-Writer**: 36 âœ“
**Problematic (Multi-Writer)**: 2 (users, éƒ¨åˆ†å…±äº«)

---

## ğŸš€ Phase 1 é·ç§»è¨ˆåŠƒ

### Step 1ï¼šåŒ…è£å…±äº«è¡¨ç‚º gRPC æœå‹™ï¼ˆWeek 1-2ï¼‰

```protobuf
// åœ¨ auth_service.proto ä¸­
service AuthService {
  rpc GetUser(GetUserRequest) returns (GetUserResponse) {}
  rpc ListUsers(ListUsersRequest) returns (ListUsersResponse) {}
  rpc CheckUserExists(CheckUserExistsRequest) returns (CheckUserExistsResponse) {}
}
```

### Step 2ï¼šé·ç§»æœå‹™èª¿ç”¨ï¼ˆWeek 3-8ï¼‰

```rust
// èˆŠæ–¹å¼ï¼ˆç›´æ¥ SQLï¼‰
SELECT * FROM users WHERE id = $1;

// æ–°æ–¹å¼ï¼ˆgRPCï¼‰
let user = auth_client.get_user(GetUserRequest {
  user_id: user_id.to_string()
}).await?;
```

### Step 3ï¼šç§»é™¤ç›´æ¥æ•¸æ“šåº«ä¾è³´ï¼ˆWeek 9-12ï¼‰

- é€å€‹æœå‹™ç§»é™¤ users è¡¨çš„ç›´æ¥æŸ¥è©¢
- æ‰€æœ‰è·¨æœå‹™èª¿ç”¨éƒ½é€šé gRPC
- é©—è­‰æ²’æœ‰ SQL ä¾è³´

### Step 4ï¼šå¯é¸æ•¸æ“šåº«åˆ†é›¢ï¼ˆPost Phase 1ï¼‰

ä¸€æ—¦æ‰€æœ‰æœå‹™é€šé gRPC é€šä¿¡ï¼Œå°±å¯ä»¥å®‰å…¨åœ°ï¼š
- ç‚ºæ¯å€‹æœå‹™å‰µå»ºå°ˆå±¬æ•¸æ“šåº«
- Auth Service ä¿æœ‰ users è¡¨çš„å”¯ä¸€å‰¯æœ¬
- å…¶ä»–æœå‹™é€šé gRPC æŸ¥è©¢ users

---

## âš ï¸ é—œéµç´„æŸ

1. **ä¸èƒ½ç ´å£ Userspace**
   - æ‰€æœ‰é·ç§»éƒ½å‘å¾Œå…¼å®¹
   - å…ˆæ–°å¢ gRPC ç«¯é»ï¼Œå¾Œåˆ é™¤ SQL æŸ¥è©¢

2. **æ€§èƒ½ç¬¬ä¸€**
   - gRPC æ‰¹é‡æ“ä½œ vs é€å€‹ SQL æŸ¥è©¢
   - ä½¿ç”¨ `GetUsersByIds()` è€Œä¸æ˜¯ N+1 æŸ¥è©¢

3. **ä¸€è‡´æ€§ä¿è­‰**
   - ä½¿ç”¨ Outbox Pattern ä¿è­‰äº‹ä»¶ä¸€è‡´æ€§
   - Kafka + Debezium ç”¨æ–¼æ•¸æ“šåŒæ­¥

4. **ç›£æ§è¦†è“‹**
   - æ¯å€‹ gRPC èª¿ç”¨éƒ½æœ‰æŒ‡æ¨™
   - è¨˜éŒ„ P99 å»¶é²ä»¥ç¢ºä¿ä¸è¶…é 200ms

---

## ğŸ“ æœå‹™é‚Šç•Œæ‘˜è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Single Database (nova_content) - Phase 0                 â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Auth Service â”‚  â”‚ User Service â”‚  â”‚Content Serviceâ”‚ â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚               â”‚ â”‚
â”‚  â”‚users         â”‚  â”‚prefs         â”‚  â”‚posts          â”‚ â”‚
â”‚  â”‚sessions      â”‚  â”‚social_meta   â”‚  â”‚comments       â”‚ â”‚
â”‚  â”‚auth_logs     â”‚  â”‚follows       â”‚  â”‚likes          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚Messaging Svc â”‚  â”‚ Media Svc    â”‚  â”‚ Streaming Svc â”‚ â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚               â”‚ â”‚
â”‚  â”‚conversations â”‚  â”‚videos        â”‚  â”‚streams        â”‚ â”‚
â”‚  â”‚messages      â”‚  â”‚upload_sess   â”‚  â”‚viewer_sessionsâ”‚ â”‚
â”‚  â”‚key_exchanges â”‚  â”‚              â”‚  â”‚               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ gRPC é€šä¿¡ï¼ˆPhase 1ï¼‰â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Separate Databases - Phase 3ï¼ˆå¯é¸ï¼‰                    â”‚
â”‚                                                           â”‚
â”‚  nova_auth    â”‚  nova_user    â”‚  nova_content â”‚ ... â”‚ â”‚
â”‚  (users, ...)  â”‚  (prefs, ...) â”‚  (posts, ...) â”‚     â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ æˆåŠŸæŒ‡æ¨™

- âœ… æ‰€æœ‰è·¨æœå‹™æŸ¥è©¢éƒ½ä½¿ç”¨ gRPCï¼ˆä¸æ˜¯ SQLï¼‰
- âœ… æ¯å€‹è¡¨æœ‰æ˜ç¢ºçš„æ‰€æœ‰è€…æœå‹™
- âœ… ç„¡ SQL ä¾è³´å¾ªç’°
- âœ… gRPC èª¿ç”¨ P99 < 50msï¼ˆæœ¬åœ°é›†ç¾¤ï¼‰
- âœ… å¯ä»¥åœ¨ 5 åˆ†é˜å…§ç¨ç«‹éƒ¨ç½²ä»»ä½•æœå‹™
