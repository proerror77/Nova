# 视频上传功能 - 快速开始指南

## 👋 问题解决

### 之前的问题
❌ iOS UI 只支持图片上传
❌ 找不到视频上传的功能
❌ CreatePostView 没有视频选择器

### 现在的解决方案
✅ 完整的图片和视频上传支持
✅ 清晰的 UI 入口和提示
✅ 统一的媒体管理框架

---

## 🎯 快速使用

### 1️⃣ 打开应用并找到上传入口

```
应用主界面 (TabView)
    ↓
点击底部 "Create" 标签（加号 ➕ 图标）
    ↓
进入创建帖子页面
```

### 2️⃣ 选择媒体

页面显示两个按钮：

```
┌─────────────────────────────┐
│  📷 Add Photo               │
│  Select from your library   │
└─────────────────────────────┘

┌─────────────────────────────┐
│  🎥 Add Video               │
│  Select from your library   │
└─────────────────────────────┘
```

- 点击 **"Add Photo"** → 上传图片
- 点击 **"Add Video"** → 上传视频

### 3️⃣ 输入标题（必填）

```
Caption
[写在这里...]
```

**重要**：标题必填，否则无法上传！

### 4️⃣ 上传

点击 **"Share Post"** 按钮

看到进度条：
```
Uploading... 50%
████████░░░░░░░░░░░░
```

完成后收到成功提示 ✅

---

## 🎬 不同的上传场景

### 图片上传流程

```
选择相册中的图片
        ↓
图片自动压缩（80% 质量）
        ↓
显示完整预览
        ↓
输入标题
        ↓
点击"Share Post"
        ↓
✅ 完成
```

**预览样式：**
```
┌─────────────────────┐
│                     │
│    图片预览 1:1     │
│   (正方形)          │
│                     │
│  [x] 右上角删除按钮 │
│  [PHOTO] 蓝色标签   │
└─────────────────────┘
```

### 视频上传流程

```
选择相册中的视频
        ↓
自动生成缩略图
        ↓
显示视频信息
  - Duration: 1:23
  - Size: 45.2 MB
        ↓
输入标题
        ↓
点击"Share Post"
        ↓
视频自动压缩（中等质量）
        ↓
✅ 完成
```

**预览样式：**
```
┌─────────────────────────┐
│  🎬 ▶ 播放按钮         │
│  [缩略图 16:9比例]     │
│  Duration: 1:23        │
│  Size: 45.2 MB         │
│                        │
│  [x] 右上角删除按钮    │
│  [VIDEO] 红色标签      │
└─────────────────────────┘
```

---

## 🛠 技术架构

### 三层架构

```
┌─────────────────────────────┐
│   CreatePostView (UI)       │ ← 用户界面
└──────────────┬──────────────┘
               ↓
┌─────────────────────────────┐
│ CreatePostViewModel         │ ← 业务逻辑
│ - 媒体选择                  │
│ - 验证                      │
│ - 上传管理                  │
└──────────────┬──────────────┘
               ↓
┌─────────────────────────────┐
│ MediaUploadManager          │ ← 上传管理
│ - 并发控制                  │
│ - 进度追踪                  │
│ - 重试机制                  │
└──────────────┬──────────────┘
               ↓
┌─────────────────────────────┐
│ VideoManager / ImageCompressor
│ - 视频压缩                  │
│ - 视频处理                  │
│ - 图片压缩                  │
└─────────────────────────────┘
```

### 数据流

```
图片或视频
    ↓
MediaData 枚举包装
    ↓
CreatePostViewModel
    ↓
MediaUploadManager
    ↓
后端 API
    ↓
✅ 完成
```

---

## 📊 核心功能对比

| 功能 | 之前 | 现在 |
|-----|------|------|
| 图片上传 | ✅ | ✅ |
| 视频上传 | ❌ | ✅ |
| UI 明确入口 | ❓ | ✅✅ |
| 视频预览 | ❌ | ✅ |
| 自动压缩 | ✅ | ✅✅ |
| 进度显示 | ✅ | ✅ |
| 错误处理 | ✅ | ✅✅ |
| 并发上传 | ❌ | ✅ (3个) |
| 重试机制 | ❌ | ✅ (3次) |

---

## 🎮 详细操作步骤

### 场景 1: 上传一张照片

**步骤：**

1. 打开应用
2. 点击底部 "Create" tab
3. 点击 "Add Photo" 按钮
4. 从相册选择一张照片
5. 看到照片预览（1:1 正方形）
6. 在 Caption 字段输入文字
7. 点击 "Share Post"
8. 等待上传完成（可能 2-5 秒）
9. 看到绿色勾 ✅ 和成功提示

### 场景 2: 上传一段视频

**步骤：**

1. 打开应用
2. 点击底部 "Create" tab
3. 点击 "Add Video" 按钮
4. 从相册选择一段视频
5. 等待缩略图生成（1-2 秒）
6. 看到视频预览，显示：
   - 缩略图 + 播放按钮
   - 视频时长
   - 文件大小
7. 在 Caption 字段输入文字
8. 点击 "Share Post"
9. 看到进度条，视频自动压缩并上传
10. 完成后收到成功提示

---

## ⚠️ 常见问题

### Q1: "Share Post" 按钮为什么灰色？
**A:** 因为还没有：
- 选择图片/视频，**或**
- 输入标题

两个条件都需要满足。

### Q2: 视频缩略图为什么还在加载？
**A:** 系统正在生成视频缩略图，通常需要 1-2 秒。

### Q3: 上传失败了怎么办？
**A:** 系统会自动重试最多 3 次。如果仍然失败，会显示错误信息。

### Q4: 大视频会上传多久？
**A:** 取决于：
- 视频文件大小
- 网络速度
- 最大等待时间是 5 分钟

### Q5: 可以同时上传多个文件吗？
**A:** 目前每次只能上传一个文件（一张图片或一段视频）。
系统支持最多 3 个并发上传（不同用户的上传）。

---

## 🔍 验证清单

使用时检查以下几点：

- [ ] 能否打开 "Create" tab？
- [ ] 是否看到 "Add Photo" 和 "Add Video" 两个按钮？
- [ ] 能否选择图片？
- [ ] 能否选择视频？
- [ ] 视频是否显示缩略图、时长和大小？
- [ ] 标题框是否可以输入？
- [ ] 标题为空时 "Share Post" 是否禁用？
- [ ] 标题有内容后按钮是否启用？
- [ ] 上传时是否显示进度条？
- [ ] 完成后是否显示成功提示？

---

## 🚀 下一步

### 立即尝试

1. 编译并运行应用
2. 点击 "Create" tab
3. 尝试上传一张照片
4. 尝试上传一段视频

### 提供反馈

- 😊 **工作正常**？记录下来！
- 🐛 **发现问题**？记录错误信息
- 💡 **有改进建议**？收集反馈

---

## 📚 相关文件

新增和修改的文件：

```
新增：
  MediaKit/Core/MediaUploadManager.swift
  MEDIA_UPLOAD_IMPLEMENTATION.md (详细文档)

修改：
  ViewModels/Post/CreatePostViewModel.swift
  Views/Post/CreatePostView.swift
```

详见 `MEDIA_UPLOAD_IMPLEMENTATION.md` 获取技术细节。

---

## 💪 设计理念

基于 Linus Torvalds 的代码哲学：

> **"好代码没有特殊情况"**

**实现中的应用：**

1. ✅ **统一的媒体框架**
   - 一个 `MediaUploadManager` 处理图片和视频
   - 没有重复代码

2. ✅ **清晰的 UI**
   - 两个明确的按钮（Photo 和 Video）
   - 不需要用户猜测如何操作

3. ✅ **简化的逻辑**
   - `MediaData` 枚举统一处理
   - 最少的条件分支

---

## 🎓 总结

| 方面 | 改进 |
|-----|------|
| 功能性 | ➕ 新增视频上传 |
| 易用性 | ➕ 明确的 UI 按钮 |
| 可靠性 | ➕ 自动重试 + 错误处理 |
| 性能 | ➕ 并发上传 + 自动压缩 |
| 代码质量 | ➕ 统一的媒体框架 |

**现在可以轻松上传图片和视频了！** 🎉

