# CryptoCore.xcframework (iOS)

Client-side E2E crypto wrapper for iOS, bridging to the existing Rust crate `backend/libs/crypto-core`.

This folder contains build notes and scripts to generate `CryptoCore.xcframework` for iOS devices/simulators.

## Prerequisites

- **Rust toolchain** (stable, 1.75+)
  ```bash
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
  ```

- **Xcode command line tools**
  ```bash
  xcode-select --install
  ```

- **cbindgen** (for C header generation)
  ```bash
  cargo install cbindgen
  ```

- **iOS targets** (will be auto-installed by build script)
  ```bash
  rustup target add aarch64-apple-ios
  rustup target add aarch64-apple-ios-sim
  rustup target add x86_64-apple-ios
  ```

## Build Targets

We build static libraries for:
- `aarch64-apple-ios` - iOS devices (iPhone/iPad)
- `aarch64-apple-ios-sim` - Simulator on Apple Silicon Macs
- `x86_64-apple-ios` - Simulator on Intel Macs

Then we create an XCFramework containing all three architectures.

## Build Instructions

```bash
cd ios/CryptoCore
./build.sh
```

This will:
1. Generate `include/cryptocore.h` via cbindgen (from `backend/libs/crypto-core/cbindgen.toml`)
2. Build static libraries for all three targets
3. Create `CryptoCore.xcframework` in the current directory

### Expected Output

```
Generating C header via cbindgen...
Building static libraries...
  • Installing target aarch64-apple-ios...
  • Building for aarch64-apple-ios...
  • Installing target aarch64-apple-ios-sim...
  • Building for aarch64-apple-ios-sim...
  • Installing target x86_64-apple-ios...
  • Building for x86_64-apple-ios...
Creating XCFramework...
✅ Built CryptoCore.xcframework

Framework location: /path/to/ios/CryptoCore/CryptoCore.xcframework
Header location: /path/to/ios/CryptoCore/include/cryptocore.h
```

## Swift Usage

Add `CryptoCore.xcframework` to your Xcode project (Embed & Sign not required for static).

Swift wrapper lives at `ios/NovaSocial/Network/Security/CryptoCore.swift`.
Use `CryptoCoreProvider.shared.encrypt/decrypt/generateNonce` from Swift.

## FFI API Reference

The C header exposes these functions from Rust:

### `cryptocore_generate_nonce`
```c
unsigned long cryptocore_generate_nonce(unsigned char *out_buf, unsigned long out_len);
```
Generates a random 24-byte nonce for encryption.
- Returns: 24 on success, 0 on error

### `cryptocore_encrypt`
```c
unsigned char* cryptocore_encrypt(
    const unsigned char *plaintext_ptr, unsigned long plaintext_len,
    const unsigned char *recipient_pk_ptr, unsigned long recipient_pk_len,
    const unsigned char *sender_sk_ptr, unsigned long sender_sk_len,
    const unsigned char *nonce_ptr, unsigned long nonce_len,
    unsigned long *out_len_ptr
);
```
Encrypts plaintext using Curve25519XSalsa20Poly1305 (NaCl box).
- Returns: Pointer to ciphertext (caller must free with `cryptocore_free`), NULL on error

### `cryptocore_decrypt`
```c
unsigned char* cryptocore_decrypt(
    const unsigned char *ciphertext_ptr, unsigned long ciphertext_len,
    const unsigned char *sender_pk_ptr, unsigned long sender_pk_len,
    const unsigned char *recipient_sk_ptr, unsigned long recipient_sk_len,
    const unsigned char *nonce_ptr, unsigned long nonce_len,
    unsigned long *out_len_ptr
);
```
Decrypts ciphertext using Curve25519XSalsa20Poly1305 (NaCl box).
- Returns: Pointer to plaintext (caller must free with `cryptocore_free`), NULL on error

### `cryptocore_free`
```c
void cryptocore_free(unsigned char *buf_ptr, unsigned long buf_len);
```
Frees memory allocated by `cryptocore_encrypt` or `cryptocore_decrypt`.

## Architecture

```
┌─────────────────────────────────────┐
│  Swift (iOS App)                     │
│  CryptoCoreProvider.swift            │
└──────────────┬──────────────────────┘
               │
               │ (Swift to C bridging)
               ▼
┌─────────────────────────────────────┐
│  C Header (cryptocore.h)             │
│  Generated by cbindgen               │
└──────────────┬──────────────────────┘
               │
               │ (FFI boundary)
               ▼
┌─────────────────────────────────────┐
│  Rust (crypto-core crate)            │
│  - X25519 ECDH key exchange          │
│  - NaCl box (Curve25519XSalsa20)     │
│  - NaCl secretbox (at-rest crypto)   │
│  - sodiumoxide bindings              │
└─────────────────────────────────────┘
```

## Notes

- In development, if the XCFramework is missing, the Swift wrapper falls back to a no-op/Base64 scheme so app flows aren't blocked.
- Replace the fallback with the real framework when shipping strict E2E.
- The Rust crate uses `sodiumoxide` (libsodium bindings) for cryptographic operations.
- FFI functions use `#[no_mangle]` and `extern "C"` for C ABI compatibility.

